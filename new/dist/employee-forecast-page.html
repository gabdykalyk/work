<!DOCTYPE html>
<html class="hrm-page employee-forecast-page hrm-page--initializing"
      data-bind="childrenComplete: childrenComplete" lang="ru">
<head>
    <title>Sakura</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="HandheldFriendly" content="true" />
<meta content="IE=edge" http-equiv="X-UA-Compatible" />
<link href="https://fonts.googleapis.com/css?family=Fira+Sans:100,200,300,400,500,600,700,800,900&display=swap&subset=cyrillic" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2@4.0.12/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/overlayscrollbars/1.10.2/css/OverlayScrollbars.min.css" integrity="sha256-zUBmWpj0DsZzFautKgMOtiOkT6ECQ+a6RitMns7+HRM=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://unpkg.com/tippy.js@5/dist/backdrop.css" />
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
<link rel="stylesheet" href="assets/fonts/fontawesome/css/all.css" />

<link rel="stylesheet" href="assets/css/main.css" />

</head>

<body>
    <div class="hrm-scaffold">
        <div class="hrm-scaffold__sidebar" data-bind="component: {name: 'hrm-basic-sidebar'}"></div>
        <div class="hrm-scaffold__body">
            <div class="hrm-scaffold__content employee-forecast-page__content">
                <div class="employee-forecast-page__header">
                    <span class="employee-forecast-page__title">
                        Прогноз по сотрудникам
                    </span>

                    <!-- ko if: viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
                        <button class="hrm-button hrm-button-with-icon hrm-button-with-icon--theme_secondary
                                       hrm-button-with-arrow-left-icon employee-forecast-page__back-button">
                            К мастеру настроек
                        </button>
                    <!-- /ko -->

                    <!-- ko if: viewportSize().width <= HRM_BREAKPOINTS.mobileMaxWidth -->
                        <button class="hrm-button hrm-circle-icon-button hrm-circle-icon-button--theme_secondary
                                       hrm-circle-arrow-left-icon-button employee-forecast-page__back-button">
                        </button>
                    <!-- /ko -->
                </div>

                <div class="employee-forecast-page__form">
                    <div class="employee-forecast-page__form-header">
                        <!-- ko let: {control: ko.observable(null), label: ko.observable(null)} -->
                            <div class="employee-forecast-page__date-form-field"
                                 data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
                                <label data-bind="hrmFormFieldLabel: label">Расчёт на дату</label>

                                <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
                                    <input data-bind="
                                        textInput: $root.date,
                                        hrmDatepicker,
                                        hrmFormFieldDatepickerControl: control,
                                        hrmFormFieldDatepickerControlErrorStateMatcher: $root.formControlErrorStateMatcher.bind($root)
                                    ">

                                    <i class="hrm-form-field__suffix hrm-form-field-icon hrm-form-field-calendar-icon"></i>
                                </div>

                                <div data-bind="
                                    component: {name: 'hrm-form-field-error'},
                                    hrmSlide,
                                    hrmSlideValue: control() !== null ? control() !== null ? control().errorState : false : false,
                                    hrmSlideDuration: 150
                                ">
                                    <!-- ko text: $root.date.error() --><!-- /ko -->
                                </div>
                            </div>
                        <!-- /ko -->

                        <!-- ko template: {
                            foreach: hrmTemplateIf(!isBuilt(), $data),
                            afterAdd: hrmFadeAfterAddFactory(200, 200),
                            beforeRemove: hrmFadeBeforeRemoveFactory(200)
                        } -->
                            <div class="hrm-button hrm-basic-button hrm-accent-button employee-forecast-page__form-header-action
                                        employee-forecast-page__build-forecast-button"
                                 data-bind="click: function () {buildForecast();}">
                                Построить прогноз
                            </div>
                        <!-- /ko -->

                        <!-- ko template: {
                            foreach: hrmTemplateIf(isBuilt(), $data),
                            afterAdd: hrmFadeAfterAddFactory(200, 200),
                            beforeRemove: hrmFadeBeforeRemoveFactory(200)
                        } -->
                            <div class="hrm-button hrm-basic-button employee-forecast-page__form-header-action
                                        employee-forecast-page__recalculate-forecast-button">
                                Пересчитать
                            </div>
                        <!-- /ko -->
                    </div>

                    <!-- ko template: {
                        foreach: hrmTemplateIf(isBuilt(), $data),
                        afterAdd: hrmFadeAfterAddFactory(200, 200),
                        beforeRemove: hrmFadeBeforeRemoveFactory(200)
                    } -->
                        <!-- ko if: $root.viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
                            <table class="employee-forecast-page__positions-table" data-bind="hrmTable">
                                <thead>
                                <tr>
                                    <th>
                                        <div class="hrm-table__head-cell-content">
                                            Должность
                                            <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                           hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                    data-bind="hrmTooltip, hrmTooltipText: 'Должность'">
                                            </button>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="hrm-table__head-cell-content">
                                            Тип нагрузки
                                            <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                           hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                    data-bind="hrmTooltip, hrmTooltipText: 'Тип нагрузки'">
                                            </button>
                                        </div>
                                    </th>
                                    <th colspan="2">
                                        <div class="hrm-table__head-cell-content">
                                            Нагрузка
                                            <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                           hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                    data-bind="hrmTooltip, hrmTooltipText: 'Нагрузка'">
                                            </button>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="hrm-table__head-cell-content">
                                            Сотрудники
                                            <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                           hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                    data-bind="hrmTooltip, hrmTooltipText: 'Сотрудники'">
                                            </button>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="hrm-table__head-cell-content">
                                            Нормо-часы
                                            <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                           hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                    data-bind="hrmTooltip, hrmTooltipText: 'Нормо-часы'">
                                            </button>
                                        </div>
                                    </th>
                                </tr>
                                </thead>

                                <tbody>
                                <!-- ko foreach: formModel().positions -->
                                    <tr>
                                        <td data-bind="text: name"></td>
                                        <td>
                                            <!-- ko text: $root.getWorkloadTypeName(workloadType) --><!-- /ko -->
                                            <!-- ko if: workloadType === 2 -->
                                                <span class="employee-forecast-page__positions-table-categories-count"
                                                      data-bind="text: categories.length, hrmTooltip, hrmTooltipText: $root.getCategoriesTooltipText(categories)">
                                                </span>
                                            <!-- /ko -->
                                        </td>
                                        <!-- ko let: {editableCell: ko.observable(null)} -->
                                            <td data-bind="hrmTableEditableCell: editableCell">
                                                <select data-bind="
                                                    value: units,
                                                    hrmSelect,
                                                    hrmTableEditableCellSelectControl,
                                                    hrmTableEditableCellSelectControlOwner: editableCell
                                                ">
                                                    <option value="1">Штуки</option>
                                                    <option value="2">Рубли</option>
                                                    <option value="3">Норма времени</option>
                                                </select>
                                            </td>
                                        <!-- /ko -->
                                        <!-- ko let: {editableCell: ko.observable(null)} -->
                                            <td class="employee-forecast-page__positions-table-workload-cell"
                                                data-bind="hrmTableEditableCell: editableCell">
                                                <input data-bind="
                                                    value: workload,
                                                    hrmMask, hrmMaskPattern: 'decimal',
                                                    hrmMaskOptions: {digits: '0,2', groupSeparator: ' ', autoGroup: true, allowMinus: false, rightAlign: false},
                                                    hrmTableEditableCellInputControl,
                                                    hrmTableEditableCellInputControlOwner: editableCell
                                                " placeholder="0">
                                            </td>
                                        <!-- /ko -->
                                        <td class="employee-forecast-page__positions-table-employee-count-cell"
                                            data-bind="text: employees().length">
                                        </td>
                                        <td class="employee-forecast-page__positions-table-estimated-hours-cell"
                                            data-bind="text: estimatedHours">
                                        </td>
                                    </tr>
                                <!-- /ko -->
                                </tbody>
                            </table>
                        <!-- /ko -->

                        <!-- ko if: $root.viewportSize().width <= HRM_BREAKPOINTS.mobileMaxWidth -->
                            <div class="hrm-table__fixed-section-container employee-forecast-page__positions-table">
                                <table class="hrm-table__fixed-section hrm-table__fixed-section--position_left
                                              employee-forecast-page__positions-table-fixed-section"
                                       data-bind="hrmTable">
                                    <thead>
                                    <tr>
                                        <th>
                                            <div class="hrm-table__head-cell-content employee-forecast-page__positions-table-table-head-cell-content">
                                                Должность
                                                <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                               hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                        data-bind="hrmTooltip, hrmTooltipText: 'Должность'">
                                                </button>
                                            </div>
                                        </th>
                                    </tr>

                                    <tr>
                                        <th>
                                            <div class="hrm-table__head-cell-content employee-forecast-page__positions-table-table-head-cell-content">
                                                Тип нагрузки
                                                <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                               hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                        data-bind="hrmTooltip, hrmTooltipText: 'Тип нагрузки'">
                                                </button>
                                            </div>
                                        </th>
                                    </tr>

                                    <tr>
                                        <th>
                                            <div class="hrm-table__head-cell-content employee-forecast-page__positions-table-table-head-cell-content">
                                                Нагрузка
                                                <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                               hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                        data-bind="hrmTooltip, hrmTooltipText: 'Нагрузка'">
                                                </button>
                                            </div>
                                        </th>
                                    </tr>

                                    <tr>
                                        <th>
                                            <div class="hrm-table__head-cell-content employee-forecast-page__positions-table-table-head-cell-content">
                                                Сотрудники
                                                <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                               hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                        data-bind="hrmTooltip, hrmTooltipText: 'Сотрудники'">
                                                </button>
                                            </div>
                                        </th>
                                    </tr>

                                    <tr>
                                        <th>
                                            <div class="hrm-table__head-cell-content employee-forecast-page__positions-table-table-head-cell-content">
                                                Нормо-часы
                                                <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                               hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                        data-bind="hrmTooltip, hrmTooltipText: 'Нормо-часы'">
                                                </button>
                                            </div>
                                        </th>
                                    </tr>
                                    </thead>
                                </table>

                                <div class="hrm-table__scrollable-wrapper">
                                    <table class="employee-forecast-page__positions-table-table"
                                           data-bind="hrmTable">
                                        <tbody>
                                        <tr>
                                            <!-- ko foreach: formModel().positions -->
                                                <td colspan="2" data-bind="text: name"></td>
                                            <!-- /ko -->
                                        </tr>
                                        <tr>
                                            <!-- ko foreach: formModel().positions -->
                                                <td colspan="2">
                                                    <!-- ko text: $root.getWorkloadTypeName(workloadType) --><!-- /ko -->
                                                    <!-- ko if: workloadType === 2 -->
                                                        <span class="employee-forecast-page__positions-table-categories-count"
                                                              data-bind="text: categories.length, hrmTooltip, hrmTooltipText: $root.getCategoriesTooltipText(categories)">
                                                        </span>
                                                    <!-- /ko -->
                                                </td>
                                            <!-- /ko -->
                                        </tr>

                                        <tr>
                                            <!-- ko foreach: formModel().positions -->
                                                <!-- ko let: {editableCell: ko.observable(null)} -->
                                                    <td data-bind="hrmTableEditableCell: editableCell">
                                                        <select data-bind="
                                                            value: units,
                                                            hrmSelect,
                                                            hrmTableEditableCellSelectControl,
                                                            hrmTableEditableCellSelectControlOwner: editableCell
                                                        ">
                                                            <option value="1">Штуки</option>
                                                            <option value="2">Рубли</option>
                                                            <option value="3">Норма времени</option>
                                                        </select>
                                                    </td>
                                                <!-- /ko -->

                                                <!-- ko let: {editableCell: ko.observable(null)} -->
                                                    <td class="employee-forecast-page__positions-table-workload-cell"
                                                        data-bind="hrmTableEditableCell: editableCell">
                                                        <input data-bind="
                                                            value: workload,
                                                            hrmMask, hrmMaskPattern: 'decimal',
                                                            hrmMaskOptions: {digits: '0,2', groupSeparator: ' ', autoGroup: true, allowMinus: false, rightAlign: false},
                                                            hrmTableEditableCellInputControl,
                                                            hrmTableEditableCellInputControlOwner: editableCell
                                                        " placeholder="0">
                                                    </td>
                                                <!-- /ko -->
                                            <!-- /ko -->
                                        </tr>

                                        <tr>
                                            <!-- ko foreach: formModel().positions -->
                                                <td class="employee-forecast-page__positions-table-estimated-hours-cell"
                                                    data-bind="text: estimatedHours" colspan="2">
                                                </td>
                                            <!-- /ko -->
                                        </tr>

                                        <tr>
                                            <!-- ko foreach: formModel().positions -->
                                                <td class="employee-forecast-page__positions-table-estimated-hours-cell"
                                                    data-bind="text: estimatedHours" colspan="2">
                                                </td>
                                            <!-- /ko -->
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        <!-- /ko -->

                        <div class="employee-forecast-page__form-employees-section">
                            <!-- ko template: {
                                foreach: hrmTemplateIf(!isEmployeesCalculated(), $data),
                                afterAdd: hrmFadeAfterAddFactory(200, 200),
                                beforeRemove: hrmFadeBeforeRemoveFactory(200)
                            } -->
                                <div class="hrm-button hrm-basic-button hrm-accent-button employee-forecast-page__form-employees-section-action
                                            employee-forecast-page__add-employees-button"
                                     data-bind="click: function () {calculateEmployees();}">
                                    Добавить сотрудников
                                </div>
                            <!-- /ko -->

                            <!-- ko template: {
                                foreach: hrmTemplateIf(isEmployeesCalculated(), $data),
                                afterAdd: hrmFadeAfterAddFactory(200, 200),
                                beforeRemove: hrmFadeBeforeRemoveFactory(200)
                            } -->
                                <div class="hrm-button hrm-basic-button employee-forecast-page__form-employees-section-action
                                            employee-forecast-page__recalculate-employees-button"
                                     data-bind="click: function() {recalculateEmployees();}">
                                    Пересчитать сотрудников
                                </div>

                                <span class="employee-forecast-page__form-employees-section-title">Сотрудники</span>

                                <!-- ko if: $root.viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
                                    <div class="hrm-table__fixed-section-container
                                                employee-forecast-page__employees-table-fixed-section-container">
                                        <!-- ko if: $root.viewportSize().width <= HRM_BREAKPOINTS.tabletMaxWidth -->
                                            <table class="hrm-table__fixed-section hrm-table__fixed-section--position_left
                                                          employee-forecast-page__employees-table
                                                          employee-forecast-page__employees-table-fixed-section"
                                                   data-bind="hrmTable">
                                                <thead>
                                                <tr>
                                                    <th>
                                                        Сотрудник
                                                    </th>
                                                </tr>
                                                </thead>

                                                <tbody>
                                                <!-- ko foreach: {data: formModel().positions, as: 'position'} -->
                                                    <tr class="employee-forecast-page__employees-table-position-row">
                                                        <td class="employee-forecast-page__employees-table-position-name-cell">
                                                            <div class="hrm-table__cell-content">
                                                                <button class="hrm-button hrm-circle-icon-button hrm-circle-plus-icon-button
                                                                               hrm-circle-icon-button--theme_neutral employee-forecast-page__employees-table-position-name-cell-add-button"
                                                                        data-bind="click: function() {$root.addEmployee(position);}" title="Добавить сотрудника">
                                                                </button>
                                                                <span class="employee-forecast-page__employees-table-position-name-cell-name"
                                                                      data-bind="text: name">
                                                                </span>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <!-- ko foreach: {
                                                        data: employees,
                                                        as: 'employee',
                                                        afterAdd: hrmFadeAfterAddFactory(200),
                                                        beforeRemove: hrmFadeBeforeRemoveFactory(200)
                                                    } -->
                                                        <tr class="employee-forecast-page__employees-table-employee-row"
                                                            data-bind="
                                                                css: {
                                                                    'employee-forecast-page__employees-table-employee-row--multi-interval': employee.workingIntervals().length > 1
                                                                }
                                                            "
                                                        >
                                                            <td class="employee-forecast-page__employees-table-employee-name-cell"
                                                                data-bind="style: {height: employee.workingIntervals().length * 40 }">
                                                                <div class="employee-forecast-page__employees-table-employee">
                                                                    <button class="hrm-button hrm-circle-icon-button hrm-circle-times-icon-button
                                                                                   hrm-circle-icon-button--theme_secondary
                                                                                   employee-forecast-page__employees-table-employee-remove-button"
                                                                            data-bind="click: function() {position.employees.remove(employee);}"
                                                                            title="Удалить сотрудника">
                                                                    </button>
                                                                    <span class="employee-forecast-page__employees-table-employee-name"
                                                                          data-bind="text: name">
                                                                    </span>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    <!-- /ko -->
                                                <!-- /ko -->
                                                </tbody>
                                            </table>
                                        <!-- /ko -->

                                        <div class="hrm-table__scrollable-wrapper">
                                            <table class="employee-forecast-page__employees-table" data-bind="hrmTable">
                                                <thead>
                                                <tr>
                                                    <!-- ko if: $root.viewportSize().width > HRM_BREAKPOINTS.tabletMaxWidth -->
                                                        <th class="employee-forecast-page__employees-table-name-head-cell">
                                                            Сотрудник
                                                        </th>
                                                    <!-- /ko -->
                                                    <th class="employee-forecast-page__employees-table-working-intervals-head-cell">
                                                        <div class="hrm-table__head-cell-content">
                                                            Начало/конец работы
                                                            <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                                           hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                                    data-bind="hrmTooltip, hrmTooltipText: 'Начало/конец работы'">
                                                            </button>
                                                        </div>
                                                    </th>
                                                    <th>
                                                        <div class="hrm-table__head-cell-content">
                                                            Рабочее время
                                                            <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                                           hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                                    data-bind="hrmTooltip, hrmTooltipText: 'Рабочее время'">
                                                            </button>
                                                        </div>
                                                    </th>
                                                    <th>
                                                        <div class="hrm-table__head-cell-content">
                                                            <span>Оклад, <i class="far fa-ruble-sign"></i>/час</span>
                                                            <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                                           hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                                    data-bind="hrmTooltip, hrmTooltipText: 'Оклад, &lt;i class=&quot;far fa-ruble-sign&quot;&gt;&lt;/i&gt;/час'">
                                                            </button>
                                                        </div>
                                                    </th>
                                                    <th>
                                                        <div class="hrm-table__head-cell-content">
                                                            Норматив выручки
                                                            <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                                           hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                                    data-bind="hrmTooltip, hrmTooltipText: 'Норматив выручки'">
                                                            </button>
                                                        </div>
                                                    </th>

                                                    <th class="employee-forecast-page__employees-table-salary-bulk-head-cell">
                                                        <div class="hrm-table__head-cell-content">
                                                            <span>Основная часть зп, <i class="far fa-ruble-sign"></i></span>
                                                            <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                                           hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                                    data-bind="hrmTooltip, hrmTooltipText: 'Основная часть зп, &lt;i class=&quot;far fa-ruble-sign&quot;&gt;&lt;/i&gt;'">
                                                            </button>
                                                        </div>
                                                    </th>

                                                    <th>
                                                        <div class="hrm-table__head-cell-content">
                                                            <span>Премия, <i class="far fa-ruble-sign"></i></span>
                                                            <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                                           hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                                    data-bind="hrmTooltip, hrmTooltipText: 'Прем., &lt;i class=&quot;far fa-ruble-sign&quot;&gt;&lt;/i&gt;'">
                                                            </button>
                                                        </div>
                                                    </th>

                                                    <th>
                                                        <div class="hrm-table__head-cell-content">
                                                            <span>Депрем, <i class="far fa-ruble-sign"></i></span>
                                                            <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                                           hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                                    data-bind="hrmTooltip, hrmTooltipText: 'Депрем, &lt;i class=&quot;far fa-ruble-sign&quot;&gt;&lt;/i&gt;'">
                                                            </button>
                                                        </div>
                                                    </th>

                                                    <th>
                                                        <div class="hrm-table__head-cell-content">
                                                            <span>К выплате, <i class="far fa-ruble-sign"></i></span>
                                                            <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                                           hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                                    data-bind="hrmTooltip, hrmTooltipText: 'К выплате, &lt;i class=&quot;far fa-ruble-sign&quot;&gt;&lt;/i&gt;'">
                                                            </button>
                                                        </div>
                                                    </th>
                                                </tr>
                                                </thead>

                                                <tbody>
                                                <!-- ko foreach: {data: formModel().positions, as: 'position'} -->
                                                    <tr class="employee-forecast-page__employees-table-position-row">
                                                        <!-- ko if: $root.viewportSize().width > HRM_BREAKPOINTS.tabletMaxWidth -->
                                                            <td class="employee-forecast-page__employees-table-position-name-cell" colspan="3">
                                                                <div class="hrm-table__cell-content">
                                                                    <button class="hrm-button hrm-circle-icon-button hrm-circle-plus-icon-button
                                                                                   hrm-circle-icon-button--theme_neutral employee-forecast-page__employees-table-position-name-cell-add-button"
                                                                            data-bind="click: function() {$root.addEmployee(position);}" title="Добавить сотрудника">
                                                                    </button>
                                                                    <span class="employee-forecast-page__employees-table-position-name-cell-name"
                                                                          data-bind="text: name">
                                                                    </span>
                                                                </div>
                                                            </td>
                                                        <!-- /ko -->
                                                        <!-- ko if: $root.viewportSize().width <= HRM_BREAKPOINTS.tabletMaxWidth -->
                                                            <td colspan="2"></td>
                                                        <!-- /ko -->
                                                        <!-- ko let: {editableCell: ko.observable(null)} -->
                                                            <td class="employee-forecast-page__employees-table-rate-cell"
                                                                data-bind="hrmTableEditableCell: editableCell">
                                                                <input data-bind="
                                                                    textInput: rate,
                                                                    event: {
                                                                        input: function () {
                                                                            $root.onRateInput(position);
                                                                        }
                                                                    },
                                                                    hrmMask, hrmMaskPattern: 'decimal',
                                                                    hrmMaskOptions: {digits: '0,2', groupSeparator: ' ', autoGroup: true, allowMinus: false, rightAlign: false},
                                                                    hrmTableEditableCellInputControl,
                                                                    hrmTableEditableCellInputControlOwner: editableCell
                                                                " placeholder="0">
                                                            </td>
                                                        <!-- /ko -->
                                                        <td class="employee-forecast-page__employees-table-statistics-cell" colspan="5">
                                                            ФОТ — <b>34%</b>, норматив выработки — <b>90%</b>
                                                        </td>
                                                    </tr>
                                                    <!-- ko foreach: {
                                                        data: employees,
                                                        as: 'employee',
                                                        afterAdd: hrmFadeAfterAddFactory(200),
                                                        beforeRemove: hrmFadeBeforeRemoveFactory(200)
                                                    } -->
                                                        <tr class="employee-forecast-page__employees-table-employee-row"
                                                            data-bind="
                                                                css: {
                                                                    'employee-forecast-page__employees-table-employee-row--multi-interval': employee.workingIntervals().length > 1
                                                                }
                                                            "
                                                        >
                                                            <!-- ko if: $root.viewportSize().width > HRM_BREAKPOINTS.tabletMaxWidth -->
                                                                <td class="employee-forecast-page__employees-table-employee-name-cell"
                                                                    data-bind="attr: {rowspan: employee.workingIntervals().length}">
                                                                    <div class="employee-forecast-page__employees-table-employee">
                                                                        <button class="hrm-button hrm-circle-icon-button hrm-circle-times-icon-button
                                                                                       hrm-circle-icon-button--theme_secondary
                                                                                       employee-forecast-page__employees-table-employee-remove-button"
                                                                                data-bind="click: function() {position.employees.remove(employee);}" title="Удалить сотрудника">
                                                                        </button>
                                                                        <span class="employee-forecast-page__employees-table-employee-name"
                                                                              data-bind="text: name">
                                                                        </span>
                                                                    </div>
                                                                </td>
                                                            <!-- /ko -->
                                                            <!-- ko let: {editableCell: ko.observable(null)} -->
                                                                <td class="employee-forecast-page__employees-table-interval-cell"
                                                                    data-bind="
                                                                        hrmTableEditableCell: editableCell,
                                                                        hrmTableEditableCellError: $root.editableCellControlErrorExtractor(employee.workingIntervals()[0].value),
                                                                    ">
                                                                    <div class="hrm-table__cell-content hrm-table__editable-cell-content">
                                                                        <input data-bind="
                                                                            textInput: employee.workingIntervals()[0].value,
                                                                            hrmMask,
                                                                            hrmMaskPattern: '99:99 – 99:99',
                                                                            hrmTableEditableCellInputControl,
                                                                            hrmTableEditableCellInputControlOwner: editableCell
                                                                        " placeholder="00:00 - 00:00">
                                                                        <div class="employee-forecast-page__employees-table-interval-cell-actions">
                                                                            <!-- ko if: employee.workingIntervals().length > 1 -->
                                                                                <button class="hrm-button hrm-icon-button hrm-times-icon-button
                                                                                               hrm-icon-button--theme_negative
                                                                                               employee-forecast-page__employees-table-interval-cell-remove-button"
                                                                                        data-bind="
                                                                                            click: function () {employee.workingIntervals.splice(0, 1);},
                                                                                            attr: {title: 'Удалить интервал ' + employee.workingIntervals()[0].value()}
                                                                                        ">
                                                                                </button>
                                                                            <!-- /ko -->

                                                                            <div class="hrm-spacer"></div>

                                                                            <!-- ko if: employee.workingIntervals().length === 1 -->
                                                                                <button class="hrm-button hrm-icon-button hrm-plus-icon-button
                                                                                               hrm-icon-button--theme_positive
                                                                                               employee-forecast-page__employees-table-interval-cell-add-button"
                                                                                        title="Добавить рабочий интервал"
                                                                                        data-bind="click: function () {$root.addWorkingInterval(employee);}">
                                                                                </button>
                                                                            <!-- /ko -->
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                            <!-- /ko -->
                                                            <td class="employee-forecast-page__employees-table-working-hours-cell"
                                                                data-bind="
                                                                    text: $root.formatDuration($root.getEmployeeWorkingHours(employee)()),
                                                                    attr: {rowspan: employee.workingIntervals().length}
                                                                ">
                                                            </td>
                                                            <!-- ko let: {editableCell: ko.observable(null)} -->
                                                                <td class="employee-forecast-page__employees-table-rate-cell" data-bind="
                                                                    hrmTableEditableCell: editableCell,
                                                                    attr: {rowspan: employee.workingIntervals().length}
                                                                ">
                                                                    <input data-bind="
                                                                        textInput: employee.rate,
                                                                        event: {
                                                                            input: function () {
                                                                                $root.onEmployeeRateInput(position);
                                                                            }
                                                                        },
                                                                        hrmMask, hrmMaskPattern: 'decimal',
                                                                        hrmMaskOptions: {digits: '0,2', groupSeparator: ' ', autoGroup: true, allowMinus: false, rightAlign: false},
                                                                        hrmTableEditableCellInputControl,
                                                                        hrmTableEditableCellInputControlOwner: editableCell
                                                                    " placeholder="0">
                                                                </td>
                                                            <!-- /ko -->
                                                            <td class="employee-forecast-page__employees-table-return-rate-cell"
                                                                data-bind="
                                                                    html: returnRate + ' ' + $root.getUnitsSuffixHtml(position.units()),
                                                                    attr: {rowspan: employee.workingIntervals().length}
                                                                ">
                                                            </td>
                                                            <td class="employee-forecast-page__employees-table-salary-bulk-cell"
                                                                data-bind="text: $root.formatDecimal($root.getEmployeeSalaryBulk(employee)()), attr: {rowspan: employee.workingIntervals().length}">
                                                            </td>
                                                            <!-- ko let: {editableCell: ko.observable(null)} -->
                                                                <td class="employee-forecast-page__employees-table-bonus-cell" data-bind="
                                                                    hrmTableEditableCell: editableCell,
                                                                    attr: {rowspan: employee.workingIntervals().length}
                                                                ">
                                                                    <input data-bind="
                                                                        textInput: employee.bonus,
                                                                        hrmMask, hrmMaskPattern: 'decimal',
                                                                        hrmMaskOptions: {digits: '0,2', groupSeparator: ' ', autoGroup: true, allowMinus: false, rightAlign: false},
                                                                        hrmTableEditableCellInputControl,
                                                                        hrmTableEditableCellInputControlOwner: editableCell
                                                                    " placeholder="0">
                                                                </td>
                                                            <!-- /ko -->
                                                            <!-- ko let: {editableCell: ko.observable(null)} -->
                                                                <td class="employee-forecast-page__employees-table-fine-cell" data-bind="
                                                                    hrmTableEditableCell: editableCell,
                                                                    attr: {rowspan: employee.workingIntervals().length}
                                                                ">
                                                                    <input data-bind="
                                                                        textInput: employee.fine,
                                                                        hrmMask, hrmMaskPattern: 'decimal',
                                                                        hrmMaskOptions: {digits: '0,2', groupSeparator: ' ', autoGroup: true, allowMinus: false, rightAlign: false},
                                                                        hrmTableEditableCellInputControl,
                                                                        hrmTableEditableCellInputControlOwner: editableCell
                                                                    " placeholder="0">
                                                                </td>
                                                            <!-- /ko -->
                                                            <td class="employee-forecast-page__employees-table-salary-cell"
                                                                data-bind="
                                                                    text: $root.formatDecimal($root.getEmployeeSalary(employee)()),
                                                                    attr: {rowspan: employee.workingIntervals().length}
                                                                ">
                                                            </td>
                                                        </tr>

                                                        <!-- ko foreach: {data: workingIntervals().slice(1), as: 'workingInterval'} -->
                                                            <tr class="employee-forecast-page__employees-table-employee-row"
                                                                data-bind="
                                                                    css: {
                                                                        'employee-forecast-page__employees-table-employee-row--multi-interval': employee.workingIntervals().length > 1
                                                                    }
                                                                "
                                                            >
                                                                <!-- ko let: {editableCell: ko.observable(null)} -->
                                                                    <td class="employee-forecast-page__employees-table-interval-cell"
                                                                        data-bind="
                                                                            hrmTableEditableCell: editableCell,
                                                                            hrmTableEditableCellError: $root.editableCellControlErrorExtractor(workingInterval.value),
                                                                        ">
                                                                        <div class="hrm-table__cell-content hrm-table__editable-cell-content">
                                                                            <input data-bind="
                                                                                textInput: workingInterval.value,
                                                                                hrmMask,
                                                                                hrmMaskPattern: '99:99 – 99:99',
                                                                                hrmTableEditableCellInputControl,
                                                                                hrmTableEditableCellInputControlOwner: editableCell
                                                                            " placeholder="00:00 - 00:00">
                                                                            <div class="employee-forecast-page__employees-table-interval-cell-actions">
                                                                                <button class="hrm-button hrm-icon-button hrm-times-icon-button
                                                                                               hrm-icon-button--theme_negative
                                                                                               employee-forecast-page__employees-table-interval-cell-remove-button"
                                                                                        data-bind="
                                                                                            click: function () {employee.workingIntervals.remove(workingInterval);},
                                                                                            attr: {title: 'Удалить интервал ' + workingInterval.value()}
                                                                                        ">
                                                                                </button>

                                                                                <div class="hrm-spacer"></div>

                                                                                <!-- ko if: employee.workingIntervals().length === workingIntervalIndex() + 2  -->
                                                                                    <button class="hrm-button hrm-icon-button hrm-plus-icon-button
                                                                                                   hrm-icon-button--theme_positive
                                                                                                   employee-forecast-page__employees-table-interval-cell-add-button"
                                                                                            title="Добавить рабочий интервал"
                                                                                            data-bind="click: function () {$root.addWorkingInterval(employee);}">
                                                                                    </button>
                                                                                <!-- /ko -->
                                                                            </div>
                                                                        </div>
                                                                    </td>
                                                                <!-- /ko -->
                                                            </tr>
                                                        <!-- /ko -->
                                                    <!-- /ko -->
                                                <!-- /ko -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                <!-- /ko -->

                                <!-- ko if: $root.viewportSize().width <= HRM_BREAKPOINTS.mobileMaxWidth -->
                                    <div class="employee-forecast-page__employees-table">
                                        <!-- ko foreach: {data: formModel().positions, as: 'position'} -->
                                            <!-- ko let: {isOpen: ko.observable(positionIndex() === 0)} -->
                                                <div class="employee-forecast-page__employees-table-position-section"
                                                     data-bind="css: {'employee-forecast-page__employees-table-position-section--open': isOpen() && employees().length > 0}">
                                                    <div class="employee-forecast-page__employees-table-position-section-header">
                                                        <button class="hrm-button hrm-circle-icon-button
                                                                       hrm-circle-icon-button--theme_neutral
                                                                       hrm-circle-arrow-down-icon-button
                                                                       employee-forecast-page__employees-table-position-section-header-toggle-button"
                                                                data-bind="click: function() {isOpen(!isOpen());}">
                                                        </button>

                                                        <span class="employee-forecast-page__employees-table-position-section-header-title"
                                                              data-bind="
                                                                text: name,
                                                                click: function() {isOpen(!isOpen());}
                                                              ">
                                                        </span>

                                                        <div class="hrm-spacer"></div>

                                                        <button class="hrm-button hrm-circle-icon-button hrm-circle-plus-icon-button
                                                                       hrm-circle-icon-button--theme_neutral employee-forecast-page__employees-table-position-section-header-add-button"
                                                                data-bind="click: function() {$root.addEmployee(position); isOpen(true);}" title="Добавить сотрудника">
                                                        </button>
                                                    </div>

                                                    <div class="employee-forecast-page__employees-table-position-section-body"
                                                         data-bind="hrmSlide, hrmSlideValue: isOpen() && employees().length > 0">
                                                        <div class="employee-forecast-page__employees-table-position-section-body-header">
                                                            <!-- ko let: {control: ko.observable(null), label: ko.observable(null)} -->
                                                                <div class="employee-forecast-page__employees-table-position-section-body-header-rate-form-field"
                                                                     data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
                                                                    <label data-bind="hrmFormFieldLabel: label">
                                                                        Оклад, <i class="far fa-ruble-sign"></i>/час
                                                                    </label>

                                                                    <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
                                                                        <input data-bind="
                                                                            textInput: position.rate,
                                                                            event: {
                                                                                input: function () {
                                                                                    $root.onRateInput(position);
                                                                                }
                                                                            },
                                                                            hrmFormFieldInputControl: control
                                                                        ">
                                                                    </div>
                                                                </div>
                                                            <!-- /ko -->

                                                            <span class="employee-forecast-page__employees-table-position-section-body-header-statistics">
                                                                ФОТ — <b>34%</b><br>норматив выраб. — <b>90%</b>
                                                            </span>
                                                        </div>

                                                        <!-- ko if: employees().length > 0 -->
                                                            <div class="hrm-table__fixed-section-container
                                                                        employee-forecast-page__employees-table-position-section-table-fixed-section-container">
                                                                <table class="hrm-table__fixed-section hrm-table__fixed-section--position_left
                                                                              employee-forecast-page__employees-table-position-section-table-fixed-section"
                                                                       data-bind="hrmTable">
                                                                    <thead>
                                                                    <tr>
                                                                        <th class="employee-forecast-page__employees-table-name-head-cell">
                                                                            Сотрудник
                                                                        </th>
                                                                    </tr>
                                                                    <tr>
                                                                        <th class="employee-forecast-page__employees-table-working-intervals-head-cell"
                                                                            data-bind="
                                                                                style: {height: $root.getPositionMaxWorkingIntervalCount(position)() * 40},
                                                                                css: {
                                                                                    'employee-forecast-page__employees-table-working-intervals-head-cell--single-line': $root.getPositionMaxWorkingIntervalCount(position)() === 1
                                                                                }
                                                                            ">
                                                                            <div class="hrm-table__head-cell-content">
                                                                                Начало/конец работы
                                                                                <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                                                   hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                                                        data-bind="hrmTooltip, hrmTooltipText: 'Начало/конец работы'">
                                                                                </button>
                                                                            </div>
                                                                        </th>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>
                                                                            <div class="hrm-table__head-cell-content">
                                                                                Рабочее время
                                                                                <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                                                   hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                                                        data-bind="hrmTooltip, hrmTooltipText: 'Рабочее время'">
                                                                                </button>
                                                                            </div>
                                                                        </th>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>
                                                                            <div class="hrm-table__head-cell-content">
                                                                                <span>Оклад, <i class="far fa-ruble-sign"></i>/час</span>
                                                                                <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                                                   hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                                                        data-bind="hrmTooltip, hrmTooltipText: 'Оклад, &lt;i class=&quot;far fa-ruble-sign&quot;&gt;&lt;/i&gt;/час'">
                                                                                </button>
                                                                            </div>
                                                                        </th>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>
                                                                            <div class="hrm-table__head-cell-content">
                                                                                Норматив выручки
                                                                                <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                                                   hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                                                        data-bind="hrmTooltip, hrmTooltipText: 'Норматив выручки'">
                                                                                </button>
                                                                            </div>
                                                                        </th>
                                                                    </tr>

                                                                    <tr>
                                                                        <th class="employee-forecast-page__employees-table-salary-bulk-head-cell">
                                                                            <div class="hrm-table__head-cell-content">
                                                                                <span>Основная часть зп, <i class="far fa-ruble-sign"></i></span>
                                                                                <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                                                   hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                                                        data-bind="hrmTooltip, hrmTooltipText: 'Основная часть зп, &lt;i class=&quot;far fa-ruble-sign&quot;&gt;&lt;/i&gt;'">
                                                                                </button>
                                                                            </div>
                                                                        </th>
                                                                    </tr>

                                                                    <tr>
                                                                        <th>
                                                                            <div class="hrm-table__head-cell-content">
                                                                                <span>Прем., <i class="far fa-ruble-sign"></i></span>
                                                                                <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                                                   hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                                                        data-bind="hrmTooltip, hrmTooltipText: 'Прем., &lt;i class=&quot;far fa-ruble-sign&quot;&gt;&lt;/i&gt;'">
                                                                                </button>
                                                                            </div>
                                                                        </th>
                                                                    </tr>

                                                                    <tr>
                                                                        <th>
                                                                            <div class="hrm-table__head-cell-content">
                                                                                <span>Депрем, <i class="far fa-ruble-sign"></i></span>
                                                                                <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                                                   hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                                                        data-bind="hrmTooltip, hrmTooltipText: 'Депрем, &lt;i class=&quot;far fa-ruble-sign&quot;&gt;&lt;/i&gt;'">
                                                                                </button>
                                                                            </div>
                                                                        </th>
                                                                    </tr>

                                                                    <tr>
                                                                        <th>
                                                                            <div class="hrm-table__head-cell-content">
                                                                                <span>К выплате, <i class="far fa-ruble-sign"></i></span>
                                                                                <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button
                                                                                   hrm-table__head-cell-info-button hrm-circle-icon-button--theme_neutral"
                                                                                        data-bind="hrmTooltip, hrmTooltipText: 'К выплате, &lt;i class=&quot;far fa-ruble-sign&quot;&gt;&lt;/i&gt;'">
                                                                                </button>
                                                                            </div>
                                                                        </th>
                                                                    </tr>

                                                                    <tr>
                                                                        <th>
                                                                            Удалить
                                                                        </th>
                                                                    </tr>
                                                                    </thead>
                                                                </table>

                                                                <div class="hrm-table__scrollable-wrapper">
                                                                    <table class="employee-forecast-page__employees-table-position-section-table"
                                                                           data-bind="hrmTable">
                                                                        <tbody>
                                                                            <tr>
                                                                                <!-- ko foreach: {
                                                                                    data: employees,
                                                                                    as: 'employee',
                                                                                    afterAdd: hrmFadeAfterAddFactory(200),
                                                                                    beforeRemove: hrmFadeBeforeRemoveFactory(200)
                                                                                } -->
                                                                                    <td class="employee-forecast-page__employees-table-employee-name-cell"
                                                                                        data-bind="text: name">
                                                                                    </td>
                                                                                <!-- /ko -->
                                                                            </tr>

                                                                            <!-- ko foreach: {data: _.range($root.getPositionMaxWorkingIntervalCount(position)()), as: 'workingIntervalIndex'} -->
                                                                                <tr>
                                                                                    <!-- ko foreach: {
                                                                                        data: position.employees,
                                                                                        as: 'employee',
                                                                                        afterAdd: hrmFadeAfterAddFactory(200),
                                                                                        beforeRemove: hrmFadeBeforeRemoveFactory(200)
                                                                                    } -->
                                                                                        <!-- ko if: workingIntervalIndex < workingIntervals().length -->
                                                                                            <!-- ko let: {
                                                                                                editableCell: ko.observable(null),
                                                                                                workingInterval: workingIntervals()[workingIntervalIndex]
                                                                                            } -->
                                                                                                <td class="employee-forecast-page__employees-table-interval-cell"
                                                                                                    data-bind="
                                                                                                        hrmTableEditableCell: editableCell,
                                                                                                        hrmTableEditableCellError: $root.editableCellControlErrorExtractor(workingInterval.value),
                                                                                                        css: {'employee-forecast-page__employees-table-interval-cell--single-line': $root.getPositionMaxWorkingIntervalCount(position)() === 1}
                                                                                                    ">
                                                                                                    <div class="hrm-table__cell-content hrm-table__editable-cell-content">
                                                                                                        <input data-bind="
                                                                                                            textInput: workingInterval.value,
                                                                                                            hrmMask,
                                                                                                            hrmMaskPattern: '99:99 – 99:99',
                                                                                                            hrmTableEditableCellInputControl,
                                                                                                            hrmTableEditableCellInputControlOwner: editableCell
                                                                                                        " placeholder="00:00 - 00:00">
                                                                                                        <div class="employee-forecast-page__employees-table-interval-cell-actions">
                                                                                                            <!-- ko if: employee.workingIntervals().length > 1 -->
                                                                                                                <button class="hrm-button hrm-icon-button hrm-times-icon-button
                                                                                                                               hrm-icon-button--theme_negative
                                                                                                                               employee-forecast-page__employees-table-interval-cell-remove-button"
                                                                                                                        data-bind="
                                                                                                                            click: function () {employee.workingIntervals.remove(workingInterval);},
                                                                                                                            attr: {title: 'Удалить интервал ' + workingInterval.value()}
                                                                                                                        ">
                                                                                                                </button>
                                                                                                            <!-- /ko -->

                                                                                                            <div class="hrm-spacer"></div>

                                                                                                            <!-- ko if: employee.workingIntervals().length === workingIntervalIndex + 1  -->
                                                                                                                <button class="hrm-button hrm-icon-button hrm-plus-icon-button
                                                                                                                               hrm-icon-button--theme_positive
                                                                                                                               employee-forecast-page__employees-table-interval-cell-add-button"
                                                                                                                        title="Добавить рабочий интервал"
                                                                                                                        data-bind="click: function () {$root.addWorkingInterval(employee);}">
                                                                                                                </button>
                                                                                                            <!-- /ko -->
                                                                                                        </div>
                                                                                                    </div>
                                                                                                </td>
                                                                                            <!-- /ko -->
                                                                                        <!-- /ko -->

                                                                                        <!-- ko if: workingIntervalIndex >= workingIntervals().length -->
                                                                                            <td class="employee-forecast-page__employees-table-interval-cell"></td>
                                                                                        <!-- /ko -->
                                                                                    <!-- /ko -->
                                                                                </tr>
                                                                            <!-- /ko -->

                                                                            <tr>
                                                                                <!-- ko foreach: {
                                                                                    data: employees,
                                                                                    as: 'employee',
                                                                                    afterAdd: hrmFadeAfterAddFactory(200),
                                                                                    beforeRemove: hrmFadeBeforeRemoveFactory(200)
                                                                                } -->
                                                                                    <td class="employee-forecast-page__employees-table-working-hours-cell"
                                                                                        data-bind="text: $root.formatDuration($root.getEmployeeWorkingHours(employee)())">
                                                                                    </td>
                                                                                <!-- /ko -->
                                                                            </tr>

                                                                            <tr>
                                                                                <!-- ko foreach: {
                                                                                    data: employees,
                                                                                    as: 'employee',
                                                                                    afterAdd: hrmFadeAfterAddFactory(200),
                                                                                    beforeRemove: hrmFadeBeforeRemoveFactory(200)
                                                                                } -->
                                                                                    <!-- ko let: {editableCell: ko.observable(null)} -->
                                                                                        <td class="employee-forecast-page__employees-table-rate-cell"
                                                                                            data-bind="hrmTableEditableCell: editableCell">
                                                                                            <input data-bind="
                                                                                                textInput: employee.rate,
                                                                                                event: {
                                                                                                    input: function () {
                                                                                                        $root.onEmployeeRateInput(position);
                                                                                                    }
                                                                                                },
                                                                                                hrmMask, hrmMaskPattern: 'decimal',
                                                                                                hrmMaskOptions: {digits: '0,2', groupSeparator: ' ', autoGroup: true, allowMinus: false, rightAlign: false},
                                                                                                hrmTableEditableCellInputControl,
                                                                                                hrmTableEditableCellInputControlOwner: editableCell
                                                                                            " placeholder="0">
                                                                                        </td>
                                                                                    <!-- /ko -->
                                                                                <!-- /ko -->
                                                                            </tr>

                                                                            <tr>
                                                                                <!-- ko foreach: {
                                                                                    data: employees,
                                                                                    as: 'employee',
                                                                                    afterAdd: hrmFadeAfterAddFactory(200),
                                                                                    beforeRemove: hrmFadeBeforeRemoveFactory(200)
                                                                                } -->
                                                                                    <td class="employee-forecast-page__employees-table-return-rate-cell"
                                                                                        data-bind="html: returnRate + ' ' + $root.getUnitsSuffixHtml(position.units())">
                                                                                    </td>
                                                                                <!-- /ko -->
                                                                            </tr>

                                                                            <tr>
                                                                                <!-- ko foreach: {
                                                                                    data: employees,
                                                                                    as: 'employee',
                                                                                    afterAdd: hrmFadeAfterAddFactory(200),
                                                                                    beforeRemove: hrmFadeBeforeRemoveFactory(200)
                                                                                } -->
                                                                                    <td class="employee-forecast-page__employees-table-salary-bulk-cell"
                                                                                        data-bind="text: $root.formatDecimal($root.getEmployeeSalaryBulk(employee)())">
                                                                                    </td>
                                                                                <!-- /ko -->
                                                                            </tr>

                                                                            <tr>
                                                                                <!-- ko foreach: {
                                                                                    data: employees,
                                                                                    as: 'employee',
                                                                                    afterAdd: hrmFadeAfterAddFactory(200),
                                                                                    beforeRemove: hrmFadeBeforeRemoveFactory(200)
                                                                                } -->
                                                                                    <!-- ko let: {editableCell: ko.observable(null)} -->
                                                                                        <td class="employee-forecast-page__employees-table-bonus-cell"
                                                                                            data-bind="hrmTableEditableCell: editableCell">
                                                                                            <input data-bind="
                                                                                                textInput: employee.bonus,
                                                                                                hrmMask, hrmMaskPattern: 'decimal',
                                                                                                hrmMaskOptions: {digits: '0,2', groupSeparator: ' ', autoGroup: true, allowMinus: false, rightAlign: false},
                                                                                                hrmTableEditableCellInputControl,
                                                                                                hrmTableEditableCellInputControlOwner: editableCell
                                                                                            " placeholder="0">
                                                                                        </td>
                                                                                    <!-- /ko -->
                                                                                <!-- /ko -->
                                                                            </tr>

                                                                            <tr>
                                                                                <!-- ko foreach: {
                                                                                    data: employees,
                                                                                    as: 'employee',
                                                                                    afterAdd: hrmFadeAfterAddFactory(200),
                                                                                    beforeRemove: hrmFadeBeforeRemoveFactory(200)
                                                                                } -->
                                                                                    <!-- ko let: {editableCell: ko.observable(null)} -->
                                                                                        <td class="employee-forecast-page__employees-table-fine-cell"
                                                                                            data-bind="hrmTableEditableCell: editableCell">
                                                                                            <input data-bind="
                                                                                                textInput: employee.fine,
                                                                                                hrmMask, hrmMaskPattern: 'decimal',
                                                                                                hrmMaskOptions: {digits: '0,2', groupSeparator: ' ', autoGroup: true, allowMinus: false, rightAlign: false},
                                                                                                hrmTableEditableCellInputControl,
                                                                                                hrmTableEditableCellInputControlOwner: editableCell
                                                                                            " placeholder="0">
                                                                                        </td>
                                                                                    <!-- /ko -->
                                                                                <!-- /ko -->
                                                                            </tr>

                                                                            <tr>
                                                                                <!-- ko foreach: {
                                                                                    data: employees,
                                                                                    as: 'employee',
                                                                                    afterAdd: hrmFadeAfterAddFactory(200),
                                                                                    beforeRemove: hrmFadeBeforeRemoveFactory(200)
                                                                                } -->
                                                                                    <td class="employee-forecast-page__employees-table-salary-cell"
                                                                                        data-bind="text: $root.formatDecimal($root.getEmployeeSalary(employee)())">
                                                                                    </td>
                                                                                <!-- /ko -->
                                                                            </tr>

                                                                            <tr>
                                                                                <!-- ko foreach: {
                                                                                    data: employees,
                                                                                    as: 'employee',
                                                                                    afterAdd: hrmFadeAfterAddFactory(200),
                                                                                    beforeRemove: hrmFadeBeforeRemoveFactory(200)
                                                                                } -->
                                                                                    <td class="employee-forecast-page__employees-table-remove-cell">
                                                                                        <button class="hrm-button hrm-circle-icon-button hrm-circle-times-icon-button
                                                                                                       hrm-circle-icon-button--theme_secondary"
                                                                                                data-bind="click: function() {position.employees.remove(employee);}" title="Удалить сотрудника">
                                                                                        </button>
                                                                                    </td>
                                                                                <!-- /ko -->
                                                                            </tr>
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            </div>
                                                        <!-- /ko -->
                                                    </div>
                                                </div>
                                            <!-- /ko -->
                                        <!-- /ko -->
                                    </div>
                                <!-- /ko -->

                                <div class="employee-forecast-page__form-employees-section-additional-actions-list">
                                    <button class="hrm-button hrm-button-with-icon hrm-button-with-icon--theme_positive
                                                   hrm-button-with-excel-icon employee-forecast-page__form-employees-section-additional-actions-list-item">
                                        Выгрузить в excel
                                    </button>

                                    <button class="hrm-button hrm-button-with-icon hrm-button-with-icon--theme_secondary
                                                   hrm-button-with-printer-icon employee-forecast-page__form-employees-section-additional-actions-list-item">
                                        Распечатать
                                    </button>
                                </div>
                            <!-- /ko -->
                        </div>
                    <!-- /ko -->
                </div>
            </div>
            <div class="hrm-scaffold__footer employee-forecast-page__footer">
                <span class="employee-forecast-page__footer-text" data-bind="html: footerTextHtml"></span>

                <button class="hrm-button hrm-basic-button hrm-primary-button employee-forecast-page__footer-login-button">
                    <span class="hrm-primary-button__content">Войти/зарегистрироваться</span>
                    <span class="hrm-primary-button__background hrm-primary-button__hover-background"></span>
                    <span class="hrm-primary-button__background hrm-primary-button__active-background"></span>
                </button>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-debug.js" integrity="sha256-M5ZomNNnrnEB2WjSbnty5GWGqq6UuAAVNnWECisgEis=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/knockout.validation@2.0.4/dist/knockout.validation.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.12/js/select2.full.min.js" integrity="sha256-vucLmrjdfi9YwjGY/3CQ7HnccFSS/XRS1M/3k/FDXJw=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.10/js/i18n/ru.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/simplebar/5.1.0/simplebar.min.js" integrity="sha256-hFddD6XMIwFba4ITQjpv5WWE557w6O0w9RRfmGjIz4k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/overlayscrollbars/1.10.2/js/OverlayScrollbars.min.js" integrity="sha256-5Tj3ZUgjHEGwF7TxpOgbPpjhq+WxXvpfb+qr9OxRHtY=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/overlayscrollbars/1.10.2/js/jquery.overlayScrollbars.min.js" integrity="sha256-RE+oy7ofA6XerySMpTlDcg0gFUwHN3n0qQ5fUIZVq/M=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/gh/RobinHerbots/jquery.inputmask@4.0.9/dist/jquery.inputmask.bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment-with-locales.min.js" integrity="sha256-AdQN98MVZs44Eq2yTwtoKufhnU+uZ7v2kXnD5vqzZVo=" crossorigin="anonymous"></script>
<script src="https://unpkg.com/popper.js@1"></script>
<script src="https://unpkg.com/tippy.js@5"></script>
<script src="https://unpkg.com/sticky-events@3.1.1/dist/sticky-events.umd.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min.js" integrity="sha256-VeNaFBVDhoX3H+gJ37DpT/nTuZTdjYro9yBruHjVmoQ=" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>

<script src="assets/js/main.js"></script>

    <script type="text/javascript">
    $(function () {
        const $page = $(document.documentElement);

        const ViewModel = function (positions) {
            this.subscriptions = [];

            this.windowResizeHandler = () => {
                this.viewportSize({width: $(window).width(), height: $(window).height()});
            };
            this.viewportSize = ko.observable({width: $(window).width(), height: $(window).height()});

            this.childrenComplete = function () {
                $page.removeClass('hrm-page--initializing');
            };

            this.date = ko.observable(moment().format('DD.MM.YYYY, dddd')).extend({
                required: {
                    message: 'Обязательное поле'
                },
                hrmDate: {
                    params: 'DD.MM.YYYY, dddd',
                    message: 'Неверный формат даты'
                }
            });

            this.isBuilt = ko.observable(false);

            this.isEmployeesCalculated = ko.observable(false);

            this.createPositionFormModel = function (data) {
                return {
                    ...data,
                    units: ko.observable(data.units.toString()),
                    workload: ko.observable(data.workload),
                    employees: ko.observableArray(data.employees.map(e => this.createPositionEmployeeFormModel(e))),
                    rate: ko.observable('')
                };
            };

            this.createPositionEmployeeFormModel = function (data) {
                const workingIntervals = ko.observableArray(data.workingIntervals.map(v => this.createPositionEmployeeWorkingIntervalFormModel(v)));

                return {
                    ...data,
                    workingIntervals,
                    rate: ko.observable(data.rate),
                    returnRate: data.returnRate,
                    salaryBulk: ko.observable(data.salaryBulk),
                    bonus: ko.observable(data.bonus),
                    fine: ko.observable(data.fine),
                    workingIntervalsValidationObject: ko.observable().extend({
                        validation: {
                            validator: () => {
                                return workingIntervals().every(i => i.value.isValid());
                            }
                        }
                    })
                };
            };

            this.createPositionEmployeeWorkingIntervalFormModel = function (value) {
                return {
                    value: ko.observable(value).extend({
                        required: {
                            message: 'Обязательное поле'
                        },
                        validation: {
                            validator: value => {
                                if (!/^\d\d:\d\d – \d\d:\d\d$/.test(value)) {
                                    return false;
                                } else {
                                    const boundaries = value.split(' – ');

                                    if (boundaries[0] === boundaries[1]) {
                                        return false;
                                    }

                                    return boundaries.every(b => moment(b, 'HH:mm', true).isValid());
                                }
                            },
                            message: 'Неверный формат интервала'
                        }
                    })
                };
            };

            this.formModel = ko.validatedObservable({
                positions: ko.observable(positions.map(p => this.createPositionFormModel(p)))
            });

            this.buildForecast = function () {
                this.isBuilt(true);
            };

            this.calculateEmployees = function () {
                this.isEmployeesCalculated(true);
            };

            this.recalculateEmployees = function () {
                this.isEmployeesCalculated(false);

                this.formModel().positions().forEach((position, index) => {
                    position.employees(positions[index].employees.map(e => this.createPositionEmployeeFormModel(e)));
                });

                this.isEmployeesCalculated(true);
            };

            this.formControlErrorStateMatcher = function (formControl) {
                return ko.pureComputed(() => {
                    return !formControl.isValid();
                });
            };

            this.addWorkingInterval = function (employee) {
                employee.workingIntervals.push(this.createPositionEmployeeWorkingIntervalFormModel(''));
            };

            this.addEmployee = function (position) {
                const index = Math.floor(Math.random() * 1000);

                position.employees.push(this.createPositionEmployeeFormModel({
                    name: position.name + ' #' + index,
                    workingIntervals: [''],
                    rate: position.rate() !== '' ? position.rate() : 600,
                    returnRate: 30,
                    salaryBulk: 7200,
                    bonus: 100,
                    fine: 20
                }));
            };

            this.onRateInput = function (position) {
                position.employees().forEach(employee => {
                    employee.rate(position.rate());
                });
            };

            this.onEmployeeRateInput = function (position) {
                position.rate('');
            };

            this.footerTextHtml = ko.pureComputed(() => {
               if (this.viewportSize().width <= HRM_BREAKPOINTS.mobileMaxWidth) {
                   return 'Авторизация позволит <b>настраивать<br> должности</b> и <b>сохранять параметры</b> таблиц для следующих расчетов';
               } else {
                   return 'Авторизация позволит <b>настраивать должности</b><br> и <b>сохранять параметры</b> таблиц для следующих расчетов';
               }
            });

            this.getWorkloadTypeName = function (workloadType) {
                switch (workloadType) {
                    case 1: return 'Объём товара по всему предприятию';
                    case 2: return 'Объём товара по категориям';
                }
            };

            this.getEmployeeWorkingHours = function (employee) {
                return ko.pureComputed(() => {
                    if (employee.workingIntervalsValidationObject.isValid()) {
                        return employee.workingIntervals().reduce((minutes, interval) => {
                            const boundaries = interval.value().split(' – ').map(b => moment(b, 'HH:mm'));

                            if (boundaries[0].isAfter(boundaries[1])) {
                                boundaries[1].add(1, 'd');
                            }

                            return minutes + boundaries[1].diff(boundaries[0], 'minutes');
                        }, 0);
                    } else {
                        return 0;
                    }
                });
            };

            this.getEmployeeSalaryBulk = function (employee) {
                return ko.pureComputed(() => {
                    const minutes = this.getEmployeeWorkingHours(employee)();

                    return this.unmaskDecimal(employee.rate()) * (minutes / 60);
                });
            };

            this.getEmployeeSalary = function (employee) {
                return ko.pureComputed(() => {
                    const bulk = this.getEmployeeSalaryBulk(employee)();
                    const bonus = this.unmaskDecimal(employee.bonus());
                    const fine = this.unmaskDecimal(employee.fine());

                    return this.unmaskDecimal(bulk + bonus - fine);
                });
            };

            this.getPositionMaxWorkingIntervalCount = function (position) {
                return ko.pureComputed(() => {
                    return Math.max(...position.employees().map(e => e.workingIntervals().length));
                });
            };

            this.getCategoriesTooltipText = function (categories) {
                return categories.map(c => c.name).join(', ');
            };

            this.getUnitsSuffixHtml = function (units) {
                switch (units) {
                    case '1': return 'шт.';
                    case '2': return '<i class="far fa-ruble-sign"></i>';
                    case '3': return 'ч.';
                }
            };

            this.formatDecimal = function (value) {
                return Inputmask.format(value, {alias: 'decimal', digits: '2', groupSeparator: ' ', autoGroup: true, allowMinus: false}).replace('.00', '');
            };

            this.unmaskDecimal = function (value) {
                const result = Inputmask.unmask(value, {alias: 'decimal', digits: '2', groupSeparator: ' ', autoGroup: true, allowMinus: false, unmaskAsNumber: true});

                if (result === '') {
                    return 0;
                }

                return result;
            };

            this.editableCellControlErrorExtractor = function (control) {
                return ko.pureComputed(() => {
                    return !control.isValid() ? {message: control.error()} : null;
                });
            };

            this.formatDuration = function (minutes) {
                let h = Math.floor(minutes / 60).toString();
                h = h.length === 1 ? '0' + h : h;
                let m = (minutes % 60).toString();
                m = m.length === 1 ? '0' + m : m;

                return h + ':' + m;
            };

            (() => {
                $(window).on('resize', this.windowResizeHandler);
            })();
        };

        const viewModel = new ViewModel([
            {
                name: 'Повар-пицмейкер',
                workloadType: 1,
                categories: null,
                units: 1,
                workload: 90,
                employees: [
                    {
                        name: 'Повар-пицмейкер #1',
                        workingIntervals: ['11:00 – 23:00', '00:00 – 05:00'],
                        rate: 600,
                        returnRate: 30,
                        salaryBulk: 7200,
                        bonus: 100,
                        fine: 20
                    }
                ],
                estimatedHours: 36
            },
            {
                name: 'Повар-сушист',
                workloadType: 2,
                categories: [
                    {name: 'Роллы открытые'},
                    {name: 'Роллы закрытые'},
                    {name: 'Гунканы'},
                    {name: 'Суши'},
                    {name: 'Сашими'}
                ],
                units: 2,
                workload: 10000,
                employees: [
                    {
                        name: 'Повар-сушист #1',
                        workingIntervals: ['11:00 – 23:00'],
                        rate: 600,
                        returnRate: 10000,
                        salaryBulk: 7200,
                        bonus: 100,
                        fine: 20
                    },
                    {
                        name: 'Повар-сушист #2',
                        workingIntervals: ['11:00 – 23:00'],
                        rate: 600,
                        returnRate: 10000,
                        salaryBulk: 7200,
                        bonus: 100,
                        fine: 20
                    },
                    {
                        name: 'Повар-сушист #3',
                        workingIntervals: ['11:00 – 23:00'],
                        rate: 600,
                        returnRate: 10000,
                        salaryBulk: 7200,
                        bonus: 100,
                        fine: 20
                    }
                ],
                estimatedHours: 36
            },
            {
                name: 'Мороженщик',
                workloadType: 1,
                categories: null,
                units: 3,
                workload: 2.2,
                employees: [
                    {
                        name: 'Мороженщик #1',
                        workingIntervals: ['11:00 – 23:00'],
                        rate: 600,
                        returnRate: 10000,
                        salaryBulk: 7200,
                        bonus: 100,
                        fine: 20
                    },
                    {
                        name: 'Мороженщик #2',
                        workingIntervals: ['11:00 – 23:00'],
                        rate: 600,
                        returnRate: 10000,
                        salaryBulk: 7200,
                        bonus: 100,
                        fine: 20
                    }
                ],
                estimatedHours: 36
            }
        ]);

        ViewModel.prototype.dispose = function() {
            $(window).off('resize', this.windowResizeHandler);
            this.subscriptions.forEach(s => s.dispose());
        };

        ko.applyBindings(
            viewModel,
            $page.get()[0]
        );
    });
</script>
</body>
</html>
