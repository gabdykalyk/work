<!DOCTYPE html>
<html class="hrm-page calculation-page hrm-page--initializing" data-bind="childrenComplete: childrenComplete" lang="ru">

<head>
  <title>Sakura</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="HandheldFriendly" content="true" />
<meta content="IE=edge" http-equiv="X-UA-Compatible" />
<link href="https://fonts.googleapis.com/css?family=Fira+Sans:100,200,300,400,500,600,700,800,900&display=swap&subset=cyrillic" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2@4.0.12/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/overlayscrollbars/1.10.2/css/OverlayScrollbars.min.css" integrity="sha256-zUBmWpj0DsZzFautKgMOtiOkT6ECQ+a6RitMns7+HRM=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://unpkg.com/tippy.js@5/dist/backdrop.css" />
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
<link rel="stylesheet" href="assets/fonts/fontawesome/css/all.css" />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.css" integrity="sha256-vZ3SaLOjnKO/gGvcUWegySoDU6ff33CS5i9ot8J9Czk=" crossorigin="anonymous" />

<link rel="stylesheet" href="assets/css/main.css" />

</head>

<body>
  <div style="display: none">
  <svg>
    <symbol id="excel-icon">
      <path
        d="M8.47538 3.125H10.5823L8.05679 6.85381L10.9062 11H8.71957L6.98437 8.43767L5.24813 11H3.0625L5.91196 6.85381L3.38642 3.125H5.49336L6.98437 5.29456L8.47538 3.125Z"
        fill="#12C971" />
      <path d="M1 13V1H13V13H1Z" stroke="#12C971" fill="none" stroke-width="2" />
    </symbol>
    <symbol id="print-icon">
      <path d="M4 5V1H10.0625V5" stroke="#8E9CBB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        fill="none" />
      <path
        d="M3.4 11H2.2C1.88174 11 1.57652 10.8595 1.35147 10.6095C1.12643 10.3594 1 10.0203 1 9.66667V6.33333C1 5.97971 1.12643 5.64057 1.35147 5.39052C1.57652 5.14048 1.88174 5 2.2 5H11.8C12.1183 5 12.4235 5.14048 12.6485 5.39052C12.8736 5.64057 13 5.97971 13 6.33333V9.66667C13 10.0203 12.8736 10.3594 12.6485 10.6095C12.4235 10.8595 12.1183 11 11.8 11H10.6"
        stroke="#8E9CBB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
      <path d="M10 9H4V13H10V9Z" stroke="#8E9CBB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        fill="none" />
    </symbol>
    <symbol id="picture-icon">
      <path
        d="M11.6667 1H2.33333C1.59695 1 1 1.59695 1 2.33333V11.6667C1 12.403 1.59695 13 2.33333 13H11.6667C12.403 13 13 12.403 13 11.6667V2.33333C13 1.59695 12.403 1 11.6667 1Z"
        stroke="#8E9CBB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
      <path
        d="M5.5 6C6.32843 6 7 5.32843 7 4.5C7 3.67157 6.32843 3 5.5 3C4.67157 3 4 3.67157 4 4.5C4 5.32843 4.67157 6 5.5 6Z"
        fill="#8E9CBB" />
      <path d="M13 9.18182L10.1875 6L4 13" stroke="#8E9CBB" stroke-width="2" stroke-linejoin="round" fill="none" />
      <path d="M6 9.81818L4.4375 8L1 12" stroke="#8E9CBB" stroke-width="2" stroke-linejoin="round" fill="none" />
    </symbol>
    <symbol id="calculation-icon">
      <path
        d="M4 5H10M4 8H6M4 11H6M8 8H10M8 11H10M3 15H11C12.1046 15 13 14.1046 13 13V3C13 1.89543 12.1046 1 11 1H3C1.89543 1 1 1.89543 1 3V13C1 14.1046 1.89543 15 3 15Z"
        stroke="#8E9CBB" stroke-width="2" fill="none" />
    </symbol>

  </svg>
</div>
  <div class="hrm-scaffold">
    <div class="hrm-scaffold__sidebar"
      data-bind="component: {name: 'hrm-main-sidebar', params: {collapsed: isSidebarCollapsed}}"></div>
    <div class="hrm-scaffold__body">
      <!-- Page content  -->
      <div class="hrm-scaffold__content calculation-page__content">

        <div class="calculation-page__header">
          <span class="calculation-page__title">
            <!-- ko text: isNew() ? 'Новый расчет' : 'Сохраненный расчет' -->
            <!-- /ko -->
          </span>
          <div class="calculation-page__actions">
            <!-- ko ifnot: isNew -->

            <!-- ko if: $root.utils.viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
            <button
              class="hrm-button hrm-button-with-icon-right hrm-button-with-arrow-down-icon-right hrm-button-with-icon--theme_secondary calculation-tab__settings-button calculation-tab__settings-employees"
              data-bind="hrmDropdownMenu, hrmDropdownMenuTemplate: 'versions-dropdown-template'">
              <!-- ko if: currentVersion -->
              <!-- ko text: currentVersion().time -->
              <!-- /ko -->
              <!-- /ko -->
            </button>

            <button
              class="hrm-button hrm-button-with-icon-right hrm-button-with-arrow-down-icon-right hrm-button-with-icon--theme_secondary calculation-tab__settings-button calculation-tab__settings-employees"
              data-bind="hrmDropdownMenu, hrmDropdownMenuTemplate: 'actions-dropdown-template'">
              Действия
            </button>
            <!-- /ko -->

            <button class="hrm-button hrm-circle-icon-button hrm-circle-bookmark-icon-button" data-bind="hrmTooltip,
              hrmTooltipText: inBookmarks()
                ? 'Удалить раздел из избранного'
                : 'Добавить в избранное',
              click: function() {
                if (inBookmarks()) removeFromBookmarks();
                else addToBookmarks();
              },
              css: {
                'active': inBookmarks
              }">
            </button>
            <!-- /ko -->

            <a href="#"
              class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_tablet hrm-button-with-icon--theme_secondary hrm-button-with-arrow-left-icon">
              К списку расчетов
            </a>

          </div>
        </div>

        <!-- ko if: !isNew() && $root.utils.viewportSize().width <= HRM_BREAKPOINTS.mobileMaxWidth -->
        <div class="calculation-page__actions">
          <button
            class="hrm-button hrm-button-with-icon-right hrm-button-with-arrow-down-icon-right hrm-button-with-icon--theme_secondary calculation-tab__settings-button calculation-tab__settings-employees"
            data-bind="hrmDropdownMenu, hrmDropdownMenuTemplate: 'versions-dropdown-template'">
            <!-- ko if: currentVersion -->
            <!-- ko text: currentVersion.time() -->
            <!-- /ko -->
            <!-- /ko -->
          </button>

          <button
            class="hrm-button hrm-button-with-icon-right hrm-button-with-arrow-down-icon-right hrm-button-with-icon--theme_secondary calculation-tab__settings-button calculation-tab__settings-employees"
            data-bind="hrmDropdownMenu, hrmDropdownMenuTemplate: 'actions-dropdown-template'">
            Действия
          </button>
        </div>
        <!-- /ko -->

        <div class="calculation-form">
          <!-- Input table -->
          <div
            data-bind="component: {name: 'calculation-page-input-form', params: { model: $root.inputModel, onSubmit: $root.buildCalculation.bind($root) }}">
          </div>
          <!-- /Input table -->

          <!-- ko template: {
            foreach: hrmTemplateIf(loading(), $data),
            afterAdd: hrmFadeAfterAddFactory(200, 200),
          } -->
          <div class="loader-block">
            <i class="fa fa-spinner fa-pulse loader-block__indicator">
            </i>
            <span class="loader-block__text">Производится расчет</span>
          </div>
          <!-- /ko -->

          <!-- ko template: {
            foreach: hrmTemplateIf(!loading() && isBuilt(), $data),
            afterAdd: afterRenderBuild,
            beforeRemove: hrmFadeBeforeRemoveFactory(200)
          } -->
          <div class="calculation-form__content">
            <!-- Summary table -->
            <div data-bind="component: {name: 'calculation-page-summary-table', params: { model: $root.summaryModel }}">
            </div>
            <!-- /Summary table -->

            <!-- Tabs -->
            <div class="calculation-page__tabs"
              data-bind="component: {name: 'hrm-tab-group', params: {items: tabs.tabs, activeItem: tabs.activeTab }}">
            </div>



            <!-- ko template: {
                foreach: hrmTemplateIf(tabs.activeTab() === 0, $data),
                afterAdd: tabs.afterOpen,
                beforeRemove: hrmFadeBeforeRemoveFactory(200),
              } -->
            <div class="calculation-page__tab">
              <!-- ko let: {tabName: 'production'} -->
<div data-bind="component: {name: 'calculation-page-positions-table', params: { tabName: 'production', positions: $root.productionPositions, utils: $root.utils, total: $root.summaryModel.productionTotal, model: $root.summaryModel }}"></div>
<!-- /ko -->

            </div>
            <!-- /ko -->

            <!-- ko template: {
                foreach: hrmTemplateIf(tabs.activeTab() === 1, $data),
                afterAdd: tabs.afterOpen,
                beforeRemove: hrmFadeBeforeRemoveFactory(200)
              } -->
            <div class="calculation-page__tab">
              <div data-bind="component: {name: 'calculation-page-delivery-table', params: { tabName: 'delivery', position: $root.summaryModel.driversData, utils: $root.utils, total: $root.summaryModel.deliveryTotal, model: $root.summaryModel }}"></div>

            </div>
            <!-- /ko -->

            <!-- ko template: {
                foreach: hrmTemplateIf(tabs.activeTab() === 2, $data),
                afterAdd: hrmFadeAfterAddFactory(200, 200),
                beforeRemove: hrmFadeBeforeRemoveFactory(200)
              } -->
            <div class="calculation-page__tab">
              <div class="lateness-tab"
     data-bind="let: { table: latenessModel }">

  <div class="lateness-filters">

    <!-- ko let: {control: ko.observable(null)} -->
    <div class="lateness-filter__positions" data-bind="hrmFormField, hrmFormFieldControlRef: control">

      <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
        <select data-bind="
               selectedOptions: table.filters.positions,
               hrmSelect,
               hrmSelectPlaceholder: 'Должности',
               hrmFormFieldSelectControl: control" multiple>
          <option></option>
          <option value="operator">Оператор</option>
          <option value="administrator">Администратор филиала</option>
          <option value="sushi-master">Повар-сушист</option>
          <option value="pizza-master">Повар-пиццемейкер</option>
          <option value="hot-shop">Горячий цех</option>
          <option value="driver">Водитель</option>
        </select>
      </div>
    </div>
    <!-- /ko -->

    <!-- ko let: {control: ko.observable(null)} -->
    <div class="lateness-filter__lateness"
         data-bind="hrmFormField, hrmFormFieldControlRef: control">

      <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
        <select data-bind="
               value: table.filters.lateness,
               hrmSelect, hrmSelectAllowClear: true,
               hrmFormFieldSelectControl: control,
               hrmSelectPlaceholder: 'Степень опоздания'">
          <option></option>
          <option value="1">Меньше 5 минут</option>
          <option value="2">5-10 минут</option>
          <option value="3">Больше 10 минут</option>
        </select>
      </div>

    </div>
    <!-- /ko -->

  </div>

  <template id="lateness-position-template">
  <table class="lateness-table-position" data-bind="hrmTable, let: { intervals: table.intervals, latenessDegree: table.filters.lateness }">
    <thead>
      <tr>
        <th data-bind="attr: {colspan: position.paramsCount + (latenessDegree() ? 1 : 4) }">
          <div data-bind="text: position.name"></div>
        </th>
      </tr>
      <tr>
        <th class="lateness-table__position-param">
          <div>КОРФ</div>
        </th>
        <th>
          <div>Нагрузка</div>
        </th>
        <th class="lateness-table__position-param">
          <div>Сотр.</div>
        </th>
        <!-- ko foreach: position.params -->
        <th class="lateness-table__position-param">
          <div data-bind="text: $data.name"></div>
        </th>
        <!-- /ko -->
        <!-- ko if: !latenessDegree() || latenessDegree() == 1 -->
        <th class="lateness-table__position-param lateness-table__lateness-degree">
          <div>&lt;5</div>
        </th>
        <!-- /ko -->
        <!-- ko if: !latenessDegree() || latenessDegree() == 2 -->
        <th class="lateness-table__position-param lateness-table__lateness-degree">
          <div>5-10</div>
        </th>
        <!-- /ko -->
        <!-- ko if: !latenessDegree() || latenessDegree() == 3 -->
        <th class="lateness-table__position-param lateness-table__lateness-degree">
          <div>&gt;10</div>
        </th>
        <!-- /ko -->
        <!-- ko if: !latenessDegree() -->
        <th class="lateness-table__position-param">
          <div>Всего</div>
        </th>
        <!-- /ko -->
      </tr>
    </thead>
    <tbody>
      <!-- ko foreach: { data: intervals, as: 'interval' } -->
      <tr data-bind="let: {
        latenessInterval: position.lateness.intervals()[intervalIndex()],
        i: intervalIndex()
      }">
        <td align="right">
          <div data-bind="text: position.korf.intervals()[i]"></div>
        </td>
        <td align="right" data-bind="style: {
          'background-color': position.getWorkloadColor(i)
        }">
          <div data-bind="text: position.workload.intervals()[i]"></div>
        </td>
        <td align="right">
          <div data-bind="text: position.employees.intervals()[i]"></div>
        </td>

        <!-- ko foreach: { data: position.params, as: 'param' } -->
        <!-- ko let: { paramModel: position[param.id] } -->
        <td align="right">
          <div data-bind="text: paramModel.intervals()[i]"></div>
        </td>
        <!-- /ko -->
        <!-- /ko -->

        <!-- ko if: !latenessDegree() || latenessDegree() == 1 -->
        <td align="center" data-bind="style: {
          'background-color': latenessInterval.light > 0 ? '#B8EFD5' : ''
        }">
          <div data-bind="text: latenessInterval.light || ''"></div>
        </td>
        <!-- /ko -->

        <!-- ko if: !latenessDegree() || latenessDegree() == 2 -->
        <td align="center" data-bind="style: {
          'background-color': latenessInterval.medium > 0 ? '#FDFFB3' : ''
        }">
          <div data-bind="text: latenessInterval.medium || ''"></div>
        </td>
        <!-- /ko -->

        <!-- ko if: !latenessDegree() || latenessDegree() == 3 -->
        <td  align="center" data-bind="style: {
          'background-color': latenessInterval.hard > 0 ? '#FFE6F2' : ''
        }">
          <div data-bind="text: latenessInterval.hard || ''"></div>
        </td>
        <!-- /ko -->

        <!-- ko if: !latenessDegree() -->
        <td  align="center" data-bind="style: {
          'background-color': position.lateness.intervalsTotal()[i] ? '' : ''
        }">
          <div data-bind="text: position.lateness.intervalsTotal()[i] || ''"></div>
        </td>
        <!-- /ko -->

      </tr>
      <!-- /ko -->

      <tr data-bind="let: {latenessTotal: position.lateness.total()}">
        <td align="right" class="lateness-table__highlighted">
          <div data-bind="text: position.korf.total"></div>
        </td>
        <td align="right" class="lateness-table__highlighted">
          <div data-bind="text: position.workload.total"></div>
        </td>
        <td align="right" class="lateness-table__highlighted">
          <div data-bind="text: position.employees.total"></div>
        </td>
        <!-- ko foreach: { data: position.params, as: 'param' } -->
        <!-- ko let: { paramModel: position[param.id] } -->
        <td align="right" class="lateness-table__highlighted">
          <div data-bind="text: paramModel.total"></div>
        </td>
        <!-- /ko -->
        <!-- /ko -->

        <!-- ko if: !latenessDegree() || latenessDegree() == 1 -->
        <td align="center">
          <div data-bind="text: latenessTotal.light || ''"></div>
        </td>
        <!-- /ko -->
        <!-- ko if: !latenessDegree() || latenessDegree() == 2 -->
        <td align="center">
          <div data-bind="text: latenessTotal.medium || ''"></div>
        </td>
        <!-- /ko -->
        <!-- ko if: !latenessDegree() || latenessDegree() == 3 -->
        <td align="center">
          <div data-bind="text: latenessTotal.hard || ''"></div>
        </td>
        <!-- /ko -->
        <!-- ko if: !latenessDegree() -->
        <td align="center">
          <div data-bind="text: latenessTotal.total || ''"></div>
        </td>
        <!-- /ko -->
      </tr>
    </tbody>
  </table>
</template>

<template id="lateness-total-template">
  <table class="lateness-table-total" data-bind="hrmTable, let: { intervals: table.intervals, latenessDegree: table.filters.lateness }">
    <thead>
      <tr>
        <th data-bind="attr: {colspan: latenessDegree() ? 1 : 4 }">
          <div>Итого</div>
        </th>
      </tr>
      <tr>
        <!-- ko if: !latenessDegree() || latenessDegree() == 1 -->
        <th align="center" class="lateness-table__position-param lateness-table__lateness-degree">
          <div>&lt;5</div>
        </th>
        <!-- /ko -->
        <!-- ko if: !latenessDegree() || latenessDegree() == 2 -->
        <th align="center" class="lateness-table__position-param lateness-table__lateness-degree">
          <div>5-10</div>
        </th>
        <!-- /ko -->
        <!-- ko if: !latenessDegree() || latenessDegree() == 3 -->
        <th align="center" class="lateness-table__position-param lateness-table__lateness-degree">
          <div>&gt;10</div>
        </th>
        <!-- /ko -->
        <!-- ko if: !latenessDegree() -->
        <th align="center" class="lateness-table__position-param">
          <div>Всего</div>
        </th>
        <!-- /ko -->
      </tr>
    </thead>
    <tbody data-bind="let: { total: table.total() }" data-bind="descendantsComplete: function() {
      console.log('descendants1');
    }, childrenComplete: function() {
      console.log('children1');
    }">
      <!-- ko foreach: { data: intervals, as: 'interval' } -->
      <tr data-bind="let: {latenessInterval: total.intervals[intervalIndex()]}">
        <!-- ko if: !latenessDegree() || latenessDegree() == 1 -->
        <th align="center" data-bind="style: {
          'background-color': latenessInterval.light > 0 ? '#B8EFD5' : ''
        }">
          <div data-bind="text: latenessInterval.light"></div>
        </th>
        <!-- /ko -->
        <!-- ko if: !latenessDegree() || latenessDegree() == 2 -->
        <th align="center" data-bind="style: {
          'background-color': latenessInterval.medium > 0 ? '#FDFFB3' : ''
        }">
          <div data-bind="text: latenessInterval.medium"></div>
        </th>
        <!-- /ko -->
        <!-- ko if: !latenessDegree() || latenessDegree() == 3 -->
        <th align="center" data-bind="style: {
          'background-color': latenessInterval.hard > 0 ? '#FFE6F2' : ''
        }">
          <div data-bind="text: latenessInterval.hard"></div>
        </th>
        <!-- /ko -->
        <!-- ko if: !latenessDegree() -->
        <th align="center">
          <div data-bind="text: latenessInterval.total"></div>
        </th>
        <!-- /ko -->
      </tr>
      <!-- /ko -->

      <tr data-bind="let: { latenessTotal: table.total().total }">
        <!-- ko if: !latenessDegree() || latenessDegree() == 1 -->
        <th>
          <div data-bind="text: latenessTotal.light"></div>
        </th>
        <!-- /ko -->
        <!-- ko if: !latenessDegree() || latenessDegree() == 2 -->
        <th>
          <div data-bind="text: latenessTotal.medium"></div>
        </th>
        <!-- /ko -->
        <!-- ko if: !latenessDegree() || latenessDegree() == 3 -->
        <th>
          <div data-bind="text: latenessTotal.hard"></div>
        </th>
        <!-- /ko -->
        <!-- ko if: !latenessDegree() -->
        <th>
          <div data-bind="text: latenessTotal.total"></div>
        </th>
        <!-- /ko -->
      </tr>
    </tbody>
  </table>
</template>

<div class="lateness-table" data-bind="using: latenessModel">
  <!-- ko template: {
    foreach: hrmTemplateIf(!loaded(), $data),
    afterAdd: hrmFadeAfterAddFactory(200, 200),
    beforeRemove: hrmFadeBeforeRemoveFactory(200)
  } -->
  <div class="loader">
    <i class="fa fa-spinner fa-pulse loader__indicator">
    </i>
  </div>
  <!-- /ko -->

  <!-- ko template: {
      foreach: hrmTemplateIf(loaded(), $data),
      afterAdd: hrmFadeAfterAddFactory(200)
    } -->

  <div data-bind="component: {
  name: 'hrm-scrollable-wrapper',
  params: { options: {left: {disabled: true}} }
}">

    <table class="lateness-table__positions"
    data-bind="descendantsComplete: function() {
      console.log('descendants');
    }, childrenComplete: function() {
      console.log('children');
    }">

      <tbody>
        <tr>
          <td class="lateness-table__container-cell lateness-table__fixed">

            <table class="lateness-table__intervals" data-bind="hrmTable">
              <thead>
                <tr>
                  <th height="80">
                    <div>Всего</div>
                  </th>
                </tr>
              </thead>
              <tbody>
                <!-- ko foreach: table.intervals -->
                <tr>
                  <td>
                    <div data-bind="text: table.getIntervalString($data)"></div>
                  </td>
                </tr>
                <!-- /ko -->
                <tr>
                  <td class="lateness-table__highlighted">
                    <div></div>
                  </td>
                </tr>
              </tbody>
            </table>

          </td>


          <!-- ko foreach: {
            data: table.positions.filter(p => p.visible()),
            as: 'position'
          } -->
          <td class="lateness-table__container-cell">
            <!-- ko template: {
              name: 'lateness-position-template',
              data: {
                position: position,
              }
            } -->
            <!-- /ko -->
          </td>
          <!-- /ko -->


          <!-- ko if: table.positions.filter(p => p.visible()).length > 1 -->
          <td class="lateness-table__container-cell">
            <!-- ko template: {
              name: 'lateness-total-template'
            } -->
            <!-- /ko -->
          </td>
          <!-- /ko -->
        </tr>
      </tbody>

    </table>
  </div>
  <!-- /ko -->

</div>


</div>

            </div>
            <!-- /ko -->
            <!-- /Tabs -->

            <div class="calculation-form__actions">
              <button class="hrm-button hrm-button--size_large hrm-basic-button calculation-form__action"
                data-bind="click: reset, disable: blockResetButton">
                Отменить
              </button>

              <button
                class="hrm-button hrm-button--size_large hrm-basic-button hrm-accent-button calculation-form__action"
                data-bind="click: $root.submit.bind($root, null), disable: blockSaveButton">
                Сохранить

                <!-- ko template: {
                  foreach: hrmTemplateIf(showSuccessMessage(), $data),
                  afterAdd: hrmFadeAfterAddFactory(200),
                  beforeRemove: hrmFadeBeforeRemoveFactory(200)
                } -->
                <div class="message message--success">
                  <i class="far fa-check"></i>
                  Расчет успешно сохранен
                </div>
                <!-- /ko -->

                <!-- ko template: {
                  foreach: hrmTemplateIf(showErrorMessage(), $data),
                  afterAdd: hrmFadeAfterAddFactory(200),
                  beforeRemove: hrmFadeBeforeRemoveFactory(200)
                } -->
                <div class="message message--error">
                  <i class="far fa-exclamation-circle"></i>
                  Произошла ошибка при сохранении
                </div>
                <!-- /ko -->
              </button>

              <button
                class="hrm-button hrm-button--size_large hrm-basic-button hrm-accent-button calculation-form__action"
                data-bind="click: $root.submit.bind($root, true), disable: blockSaveButton">
                Сохранить c ошибкой

                <!-- ko template: {
                  foreach: hrmTemplateIf(showErrorMessage(), $data),
                  afterAdd: hrmFadeAfterAddFactory(200),
                  beforeRemove: hrmFadeBeforeRemoveFactory(200)
                } -->
                <div class="message message--error">
                  <i class="far fa-exclamation-circle"></i>
                  Произошла ошибка при сохранении
                </div>
                <!-- /ko -->
              </button>
            </div>
          </div>
          <!-- /ko -->
        </div>
      </div>
      <!-- /Page content  -->



    </div>

    <script type="text/html"
        id="confirm-modal-template">

  <div data-bind="component: {
      name: 'confirm-modal-dialog',
      params: {
        data, modalElement,
        cancel: function () { close(); },
        submit: function ($data) {close($data);}
      }}" role="document">
  </div>

</script>

<script type="text/html"
        id="positions-modal-template">

  <div data-bind="component: {
      name: 'positions-modal-dialog',
      params: {
        data, modalElement,
        cancel: function () { close(); },
        submit: function ($data) {close($data);}
      }}" role="document">
  </div>

</script>

<script type="text/html"
        id="columns-modal-template">

  <div data-bind="component: {
      name: 'columns-modal-dialog',
      params: {
        data, modalElement,
        cancel: function () { close(); },
        submit: function ($data) {close($data);}
      }}" role="document">
  </div>

</script>

<script type="text/html"
        id="stimulation-modal-template">

  <div data-bind="component: {
      name: 'stimulation-modal-dialog',
      params: {
        data, modalElement,
        cancel: function () { close(); },
        submit: function ($data) {close($data);}
      }}" role="document">
  </div>

</script>

<script type="text/html"
        id="compensations-modal-template">

  <div data-bind="component: {
      name: 'compensations-modal-dialog',
      params: {
        data, modalElement,
        cancel: function () { close(); },
        submit: function ($data) {close($data);}
      }}" role="document">
  </div>

</script>

<script type="text/html"
        id="create-employee-modal-template">

  <div data-bind="component: {
      name: 'create-employee-modal-dialog',
      params: {
        data, modalElement,
        cancel: function () { close(); },
        submit: function ($data) {close($data);}
      }}" role="document">
  </div>

</script>

<script type="text/html"
        id="add-employees-modal-template">

  <div data-bind="component: {
      name: 'add-employees-modal-dialog',
      params: {
        data, modalElement,
        cancel: function () { close(); },
        submit: function ($data) {close($data);}
      }}" role="document">
  </div>

</script>

<script type="text/html"
        id="account-operations-modal-template">

  <div data-bind="component: {
      name: 'account-operations-modal-dialog',
      params: {
        data, modalElement,
        cancel: function () { close(); },
        submit: function ($data) {close($data);}
      }}" role="document">
  </div>

</script>

<script type="text/html"
        id="employee-bonus-modal-template">

  <div data-bind="component: {
      name: 'employee-bonus-modal-dialog',
      params: {
        data, modalElement,
        cancel: function () { close(); },
        submit: function ($data) {close($data);}
      }}" role="document">
  </div>

</script>

<script type="text/html"
        id="employee-fine-modal-template">

  <div data-bind="component: {
      name: 'employee-fine-modal-dialog',
      params: {
        data, modalElement,
        cancel: function () { close(); },
        submit: function ($data) {close($data);}
      }}" role="document">
  </div>

</script>

<script type="text/html"
        id="employee-remove-workload-completely-modal-template">

  <div data-bind="component: {
      name: 'employee-remove-workload-completely-modal-dialog',
      params: {
        data, modalElement,
        cancel: function () { close(); },
        submit: function ($data) {close($data);}
      }}" role="document">
  </div>

</script>

<script type="text/html"
        id="employee-remove-workload-partially-modal-template">

  <div data-bind="component: {
      name: 'employee-remove-workload-partially-modal-dialog',
      params: {
        data, modalElement,
        cancel: function () { close(); },
        submit: function ($data) {close($data);}
      }}" role="document">
  </div>

</script>

<script type="text/html" id="driver-details-modal-template">
  <div class="calculation-modal__wrapper">
      <!-- ko if: $root.utils.viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
          <div class="calculation-modal__wrapper-actions">
              <button class="hrm-button calculation-modal__wrapper-close"
                      data-bind="click: function () {close();}">
              </button>
          </div>
      <!-- /ko -->

      <div data-bind="component: { name: 'driver-details-modal-dialog', params: { data, modalElement, cancel: function () { close(); }, submit: function ($data) { close($data); } } }" role="document"></div>
  </div>
</script>

<script type="text/html" id="lateness-details-modal-template">
  <div class="calculation-modal__wrapper">
      <!-- ko if: $root.utils.viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
          <div class="calculation-modal__wrapper-actions">
              <button class="hrm-button calculation-modal__wrapper-close"
                      data-bind="click: function () {close();}">
              </button>
          </div>
      <!-- /ko -->

      <div data-bind="component: { name: 'lateness-details-modal-dialog', params: { data, modalElement, cancel: function () { close(); }, submit: function ($data) { close($data); } } }" role="document"></div>
  </div>
</script>

<script type="text/html" id="routes-modal-template">
  <div class="calculation-modal__wrapper">
      <!-- ko if: $root.utils.viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
          <div class="calculation-modal__wrapper-actions">
              <button class="hrm-button calculation-modal__wrapper-close"
                      data-bind="click: function () {close();}">
              </button>
          </div>
      <!-- /ko -->

      <div data-bind="component: { name: 'routes-modal-dialog', params: { data, modalElement, cancel: function () { close(); }, submit: function ($data) { close($data); } } }" role="document"></div>
  </div>
</script>


<!-- ko component: {name: 'hrm-modal-container', params: {opens: modalOpens}} --><!-- /ko -->

  </div>

  <script id="versions-dropdown-template" type="text/html">
        <!-- ko foreach: $root.versions -->
  <div class="hrm-dropdown-menu__item">
    <a class="version-preview" data-bind="attr: {href: $data.link}">
      <div class="version-preview__userpic">
        <img data-bind="attr: {src: $data.avatar}" alt="">
      </div>
      <div class="version-preview__content">
        <div class="version-preview__user" data-bind="text: $data.name"></div>
        <div class="version-preview__time" data-bind="text: $data.time"></div>
      </div>
    </a>
  </div>
  <!-- /ko -->
  </script>

  <script id="actions-dropdown-template" type="text/html">

        <div class="hrm-dropdown-menu__item">
          <a class="action-preview" href="#">
            <svg width="14" height="14">
              <use href="#excel-icon"></use>
            </svg>
            Выгрузить в Excel
          </a>
        </div>
        <div class="hrm-dropdown-menu__item">
          <a class="action-preview" href="#">
            <svg width="14" height="14">
              <use href="#print-icon"></use>
            </svg>
            Распечатать
          </a>
        </div>
        <div class="hrm-dropdown-menu__item">
          <a class="action-preview" href="#">
            <svg width="14" height="14">
              <use href="#picture-icon"></use>
            </svg>
            Для фото
          </a>

        </div>
        <div class="hrm-dropdown-menu__item">
          <a class="action-preview" href="#">
            <svg width="14" height="16">
              <use href="#calculation-icon"></use>
            </svg>
            Новый расчет
          </a>
        </div>
  </script>

  <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-debug.js" integrity="sha256-M5ZomNNnrnEB2WjSbnty5GWGqq6UuAAVNnWECisgEis=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/knockout.validation@2.0.4/dist/knockout.validation.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.12/js/select2.full.min.js" integrity="sha256-vucLmrjdfi9YwjGY/3CQ7HnccFSS/XRS1M/3k/FDXJw=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.10/js/i18n/ru.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/simplebar/5.1.0/simplebar.min.js" integrity="sha256-hFddD6XMIwFba4ITQjpv5WWE557w6O0w9RRfmGjIz4k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/overlayscrollbars/1.10.2/js/OverlayScrollbars.min.js" integrity="sha256-5Tj3ZUgjHEGwF7TxpOgbPpjhq+WxXvpfb+qr9OxRHtY=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/overlayscrollbars/1.10.2/js/jquery.overlayScrollbars.min.js" integrity="sha256-RE+oy7ofA6XerySMpTlDcg0gFUwHN3n0qQ5fUIZVq/M=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/gh/RobinHerbots/jquery.inputmask@4.0.9/dist/jquery.inputmask.bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment-with-locales.min.js" integrity="sha256-AdQN98MVZs44Eq2yTwtoKufhnU+uZ7v2kXnD5vqzZVo=" crossorigin="anonymous"></script>
<script src="https://unpkg.com/popper.js@1"></script>
<script src="https://unpkg.com/tippy.js@5"></script>
<script src="https://unpkg.com/sticky-events@3.1.1/dist/sticky-events.umd.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min.js" integrity="sha256-VeNaFBVDhoX3H+gJ37DpT/nTuZTdjYro9yBruHjVmoQ=" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.js" integrity="sha256-id5Qk/MwQJxgNlDFDpVymUuReXfTUZiaQKb8arrddQM=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/mode/xml/xml.min.js" integrity="sha256-Lfk8z6WUsBN6YiCaMpH6bxBHyRqkPK4O2QbQHFNUS40=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/autoresize-textarea@1.1.3/src/autoresize-textarea.min.js"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

<script src="assets/js/main.js"></script>


  <template id="confirm-modal-dialog-template">
  <button class="hrm-button hrm-basic-modal-dialog__close-button"
          data-bind="click: function() { cancel(); }"
          aria-label="Close">
  </button>


  <div class="hrm-basic-modal-dialog__body">
    <!-- ko text: text -->
    <!-- /ko -->
  </div>

  <div class="hrm-basic-modal-dialog__action-list">
    <button class="hrm-button hrm-basic-button hrm-basic-modal-dialog__action-list-item"
            data-bind="click: function() {cancel();}, text: cancelButton">

    </button>

    <button class="hrm-button hrm-basic-button hrm-accent-button hrm-basic-modal-dialog__action-list-item"
            data-bind="click: function() {submit();}, text: confirmButton">

    </button>
  </div>
</template>


<script>
  $(function () {
    ko.components.register('confirm-modal-dialog', {
      viewModel: {
        createViewModel: function (params, componentInfo) {
          const $element = $(componentInfo.element);
          $element.addClass([
            'modal-dialog',
            'modal-dialog-centered',
            'hrm-modal-dialog',
            'hrm-basic-modal-dialog',
            'modal-dialog--confirm'
          ]);

          const ViewModel = function () {
            this.text = params.data.text;
            this.confirmButton = params.data.confirmButton || 'Подтвердить';
            this.cancelButton = params.data.cancelButton || 'Отменить';

            this.cancel = function () {
              if ('cancel' in params) {
                params.cancel();
              }
            };

            this.submit = function () {
              if ('submit' in params) {
                params.submit(true);
              }
            };
          }

          return new ViewModel();
        }
      },
      template: {
        element: 'confirm-modal-dialog-template'
      }
    });
  })
</script>

  <template id="columns-modal-dialog-template">

  <button class="hrm-button hrm-basic-modal-dialog__close-button"
          data-bind="click: function() { cancel(); }"
          aria-label="Close">
  </button>

  <div class="hrm-basic-modal-dialog__header">
    <h2 class="hrm-basic-modal-dialog__title">
      Настройка столбцов
    </h2>
  </div>

  <div class="hrm-basic-modal-dialog__body columns-settings">
    <div class="columns-settings__search"
         data-bind="component: {name: 'hrm-search-field', params: { termModel: term, placeholder: 'Поиск по наименованию' }}">
    </div>


    <div class="modal-dialog__scroll" data-bind="component: { name: 'hrm-scrollable-wrapper', params: { options: {}}}">
      <div class="modal-dialog__scroll-container columns-settings__list"
           >
        <!-- ko foreach: { data: columns, as: 'column' } -->

        <!-- ko if: column.visible() -->

        <!-- ko let: {checkboxGroup: ko.observable(null)} -->
        <div class="columns-settings__list-item">
          <div data-bind="component: {name: 'hrm-checkbox-group', params: {exportAs: checkboxGroup}}">
            <div
                 data-bind="component: {name: 'hrm-checkbox', params: {owner: checkboxGroup, checked: column.checked }}">
            </div>
            <label
                   data-bind="hrmCheckboxGroupLabel, hrmCheckboxGroupLabelOwner: checkboxGroup, text: column.name"></label>
          </div>
        </div>
        <!-- /ko -->

        <!-- /ko -->
        <!-- /ko -->
      </div>
    </div>


  </div>

  <div class="hrm-basic-modal-dialog__action-list columns-settings__action-list">
    <button class="hrm-button hrm-basic-button  hrm-button--size_large hrm-basic-modal-dialog__action-list-item"
            data-bind="click: function() {reset();}">
      Сбросить
    </button>

    <button class="hrm-button hrm-basic-button hrm-button--size_large  hrm-accent-button hrm-basic-modal-dialog__action-list-item"
            data-bind="click: function() {submit();}">
      Применить
    </button>
  </div>

</template>


<script type="text/javascript">
    $(function () {
        function ColumnModel(column) {
            const checked = ko.observable(column.visible());
            function apply() {
                column.visible(checked());
            }
            return {
                id: column.id,
                name: column.fullTitle,
                checked,
                visible: ko.observable(true),
                apply
            }
        }

        ko.components.register('columns-modal-dialog', {
            viewModel: {
                createViewModel: function (params, componentInfo) {
                    const $element = $(componentInfo.element);
                    $element.addClass([
                        'modal-dialog',
                        'modal-dialog-centered',
                        'hrm-modal-dialog',
                        'hrm-basic-modal-dialog',
                        'hrm-modal-dialog--size_large',
                        'modal-dialog--columns'
                    ]);


                    const viewModel = new (function () {
                        this.columns = params.data.columns.map(ColumnModel);

                        this.viewportSize = ko.observable({ width: $(window).width(), height: $(window).height() });

                        this.windowResizeHandler = () => {
                            this.viewportSize({ width: $(window).width(), height: $(window).height() });
                        };

                        $(window).on('resize', this.windowResizeHandler);

                        /** Поисковый запрос */
                        this.term = ko.observable('');
                        /** Скрыть/Показать позиции в списке */
                        this.term.subscribe(value => {
                            const formattedTerm = value.toLowerCase();

                            this.columns.forEach(c => {
                                let isVisible = true;
                                if (formattedTerm.length >= 1) {
                                    const formattedName = c.name.toLowerCase();
                                    isVisible = formattedName.indexOf(formattedTerm) !== -1;
                                    console.log(isVisible)
                                }
                                c.visible(isVisible);
                            })
                        });

                        /** Сбросить все чекбоксы и поисковый запрос */
                        this.reset = function () {
                            this.term('');
                            this.columns.forEach(c => {
                                c.checked(false);
                            });
                        }

                        /** Закрыть окно без изменений */
                        this.cancel = function () {
                            if ('cancel' in params) {
                                params.cancel();
                            }
                        };

                        /** Применить изменения */
                        this.apply = function () {
                            this.columns.forEach(c => {
                                c.apply()
                            });
                        }

                        this.submit = function () {
                            if ('submit' in params) {
                                this.apply();
                                params.submit(true);
                            }
                        };
                    });

                    viewModel.dispose = () => {
                        $(window).off('resize', viewModel.windowResizeHandler);
                    }

                    return viewModel;
                }
            },
            template: {
                element: document.getElementById('columns-modal-dialog-template')
            }
        });
    });
</script>

  <template id="positions-modal-dialog-template">

  <button class="hrm-button hrm-basic-modal-dialog__close-button"
          data-bind="click: function() { cancel(); }"
          aria-label="Close">
  </button>

  <div class="hrm-basic-modal-dialog__header">
    <h2 class="hrm-basic-modal-dialog__title">
      Показывать в таблице должности
    </h2>
  </div>

  <div class="hrm-basic-modal-dialog__body positions-settings">
    <div class="positions-settings__search"
         data-bind="component: {name: 'hrm-search-field', params: { termModel: term, placeholder: 'Поиск по должности' }}">
    </div>

    <div class="modal-dialog__scroll">
      <div class="positions-settings__list"
           data-bind="component: { name: 'hrm-scrollable-wrapper', params: { options: {}} }">
        <!-- ko foreach: { data: positions, as: 'position' } -->

        <!-- ko let: {checkboxGroup: ko.observable(null), visible: position.visible} -->
        <div class="positions-settings__list-item"
             data-bind="if: visible">
          <div data-bind="component: {name: 'hrm-checkbox-group', params: {exportAs: checkboxGroup}}">
            <div
                 data-bind="component: {name: 'hrm-checkbox', params: {owner: checkboxGroup, checked: position.checked }}">
            </div>
            <label
                   data-bind="hrmCheckboxGroupLabel, hrmCheckboxGroupLabelOwner: checkboxGroup, text: position.name"></label>
          </div>
        </div>
        <!-- /ko -->

        <!-- /ko -->
      </div>
    </div>



  </div>

  <div class="hrm-basic-modal-dialog__action-list">
    <button class="hrm-button hrm-basic-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-cancel-button"
            data-bind="click: function() {reset();}">
      Сбросить
    </button>

    <button class="hrm-button hrm-basic-button hrm-accent-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-submit-button"
            data-bind="click: function() {submit();}">
      Применить
    </button>
  </div>

</template>


<script type="text/javascript">
    $(function () {
        function PositionModel(positionData) {
            const checked =  ko.observable(!!positionData.visible());
            function apply() {
                positionData.visible(checked());
            }
            return {
                name: positionData.name,
                checked,
                visible: ko.observable(true),
                apply
            }
        }

        ko.components.register('positions-modal-dialog', {
            viewModel: {
                createViewModel: function (params, componentInfo) {
                    const $element = $(componentInfo.element);
                    $element.addClass([
                        'modal-dialog',
                        'modal-dialog-centered',
                        'hrm-modal-dialog',
                        'hrm-basic-modal-dialog',
                        'hrm-modal-dialog--size_large',
                        'modal-dialog--positions-settings'
                    ]);

                    const ViewModel = function(positions) {
                        /** Positions model */
                        this.positions = positions.map(PositionModel);

                        /** Поисковый запрос */
                        this.term = ko.observable('');
                        /** Скрыть/Показать позиции в списке */
                        this.term.subscribe(value => {
                            const formattedTerm = value.toLowerCase();

                            this.positions.forEach(p => {
                                let isVisible = true;
                                if (formattedTerm.length >= 1) {
                                    const formattedName = p.name.toLowerCase();
                                    isVisible = formattedName.indexOf(formattedTerm) !== -1;
                                }
                                p.visible(isVisible);
                            })
                        });

                        /** Сбросить все чекбоксы и поисковый запрос */
                        this.reset = function () {
                            this.term('');
                            this.positions.forEach(p => {
                                p.checked(false);
                            });
                        }

                        /** Закрыть окно без изменений */
                        this.cancel = function () {
                            if ('cancel' in params) {
                                params.cancel();
                            }
                        };

                        /** Применить изменения */
                        this.apply = function() {
                            this.positions.forEach(p => {
                                p.apply();
                            });
                        }

                        this.submit = function () {
                            if ('submit' in params) {
                                this.apply();
                                params.submit(true);
                            }
                        };
                    }

                    return new ViewModel(params.data.positions());
                }
            },
            template: {
                element: document.getElementById('positions-modal-dialog-template')
            }
        });
    });
</script>

  <template id="account-operation-template">
  <div class="account-operation"
       data-bind="hrmLog">
    <div class="account-operation__type">

      <div class="hrm-radio-group"
           data-bind="let: {radioGroupId: 'account-operation-' + $index()}">
        <div class="hrm-radio-group__radio hrm-radio-group__radio--theme_negative">
          <input class="hrm-radio-group__radio-input"
                 data-bind="checked: type, attr: {id: radioGroupId + '-fine'}"
                 type="radio"
                 value="fine"
                 checked />
          <label class="hrm-radio-group__radio-label"
                 data-bind="attr: {'for': radioGroupId + '-fine'}">
            Списать
          </label>
        </div>

        <div class="hrm-radio-group__radio hrm-radio-group__radio--theme_positive">
          <input class="hrm-radio-group__radio-input"
                 data-bind="checked: type, attr: {id: radioGroupId + '-bonus'}"
                 type="radio"
                 value="bonus" />
          <label class="hrm-radio-group__radio-label"
                 data-bind="attr: {'for': radioGroupId + '-bonus'}">
            Начислить
          </label>
        </div>
      </div>

    </div>

    <div class="account-operation__sum">
      <!-- ko let: {control: ko.observable(null)} -->
      <div class="account-operation__sum-value"
           data-bind="hrmFormField, hrmFormFieldControlRef: control">
        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <input type="text" placeholder="0"
                 data-bind="
              textInput: sum,
              hrmMask, hrmMaskPattern: 'decimal',
              hrmFormFieldInputControl: control,
              hrmFormFieldInputControlErrorStateMatcher: $parent.formControlErrorStateMatcher.bind($parent)
          ">
        </div>

        <div data-bind="
          component: {name: 'hrm-form-field-error'},
          hrmSlide,
          hrmSlideValue: control() !== null ? control().errorState : false,
          hrmSlideDuration: 150
      ">
          <!-- ko text: $parent.sum.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <div class="account-operation__sum-sign">₽</div>
    </div>


    <!-- ko let: {control: ko.observable(null)} -->
    <div class="account-operation__comment"
         data-bind="hrmFormField, hrmFormFieldControlRef: control">

      <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control, hrmFormFieldBasisAllowClear">
        <textarea data-bind="
            attr: {placeholder: commentPlaceholder},
            textInput: comment,
            hrmFormFieldInputControl: control,
            hrmAutoResize"
                  placeholder="Комментарий"></textarea>
      </div>

    </div>
    <!-- /ko -->



    <div class="account-operation__remove">
      <!-- ko if: $parent.viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
      <button class="hrm-button hrm-icon-button hrm-trash-icon-button hrm-icon-button--theme_negative"
              data-bind="click: $parent.removeOperation, hrmTooltip, hrmTooltipText: 'Удалить'"></button>
      <!-- /ko -->

      <!-- ko ifnot: $parent.viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
      <button class="hrm-button hrm-button-with-icon hrm-button-with-icon--theme_negative hrm-button-with-trash-icon"
              data-bind="click: $parent.removeOperation, hrmTooltip, hrmTooltipText: 'Удалить'">Удалить</button>
      <!-- /ko -->


    </div>
  </div>
</template>

<template id="account-operations-modal-dialog-template">
  <button class="hrm-button hrm-basic-modal-dialog__close-button"
          data-bind="click: function() { cancel(); }"
          aria-label="Close">
  </button>

  <div class="hrm-basic-modal-dialog__header">
    <h2 class="hrm-basic-modal-dialog__title">
      Операции с личным счетом
    </h2>
  </div>

  <div class="hrm-basic-modal-dialog__body account-operations-form">

    <div class="modal-dialog__scroll">
      <div class="account-operations-form__list" data-bind="component: {
        name: 'hrm-scrollable-wrapper',
        params: { options: {} }
      }">
        <!-- ko template: {
          name: 'account-operation-template',
          foreach: operations,
          afterAdd: hrmFadeAfterAddFactory(200),
          beforeRemove: hrmFadeBeforeRemoveFactory(200)
        } -->
        <!-- /ko -->
      </div>
    </div>



    <div class="account-operations-form__actions">
      <button class="hrm-button hrm-button-with-icon hrm-button-with-icon--theme_neutral hrm-button-with-plus-icon"
              data-bind="click: addOperation">Добавить</button>

      <div class="account-operations-form__total color--secondary">
        Итого: <span class="account-operations-form__total-value"
              data-bind="hrmColoredSign: total">
          <!-- ko text: $component.formatSign(total) -->
          <!-- /ko -->
          <i class="far fa-ruble-sign"
             aria-hidden="true"></i>
        </span>

      </div>



    </div>



  </div>

  <div class="hrm-basic-modal-dialog__action-list">
    <button class="hrm-button hrm-basic-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-cancel-button"
            data-bind="click: function() {cancel();}">
      Отменить
    </button>

    <button class="hrm-button hrm-basic-button hrm-accent-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-submit-button"
            data-bind="click: function() {submit();}">
      Сохранить
    </button>
  </div>
</template>


<script>
  $(function () {
    function AccountOperation(operationData) {
      operationData = operationData || {};

      this.type = ko.observable(operationData.type || 'fine').extend({
        required: {
          message: 'Обязательное поле'
        }
      });
      this.sum = ko.observable(parseFloat(operationData.sum) || '').extend({
        required: {
          message: 'Обязательное поле'
        },
        number: {
          message: 'Некорректный формат'
        }
      });
      this.comment = ko.observable(operationData.comment || '');
      this.commentPlaceholder = ko.pureComputed(() => {
        return this.type() === 'fine' ? 'Комментарий к списанию' : 'Комментарий к начислению';
      });
      this.total = ko.pureComputed(() => {
        const sign = this.type() === 'fine' ? -1 : 1;
        return this.sum() * sign;
      });

      this.getData = () => {
        let sum = parseFloat(this.sum());
        sum = sum.toFixed(2);

        return {
          type: this.type(),
          sum: parseFloat(sum),
          comment: this.comment()
        };
      }
    }

    ko.components.register('account-operations-modal-dialog', {
      viewModel: {
        createViewModel: function (params, componentInfo) {
          const $element = $(componentInfo.element);
          $element.addClass([
            'modal-dialog',
            'modal-dialog-centered',
            'hrm-modal-dialog',
            'hrm-basic-modal-dialog',
            'modal-dialog--account-operations'
          ]);

          const ViewModel = function (operations) {
            this.viewportSize = ko.observable({ width: $(window).width(), height: $(window).height() });
            this.windowResizeHandler = () => {
              this.viewportSize({ width: $(window).width(), height: $(window).height() });
            };
            $(window).on('resize', this.windowResizeHandler);

            this.formatSign = (number) => {
              const formattedNumber = parseFloat(ko.unwrap(number));
              if (!formattedNumber) return number;
              if (formattedNumber > 0) return '+' + formattedNumber;
              return formattedNumber;
            };

            this.isSubmitted = ko.observable(false);

            this.formControlErrorStateMatcher = (formControl) => {
              return ko.pureComputed(() => {
                return this.isSubmitted() && !formControl.isValid();
              });
            };

            this.operations = ko.observableArray(operations.map(o => new AccountOperation(o)));
            if (!this.operations().length) this.operations.push(new AccountOperation());

            this.total = ko.pureComputed(() => {
              return this.operations().reduce((sum, operation) => {

                return Math.floor((sum + operation.total()) * 100) / 100;
              }, 0);
            })

            this.addOperation = () => {
              this.operations.push(new AccountOperation());
            }

            this.removeOperation = (operation) => {
              this.operations.remove(operation);
            }

            /** Закрыть окно без изменений */
            this.cancel = function () {
              if ('cancel' in params) {
                params.cancel();
              }
            };

            /** Применить изменения */
            this.apply = function () {
              employee.accountOperations(this.operations()
                .map(operation => operation.getData())
                .filter(operation => operation.sum));
            }

            this.submit = function () {
              if ('submit' in params) {
                this.apply();
                params.submit(true);
              }
            };

            this.dispose = function () {
              $(window).off('resize', this.windowResizeHandler);
            };

          }

          const employee = params.data.employee;
          return new ViewModel(employee.accountOperations());
        }
      },
      template: {
        element: 'account-operations-modal-dialog-template'
      }
    });
  })
</script>

  <template id="fine-block-template">
  <div class="fine-block">
    <div class="fine-block__content">
      <!-- Base select -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
      <div class="fine-block__row fine-block__base"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">
          Основание штрафа
        </label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <select data-bind="bindInner, value: base,
            hrmSelect,
            hrmSelectSearchEnabled: true,
            hrmSelectPlaceholder: 'Не выбрано', hrmSelectAllowClear: true,
            hrmFormFieldSelectControl: control,
            hrmFormFieldSelectControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)">

            <option></option>

            <!-- ko foreach: {data: $component.fineBases, as: 'group'} -->
            <optgroup data-bind="attr: {label: group.name}">
              <!-- ko foreach: { data: group.items, as: 'option' } -->
              <option data-bind="value: '' + option.id, text: option.name"></option>
              <!-- /ko -->

            </optgroup>
            <!-- /ko -->
          </select>
        </div>


        <div data-bind="component: {name: 'hrm-form-field-error'},
          hrmSlide,
          hrmSlideValue: control() !== null ? control().errorState : false,
          hrmSlideDuration: 150">
          <!-- ko text: $parent.base.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /Base select -->

      <div class="fine-block__row">
        <!-- Sum field -->
        <!-- ko let: {control: ko.observable(null), label: ko.observable(null)} -->
        <div class="fine-block__sum"
             data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
          <label data-bind="hrmFormFieldLabel: label">Сумма,
            <i class="far fa-ruble-sign"></i>
          </label>

          <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
            <input data-bind="
              textInput: sum,
              hrmFormFieldInputControl: control,
              hrmFormFieldInputControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)"
                   readonly
                   type="number">
          </div>

          <div data-bind="
              component: {name: 'hrm-form-field-error'},
              hrmSlide,
              hrmSlideValue: control() !== null ? control().errorState : false,
              hrmSlideDuration: 150
          ">
            <!-- ko text: $parent.sum.error() -->
            <!-- /ko -->
          </div>
        </div>
        <!-- /ko -->
        <!-- /Sum field -->


        <!-- Author select -->
        <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
        <div class="fine-block__author"
             data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
          <label data-bind="hrmFormFieldLabel: label">Автор штрафа</label>

          <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
            <select data-bind="bindInner, value: author,
              hrmSelect,
              hrmSelectSearchEnabled: true,
              hrmSelectPlaceholder: 'Не выбран', hrmSelectAllowClear: true,
              hrmFormFieldSelectControl: control,
              hrmFormFieldSelectControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)">
              <option></option>
              <!-- ko foreach: $component.authors -->
              <option data-bind="value: '' + id, text: name"></option>
              <!-- /ko -->
            </select>
          </div>

          <div data-bind="component: {name: 'hrm-form-field-error'},
        hrmSlide,
        hrmSlideValue: control() !== null ? control().errorState : false,
        hrmSlideDuration: 150">
            <!-- ko text: $parent.author.error() -->
            <!-- /ko -->
          </div>
        </div>
        <!-- /ko -->
        <!-- /Author select -->
      </div>

      <!-- Comment field -->
      <!-- ko let: {control: ko.observable(null)} -->
      <div class="fine-block__row fine-block__comment"
           data-bind="
     hrmFormField, hrmFormFieldControlRef: control
 ">

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control, hrmFormFieldBasisAllowClear">
          <textarea data-bind="
             textInput: comment,
             hrmFormFieldInputControl: control,
             hrmAutoResize
         "
                    placeholder="Комментарий"></textarea>
        </div>

      </div>
      <!-- /ko -->
      <!-- /Comment field -->
    </div>

    <div class="fine-block__remove">
      <!-- ko if: $component.viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
      <button class="hrm-button hrm-icon-button hrm-trash-icon-button hrm-icon-button--theme_negative"
              data-bind="click: $component.removeFine, hrmTooltip, hrmTooltipText: 'Удалить'"></button>
      <!-- /ko -->

      <!-- ko ifnot: $component.viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
      <button class="hrm-button hrm-button-with-icon hrm-button-with-icon--theme_negative hrm-button-with-trash-icon"
              data-bind="click: $component.removeFine, hrmTooltip, hrmTooltipText: 'Удалить'">Удалить</button>
      <!-- /ko -->
    </div>
  </div>
</template>

<template id="employee-fine-modal-dialog-template">
  <button class="hrm-button hrm-basic-modal-dialog__close-button"
          data-bind="click: function() { cancel(); }"
          aria-label="Close">
  </button>

  <div class="hrm-basic-modal-dialog__header">
    <h2 class="hrm-basic-modal-dialog__title">
      Выписать штраф
    </h2>
  </div>

  <div class="hrm-basic-modal-dialog__body fine-form">
    <div class="modal-dialog__scroll">
      <div class="fine-form__scroll-list"
           data-bind="hrmScrollable">
        <!-- ko template: {
          name: 'fine-block-template',
          foreach: fines,
          afterAdd: hrmFadeAfterAddFactory(200),
          beforeRemove: hrmFadeBeforeRemoveFactory(200)
        } -->
        <!-- /ko -->


      </div>
    </div>
    <div class="fine-form__actions">
      <button class="hrm-button hrm-button-with-icon hrm-button-with-icon--theme_neutral hrm-button-with-plus-icon"
              data-bind="click: addFine">Добавить штраф</button>

      <div class="fine-form__total color--secondary">
        Итого: <span class="fine-form__total-value"
              data-bind="hrmColoredSign: -1 * total()">
          <!-- ko text: $component.formatSign(-1 * total()) -->
          <!-- /ko -->
          <i class="far fa-ruble-sign"
             aria-hidden="true"></i>
        </span>
      </div>

    </div>

  </div>

  <div class="hrm-basic-modal-dialog__action-list">
    <button class="hrm-button hrm-basic-button hrm-basic-modal-dialog__action-list-item
        position-page__speciality-modal-dialog-cancel-button"
            data-bind="click: function() {cancel();}">
      Отменить
    </button>

    <button class="hrm-button hrm-basic-button hrm-accent-button hrm-basic-modal-dialog__action-list-item
        position-page__speciality-modal-dialog-submit-button"
            data-bind="click: function() {submit();}">
      Сохранить
    </button>
  </div>
</template>


<script>
  $(function () {
    function Fine(defaultData, fineBases) {
      defaultData = defaultData || {};
      const base = ko.observable(defaultData.base).extend({
        required: {
          message: 'Обязательное поле'
        }
      });
      const sum = ko.observable(defaultData.sum || '').extend({
        required: {
          message: 'Обязательное поле'
        },
        number: {
          message: 'Некорректный формат'
        }
      });
      base.subscribe(baseId => {
        let baseData;
        for (let groupIndex in fineBases) {
          let group = fineBases[groupIndex];
          for (let itemIndex in group.items) {
            let item = group.items[itemIndex];
            if (item.id === baseId) {
              baseData = item;
              break;
            }
          }
          if (baseData) break;
        }

        fineBases.find(group => {
          return group.items.find(item => item.id === baseId);
        });
        if (baseData) sum(baseData.sum);
        else sum(null);
      });
      const author = ko.observable(defaultData.author).extend({
        required: {
          message: 'Обязательное поле'
        }
      });

      const validationObject = ko.validatedObservable({
        base,
        author,
        sum
      });
      return {
        base,
        author,
        sum,
        comment: ko.observable(defaultData.comment || '').extend({

        }),

        isValid: () => {
          return validationObject.isValid();
        }
      }
    }

    ko.components.register('employee-fine-modal-dialog', {
      viewModel: {
        createViewModel: function (params, componentInfo) {
          const $element = $(componentInfo.element);
          $element.addClass([
            'modal-dialog',
            'modal-dialog-centered',
            'hrm-modal-dialog',
            'hrm-basic-modal-dialog',
            'hrm-modal-dialog--size_large',
            'modal-dialog--employee-fine'
          ]);

          const employee = params.data.employee;
          const finesList = params.data.fines;
          const authorsList = params.data.authors;

          const ViewModel = function (defaultFines, finesList, authorsList) {
            this.viewportSize = ko.observable({ width: $(window).width(), height: $(window).height() });
            this.windowResizeHandler = () => {
              this.viewportSize({ width: $(window).width(), height: $(window).height() });
            };
            $(window).on('resize', this.windowResizeHandler);

            this.formatSign = (number) => {
              const formattedNumber = parseFloat(ko.unwrap(number));
              if (!formattedNumber) return number;
              if (formattedNumber > 0) return '+' + formattedNumber;
              return formattedNumber;
            };

            this.isSubmitted = ko.observable(false);

            this.formControlErrorStateMatcher = (formControl) => {
              return ko.pureComputed(() => {
                return this.isSubmitted() && !formControl.isValid();
              });
            };

            this.fineBases = finesList;
            this.authors = authorsList;

            this.fines = ko.observableArray(defaultFines.map((fineData) => {
                return Fine(fineData, this.fineBases);
            }));

            if (!this.fines().length) this.fines.push(Fine(null, this.fineBases));

            this.addFine = () => {
              this.fines.push(Fine(null, this.fineBases))
            };

            this.removeFine = (fine) => {
              this.fines.remove(fine);
            }

            this.total = ko.pureComputed(() => {
              return this.fines().reduce((sum, fine) => {
                let fineSum = parseFloat(fine.sum()) || 0;
                return sum + fineSum;
              }, 0);
            })

            /** Закрыть окно без изменений */
            this.cancel = function () {
              if ('cancel' in params) {
                params.cancel();
              }
            };

            /** Применить изменения */
            this.apply = function () {
              employee.fines(ko.toJS(this.fines));
            }

            this.submit = function () {
              this.isSubmitted(true);

              if (this.fines().some(f => !f.isValid())) return;

              if ('submit' in params) {
                this.apply();
                params.submit(true);
              }
            };

            this.dispose = function () {
              $(window).off('resize', this.windowResizeHandler);
            };
          }

          return new ViewModel(employee.fines(), finesList, authorsList);
        }
      },
      template: {
        element: 'employee-fine-modal-dialog-template'
      }
    });
  })
</script>

  <template id="bonus-block-template">
  <div class="bonus-block">
    <div class="bonus-block__content">
      <!-- Base select -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
      <div class="bonus-block__row bonus-block__base"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">
          Основание премии
        </label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <select data-bind="bindInner, value: base,
            hrmSelect,
            hrmSelectSearchEnabled: true,
            hrmSelectPlaceholder: 'Не выбрано', hrmSelectAllowClear: true,
            hrmFormFieldSelectControl: control,
            hrmFormFieldSelectControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)">

            <option></option>

            <!-- ko foreach: {data: $component.bonusBases, as: 'group'} -->
            <optgroup data-bind="attr: {label: group.name}">
              <!-- ko foreach: { data: group.items, as: 'option' } -->
              <option data-bind="value: option.id, text: option.name"></option>
              <!-- /ko -->

            </optgroup>
            <!-- /ko -->
          </select>
        </div>

        <div data-bind="component: {name: 'hrm-form-field-error'},
     hrmSlide,
     hrmSlideValue: control() !== null ? control().errorState : false,
     hrmSlideDuration: 150">
          <!-- ko text: $parent.base.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /Base select -->

      <div class="bonus-block__row">
        <!-- Sum field -->
        <!-- ko let: {control: ko.observable(null), label: ko.observable(null)} -->
        <div class="bonus-block__sum"
             data-bind="
      hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label
  ">
          <label data-bind="hrmFormFieldLabel: label">Сумма,
            <i class="far fa-ruble-sign"></i>
          </label>

          <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
            <input data-bind="
              textInput: sum,
              hrmMask, hrmMaskPattern: 'decimal',
              hrmFormFieldInputControl: control,
              hrmFormFieldInputControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)
          ">
          </div>

          <div data-bind="
          component: {name: 'hrm-form-field-error'},
          hrmSlide,
          hrmSlideValue: control() !== null ? control().errorState : false,
          hrmSlideDuration: 150
      ">
            <!-- ko text: $parent.sum.error() -->
            <!-- /ko -->
          </div>
        </div>
        <!-- /ko -->
        <!-- /Sum field -->


        <!-- Author select -->
        <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
        <div class="bonus-block__author"
             data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
          <label data-bind="hrmFormFieldLabel: label">Автор штрафа</label>

          <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
            <select data-bind="bindInner, value: author,
       hrmSelect,
       hrmSelectSearchEnabled: true,
       hrmSelectPlaceholder: 'Не выбран', hrmSelectAllowClear: true,
       hrmFormFieldSelectControl: control,
       hrmFormFieldSelectControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)">
              <option></option>
              <!-- ko foreach: $component.authors -->
              <option data-bind="value: id, text: name"></option>
              <!-- /ko -->
            </select>
          </div>

          <div data-bind="component: {name: 'hrm-form-field-error'},
   hrmSlide,
   hrmSlideValue: control() !== null ? control().errorState : false,
   hrmSlideDuration: 150">
            <!-- ko text: $parent.author.error() -->
            <!-- /ko -->
          </div>
        </div>
        <!-- /ko -->
        <!-- /Author select -->
      </div>

      <!-- Comment field -->
      <!-- ko let: {control: ko.observable(null)} -->
      <div class="bonus-block__row bonus-block__comment"
           data-bind="
     hrmFormField, hrmFormFieldControlRef: control
 ">

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control, hrmFormFieldBasisAllowClear">
          <textarea data-bind="
             textInput: comment,
             hrmFormFieldInputControl: control,
             hrmAutoResize
         "
                    placeholder="Комментарий"></textarea>
        </div>

      </div>
      <!-- /ko -->
      <!-- /Comment field -->
    </div>

    <div class="bonus-block__remove">
      <!-- ko if: $component.viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
      <button class="hrm-button hrm-icon-button hrm-trash-icon-button hrm-icon-button--theme_negative"
              data-bind="click: $component.removeBonus, hrmTooltip, hrmTooltipText: 'Удалить'"></button>
      <!-- /ko -->

      <!-- ko ifnot: $component.viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
      <button class="hrm-button hrm-button-with-icon hrm-button-with-icon--theme_negative hrm-button-with-trash-icon"
              data-bind="click: $component.removeBonus, hrmTooltip, hrmTooltipText: 'Удалить'" >Удалить</button>
      <!-- /ko -->
    </div>
  </div>
</template>

<template id="employee-bonus-modal-dialog-template">
  <button class="hrm-button hrm-basic-modal-dialog__close-button"
          data-bind="click: function() { cancel(); }"
          aria-label="Close">
  </button>

  <div class="hrm-basic-modal-dialog__header">
    <h2 class="hrm-basic-modal-dialog__title">
      Выписать премию
    </h2>
  </div>

  <div class="hrm-basic-modal-dialog__body bonus-form">
    <div class="modal-dialog__scroll">
      <div class="bonus-form__scroll-list"
           data-bind="hrmScrollable">
        <!-- ko template: {
          name: 'bonus-block-template',
          foreach: bonuses,
          afterAdd: hrmFadeAfterAddFactory(200),
          beforeRemove: hrmFadeBeforeRemoveFactory(200)
        } -->
        <!-- /ko -->


      </div>
    </div>
    <div class="bonus-form__actions">
      <button class="hrm-button hrm-button-with-icon hrm-button-with-icon--theme_neutral hrm-button-with-plus-icon"
              data-bind="click: addBonus">Добавить премию</button>

      <div class="bonus-form__total color--secondary">
        Итого: <span class="bonus-form__total-value"
              data-bind="hrmColoredSign: total">
          <!-- ko text: $component.formatSign(total) -->
          <!-- /ko -->
          <i class="far fa-ruble-sign"
             aria-hidden="true"></i>
        </span>
      </div>

    </div>

  </div>

  <div class="hrm-basic-modal-dialog__action-list">
    <button class="hrm-button hrm-basic-button hrm-basic-modal-dialog__action-list-item
        position-page__speciality-modal-dialog-cancel-button"
            data-bind="click: function() {cancel();}">
      Отменить
    </button>

    <button class="hrm-button hrm-basic-button hrm-accent-button hrm-basic-modal-dialog__action-list-item
        position-page__speciality-modal-dialog-submit-button"
            data-bind="click: function() {submit();}">
      Сохранить
    </button>
  </div>
</template>


<script>
  $(function () {
    function Bonus(defaultData, bonusBases) {
      defaultData = defaultData || {};
      const base = ko.observable(defaultData.base).extend({
        required: {
          message: 'Обязательное поле'
        }
      });
      const sum = ko.observable(defaultData.sum || '').extend({
        required: {
          message: 'Обязательное поле'
        },
        number: {
          message: 'Некорректный формат'
        }
      });

      const author = ko.observable(defaultData.author).extend({
        required: {
          message: 'Обязательное поле'
        }
      });

      const comment = ko.observable(defaultData.comment || '').extend({

      });

      const validationObject = ko.validatedObservable({
        base,
        author,
        sum
      });

      return {
        base,
        author,
        sum,
        comment,

        isValid: () => {
          return validationObject.isValid();
        },
        getData: () => {
          return {
            base: base(),
            author: author(),
            comment: comment(),
            sum: parseFloat(sum())
          }
        }
      }
    }

    ko.components.register('employee-bonus-modal-dialog', {
      viewModel: {
        createViewModel: function (params, componentInfo) {
          const $element = $(componentInfo.element);
          $element.addClass([
            'modal-dialog',
            'modal-dialog-centered',
            'hrm-modal-dialog',
            'hrm-basic-modal-dialog',
            'hrm-modal-dialog--size_large',
            'modal-dialog--employee-bonus'
          ]);

          const employee = params.data.employee;
          const bonusesList = params.data.bonuses;
          const authorsList = params.data.authors;

          const ViewModel = function (defaultBonuses, bonusesList, authorsList) {
            this.viewportSize = ko.observable({ width: $(window).width(), height: $(window).height() });
            this.windowResizeHandler = () => {
              this.viewportSize({ width: $(window).width(), height: $(window).height() });
            };
            $(window).on('resize', this.windowResizeHandler);

            this.formatSign = (number) => {
              const formattedNumber = parseFloat(ko.unwrap(number));
              if (!formattedNumber) return number;
              if (formattedNumber > 0) return '+' + formattedNumber;
              return formattedNumber;
            };

            this.isSubmitted = ko.observable(false);

            this.formControlErrorStateMatcher = (formControl) => {
              return ko.pureComputed(() => {
                return this.isSubmitted() && !formControl.isValid();
              });
            };

            this.bonusBases = bonusesList;
            this.authors = authorsList;

            this.bonuses = ko.observableArray(defaultBonuses.map((bonusData) => {
                return Bonus(bonusData, this.bonusBases);
            }));

            if (!this.bonuses().length) this.bonuses.push(Bonus(null, this.bonusBases));

            this.addBonus = () => {
              this.bonuses.push(Bonus(null, this.bonusBases))
            };

            this.removeBonus = (bonus) => {
              this.bonuses.remove(bonus);
            }

            this.total = ko.pureComputed(() => {
              return this.bonuses().reduce((sum, bonus) => {
                let bonusSum = parseFloat(bonus.sum()) || 0;
                return sum + bonusSum;
              }, 0);
            })

            /** Закрыть окно без изменений */
            this.cancel = function () {
              if ('cancel' in params) {
                params.cancel();
              }
            };

            /** Применить изменения */
            this.apply = function () {
              employee.bonuses(this.bonuses().map(b => b.getData()));
            }

            this.submit = function () {
              this.isSubmitted(true);

              if (this.bonuses().some(b => !b.isValid())) return;

              if ('submit' in params) {
                this.apply();
                params.submit(true);
              }
            };

            this.dispose = function () {
              $(window).off('resize', this.windowResizeHandler);
            };
          }

          return new ViewModel(employee.bonuses(), bonusesList, authorsList);
        }
      },
      template: {
        element: 'employee-bonus-modal-dialog-template'
      }
    });
  })
</script>

  <template id="create-employee-modal-dialog-template">

  <button class="hrm-button hrm-basic-modal-dialog__close-button"
          data-bind="click: function() { cancel(); }"
          aria-label="Close">
  </button>

  <div class="hrm-basic-modal-dialog__header">
    <h2 class="hrm-basic-modal-dialog__title">
      Создать сотрудника
    </h2>
  </div>

  <div class="hrm-basic-modal-dialog__body employee-form"
       data-bind="using: formModel">

    <div class="employee-form__row">
      <!-- Name field -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null)} -->
      <div class="employee-form__name"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">ФИО сотрудника</label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control, hrmFormFieldBasisAllowClear">
          <input data-bind="
              textInput: name,
              hrmFormFieldInputControl: control,
              hrmFormFieldInputControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)
          ">
        </div>

        <div data-bind="
          component: {name: 'hrm-form-field-error'},
          hrmSlide,
          hrmSlideValue: control() !== null ? control().errorState : false,
          hrmSlideDuration: 150
      ">
          <!-- ko text: $parent.name.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /Name field -->
    </div>

    <div class="employee-form__row">
      <!-- Position select -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
      <div class="employee-form__position"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">
          Должность
        </label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <select data-bind="value: position,
              options: $component.positions,
              optionsText: 'name',
              optionsValue: 'id',
              valueAllowUnset: true,
              hrmSelect,
              hrmSelectPlaceholder: 'Не выбрано',
              hrmSelectSearchEnabled: true,
              hrmSelectAllowClear: true,
              hrmFormFieldSelectControl: control,
              hrmFormFieldSelectControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)">
          </select>
        </div>

        <div data-bind="
          component: {name: 'hrm-form-field-error'},
          hrmSlide,
          hrmSlideValue: control() !== null ? control().errorState : false,
          hrmSlideDuration: 150
      ">
          <!-- ko text: $parent.position.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /Position select -->


      <!-- Levels select -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
      <div class="employee-form__level"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">
          Разряд
        </label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <select data-bind="value: level,
              disable: $component.levels().length === 0,
              options: $component.levels,
              valueAllowUnset: true,
              hrmSelect,
              hrmSelectPlaceholder: 'Не выбрано', 
              hrmFormFieldSelectControl: control">
          </select>
        </div>
      </div>
      <!-- /ko -->
      <!-- /Levels select -->
    </div>


  </div>

  <div class="hrm-basic-modal-dialog__action-list">
    <button class="hrm-button hrm-basic-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-cancel-button"
            data-bind="click: function() {cancel();}">
      Отменить
    </button>

    <button class="hrm-button hrm-basic-button hrm-accent-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-submit-button"
            data-bind="click: function() {submit();}">
      Сохранить
    </button>
  </div>

</template>


<script type="text/javascript">
  $(function () {
    function PositionModal(position) {
      return {
        id: position.id,
        name: position.name,
        levels: position.levels
      };
    }

    ko.components.register('create-employee-modal-dialog', {
      viewModel: {
        createViewModel: function (params, componentInfo) {
          const $element = $(componentInfo.element);

          $element.addClass([
            'modal-dialog',
            'modal-dialog-centered',
            'hrm-modal-dialog',
            'hrm-basic-modal-dialog',
            'hrm-modal-dialog--size_large',
            'modal-dialog--create-employee'
          ]);

          const ViewModel = function () {
            this.isSubmitted = ko.observable(false);

            this.formControlErrorStateMatcher = (formControl) => {
              return ko.pureComputed(() => {
                return this.isSubmitted() && !formControl.isValid();
              });
            };

            console.log(params.data)

            this.positions = params.data.positions.map(PositionModal);
            this.levels = ko.observable([]);

            this.formModel = {
              position: ko.observable('').extend({
                required: {
                  message: 'Обязательное поле'
                }
              }),
              level: ko.observable(null),
              name: ko.observable('').extend({
                required: {
                  message: 'Обязательное поле'
                }
              })
            }

            this.validationObject = ko.validatedObservable({
              name: this.formModel.name,
              position: this.formModel.position,
            });

            this.formModel.position.subscribe(positionId => {
              this.formModel.level(null);
              if (!positionId) {
                this.levels([]);
                return;
              }

              const position = this.positions.find(p => p.id === positionId);
              if (!position) this.levels([]);
              else this.levels(position.levels);

              if (this.levels().length) this.formModel.level(this.levels()[0])
            })

            this.cancel = function () {
              if ('cancel' in params) {
                params.cancel();
              }
            };

            this.submit = function () {
              this.isSubmitted(true);

              if (this.validationObject.isValid()) {
                if ('submit' in params) {
                  params.submit(ko.toJS(this.formModel));
                }
              }
            };
          }

          return new ViewModel();
        }
      },
      template: {
        element: document.getElementById('create-employee-modal-dialog-template')
      }
    });
  });
</script>

  <script type="text/html"
        id="add-employees-modal-employee-template">
  <!-- ko let: {checkboxGroup: ko.observable(null)} -->
<div data-bind="component: {name: 'hrm-checkbox-group', params: {exportAs: checkboxGroup}}">
  <div data-bind="component: {name: 'hrm-checkbox', params: {owner: checkboxGroup, checked: employee.checked }}">
  </div>
  <label data-bind="hrmCheckboxGroupLabel, hrmCheckboxGroupLabelOwner: checkboxGroup, text: employee.name"></label>
</div>
<!-- /ko -->
</script>

<script type="text/html"
        id="add-employees-modal-position-list-template">

        <div class="employees-form__employees-scrollable-list"
        data-bind="component: { name: 'hrm-scrollable-wrapper', params: { options: {} } }">

        <!-- ko let: {checkboxGroup: ko.observable(null)} -->
        <div class="employees-form__checkbox-group">
          <div data-bind="component: {name: 'hrm-checkbox-group', params: {exportAs: checkboxGroup}}">

              <!-- ko foreach: {data: $parent.position.employees, as: 'employee'} -->
              <!-- ko if: employee.visible -->
              <div class="employees-form__checkbox">

                    <!-- ko template: { name: 'add-employees-modal-employee-template', data: {employee: employee} } -->
                    <!-- /ko -->
              </div>
              <!-- /ko -->
              <!-- /ko -->


          </div>
        </div>
        <!-- /ko -->

        </div>
</script>

<script type="text/html"
        id="add-employees-modal-other-list-template">

  <div class="employees-form__employees-scrollable-list"
  data-bind="component: { name: 'hrm-scrollable-wrapper', params: { options: {} } }">

  <!-- ko let: {checkboxGroup: ko.observable(null)} -->
  <div class="employees-form__checkbox-group">
    <div data-bind="component: {name: 'hrm-checkbox-group', params: {exportAs: checkboxGroup}}">

      <!-- ko foreach: { data: $parent.positions, as: 'position' } -->
      <div class="employees-form__position"
            data-bind="if: position.hasVisibleEmployees">
        <div class="employees-form__position-name"
              data-bind="text: position.name"></div>

        <!-- ko foreach: {data: position.employees, as: 'employee'} -->
        <!-- ko if: employee.visible -->
        <div class="employees-form__checkbox">

              <!-- ko template: { name: 'add-employees-modal-employee-template', data: {employee: employee} } -->
              <!-- /ko -->
        </div>
        <!-- /ko -->
        <!-- /ko -->

      </div>
      <!-- /ko -->
    </div>
  </div>
  <!-- /ko -->

  </div>

</script>


<template id="add-employees-position-tab-template">
  <div class="employees-form__row">
    <!-- ko let: {control: ko.observable(null), label: ko.observable(null)} -->
    <div class="hrm-form-field-switch-group"
         data-bind="hrmSwitchGroup, hrmSwitchGroupControlRef: control, hrmSwitchGroupLabelRef: label">
      <div data-bind="component: {name: 'hrm-switch', params: {exportAs: control, checked: allBranches}}"></div>
      <label data-bind="hrmSwitchGroupLabel: label">
        Все филиалы
      </label>
    </div>
    <!-- /ko -->

    <div class="employees-form__search"
         data-bind="component: {name: 'hrm-search-field', params: { termModel: term, placeholder: 'Поиск по ФИО' }}">
    </div>
  </div><!-- .employees-form__row -->


  <!-- Подгрузка сотрудников -->
  <!-- ko template: {
        foreach: hrmTemplateIf(loadingBranches(), $data),
        afterAdd: hrmFadeAfterAddFactory(200, 200),
        beforeRemove: hrmFadeBeforeRemoveFactory(200)
      } -->
  <div>
    <div class="employees-form__calculating">
      <i class="fa fa-spinner fa-pulse
                            employees-form__calculating-indicator">
      </i>
    </div>
  </div>
  <!-- /ko -->

  <div class="employees-form__tab modal-dialog__scroll">
  <!-- Отображение сотрудников -->
  <!-- ko template: {
        foreach: hrmTemplateIf(!loadingBranches(), $data),
        afterAdd: hrmFadeAfterAddFactory(200, 200),
        beforeRemove: hrmFadeBeforeRemoveFactory(200)
      } -->

  <!-- Список позиций -->
  <!-- ko ifnot: isSingle -->
  <!-- ko template: { name: 'add-employees-modal-other-list-template', data: {positions: positions} } -->
  <!-- /ko -->
  <!-- /ko -->
  <!-- /Список позиций -->

  <!-- Одна позиция -->
  <!-- ko if: isSingle -->
  <!-- ko template: { name: 'add-employees-modal-position-list-template', data: {position: positions[0]} } -->
  <!-- /ko -->
  <!-- /ko -->
  <!-- /Одна позиция -->

  <!-- /ko -->
  <!-- /Отображение сотрудников -->
  </div>

</template>

<template id="add-employees-modal-dialog-template">

  <button class="hrm-button hrm-basic-modal-dialog__close-button"
          data-bind="click: function() { cancel(); }"
          aria-label="Close">
  </button>

  <div class="hrm-basic-modal-dialog__header">
    <h2 class="hrm-basic-modal-dialog__title" data-bind="text: title">
    </h2>
  </div>

  <div class="hrm-basic-modal-dialog__body employees-form">
    <!-- ko if: tabs -->
    <div class="employees-form__tabs">
      <div style="width: 100%"
           data-bind="component: {name: 'hrm-tab-group', params: {items: tabs, activeItem: activeTab }}">
      </div>
    </div>
    <!-- /ko -->


      <!-- ko if: activePosition -->
        <!-- ko component: {
          name: 'add-employees-position-tab',
          params: {
            term: term,
            mode: 'single',
            position: activePosition()
          }
        } -->
        <!-- /ko -->
      <!-- /ko -->


      <!-- ko ifnot: activePosition -->
      <!-- Вкладка Прочие -->
        <!-- ko component: {
          name: 'add-employees-position-tab',
          params: {
            term: term,
            mode: 'list',
            positions: list
          }
        } -->
        <!-- /ko -->
      <!-- /Вкладка Прочие -->
      <!-- /ko -->

  </div>

  <div class="hrm-basic-modal-dialog__action-list">
    <button class="hrm-button hrm-basic-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-cancel-button"
            data-bind="click: function() {cancel();}">
      Сбросить
    </button>

    <button class="hrm-button hrm-basic-button hrm-accent-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-submit-button"
            data-bind="click: function() {submit();}">
      Применить
    </button>
  </div>

</template>


<script type="text/javascript">
  $(function () {
    const modes = {
      SINGLE: 'single',
      TABS: 'tabs',
      LIST: 'list'
    };

    function EmployeeModel(employeeData) {
      return {
        id: employeeData.id,
        name: employeeData.name,
        checked: ko.observable(!!employeeData.visible()),
        visible: ko.observable(true)
      }
    }

    function PositionModel(positionData) {
      const name = positionData.name;
      const id = positionData.id;
      const employees = ko.observableArray(positionData.employees().map(EmployeeModel));
      const hasVisibleEmployees = ko.observable(true);
      const visible = positionData.visible();
      const loaded = ko.observable(positionData.allEmployeesLoaded());

      function getData() {
        return {
          id,
          employees: ko.toJS(employees),
          loaded
        }
      }

      return {
        name,
        id,
        employees,
        visible,
        hasVisibleEmployees,
        loaded,
        getData
      }
    }

    function NewEmployeeModel(employeeData) {
      return {
        id: employeeData.id,
        name: employeeData.name,
        checked: ko.observable(false),
        visible: ko.observable(true),
        loaded: true,
      }
    }

    ko.components.register('add-employees-position-tab', {
      viewModel: function (params) {
        this.term = params.term;
        this.mode = params.mode || ('position' in params ? modes.SINGLE : modes.LIST);

        this.isSingle = this.mode === modes.SINGLE;

        if (this.isSingle) {
          this.positions = [params.position];
        } else {
          this.positions = params.positions;
        }

        const isAlreadyLoaded = this.positions.every(p => p.loaded());

        this.allBranches = ko.observable(isAlreadyLoaded);
        this.loadingBranches = ko.observable(false);
        this.allBranches.subscribe(value => {
          if (value) {
            this.loadingBranches(true)
            this.loadBranches(() => {
              this.loadingBranches(false);
            });
          } else {
            this.restoreEmployeesList();
          }
        });

        this.restoreEmployeesList = () => {
          this.positions.forEach(p => {
            p.loaded(false);
            const oldEmployeesList = p.employees().filter(e => !e.loaded)
            p.employees(oldEmployeesList)
          })
        };

        this.loadBranches = (cb) => {
          if (this.isSingle) {
            const position = this.positions[0];
            position.loaded(true);
            console.log('Сделать запрос, категория', position.name);
            // Данные
            const employeesList = [
              { name: 'Рабочий #1', id: position.name + '1' },
              { name: 'Рабочий #2', id: position.name + '2' },
              { name: 'Рабочий #3', id: position.name + '3' }
            ];

            // Добавить новых работников
            employeesList.forEach(e => {
              position.employees.push(NewEmployeeModel(e))
            });
          } else {
            const positionsList = this.positions.map(p => p.name)
            // Добавить новых работников в каждую категию
            updatedEmployees = this.positions.forEach(p => {
              p.loaded(true);
              const employeesList = [
                { name: 'Рабочий #1', id: p.name + '1' },
                { name: 'Рабочий #2', id: p.name + '2' },
                { name: 'Рабочий #3', id: p.name + '3' }
              ];
              employeesList.forEach(e => {
                p.employees.push(NewEmployeeModel(e))
              });
            })
          }

          setTimeout(cb, 3000)
        }
      },
      template: {
        element: 'add-employees-position-tab-template'
      }
    })

    ko.components.register('add-employees-modal-dialog', {
      viewModel: {
        createViewModel: function (params, componentInfo) {
          const $element = $(componentInfo.element);
          $element.addClass([
            'modal-dialog',
            'modal-dialog-centered',
            'hrm-modal-dialog',
            'hrm-basic-modal-dialog',
            'hrm-modal-dialog--size_large',
            'modal-dialog--add-employees'
          ]);


          const ViewModel = function () {
            this.isSubmitted = ko.observable(false);

            this.formControlErrorStateMatcher = (formControl) => {
              return ko.pureComputed(() => {
                return this.isSubmitted() && !formControl.isValid();
              });
            };

            this.mode = params.data.mode || ('position' in params.data ? modes.SINGLE : modes.TABS);

            this.positions = this.mode === modes.SINGLE
              ? [PositionModel(params.data.position)]
              : params.data.positions.map(PositionModel);

            this.term = ko.observable('');
            const termUpdateHandler = (value) => {
              console.log('upate', value)
              const formattedValue = value.toLowerCase();
              this.positions.forEach(p => {
                let hasVisibleEmployees = 0;
                p.employees().forEach(e => {
                  let isVisible = true;
                  if (formattedValue.length >= 1) {
                    const name = e.name.toLowerCase();
                    isVisible = name.indexOf(formattedValue) !== -1;
                  }
                  e.visible(isVisible);
                  if (isVisible) hasVisibleEmployees++;
                });
                p.hasVisibleEmployees(hasVisibleEmployees);
              })
            }
            this.term.subscribe(value => {
              termUpdateHandler(value);
            });

            this.tabs = null;
            this.activePosition = null;
            this.list = null;
            this.title = 'Добавить сотрудников';

            if (this.mode === modes.SINGLE) {
              this.activePosition = ko.observable(this.positions[0]);
              this.title = this.activePosition().name;
            } else if (this.mode === modes.LIST) {
              this.list = this.positions;
              this.title = 'Прочие';
            } else {
              this.list = this.positions.filter(position => !position.visible);
              const visiblePositions = this.positions.filter(position => position.visible);
              this.tabs = (() => {
                const tabs = visiblePositions.map(position => new HrmTabGroupItem(position.name));
                if (this.list.length) tabs.push(new HrmTabGroupItem('Прочие'));
                return tabs;
              })();
              this.activeTab = ko.observable(0);
              this.activePosition = ko.pureComputed(() => {
                return visiblePositions[this.activeTab()];
              });
              this.activeTab(0);
            }

            console.log('modal', ko.toJS(this.positions))

            this.cancel = function () {
              if ('cancel' in params) {
                params.cancel();
              }
            };

            this.submit = function () {
              this.isSubmitted(true);
              if ('submit' in params) {
                params.submit(this.positions.map(p => p.getData()));
              }
            };
          }

          return new ViewModel();
        }
      },
      template: {
        element: document.getElementById('add-employees-modal-dialog-template')
      }
    });
  });
</script>

  <template id="stimulation-modal-dialog-template">

  <button class="hrm-button hrm-basic-modal-dialog__close-button"
          data-bind="click: function() { cancel(); }"
          aria-label="Close">
  </button>

  <div class="hrm-basic-modal-dialog__header">
    <h2 class="hrm-basic-modal-dialog__title">
      Выписать штраф/премию смене
    </h2>
  </div>

  <div class="hrm-basic-modal-dialog__body stimulation-settings"
       data-bind="using: formModel">
    <div class="stimulation-settings__row">
      <!-- Category select -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
      <div class="stimulation-settings__select stimulation-settings__category"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">
          Категория
        </label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <select data-bind="value: category,
                   hrmSelect,
                   hrmSelectPlaceholder: 'Все', hrmSelectAllowClear: true,
                   hrmFormFieldSelectControl: control">
            <option></option>
            <option value="production">Производство</option>
            <option value="delivery">Доставка</option>
          </select>
        </div>
      </div>
      <!-- /ko -->
      <!-- /Category select -->


      <!-- Type toggler -->
      <div class="hrm-radio-group stimulation-settings__type">
        <div class="hrm-radio-group__radio hrm-radio-group__radio--theme_negative">
          <input class="hrm-radio-group__radio-input"
                 data-bind="checked: stimulationType"
                 type="radio"
                 value="fine"
                 id="fine-radio" />
          <label class="hrm-radio-group__radio-label"
                 for="fine-radio">
            Штраф
          </label>
        </div>

        <div class="hrm-radio-group__radio hrm-radio-group__radio--theme_positive">
          <input class="hrm-radio-group__radio-input"
                 data-bind="checked: stimulationType"
                 type="radio"
                 value="bonus"
                 id="bonus-radio" />
          <label class="hrm-radio-group__radio-label"
                 for="bonus-radio">
            Премия
          </label>
        </div>
      </div>
      <!-- /Type toggler -->
    </div>


    <div class="stimulation-settings__row">
      <!-- Base select -->

      <!-- ko if: stimulationType() === 'fine' -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
      <div class="stimulation-settings__select stimulation-settings__base"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">
          Основание штрафа
        </label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <select data-bind="value: base,
              hrmSelect,
              hrmSelectSearchEnabled: true,
              hrmSelectPlaceholder: 'Не выбрано', hrmSelectAllowClear: true,
              hrmFormFieldSelectControl: control,
              hrmFormFieldSelectControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)">

            <option></option>
            <!-- ko foreach: $component.fines -->
            <optgroup data-bind="attr: { label: name }">
              <!-- ko foreach: items -->
              <option data-bind="value: id, text: name"></option>
              <!-- /ko -->
            </optgroup>
            <!-- /ko -->
          </select>
        </div>

        <div data-bind="component: {name: 'hrm-form-field-error'},
            hrmSlide,
            hrmSlideValue: control() !== null ? control().errorState : false,
            hrmSlideDuration: 150">
          <!-- ko text: $parent.base.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /ko -->


      <!-- ko ifnot: stimulationType() === 'fine' -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
      <div class="stimulation-settings__select stimulation-settings__base"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">
          Основание премии
        </label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <select data-bind="value: base,
              hrmSelect,
              hrmSelectSearchEnabled: true,
              hrmSelectPlaceholder: 'Не выбрано', hrmSelectAllowClear: true,
              hrmFormFieldSelectControl: control,
              hrmFormFieldSelectControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)">

            <option></option>
            <!-- ko foreach: $component.bonuses -->
            <optgroup data-bind="attr: { label: name }">
              <!-- ko foreach: items -->
              <option data-bind="value: id, text: name"></option>
              <!-- /ko -->
            </optgroup>
            <!-- /ko -->
          </select>
        </div>

        <div data-bind="component: {name: 'hrm-form-field-error'},
            hrmSlide,
            hrmSlideValue: control() !== null ? control().errorState : false,
            hrmSlideDuration: 150">
          <!-- ko text: $parent.base.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /ko -->
      <!-- /Base select -->


    </div>

    <div class="stimulation-settings__row">
      <!-- Author select -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
      <div class="stimulation-settings__select stimulation-settings__author"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">
          <!-- ko text: stimulationType() === 'fine' ? 'Автор штрафа' : 'Автор премии' -->
          <!-- /ko -->
        </label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <select data-bind="value: author,
            hrmSelect,
            hrmSelectSearchEnabled: true,
            hrmSelectPlaceholder: 'Не выбран', hrmSelectAllowClear: true,
            hrmFormFieldSelectControl: control,
            hrmFormFieldSelectControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)">
            <option></option>
            <!-- ko foreach: $component.authors -->
            <option data-bind="value: id, text: name"></option>
            <!-- /ko -->
          </select>
        </div>

        <div data-bind="component: {name: 'hrm-form-field-error'},
        hrmSlide,
        hrmSlideValue: control() !== null ? control().errorState : false,
        hrmSlideDuration: 150">
          <!-- ko text: $parent.author.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /Author select -->

      <!-- Sum field -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null)} -->
      <div class="stimulation-settings__sum"
           data-bind="
           hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label
       ">
        <label data-bind="hrmFormFieldLabel: label">Сумма, ₽</label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <input data-bind="
                   attr: {readonly: stimulationType() === 'fine'},
                   textInput: sum,
                   hrmFormFieldInputControl: control,
                   hrmFormFieldInputControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)
               "
                 type="number">
        </div>

        <div data-bind="
               component: {name: 'hrm-form-field-error'},
               hrmSlide,
               hrmSlideValue: control() !== null ? control().errorState : false,
               hrmSlideDuration: 150
           ">
          <!-- ko text: $parent.sum.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /Sum field -->
    </div>

    <div class="stimulation-settings__row">
      <!-- Comment field -->
      <!-- ko let: {control: ko.observable(null)} -->
      <div class="stimulation-settings__comment"
           data-bind="
           hrmFormField, hrmFormFieldControlRef: control
       ">

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control, hrmFormFieldBasisAllowClear">
          <textarea data-bind="
                   textInput: comment,
                   hrmFormFieldInputControl: control,
                   hrmAutoResize
               "
                    placeholder="Комментарий"></textarea>
        </div>

      </div>
      <!-- /ko -->
      <!-- /Comment field -->
    </div>


  </div>

  <div class="hrm-basic-modal-dialog__action-list">
    <button class="hrm-button hrm-basic-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-cancel-button"
            data-bind="click: function() {cancel();}">
      Отменить
    </button>

    <button class="hrm-button hrm-basic-button hrm-accent-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-submit-button"
            data-bind="click: function() {submit();}">
      Сохранить
    </button>
  </div>

</template>


<script type="text/javascript">
  $(function () {
    ko.components.register('stimulation-modal-dialog', {
      viewModel: {
        createViewModel: function (params, componentInfo) {
          const $element = $(componentInfo.element);

          $element.addClass([
            'modal-dialog',
            'modal-dialog-centered',
            'hrm-modal-dialog',
            'hrm-basic-modal-dialog',
            'hrm-modal-dialog--size_large',
            'modal-dialog--stimulation'
          ]);

          const ViewModel = function () {
            this.isSubmitted = ko.observable(false);

            this.fines = params.data.fines;
            this.bonuses = params.data.bonuses;
            this.authors = params.data.authors;

            this.formControlErrorStateMatcher = (formControl) => {
              return ko.pureComputed(() => {
                return this.isSubmitted() && !formControl.isValid();
              });
            };

            /* fine/bonus */
            this.stimulationTypes = {
              "FINE": 'fine',
              "BONUS": 'bonus'
            }

            this.formModel = {
              category: ko.observable(params.data.category),
              stimulationType: ko.observable(this.stimulationTypes.FINE),
              base: ko.observable('').extend({
                required: {
                  message: 'Обязательное поле'
                }
              }),
              author: ko.observable('').extend({
                required: {
                  message: 'Обязательное поле'
                }
              }),
              sum: ko.observable(0).extend({
                required: {
                  message: 'Обязательное поле'
                },
                number: {
                  message: 'Некорректный формат'
                }
              }),
              comment: ko.observable('').extend({

              }),
            };

            this.reset = function () {
              this.formModel.base('');
              this.formModel.sum('');
              this.formModel.author('');
              this.formModel.comment('');
            }

            this.formModel.stimulationType.subscribe(() => {
              this.reset();
            });

            const getFineById = (fineId) => {
              for (let i in this.fines) {
                const items = this.fines[i].items;
                for (let k in items) {
                  const fine = items[k];
                  if (fine.id == fineId) return fine;
                }
              }
            };

            this.formModel.base.subscribe((value) => {
              if (this.formModel.stimulationType() !== this.stimulationTypes.FINE) return;
              if (!value) this.formModel.sum(0);
              const fine = getFineById(value);
              this.formModel.sum(fine ? fine.sum : 0);
            });

            this.validationObject = ko.validatedObservable({
              base: this.formModel.base,
              author: this.formModel.author,
              sum: this.formModel.sum,
            });

            this.cancel = function () {
              if ('cancel' in params) {
                params.cancel();
              }
            };

            this.submit = function () {
              this.isSubmitted(true);

              if (this.validationObject.isValid()) {
                if ('submit' in params) {

                  params.submit({
                    category: this.formModel.category(),
                    stimulationType: this.formModel.stimulationType(),
                    base: this.formModel.base(),
                    author: this.formModel.author(),
                    comment: this.formModel.comment(),
                    sum: parseFloat(this.formModel.sum()),
                  });
                }
              }

            };
          }

          return new ViewModel();
        }
      },
      template: {
        element: document.getElementById('stimulation-modal-dialog-template')
      }
    });
  });
</script>


  <script type="text/javascript">
  $(function () {

    ko.components.register('compensations-modal-dialog', {
      viewModel: {
        createViewModel: function (params, componentInfo) {
          const $element = $(componentInfo.element);

          $element.addClass([
            'modal-dialog',
            'modal-dialog-centered',
            'hrm-modal-dialog',
            'hrm-basic-modal-dialog',
            'modal-dialog--compensations'
          ]);

          const ViewModel = function () {
            this.isSubmitted = ko.observable(false);

            this.formControlErrorStateMatcher = (formControl) => {
              return ko.pureComputed(() => {
                return this.isSubmitted() && !formControl.isValid();
              });
            };

            this.compensations = params.data.compensations;
            this.employee = params.data.employee;

            let currentCompensation = null;

            this.compensationId = ko.observable('').extend({
              required: {
                message: 'Обязательное поле'
              }
            });
            this.sum = ko.observable(0);

            this.compensationId.subscribe(v => {
              currentCompensation = this.compensations.find(c => c.id == this.compensationId());
              if (currentCompensation) this.sum(currentCompensation.sum);
              else this.sum(0);
            })
            if (this.employee.compensation()) {
              currentCompensation = this.employee.compensation();
              this.compensationId(this.employee.compensation().id);
            }

            this.cancel = function () {
              if ('cancel' in params) {
                params.cancel();
              }
            };

            this.submit = function () {
              this.isSubmitted(true);

              if (currentCompensation) {
                this.employee.compensation(currentCompensation);
                if ('submit' in params) {
                  params.submit();
                }
              }

            };
          }

          return new ViewModel();
        }
      },
      template: {
        element: document.getElementById('compensations-modal-dialog-template')
      }
    });
  });
</script>

<template id="compensations-modal-dialog-template">

  <button class="hrm-button hrm-basic-modal-dialog__close-button"
          data-bind="click: function() { cancel(); }"
          aria-label="Close">
  </button>

  <div class="hrm-basic-modal-dialog__header">
    <h2 class="hrm-basic-modal-dialog__title">
      Создать сотрудника
    </h2>
  </div>

  <div class="hrm-basic-modal-dialog__body compensation-form">

    <div class="compensation-form__row">
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
      <div class="compensation-form__id"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">
          Компенсация
        </label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <select data-bind="value: compensationId,
              options: $component.compensations,
              optionsText: 'name',
              optionsValue: 'id',
              valueAllowUnset: true,
              hrmSelect,
              hrmSelectPlaceholder: 'Компенсация',
              hrmSelectSearchEnabled: true,
              hrmSelectAllowClear: true,
              hrmFormFieldSelectControl: control,
              hrmFormFieldSelectControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)">
          </select>
        </div>

        <div data-bind="
          component: {name: 'hrm-form-field-error'},
          hrmSlide,
          hrmSlideValue: control() !== null ? control().errorState : false,
          hrmSlideDuration: 150
      ">
          <!-- ko text: $parent.compensationId.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->



      <!-- ko let: {control: ko.observable(null), label: ko.observable(null)} -->
      <div class="compensation-form__sum"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">Сумма, ₽</label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <input data-bind="
              value: sum,
              hrmFormFieldInputControl: control
          " readonly>
        </div>


      </div>
      <!-- /ko -->

    </div>

  </div>

  <div class="hrm-basic-modal-dialog__action-list">
    <button class="hrm-button hrm-basic-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-cancel-button"
            data-bind="click: function() {cancel();}">
      Отменить
    </button>

    <button class="hrm-button hrm-basic-button hrm-accent-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-submit-button"
            data-bind="click: function() {submit();}">
      Сохранить
    </button>
  </div>

</template>

  <script type="text/javascript">
  $(function () {

    ko.components.register('employee-remove-workload-partially-modal-dialog', {
      viewModel: {
        createViewModel: function (params, componentInfo) {
          const $element = $(componentInfo.element);

          $element.addClass([
            'modal-dialog',
            'modal-dialog-centered',
            'hrm-modal-dialog',
            'hrm-basic-modal-dialog',
            'modal-dialog--remove-workload'
          ]);

          const ViewModel = function () {
            this.employee = params.data.employee;
            this.isSubmitted = ko.observable(false);

            this.salary = ko.observable(this.employee.salary()).extend({
              required: {
                message: 'Обязательное поле'
              }
            });
            this.normRatio = ko.observable(this.employee.normRatio()).extend({
              required: {
                message: 'Обязательное поле'
              }
            });
            this.bonusRatio = ko.observable(this.employee.bonusRatio()).extend({
              required: {
                message: 'Обязательное поле'
              }
            });
            this.depremationRatio = ko.observable(this.employee.depremationRatio()).extend({
              required: {
                message: 'Обязательное поле'
              }
            });

            this.validationObject = ko.validatedObservable({
              salary: this.salary,
              normRatio: this.normRatio,
              bonusRatio: this.bonusRatio,
              depremationRatio: this.depremationRatio,
            });

            this.formControlErrorStateMatcher = (formControl) => {
              return ko.pureComputed(() => {
                return this.isSubmitted() && !formControl.isValid();
              });
            };

            this.cancel = function () {
              if ('cancel' in params) {
                params.cancel();
              }
            };

            this.submit = function () {
              this.isSubmitted(true);

              if (this.validationObject.isValid()) {
                this.employee.salary(this.salary());
                this.employee.normRatio(this.normRatio());
                this.employee.bonusRatio(this.bonusRatio());
                this.employee.depremationRatio(this.depremationRatio());
                if ('submit' in params) {
                  params.submit();
                }
              }

            };
          }

          return new ViewModel();
        }
      },
      template: {
        element: document.getElementById('remove-workload-partially-modal-dialog-template')
      }
    });


    ko.components.register('employee-remove-workload-completely-modal-dialog', {
      viewModel: {
        createViewModel: function (params, componentInfo) {
          const $element = $(componentInfo.element);

          $element.addClass([
            'modal-dialog',
            'modal-dialog-centered',
            'hrm-modal-dialog',
            'hrm-basic-modal-dialog',
            'modal-dialog--remove-workload'
          ]);

          const ViewModel = function () {
            this.employee = params.data.employee;

            this.cancel = function () {
              if ('cancel' in params) {
                params.cancel();
              }
            };

            this.submit = function () {
              this.employee.normRatio(0);
                this.employee.bonusRatio(0);
                this.employee.depremationRatio(0);

              if ('submit' in params) {
                params.submit();
              }
            };
          }

          return new ViewModel();
        }
      },
      template: {
        element: document.getElementById('remove-workload-completely-modal-dialog-template')
      }
    });
  });
</script>

<template id="remove-workload-completely-modal-dialog-template">

  <button class="hrm-button hrm-basic-modal-dialog__close-button" data-bind="click: function() { cancel(); }"
    aria-label="Close">
  </button>

  <div class="hrm-basic-modal-dialog__header">
    <h2 class="hrm-basic-modal-dialog__title">
      Полностью освободить от нагрузки
      <br>
      <span class="font-weight-normal" data-bind="text: employee.name"></span>
    </h2>
  </div>

  <div class="hrm-basic-modal-dialog__body">
    Для сотрудника <span class="bold" data-bind="text: employee.name"></span> будет полностью снята нагрузка за текущую
    смену. Сотрудник за отработанную смену получит только свою заработную плату без учёта коэффициентов: норматива,
    премирования, депремирования.
  </div>

  <div class="hrm-basic-modal-dialog__action-list">
    <button class="hrm-button hrm-basic-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-cancel-button" data-bind="click: function() {cancel();}">
      Отменить
    </button>

    <button class="hrm-button hrm-basic-button hrm-accent-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-submit-button" data-bind="click: function() {submit();}">
      Снять нагрузку
    </button>
  </div>

</template>

<template id="remove-workload-partially-modal-dialog-template">

  <button class="hrm-button hrm-basic-modal-dialog__close-button" data-bind="click: function() { cancel(); }"
    aria-label="Close">
  </button>

  <div class="hrm-basic-modal-dialog__header">
    <h2 class="hrm-basic-modal-dialog__title">
      Частично освободить от нагрузки
      <br>
      <span class="font-weight-normal" data-bind="text: employee.name"></span>
    </h2>
  </div>

  <div class="hrm-basic-modal-dialog__body">

    <div class="row">
      <div class="col col-6 col-md-3">
        <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
        <div data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
          <label data-bind="hrmFormFieldLabel: label">
            Оклад, ₽

            <button
            class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-circle-icon-button--size_small"
            data-bind="hrmTooltip, hrmTooltipText: 'Оклад, ₽'"></button>
          </label>



          <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
            <input data-bind="
                  textInput: salary,
                  hrmMask, hrmMaskPattern: 'decimal',
                  hrmMaskOptions: {digits: '0,2', groupSeparator: ' ', autoGroup: true, allowMinus: false, rightAlign: false},
                  hrmFormFieldInputControl: control,
                  hrmFormFieldInputControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)
              " placeholder="0" im-insert="true" class="hrm-form-field__control hrm-form-field__control--type_input"
              id="hrm-form-field-input-control-2">
          </div>

          <div data-bind="
          component: {name: 'hrm-form-field-error'},
          hrmSlide,
          hrmSlideValue: control() !== null ? control().errorState : false,
          hrmSlideDuration: 150">
            <!-- ko text: $parent.salary.error() -->
            <!-- /ko -->
          </div>
        </div>
        <!-- /ko -->
      </div>
      <div class="col col-6 col-md-3">
        <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
        <div data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
          <label data-bind="hrmFormFieldLabel: label">
            Коэфф. норм.
            <button
            class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral  hrm-circle-icon-button--size_small"
            data-bind="hrmTooltip, hrmTooltipText: 'Коэффициент норматива'"></button>
          </label>



          <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
            <input data-bind="
                  textInput: normRatio,
                  hrmMask, hrmMaskPattern: 'decimal',
                  hrmMaskOptions: {digits: '0,2', groupSeparator: ' ', autoGroup: true, allowMinus: false, rightAlign: false},
                  hrmFormFieldInputControl: control,
                  hrmFormFieldInputControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)
              " placeholder="0" im-insert="true" class="hrm-form-field__control hrm-form-field__control--type_input"
              id="hrm-form-field-input-control-2">
          </div>

          <div data-bind="
          component: {name: 'hrm-form-field-error'},
          hrmSlide,
          hrmSlideValue: control() !== null ? control().errorState : false,
          hrmSlideDuration: 150">
            <!-- ko text: $parent.salary.error() -->
            <!-- /ko -->
          </div>
        </div>
        <!-- /ko -->
      </div>
      <div class="col col-6 col-md-3">
        <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
        <div data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
          <label data-bind="hrmFormFieldLabel: label">
            Коэфф. прем-я
            <button
            class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral  hrm-circle-icon-button--size_small"
            data-bind="hrmTooltip, hrmTooltipText: 'Коэффициент премирования'"></button>
          </label>



          <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
            <input data-bind="
                  textInput: bonusRatio,
                  hrmMask, hrmMaskPattern: 'decimal',
                  hrmMaskOptions: {digits: '0,2', groupSeparator: ' ', autoGroup: true, allowMinus: false, rightAlign: false},
                  hrmFormFieldInputControl: control,
                  hrmFormFieldInputControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)
              " placeholder="0" im-insert="true" class="hrm-form-field__control hrm-form-field__control--type_input"
              id="hrm-form-field-input-control-2">
          </div>

          <div data-bind="
          component: {name: 'hrm-form-field-error'},
          hrmSlide,
          hrmSlideValue: control() !== null ? control().errorState : false,
          hrmSlideDuration: 150">
            <!-- ko text: $parent.salary.error() -->
            <!-- /ko -->
          </div>
        </div>
        <!-- /ko -->
      </div>
      <div class="col col-6 col-md-3">
        <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
        <div data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
          <label data-bind="hrmFormFieldLabel: label">
            Коэфф. депр-я

            <button
            class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-circle-icon-button--size_small"
            data-bind="hrmTooltip, hrmTooltipText: 'Коэффициент депремирования'"></button>
          </label>



          <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
            <input data-bind="
                  textInput: depremationRatio,
                  hrmMask, hrmMaskPattern: 'decimal',
                  hrmMaskOptions: {digits: '0,2', groupSeparator: ' ', autoGroup: true, allowMinus: false, rightAlign: false},
                  hrmFormFieldInputControl: control,
                  hrmFormFieldInputControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)
              " placeholder="0" im-insert="true" class="hrm-form-field__control hrm-form-field__control--type_input"
              id="hrm-form-field-input-control-2">
          </div>

          <div data-bind="
          component: {name: 'hrm-form-field-error'},
          hrmSlide,
          hrmSlideValue: control() !== null ? control().errorState : false,
          hrmSlideDuration: 150">
            <!-- ko text: $parent.salary.error() -->
            <!-- /ko -->
          </div>
        </div>
        <!-- /ko -->
      </div>
    </div>

  </div>

  <div class="hrm-basic-modal-dialog__action-list">
    <button class="hrm-button hrm-basic-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-cancel-button" data-bind="click: function() {cancel();}">
      Отменить
    </button>

    <button class="hrm-button hrm-basic-button hrm-accent-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-submit-button" data-bind="click: function() {submit();}">
      Сохранить
    </button>
  </div>

</template>
  <template id="routes-modal-dialog-template">
  <!-- ko template: { afterRender: afterRender } -->
  <!-- ko if: viewportSize().width <= HRM_BREAKPOINTS.mobileMaxWidth -->
  <button class="hrm-button modal-dialog-content__close"
          data-bind="click: function() {cancel();}"
          aria-label="Close">
  </button>
  <!-- /ko -->

  <!-- ko if: !isLoading() -->
  <div class="routes" data-bind="hrmScrollable">
  <table data-bind="hrmTable"
         class="routes-table">
    <thead>
      <tr>
        <th class="routes-table__cell routes-table__cell--route">
          <div class="routes-table__cell-content">
            Заказ/маршрут
            <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-table__head-cell-info-button positions-table__info-icon"
                    data-bind="hrmTooltip, hrmTooltipText: 'Заказ/маршрут'"></button>
          </div>
        </th>
        <th class="routes-table__cell routes-table__cell--dates">
          <div class="routes-table__cell-content">
            Начало/завершение
            <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-table__head-cell-info-button positions-table__info-icon"
                    data-bind="hrmTooltip, hrmTooltipText: 'Начало/завершение'"></button>
          </div>
        </th>
        <th class="routes-table__cell routes-table__cell--dist">
          <div class="routes-table__cell-content">
            Дистанция, км
            <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-table__head-cell-info-button positions-table__info-icon"
                    data-bind="hrmTooltip, hrmTooltipText: 'Дистанция, км'"></button>
          </div>
        </th>
        <th class="routes-table__cell routes-table__cell--time">
          <div class="routes-table__cell-content">
            Расч./факт. время в пути
            <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-table__head-cell-info-button positions-table__info-icon"
                    data-bind="hrmTooltip, hrmTooltipText: 'Расч./факт. время в пути'"></button>
          </div>
        </th>
      </tr>
    </thead>
    <tbody>
      <!-- ko foreach: routes -->
      <tr class="routes-table__route-row">
        <td colspan="3">

          <!-- ko foreach: orders -->
          <div class="routes-table__cell-content routes-table__route">
            <span class="routes-table__route-id"
                  data-bind="text: id"></span>
            <span class="routes-table__route-address"
                  data-bind="text: address"></span>
          </div>
          <!-- /ko -->

        </td>
      </tr>
      <tr>
        <td class="routes-table__cell routes-table__cell--route">
          <!-- ko foreach: orders -->
          <div class="routes-table__cell-content routes-table__route">
            <span class="routes-table__route-id"
                  data-bind="text: id"></span>
            <span class="routes-table__route-address"
                  data-bind="text: address"></span>
          </div>
          <!-- /ko -->
        </td>
        <td class="routes-table__cell routes-table__cell--dates">
          <div class="routes-table__cell-content">
            <div data-bind="text: startedAt"></div>
            <div data-bind="text: finishedAt"></div>
          </div>
        </td>
        <td align="right"
            class="routes-table__cell routes-table__cell--dist">
          <div class="routes-table__cell-content"
               data-bind="text: distKm">
          </div>
        </td>
        <td class="routes-table__cell routes-table__cell--time">
          <div class="routes-table__cell-content">
            <div data-bind="text: estimatedTime"></div>
            <div data-bind="text: actualTime"></div>
          </div>
        </td>
      </tr>
      <!-- /ko -->
    </tbody>
  </table>
</div>
  <!-- /ko -->

  <!-- ko if: isLoading() -->
  <div class="loader">
    <i class="fa fa-spinner fa-pulse loader__indicator">
    </i>
  </div>
  <!-- /ko -->
  <!-- /ko -->
</template>


<script type="text/javascript">
    ko.components.register('routes-modal-dialog', {
        viewModel: {
            createViewModel: function (params, componentInfo) {
                const $element = $(componentInfo.element);
                $element.addClass([
                    'modal-dialog-content',
                    'modal-dialog-content--initializing'
                ]);

                return new (function () {
                    this.viewportSize = ko.observable({ width: $(window).width(), height: $(window).height() });
                    this.windowResizeHandler = () => {
                        this.viewportSize({ width: $(window).width(), height: $(window).height() });
                    };
                    $(window).on('resize', this.windowResizeHandler);

                    this.initializing = ko.observable(true);

                    this.isSubmitted = ko.observable(true);
                    this.isLoading = ko.observable(true);

                    this.formControlErrorStateMatcher = function (formControl) {
                        return ko.pureComputed(() => {
                            return this.isSubmitted() && !formControl.isValid();
                        });
                    };

                    this.employee = params.data.employee;

                    this.routes = ko.observableArray([]);

                    this.loadData = () => {
                        const id = this.employee.id;

                        setTimeout(() => {
                            const data = [
                                {
                                    orders: [
                                        {
                                            id: 58664,
                                            address: 'г. Москва, пос. Сосенское, ул. СНТ Филатов луг, д. 2',
                                        }
                                    ],
                                    startedAt: '03.04.2020 11:44',
                                    finishedAt: '03.04.2020 12:38',
                                    distKm: 12.4,
                                    estimatedTime: '0:55',
                                    actualTime: '0:35'
                                },
                                {
                                    orders: [
                                        {
                                            id: 58664,
                                            address: 'г. Москва, ул. Летчика Грицевца, д. 9',
                                        },
                                        {
                                            id: 58664,
                                            address: 'МО, г. Московский, мкрн. 1, д.29',
                                        }
                                    ],
                                    startedAt: '03.04.2020 11:44',
                                    finishedAt: '03.04.2020 12:38',
                                    distKm: 16.9,
                                    estimatedTime: '0:55',
                                    actualTime: '0:35'
                                },
                                {
                                    orders: [
                                        {
                                            id: 58664,
                                            address: 'г. Москва, пос. Сосенское, ул. СНТ Филатов луг, д. 2',
                                        }
                                    ],
                                    startedAt: '03.04.2020 11:44',
                                    finishedAt: '03.04.2020 12:38',
                                    distKm: 12.4,
                                    estimatedTime: '0:55',
                                    actualTime: '0:35'
                                }
                            ];
                            this.routes(data);

                            this.isLoading(false);

                        }, 3000);
                    };

                    this.loadData();

                    this.save = function () {
                        this.isSubmitted(true);


                    };

                    this.cancel = function () {
                        params.cancel();
                    };


                    this.afterRender = function () {
                        $element.removeClass('modal-dialog-content--initializing');
                        this.initializing(false);
                    }.bind(this);

                    this.dispose = function () {
                        $(window).off('resize', this.windowResizeHandler);
                    };
                });
            }
        },
        template: { element: 'routes-modal-dialog-template' }
    });
</script>

  <template id="orders-table-template">
  <!-- ko let: { activeOrder: ko.observable(null) } -->
  <table class="details-modal-orders-table"
         data-bind="hrmTable">
    <thead>
      <tr>
        <th class="details-modal-orders-table__cell details-modal-orders-table__cell--order">
          <div class="details-modal-orders-table__cell-content">
            № заказа
            <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-table__head-cell-info-button positions-table__info-icon"
                    data-bind="hrmTooltip, hrmTooltipText: '№ заказа'"></button>
          </div>
        </th>

        <th class="details-modal-orders-table__cell details-modal-orders-table__cell--time">
          <div class="details-modal-orders-table__cell-content">
            Время доставки
            <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-table__head-cell-info-button positions-table__info-icon"
                    data-bind="hrmTooltip, hrmTooltipText: 'Время доставки'"></button>
          </div>
        </th>

        <th class="details-modal-orders-table__cell details-modal-orders-table__cell--sum">
          <div class="details-modal-orders-table__cell-content">
            Сумма заказа, ₽
            <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-table__head-cell-info-button positions-table__info-icon"
                    data-bind="hrmTooltip, hrmTooltipText: 'Сумма заказа, ₽'"></button>
          </div>
        </th>

        <th class="details-modal-orders-table__cell details-modal-orders-table__cell--operator">
          <div class="details-modal-orders-table__cell-content">
            Обработал
            <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-table__head-cell-info-button positions-table__info-icon"
                    data-bind="hrmTooltip, hrmTooltipText: 'Обработал'"></button>
          </div>
        </th>


      </tr>
    </thead>

    <tbody>
      <!-- ko foreach: { data: orders, as: 'order' } -->

      <tr data-bind="css: {
        'details-modal-orders-table__active-row': activeOrder() === order
      }">
        <td class="details-modal-orders-table__cell">
          <div class="details-modal-orders-table__cell-content"
               data-bind="text: id"></div>
        </td>
        <td class="details-modal-orders-table__cell">
          <div class="details-modal-orders-table__cell-content"
               data-bind="text: deliveryTime"></div>
        </td>
        <td class="details-modal-orders-table__cell">
          <div class="details-modal-orders-table__cell-content"
               data-bind="text: sum"></div>
        </td>
        <td class="details-modal-orders-table__cell">
          <div class="details-modal-orders-table__cell-content details-modal-orders-table__operator">

            <div data-bind="text: operatorName"></div>
            <button class="hrm-button hrm-circle-icon-button hrm-circle-arrow-down-icon-button hrm-circle-icon-button--theme_neutral"
                    data-bind="click: function() {
                      if (activeOrder() === order) {
                       activeOrder(null);
                      } else {
                        activeOrder(order);
                      }

                    }, css: {
              'active': activeOrder() === order
            }">
            </button>
          </div>
        </td>
      </tr>

      <!-- ko template: {
        foreach: hrmTemplateIf(activeOrder() === order, $data),
        afterAdd: $component.afterDetailsAdd,
        beforeRemove: $component.beforeDetailsRemove,
      } -->
      <tr class="details-modal-orders-table__order-row">
        <td colspan="4">

          <div class="details-modal-orders-table__order order-block details-block">
            <div class="order-block__header">
              <h3 class="order-block__title">Состав заказа</h3>
              <div class="order-block__sum">
                <!-- ko text: sum + '₽' -->
                <!-- /ko -->
              </div>
            </div>

            <table class="order-block__items"
            data-bind="hrmTable">
              <tbody>
                <!-- ko foreach: items -->
                <tr>
                  <td>
                    <!-- ko text: name -->
                    <!-- /ko -->
                  </td>

                  <td>
                    <!-- ko text: count -->
                    <!-- /ko -->
                  </td>

                  <td>
                    <!-- ko text: price -->
                    <!-- /ko -->
                  </td>
                </tr>
                <!-- /ko -->
              </tbody>
            </table>

            <div class="order-block__info">

              <div class="order-block__processing">
                <h3 class="order-block__title">История изменений</h3>
                <table class="order-processing-table"
                data-bind="hrmTable">
                <tbody>
                  <tr class="order-processing-table__row order-processing-table__row--created"
                      data-bind="css: {
                    'order-processing-table__row--warning_light': true
                  }">
                    <td>
                      Создан/открыт
                    </td>
                    <td>
                      <!-- ko text: processing.createdAt -->
                      <!-- /ko -->
                    </td>
                  </tr>
                  <tr class="order-processing-table__row order-processing-table__row--confirmed"
                      data-bind="css: {
                    'order-processing-table__row--warning_medium': true
                  }">
                    <td>
                      Подтвержден
                    </td>
                    <td>
                      <!-- ko text: processing.confirmedAt -->
                      <!-- /ko -->
                    </td>
                  </tr>
                  <tr class="order-processing-table__row order-processing-table__row--printed"
                      data-bind="css: {
                    'order-processing-table__row--warning_hard': true
                  }">
                    <td>
                      Распечатан
                    </td>
                    <td>
                      <!-- ko text: processing.printedAt -->
                      <!-- /ko -->
                    </td>
                  </tr>
                  <tr class="order-processing-table__row order-processing-table__row--ready">
                    <td>
                      Приготовлен
                    </td>
                    <td>
                      <!-- ko text: processing.readyAt -->
                      <!-- /ko -->
                    </td>
                  </tr>
                  <tr class="order-processing-table__row order-processing-table__row--sended">
                    <td>
                      Отправлен
                    </td>
                    <td>
                      <!-- ko text: processing.sendedAt -->
                      <!-- /ko -->
                    </td>
                  </tr>
                  <tr class="order-processing-table__row order-processing-table__row--paid">
                    <td>
                      Оплачен
                    </td>
                    <td>
                      <!-- ko text: processing.paidAt -->
                      <!-- /ko -->
                    </td>
                  </tr>
                  <tr class="order-processing-table__row order-processing-table__row--delivered">
                    <td>
                      Доставлен
                    </td>
                    <td>
                      <!-- ko text: processing.deliveredAt -->
                      <!-- /ko -->
                    </td>
                  </tr>
                  </tbody>
                </table>
              </div>

              <div class="order-block__data">
                <div class="order-block__data-block">
                  <h4 class="order-block__title">Оператор</h4>
                  <div data-bind="text: operatorName"></div>
                </div>
                <div class="order-block__data-block">
                  <h4 class="order-block__title">Водитель</h4>

                  <!-- ko if: true -->
                  <!-- ko let: {control: ko.observable(null), driverValue: ko.observable(order.driverId) } -->

                  <div class="order-block__driver"
                       data-bind="hrmFormField, hrmFormFieldControlRef: control">

                    <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
                      <select data-bind="bindInner, value: driverValue,
                          valueAllowUnset: true,
                          change: function() {
                            $component.changeDriver(driverValue());
                          },
                          hrmSelect,
                          hrmFormFieldSelectControl: control">
                          <!-- ko foreach: $component.employees -->
                          <option data-bind="value: id, text: name"></option>
                          <!-- /ko -->
                      </select>
                    </div>

                  </div>
                  <!-- /ko -->

                  <!-- /ko -->

                  <!-- ko ifnot: true -->
                  <div data-bind="text: driverName"></div>
                  <!-- /ko -->
                </div>
                <div class="order-block__data-block order-block__delivery">
                  <h4 class="order-block__title">Доставка</h4>

                  <div class="order-block__delivery-item">
                    <i class="far fa-clock"></i>
                    <span data-bind="text: delivery.date"></span>
                  </div>
                  <div class="order-block__delivery-item">
                    <i class="far fa-exclamation-circle"></i>
                    <span data-bind="text: delivery.time"></span>
                  </div>
                  <div class="order-block__delivery-item">
                    <i class="fal fa-map-marker-alt"></i>
                    <span data-bind="text: delivery.address"></span>
                  </div>
                </div>

              </div>

            </div>

          </div>

        </td>
      </tr>
      <!-- /ko -->

      <!-- /ko -->
    </tbody>

    <tfoot>
      <tr>
        <td colspan="4">
          <div class="details-modal-orders-table__total">
            <div>
              Всего заказов: <b data-bind="text: orders.length"></b>
            </div>
            <div>
              Сумма заказов: <b data-bind="text: $component.getOrdersSum(orders)"></b>
            </div>
          </div>
        </td>
      </tr>
    </tfoot>
  </table>
  <!-- /ko -->
</template>


<template id="driver-details-modal-dialog-template">
  <!-- ko template: { afterRender: afterRender } -->
    <!-- ko if: viewportSize().width <= HRM_BREAKPOINTS.mobileMaxWidth -->
    <button class="hrm-button modal-dialog-content__close"
            data-bind="click: function() {cancel();}"
            aria-label="Close">
    </button>
    <!-- /ko -->

    <!-- ko if: !isLoading() -->
      <div class="modal-dialog-content__header">
        <div>
        <div class="modal-dialog-content__title">
          Заказы водителя
        </div>

        <!-- ko let: {control: ko.observable(null) } -->
        <div data-bind="hrmFormField, hrmFormFieldControlRef: control">

          <div class="driver-name"  data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
            <select data-bind="value: employeeId,
            valueAllowUnset: true,
            options: $component.employees,
            optionsText: 'name',
            optionsValue: 'id',
            hrmSelect,
            hrmFormFieldSelectControl: control">
            </select>
          </div>

        </div>

        <!-- /ko -->
      </div>
      </div>

      <div class="details-modal-orders">
        <div class="details-modal-orders-tabs"
            data-bind="component: {name: 'hrm-tab-group', params: {items: tabs, activeItem: activeTab }}">
        </div>

        <!-- ko template: {
            foreach: hrmTemplateIf(activeTab() === 0, $data),
            afterAdd: hrmFadeAfterAddFactory(200, 200),
            beforeRemove: hrmFadeBeforeRemoveFactory(200)
        } -->
        <div class="details-modal-orders__scroll"
            data-bind="hrmScrollable">
          <!-- ko template: {
            name: 'orders-table-template',
            data: {
              orders: orders(),
            }
          } -->
          <!-- /ko -->
        </div>
        <!-- /ko -->

        <!-- ko template: {
            foreach: hrmTemplateIf(activeTab() === 1, $data),
            afterAdd: hrmFadeAfterAddFactory(200, 200),
            beforeRemove: hrmFadeBeforeRemoveFactory(200)
        } -->
        <div class="details-modal-orders__scroll"
            data-bind="hrmScrollable">
            <!-- ko let: { activeRoute: ko.observable(null) } -->
<table class="details-modal-routes-table"
        data-bind="hrmTable">
  <thead>
    <tr>
      <th class="details-modal-routes-table__cell details-modal-routes-table__cell--order">
        <div class="details-modal-routes-table__cell-content">
          Маршрут
          <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-table__head-cell-info-button positions-table__info-icon"
                  data-bind="hrmTooltip, hrmTooltipText: 'Маршрут'"></button>
        </div>
      </th>

      <th class="details-modal-routes-table__cell details-modal-routes-table__cell--time">
        <div class="details-modal-routes-table__cell-content">
          Начало/завершение
          <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-table__head-cell-info-button positions-table__info-icon"
                  data-bind="hrmTooltip, hrmTooltipText: 'Начало/завершение'"></button>
        </div>
      </th>

      <th class="details-modal-routes-table__cell details-modal-routes-table__cell--sum">
        <div class="details-modal-routes-table__cell-content">
          Дистанция, км
          <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-table__head-cell-info-button positions-table__info-icon"
                  data-bind="hrmTooltip, hrmTooltipText: 'Дистанция, км'"></button>
        </div>
      </th>

      <th class="details-modal-routes-table__cell details-modal-routes-table__cell--operator">
        <div class="details-modal-routes-table__cell-content">
          Расч./факт. время в пути
          <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-table__head-cell-info-button positions-table__info-icon"
                  data-bind="hrmTooltip, hrmTooltipText: 'Расч./факт. время в пути'"></button>
        </div>
      </th>


    </tr>
  </thead>

  <tbody>
    <!-- ko foreach: { data: routes, as: 'route' } -->

    <tr data-bind="css: {
      'details-modal-routes-table__active-row': activeRoute() === route
    }">
      <td class="details-modal-routes-table__cell">
        <div class="details-modal-routes-table__cell-content">
            <!-- ko foreach: orders -->
            <div data-bind="text: address" class="details-modal-routes-table__order-address"></div>
            <!-- /ko -->
        </div>
      </td>
      <td class="details-modal-routes-table__cell">
        <div class="details-modal-routes-table__cell-content">
          <div data-bind="text: startedAt"></div>
            <div data-bind="text: finishedAt"></div>
        </div>
      </td>
      <td class="details-modal-routes-table__cell">
        <div class="details-modal-routes-table__cell-content"
        data-bind="text: distKm"></div>
      </td>
      <td class="details-modal-routes-table__cell">
        <div class="details-modal-routes-table__cell-content details-modal-routes-table__time">
          <div>
            <div data-bind="text: estimatedTime"></div>
            <div data-bind="text: actualTime"></div>
          </div>

          <button class="hrm-button hrm-circle-icon-button hrm-circle-arrow-down-icon-button hrm-circle-icon-button--theme_neutral"
                  data-bind="click: function() {
                    if (activeRoute() === route) {
                      activeRoute(null);
                    } else {
                      activeRoute(route);
                    }

                  }, css: {
            'active': activeRoute() === route
          }">
          </button>
        </div>
      </td>
    </tr>

    <!-- ko template: {
        foreach: hrmTemplateIf(activeRoute() === route, $data),
        afterAdd: $component.afterDetailsAdd,
        beforeRemove: $component.beforeDetailsRemove,
      } -->
    <tr class="details-modal-routes-table__route-row">
      <td colspan="4">

        <div class="details-modal-routes-table__route route-block details-block">


        <!-- ko template: {
          name: 'orders-table-template',
          data: {
            orders: route.orders
          }
        } -->
        <!-- /ko -->

        </div>

      </td>
    </tr>
    <!-- /ko -->

    <!-- /ko -->
  </tbody>
</table>
<!-- /ko -->

          </div>
        <!-- /ko -->

      </div>
    <!-- /ko -->

    <!-- ko if: isLoading() -->
    <div class="loader">
      <i class="fa fa-spinner fa-pulse loader__indicator">
      </i>
    </div>
    <!-- /ko -->
  <!-- /ko -->
</template>


<script type="text/javascript">
    ko.components.register('driver-details-modal-dialog', {
        viewModel: {
            createViewModel: function (params, componentInfo) {
                const $element = $(componentInfo.element);
                $element.addClass([
                    'modal-dialog-content',
                    'modal-dialog-content--initializing'
                ]);



                return new (function () {
                    this.viewportSize = ko.observable({ width: $(window).width(), height: $(window).height() });
                    this.windowResizeHandler = () => {
                        this.viewportSize({ width: $(window).width(), height: $(window).height() });
                    };
                    $(window).on('resize', this.windowResizeHandler);

                    this.initializing = ko.observable(true);

                    this.isSubmitted = ko.observable(true);
                    this.isLoading = ko.observable(true);

                    this.formControlErrorStateMatcher = function (formControl) {
                        return ko.pureComputed(() => {
                            return this.isSubmitted() && !formControl.isValid();
                        });
                    };

                    this.tabs = [
                        new HrmTabGroupItem('Заказы'),
                        new HrmTabGroupItem('Маршруты'),
                    ];
                    this.activeTab = ko.observable(0);

                    this.employeeId = ko.observable(params.data.employee.id);
                    this.employeeId.subscribe(v => {
                        this.isLoading(true);
                        this.loadData(v);
                    });

                    this.employees = params.data.employees;

                    this.orders = ko.observableArray([]);
                    this.routes = ko.observableArray([]);

                    this.changeOrderDriver = (driverId) => {
                        const orderId = this.activeOrder().id;
                        console.log('change order driver', orderId, driverId);
                    };

                    this.getOrdersSum = orders => {
                        return orders.reduce((acc, o) => acc + o.sum, 0);
                    }



                    this.loadData = (id) => {
                        setTimeout(() => {

                            const orders = [
                                {
                                    id: 16567,
                                    address: 'г. Москва, пос. Сосенское, ул. СНТ Филатов луг, д. 2',
                                    deliveryTime: '1ч 4мин',
                                    sum: 900,
                                    operatorName: 'Булекова Ольга',
                                    driverId: 'driver2',
                                    driverName: 'Харитонов Алексей',
                                    items: [
                                        {
                                            name: 'Картошка с говядиной и грибами',
                                            count: 1,
                                            price: 266
                                        },
                                        {
                                            name: 'Картошка с говядиной и грибами',
                                            count: 1,
                                            price: 266
                                        },
                                        {
                                            name: 'Картошка с говядиной и грибами',
                                            count: 1,
                                            price: 266
                                        },
                                        {
                                            name: 'Вилка',
                                            count: 2,
                                            price: 0
                                        }
                                    ],
                                    processing: {
                                        createdAt: '11:09',
                                        confirmedAt: '11:09',
                                        printedAt: '11:09',
                                        readyAt: '11:09',
                                        sendedAt: '11:09',
                                        paidAt: '11:09',
                                        deliveredAt: '11:09',
                                    },
                                    delivery: {
                                        date: '12:09 03.04.2020',
                                        time: '12 мин',
                                        address: 'г. Ленинский городской округ, раб. пос. Боброво, ул. Крымская, д.15'
                                    }
                                },
                                {
                                    id: 16567,
                                    address: 'г. Москва, пос. Сосенское, ул. СНТ Филатов луг, д. 2',
                                    deliveryTime: '1ч 4мин',
                                    sum: 900,
                                    operatorName: 'Булекова Ольга',
                                    driverId: 'driver1',
                                    driverName: 'Харитонов Алексей',
                                    items: [
                                        {
                                            name: 'Картошка с говядиной и грибами',
                                            count: 1,
                                            price: 266
                                        },
                                        {
                                            name: 'Картошка с говядиной и грибами',
                                            count: 1,
                                            price: 266
                                        },
                                        {
                                            name: 'Картошка с говядиной и грибами',
                                            count: 1,
                                            price: 266
                                        },
                                        {
                                            name: 'Вилка',
                                            count: 2,
                                            price: 0
                                        }
                                    ],
                                    processing: {
                                        createdAt: '11:09',
                                        confirmedAt: '11:09',
                                        printedAt: '11:09',
                                        readyAt: '11:09',
                                        sendedAt: '11:09',
                                        paidAt: '11:09',
                                        deliveredAt: '11:09',
                                    },
                                    delivery: {
                                        date: '12:09 03.04.2020',
                                        time: '12 мин',
                                        address: 'г. Ленинский городской округ, раб. пос. Боброво, ул. Крымская, д.15'
                                    }
                                },
                                {
                                    id: 16567,
                                    address: 'г. Москва, пос. Сосенское, ул. СНТ Филатов луг, д. 2',
                                    deliveryTime: '1ч 4мин',
                                    sum: 900,
                                    operatorName: 'Булекова Ольга',
                                    driverId: 'driver1',
                                    driverName: 'Харитонов Алексей',
                                    items: [
                                        {
                                            name: 'Картошка с говядиной и грибами',
                                            count: 1,
                                            price: 266
                                        },
                                        {
                                            name: 'Картошка с говядиной и грибами',
                                            count: 1,
                                            price: 266
                                        },
                                        {
                                            name: 'Картошка с говядиной и грибами',
                                            count: 1,
                                            price: 266
                                        },
                                        {
                                            name: 'Вилка',
                                            count: 2,
                                            price: 0
                                        }
                                    ],
                                    processing: {
                                        createdAt: '11:09',
                                        confirmedAt: '11:09',
                                        printedAt: '11:09',
                                        readyAt: '11:09',
                                        sendedAt: '11:09',
                                        paidAt: '11:09',
                                        deliveredAt: '11:09',
                                    },
                                    delivery: {
                                        date: '12:09 03.04.2020',
                                        time: '12 мин',
                                        address: 'г. Ленинский городской округ, раб. пос. Боброво, ул. Крымская, д.15'
                                    }
                                },
                                {
                                    id: 16567,
                                    address: 'г. Москва, пос. Сосенское, ул. СНТ Филатов луг, д. 2',
                                    deliveryTime: '1ч 4мин',
                                    sum: 900,
                                    operatorName: 'Булекова Ольга',
                                    driverId: 'driver2',
                                    driverName: 'Харитонов Алексей',
                                    items: [
                                        {
                                            name: 'Картошка с говядиной и грибами',
                                            count: 1,
                                            price: 266
                                        },
                                        {
                                            name: 'Картошка с говядиной и грибами',
                                            count: 1,
                                            price: 266
                                        },
                                        {
                                            name: 'Картошка с говядиной и грибами',
                                            count: 1,
                                            price: 266
                                        },
                                        {
                                            name: 'Вилка',
                                            count: 2,
                                            price: 0
                                        }
                                    ],
                                    processing: {
                                        createdAt: '11:09',
                                        confirmedAt: '11:09',
                                        printedAt: '11:09',
                                        readyAt: '11:09',
                                        sendedAt: '11:09',
                                        paidAt: '11:09',
                                        deliveredAt: '11:09',
                                    },
                                    delivery: {
                                        date: '12:09 03.04.2020',
                                        time: '12 мин',
                                        address: 'г. Ленинский городской округ, раб. пос. Боброво, ул. Крымская, д.15'
                                    }
                                }
                            ];
                            this.orders(orders);

                            const routes = [
                                {
                                    orders: orders.slice(0, 1),
                                    startedAt: '03.04.2020 11:44',
                                    finishedAt: '03.04.2020 12:38',
                                    distKm: 12.4,
                                    estimatedTime: '0:55',
                                    actualTime: '0:35'
                                },
                                {
                                    orders: orders.slice(0, 2),
                                    startedAt: '03.04.2020 11:44',
                                    finishedAt: '03.04.2020 12:38',
                                    distKm: 16.9,
                                    estimatedTime: '0:55',
                                    actualTime: '0:35'
                                },
                                {
                                    orders: orders.slice(0, 1),
                                    startedAt: '03.04.2020 11:44',
                                    finishedAt: '03.04.2020 12:38',
                                    distKm: 12.4,
                                    estimatedTime: '0:55',
                                    actualTime: '0:35'
                                }
                            ];
                            this.routes(routes);

                            this.isLoading(false);

                        }, 3000);
                    };

                    this.loadData(this.employeeId());

                    this.save = function () {
                        this.isSubmitted(true);
                    };

                    this.cancel = function () {
                        params.cancel();
                    };




                    this.afterRender = function () {
                        $element.removeClass('modal-dialog-content--initializing');
                        this.initializing(false);
                    }.bind(this);

                    this.afterDetailsAdd = el => {
                        let $block = $(el).find('.details-block');
                        $block.hide();
                        $(el).fadeIn(0, () => {
                            $block.slideDown(300);
                        });
                    };

                    this.beforeDetailsRemove = el => {
                        let $block = $(el).find('.details-block');
                        $block.slideUp(300, () => {
                            $(el).fadeOut(0, () => {
                                $(el).remove();
                            })
                        })
                    }

                    this.dispose = function () {
                        $(window).off('resize', this.windowResizeHandler);
                    };
                });
            }
        },
        template: { element: 'driver-details-modal-dialog-template' }
    });
</script>

  <template id="lateness-details-modal-dialog-template">
  <!-- ko template: { afterRender: afterRender } -->
    <!-- ko if: viewportSize().width <= HRM_BREAKPOINTS.mobileMaxWidth -->
    <button class="hrm-button modal-dialog-content__close"
            data-bind="click: function() {cancel();}"
            aria-label="Close">
    </button>
    <!-- /ko -->

    <!-- ko if: !isLoading() -->
      <div class="modal-dialog-content__header">
        <div>
        <div class="modal-dialog-content__title" data-bind="text: $component.title">

        </div>

      
      </div>
      </div>

      <div class="details-modal-orders">
        <div class="details-modal-orders-tabs"
            data-bind="component: {name: 'hrm-tab-group', params: {items: tabs, activeItem: activeTab }}">
        </div>

        <!-- ko template: {
            foreach: hrmTemplateIf(activeTab() === 0, $data),
            afterAdd: hrmFadeAfterAddFactory(200, 200),
            beforeRemove: hrmFadeBeforeRemoveFactory(200)
        } -->
        <div class="details-modal-orders__scroll"
            data-bind="hrmScrollable">
          <!-- ko template: {
            name: 'orders-table-template',
            data: {
              orders: orders(),
            }
          } -->
          <!-- /ko -->
        </div>
        <!-- /ko -->

        <!-- ko template: {
            foreach: hrmTemplateIf(activeTab() === 1, $data),
            afterAdd: hrmFadeAfterAddFactory(200, 200),
            beforeRemove: hrmFadeBeforeRemoveFactory(200)
        } -->
        <div class="details-modal-orders__scroll"
            data-bind="hrmScrollable">
            <!-- ko let: { activeRoute: ko.observable(null) } -->
<table class="details-modal-routes-table"
        data-bind="hrmTable">
  <thead>
    <tr>
      <th class="details-modal-routes-table__cell details-modal-routes-table__cell--order">
        <div class="details-modal-routes-table__cell-content">
          Маршрут
          <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-table__head-cell-info-button positions-table__info-icon"
                  data-bind="hrmTooltip, hrmTooltipText: 'Маршрут'"></button>
        </div>
      </th>

      <th class="details-modal-routes-table__cell details-modal-routes-table__cell--time">
        <div class="details-modal-routes-table__cell-content">
          Начало/завершение
          <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-table__head-cell-info-button positions-table__info-icon"
                  data-bind="hrmTooltip, hrmTooltipText: 'Начало/завершение'"></button>
        </div>
      </th>

      <th class="details-modal-routes-table__cell details-modal-routes-table__cell--sum">
        <div class="details-modal-routes-table__cell-content">
          Дистанция, км
          <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-table__head-cell-info-button positions-table__info-icon"
                  data-bind="hrmTooltip, hrmTooltipText: 'Дистанция, км'"></button>
        </div>
      </th>

      <th class="details-modal-routes-table__cell details-modal-routes-table__cell--operator">
        <div class="details-modal-routes-table__cell-content">
          Расч./факт. время в пути
          <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-table__head-cell-info-button positions-table__info-icon"
                  data-bind="hrmTooltip, hrmTooltipText: 'Расч./факт. время в пути'"></button>
        </div>
      </th>


    </tr>
  </thead>

  <tbody>
    <!-- ko foreach: { data: routes, as: 'route' } -->

    <tr data-bind="css: {
      'details-modal-routes-table__active-row': activeRoute() === route
    }">
      <td class="details-modal-routes-table__cell">
        <div class="details-modal-routes-table__cell-content">
            <!-- ko foreach: orders -->
            <div data-bind="text: address" class="details-modal-routes-table__order-address"></div>
            <!-- /ko -->
        </div>
      </td>
      <td class="details-modal-routes-table__cell">
        <div class="details-modal-routes-table__cell-content">
          <div data-bind="text: startedAt"></div>
            <div data-bind="text: finishedAt"></div>
        </div>
      </td>
      <td class="details-modal-routes-table__cell">
        <div class="details-modal-routes-table__cell-content"
        data-bind="text: distKm"></div>
      </td>
      <td class="details-modal-routes-table__cell">
        <div class="details-modal-routes-table__cell-content details-modal-routes-table__time">
          <div>
            <div data-bind="text: estimatedTime"></div>
            <div data-bind="text: actualTime"></div>
          </div>

          <button class="hrm-button hrm-circle-icon-button hrm-circle-arrow-down-icon-button hrm-circle-icon-button--theme_neutral"
                  data-bind="click: function() {
                    if (activeRoute() === route) {
                      activeRoute(null);
                    } else {
                      activeRoute(route);
                    }

                  }, css: {
            'active': activeRoute() === route
          }">
          </button>
        </div>
      </td>
    </tr>

    <!-- ko template: {
        foreach: hrmTemplateIf(activeRoute() === route, $data),
        afterAdd: $component.afterDetailsAdd,
        beforeRemove: $component.beforeDetailsRemove,
      } -->
    <tr class="details-modal-routes-table__route-row">
      <td colspan="4">

        <div class="details-modal-routes-table__route route-block details-block">


        <!-- ko template: {
          name: 'orders-table-template',
          data: {
            orders: route.orders
          }
        } -->
        <!-- /ko -->

        </div>

      </td>
    </tr>
    <!-- /ko -->

    <!-- /ko -->
  </tbody>
</table>
<!-- /ko -->

          </div>
        <!-- /ko -->

      </div>
    <!-- /ko -->

    <!-- ko if: isLoading() -->
    <div class="loader">
      <i class="fa fa-spinner fa-pulse loader__indicator">
      </i>
    </div>
    <!-- /ko -->
  <!-- /ko -->
</template>


<script type="text/javascript">
    ko.components.register('lateness-details-modal-dialog', {
        viewModel: {
            createViewModel: function (params, componentInfo) {
                const $element = $(componentInfo.element);
                $element.addClass([
                    'modal-dialog-content',
                    'modal-dialog-content--initializing'
                ]);



                return new (function () {
                    this.viewportSize = ko.observable({ width: $(window).width(), height: $(window).height() });
                    this.windowResizeHandler = () => {
                        this.viewportSize({ width: $(window).width(), height: $(window).height() });
                    };
                    $(window).on('resize', this.windowResizeHandler);

                    this.initializing = ko.observable(true);

                    this.isSubmitted = ko.observable(true);
                    this.isLoading = ko.observable(true);

                    this.formControlErrorStateMatcher = function (formControl) {
                        return ko.pureComputed(() => {
                            return this.isSubmitted() && !formControl.isValid();
                        });
                    };

                    this.tabs = [
                        new HrmTabGroupItem('Заказы'),
                        new HrmTabGroupItem('Маршруты'),
                    ];
                    this.activeTab = ko.observable(0);

                    this.position = params.data.position;
                    this.interval = params.data.interval;
                    this.title = params.data.title;

                    this.orders = ko.observableArray([]);
                    this.routes = ko.observableArray([]);

                    this.changeOrderDriver = (driverId) => {
                        const orderId = this.activeOrder().id;
                        console.log('change order driver', orderId, driverId);
                    };

                    this.getOrdersSum = orders => {
                        return orders.reduce((acc, o) => acc + o.sum, 0);
                    }



                    this.loadData = (id) => {
                        setTimeout(() => {

                            const orders = [
                                {
                                    id: 16567,
                                    address: 'г. Москва, пос. Сосенское, ул. СНТ Филатов луг, д. 2',
                                    deliveryTime: '1ч 4мин',
                                    sum: 900,
                                    operatorName: 'Булекова Ольга',
                                    driverId: 'driver2',
                                    driverName: 'Харитонов Алексей',
                                    items: [
                                        {
                                            name: 'Картошка с говядиной и грибами',
                                            count: 1,
                                            price: 266
                                        },
                                        {
                                            name: 'Картошка с говядиной и грибами',
                                            count: 1,
                                            price: 266
                                        },
                                        {
                                            name: 'Картошка с говядиной и грибами',
                                            count: 1,
                                            price: 266
                                        },
                                        {
                                            name: 'Вилка',
                                            count: 2,
                                            price: 0
                                        }
                                    ],
                                    processing: {
                                        createdAt: '11:09',
                                        confirmedAt: '11:09',
                                        printedAt: '11:09',
                                        readyAt: '11:09',
                                        sendedAt: '11:09',
                                        paidAt: '11:09',
                                        deliveredAt: '11:09',
                                    },
                                    delivery: {
                                        date: '12:09 03.04.2020',
                                        time: '12 мин',
                                        address: 'г. Ленинский городской округ, раб. пос. Боброво, ул. Крымская, д.15'
                                    }
                                },
                                {
                                    id: 16567,
                                    address: 'г. Москва, пос. Сосенское, ул. СНТ Филатов луг, д. 2',
                                    deliveryTime: '1ч 4мин',
                                    sum: 900,
                                    operatorName: 'Булекова Ольга',
                                    driverId: 'driver1',
                                    driverName: 'Харитонов Алексей',
                                    items: [
                                        {
                                            name: 'Картошка с говядиной и грибами',
                                            count: 1,
                                            price: 266
                                        },
                                        {
                                            name: 'Картошка с говядиной и грибами',
                                            count: 1,
                                            price: 266
                                        },
                                        {
                                            name: 'Картошка с говядиной и грибами',
                                            count: 1,
                                            price: 266
                                        },
                                        {
                                            name: 'Вилка',
                                            count: 2,
                                            price: 0
                                        }
                                    ],
                                    processing: {
                                        createdAt: '11:09',
                                        confirmedAt: '11:09',
                                        printedAt: '11:09',
                                        readyAt: '11:09',
                                        sendedAt: '11:09',
                                        paidAt: '11:09',
                                        deliveredAt: '11:09',
                                    },
                                    delivery: {
                                        date: '12:09 03.04.2020',
                                        time: '12 мин',
                                        address: 'г. Ленинский городской округ, раб. пос. Боброво, ул. Крымская, д.15'
                                    }
                                },
                                {
                                    id: 16567,
                                    address: 'г. Москва, пос. Сосенское, ул. СНТ Филатов луг, д. 2',
                                    deliveryTime: '1ч 4мин',
                                    sum: 900,
                                    operatorName: 'Булекова Ольга',
                                    driverId: 'driver1',
                                    driverName: 'Харитонов Алексей',
                                    items: [
                                        {
                                            name: 'Картошка с говядиной и грибами',
                                            count: 1,
                                            price: 266
                                        },
                                        {
                                            name: 'Картошка с говядиной и грибами',
                                            count: 1,
                                            price: 266
                                        },
                                        {
                                            name: 'Картошка с говядиной и грибами',
                                            count: 1,
                                            price: 266
                                        },
                                        {
                                            name: 'Вилка',
                                            count: 2,
                                            price: 0
                                        }
                                    ],
                                    processing: {
                                        createdAt: '11:09',
                                        confirmedAt: '11:09',
                                        printedAt: '11:09',
                                        readyAt: '11:09',
                                        sendedAt: '11:09',
                                        paidAt: '11:09',
                                        deliveredAt: '11:09',
                                    },
                                    delivery: {
                                        date: '12:09 03.04.2020',
                                        time: '12 мин',
                                        address: 'г. Ленинский городской округ, раб. пос. Боброво, ул. Крымская, д.15'
                                    }
                                },
                                {
                                    id: 16567,
                                    address: 'г. Москва, пос. Сосенское, ул. СНТ Филатов луг, д. 2',
                                    deliveryTime: '1ч 4мин',
                                    sum: 900,
                                    operatorName: 'Булекова Ольга',
                                    driverId: 'driver2',
                                    driverName: 'Харитонов Алексей',
                                    items: [
                                        {
                                            name: 'Картошка с говядиной и грибами',
                                            count: 1,
                                            price: 266
                                        },
                                        {
                                            name: 'Картошка с говядиной и грибами',
                                            count: 1,
                                            price: 266
                                        },
                                        {
                                            name: 'Картошка с говядиной и грибами',
                                            count: 1,
                                            price: 266
                                        },
                                        {
                                            name: 'Вилка',
                                            count: 2,
                                            price: 0
                                        }
                                    ],
                                    processing: {
                                        createdAt: '11:09',
                                        confirmedAt: '11:09',
                                        printedAt: '11:09',
                                        readyAt: '11:09',
                                        sendedAt: '11:09',
                                        paidAt: '11:09',
                                        deliveredAt: '11:09',
                                    },
                                    delivery: {
                                        date: '12:09 03.04.2020',
                                        time: '12 мин',
                                        address: 'г. Ленинский городской округ, раб. пос. Боброво, ул. Крымская, д.15'
                                    }
                                }
                            ];
                            this.orders(orders);

                            const routes = [
                                {
                                    orders: orders.slice(0, 1),
                                    startedAt: '03.04.2020 11:44',
                                    finishedAt: '03.04.2020 12:38',
                                    distKm: 12.4,
                                    estimatedTime: '0:55',
                                    actualTime: '0:35'
                                },
                                {
                                    orders: orders.slice(0, 2),
                                    startedAt: '03.04.2020 11:44',
                                    finishedAt: '03.04.2020 12:38',
                                    distKm: 16.9,
                                    estimatedTime: '0:55',
                                    actualTime: '0:35'
                                },
                                {
                                    orders: orders.slice(0, 1),
                                    startedAt: '03.04.2020 11:44',
                                    finishedAt: '03.04.2020 12:38',
                                    distKm: 12.4,
                                    estimatedTime: '0:55',
                                    actualTime: '0:35'
                                }
                            ];
                            this.routes(routes);

                            this.isLoading(false);

                        }, 3000);
                    };

                    this.loadData();

                    this.save = function () {
                        this.isSubmitted(true);
                    };

                    this.cancel = function () {
                        params.cancel();
                    };




                    this.afterRender = function () {
                        $element.removeClass('modal-dialog-content--initializing');
                        this.initializing(false);
                    }.bind(this);

                    this.afterDetailsAdd = el => {
                        let $block = $(el).find('.details-block');
                        $block.hide();
                        $(el).fadeIn(0, () => {
                            $block.slideDown(300);
                        });
                    };

                    this.beforeDetailsRemove = el => {
                        let $block = $(el).find('.details-block');
                        $block.slideUp(300, () => {
                            $(el).fadeOut(0, () => {
                                $(el).remove();
                            })
                        })
                    }

                    this.dispose = function () {
                        $(window).off('resize', this.windowResizeHandler);
                    };
                });
            }
        },
        template: { element: 'lateness-details-modal-dialog-template' }
    });
</script>


  <template id="calculation-page-input-form-template">
  <div class="calculation-input-form">
    <div class="calculation-input-form__header">

      <!-- Filial select -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null)} -->
      <div class="calculation-input-form__field calculation-input-form__filial"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">
          Филиал
        </label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <select data-bind="value: filial,
                    options: filialsList,
                    optionsText: 'name',
                    optionsValue: 'id',
                    hrmSelect,
                    hrmFormFieldSelectControl: control,
                    hrmSelectSearchEnabled: true,
                    hrmFormFieldSelectControlErrorStateMatcher: formControlErrorStateMatcher">
          </select>
        </div>

        <div data-bind="component: {name: 'hrm-form-field-error'},
                      hrmSlide,
                      hrmSlideValue: control() !== null ? control().errorState : false,
                      hrmSlideDuration: 150">
          <!-- ko text: $parent.filial.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /Filial select -->

      <!-- Date select -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null)} -->
      <div class="calculation-input-form__field calculation-input-form__date"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">Расчёт на дату</label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <input data-bind="textInput: date,
                        hrmDatepicker,
                        hrmDatepickerConfig: {
                          format: 'DD.MM.YYYY',
                        },
                        hrmFormFieldDatepickerControl: control,
                        hrmFormFieldDatepickerControlErrorStateMatcher: formControlErrorStateMatcher" />

          <i class="hrm-form-field__suffix hrm-form-field-icon hrm-form-field-calendar-icon"></i>
        </div>

        <div data-bind="component: {name: 'hrm-form-field-error'},
                      hrmSlide,
                      hrmSlideValue: control() !== null ? control().errorState : false,
                      hrmSlideDuration: 150">
          <!-- ko text: $parent.date.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /Date select -->

      <!-- Shift block -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null)} -->
      <div class="calculation-input-form__field calculation-input-form__shift"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label class=""
               data-bind="hrmFormFieldLabel: label">
          Смена
        </label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <select data-bind="value: shift,
                options: shiftsList,
                optionsText: 'name',
                optionsValue: 'id',
                hrmSelect,
                hrmFormFieldSelectControl: control,
                hrmFormFieldSelectControlErrorStateMatcher: formControlErrorStateMatcher">
          </select>
        </div>

        <div data-bind="component: {name: 'hrm-form-field-error'},
                hrmSlide,
                hrmSlideValue: control() !== null ? control().errorState : false,
                hrmSlideDuration: 150">
          <!-- ko text: $parent.shift.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /Shift select -->

      <!-- Interval select -->
      <!-- ko let: {control: ko.observable(null)} -->
      <div class="calculation-input-form__field calculation-input-form__interval"
           data-bind="hrmFormField, hrmFormFieldControlRef: control">

        <div class="calculation-input-form__interval-controls"
             data-bind="hrmFormFieldComplexControl: control">

          <!-- ko let: {control: ko.observable(null)} -->
          <div class="calculation-input-form__interval-control"
               data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
            <input data-bind="value: interval.start,
                            hrmTimeAutocompleter,
                            hrmMask,
                            hrmMaskPattern: 'datetime',
                            hrmMaskOptions: {
                                inputFormat: 'HH:MM',
                                placeholder: ' '
                            },
                            hrmFormFieldInputControl: control,
                            hrmFormFieldInputControlErrorStateMatcher: formControlErrorStateMatcher"
                   placeholder="00:00">
          </div>

          <!-- /ko -->

          <span class="calculation-input-form__interval-separator">-</span>

          <!-- ko let: {control: ko.observable(null)} -->
          <div class="calculation-input-form__interval-control"
               data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
            <input data-bind="value: interval.end,
                            hrmTimeAutocompleter,
                            hrmMask,
                            hrmMaskPattern: 'datetime',
                            hrmMaskOptions: {
                                inputFormat: 'HH:MM',
                                placeholder: ' '
                            },
                            hrmFormFieldInputControl: control,
                            hrmFormFieldInputControlErrorStateMatcher: formControlErrorStateMatcher"
                   placeholder="00:00">
          </div>
          <!-- /ko -->

        </div><!-- .calculation-input__interval-controls -->

        <div data-bind="component: {name: 'hrm-form-field-error'},
                      hrmSlide,
                      hrmSlideValue: !interval.isCorrect(),
                      hrmSlideDuration: 150">
          <!-- ko text: 'Некорректно задан интервал' -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /Interval select -->
      <!-- /Shift block -->


      <div class="calculation-input-form__field calculation-input-form__actions">
        <button class="hrm-button hrm-button--size_large hrm-basic-button hrm-accent-button calculation-input-form__action"
                data-bind="click: $root.buildCalculation, enable: isValid() && !$root.loading()">
          Рассчитать
        </button>

        <button class="hrm-button hrm-button--size_large hrm-basic-button calculation-input-form__action"
            data-bind="enable: !$root.loading(), click: $root.buildForNow">
          На сейчас
        </button>
      </div>


    </div><!-- .calculaton-form__header -->
  </div>

</template>


<script type="text/javascript">
  $(function () {
    /** Список филиалов */
    const filialsList = [
      { id: 1, name: 'Филиал 1' },
      { id: 2, name: 'Филиал 2' },
      { id: 3, name: 'Филиал 12345' },
      { id: 4, name: 'Филиал 4' },
      { id: 5, name: 'Филиал 5' },
      { id: 6, name: 'Филиал 6' },
      { id: 7, name: 'Филиал 7' },
      { id: 8, name: 'Филиал 8' },
      { id: 9, name: 'Филиал 9' },
      { id: 10, name: 'Филиал 10' },
      { id: 11, name: 'Филиал 11' },
      { id: 12, name: 'Филиал 12' },
      { id: 13, name: 'Филиал 13' },
    ];

    /** Список смен */
    const shifts = [
      {
        id: 'day',
        name: 'Дневная',
        start: '11:00',
        end: '23:00',
      }, {
        id: 'night',
        name: 'Ночная',
        start: '23:00',
        end: '11:00'
      }
    ];

    /** Получить объект смены по ее id */
    function getShift(value) {
      return shifts.find(shift => shift.id === value);
    }

    /** Модель интервала времени */
    function createIntervalModel(data, needCheck) {
      const start = data.start;
      const end = data.end;

      const correct = ko.pureComputed(() => {
        const endMoment = moment(end(), 'HH:mm');
        const startMoment = moment(start(), 'HH:mm');
        if (!needCheck()) return true;
        return endMoment.isAfter(startMoment);
      });

      start.extend({
        required: {
          message: 'Обязательное поле'
        },
        hrmDate: {
          params: 'HH:mm',
          message: 'Неверный формат времени'
        },
        validation: { validator: () => correct() }
      });

      end.extend({
        required: {
          message: 'Обязательное поле'
        },
        hrmDate: {
          params: 'HH:mm',
          message: 'Неверный формат времени'
        },
        validation: { validator: () => correct() }
      });

      return {
        start,
        end,
        isCorrect: correct
      };
    }


    ko.components.register('calculation-page-input-form', {
      viewModel: {
        createViewModel: function (params, componentInfo) {
          const model = params.model;

          const filial = model.filial.extend({
            required: {
              message: 'Обязательное поле'
            }
          });

          const date = model.date.extend({
            required: {
              message: 'Обязательное поле'
            },
            hrmDate: {
              params: 'DD.MM.YYYY',
              message: 'Неверный формат даты'
            }
          });

          const shift = model.shift.extend({
            required: {
              message: 'Обязательное поле'
            }
          });
          shift(shifts[0].value);
          const needCheck = ['day'];
          const changeShift = ko.observable(false);

          const start = model.interval.start;
          const end = model.interval.end;
          start(shifts[0].start);
          end(shifts[0].end);
          const interval = createIntervalModel({
            start: start,
            end: end,
          }, () => {
            return !changeShift() && needCheck.indexOf(shift()) !== -1;
          });

          shift.subscribe((value) => {
            changeShift(true);

            const shiftData = getShift(value);
            if (shiftData) {
              interval.start(shiftData.start);
              interval.end(shiftData.end);
            }

            changeShift(0);
          });

          const isValid = ko.pureComputed(() => {
            return date.isValid() && interval.isCorrect();
          }, this);

          return {
            filial,
            filialsList,

            date,

            shift,
            shiftsList: shifts,

            interval,
            isValid,

            formControlErrorStateMatcher: function (formControl) {
              return ko.pureComputed(() => {
                return !formControl.isValid();
              });
            }
          };
        }
      },

      template: {
        element: 'calculation-page-input-form-template'
      }
    })
  })
</script>

  <script type="text/html"
        id="summary-position-row-template">


  <tr class="calculation-summary__row"
  data-bind="click: function() { position.clicked(!position.clicked()); }, css: {
    'calculation-summary__row--clicked': position.clicked,
  }">
    <!-- Должность -->
    <td class="calculation-summary__cell calculation-summary__cell--job" data-bind="css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('job'),
    }">
      <div class="calculation-summary__cell-content"
           data-bind="text: position.name"></div>
    </td>

    <!-- Тип нагрузки -->
    <td class="calculation-summary__cell calculation-summary__cell--workload-type" data-bind="css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('workload-type'),
    }">
      <div class="calculation-summary__cell-content"
           data-bind="text: position.workloadType"></div>
    </td>

    <!-- Нагрузка -->
    <!-- ko let: {editableCell: ko.observable(null)} -->
    <td class="calculation-summary__cell calculation-summary__cell--workload-value"
    data-bind="hrmTableEditableCell: editableCell, click: function(_, e) { e.stopPropagation(); }, css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('workload'),
    }" align="right">
            <input data-bind="
                value: position.workload,
                hrmTableEditableCellInputControl,
                hrmTableEditableCellInputControlOwner: editableCell
            ">
      </div>

    </td>
    <!-- /ko -->

    <td class="calculation-summary__cell calculation-summary__cell--workload-units"  data-bind="css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('workload'),
    }">
      <div class="calculation-summary__cell-content" data-bind="html: $root.getUnitsSuffixHtml(position.workloadUnits)">
      </div>
    </td>

    <!-- Доп. нагрузка -->
    <td class="calculation-summary__cell calculation-summary__cell--additional-workload"  data-bind="css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('additional-workload'),
    }">
      <div class="calculation-summary__cell-content">
        <!-- ko if: position.additionalWorkloadType -->
          <div class="position-additional-workload">
            <div class="position-additional-workload__type" data-bind="text: position.additionalWorkloadType"></div>

            <div class="position-additional-workload__value" data-bind="text: position.additionalWorkload"></div>

          </div>
        <!-- /ko -->
      </div>
    </td>

    <!-- Сотрудники -->
    <td class="calculation-summary__cell calculation-summary__cell--count"  data-bind="css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('count'),
    }">
      <div class="calculation-summary__cell-content"
           data-bind="text: position.visibleEmployees().length"></div>
    </td>

    <!-- ФОТ, % в категории -->
    <td class="calculation-summary__cell calculation-summary__cell--fot-category" data-bind="style: {
      'background-color': '#FFD3E8'
    }, css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('fot-category'),
    }">
      <div class="calculation-summary__cell-content"
           data-bind="text: position.fotCategory"></div>
    </td>

    <!-- ФОТ, % от выручки -->
    <td class="calculation-summary__cell calculation-summary__cell--fot-revenue" data-bind="style: {
      'background-color': '#FFD3E8'
    }, css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('fot-revenue'),
    }">
      <div class="calculation-summary__cell-content"
           data-bind="text: position.fotRevenue"></div>
    </td>

    <!-- Норм. выработки -->
    <td class="calculation-summary__cell calculation-summary__cell--performance-standart"  data-bind="style: {
      'background-color': '#D0F4E3'
    }, css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('performance-standart'),
    }">
      <div class="calculation-summary__cell-content">
           <div class="position-performance-standart">

            <div class="position-performance-standart__value" data-bind="text: position.performanceStandart"></div>
           </div>
      </div>
    </td>

    <!-- Опоздания -->
    <td class="calculation-summary__cell calculation-summary__cell--lateness"  data-bind="css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('lateness'),
    }">
      <div class="calculation-summary__cell-content" data-bind="hrmLog">
        <!-- ko template: { name: 'lateness-template', data: {lateness: position.lateness(), total: position.totalLateness} } -->
        <!-- /ko -->
      </div>
    </td>
  </tr>

</script>

<script type="text/html"
        id="summary-drivers-row-template">

  <tr class="calculation-summary__row"
  data-bind="click: function() { position.clicked(!position.clicked()); }, css: {
    'calculation-summary__row--clicked': position.clicked,
  }">
    <!-- Должность -->
    <td class="calculation-summary__cell calculation-summary__cell--job"  data-bind="css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('job'),
    }">
      <div class="calculation-summary__cell-content"
           data-bind="text: position.name"></div>
    </td>

    <!-- Тип нагрузки -->
    <td class="calculation-summary__cell calculation-summary__cell--workload-type"  data-bind="css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('workload-type'),
    }">
      <div class="calculation-summary__cell-content"
           data-bind="text: position.workloadType"></div>
    </td>

    <!-- Нагрузка -->
    <!-- ko let: {editableCell: ko.observable(null)} -->
    <td class="calculation-summary__cell calculation-summary__cell--workload-value" align="right"  data-bind="css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('workload'),
    }">
      <div class="calculation-summary__cell-content" data-bind="text: position.workload">
      </div>
    </td>
    <!-- /ko -->

    <td class="calculation-summary__cell calculation-summary__cell--workload-units"  data-bind="css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('workload'),
    }">
      <div class="calculation-summary__cell-content" data-bind="html: $root.getUnitsSuffixHtml(position.workloadUnits)">
      </div>
    </td>


    <!-- Доп. нагрузка -->
    <td class="calculation-summary__cell calculation-summary__cell--additional-workload" data-bind="style: {
      'background-color': '#FFD3E8'
    }, css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('additional-workload'),
    }">
      <div class="calculation-summary__cell-content">
          <div class="position-additional-workload position-additional-workload--delivery">
            <div class="position-additional-workload__type">Время без дела:</div>
            <div class="position-additional-workload__value">
              <!-- ko text: position.additionalWorkload() + '%' -->
              <!-- /ko -->
            </div>
          </div>
      </div>
    </td>

    <!-- Сотрудники -->
    <td class="calculation-summary__cell calculation-summary__cell--count"  data-bind="css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('count'),
    }">
      <div class="calculation-summary__cell-content"
           data-bind="text: position.visibleEmployees().length"></div>
    </td>

    <!-- ФОТ, % в категории -->
    <td class="calculation-summary__cell calculation-summary__cell--fot-category" data-bind="style: {
      'background-color': '#FFD3E8'
    }, css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('fot-category'),
    }">
      <div class="calculation-summary__cell-content"
           data-bind="text: position.fotCategory"></div>
    </td>

    <!-- ФОТ, % от выручки -->
    <td class="calculation-summary__cell calculation-summary__cell--fot-revenue" data-bind="style: {
      'background-color': '#FFD3E8'
    }, css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('fot-revenue'),
    }">
      <div class="calculation-summary__cell-content"
           data-bind="text: position.fotRevenue"></div>
    </td>

    <!-- Норм. выработки -->
    <td class="calculation-summary__cell calculation-summary__cell--performance-standart"  data-bind="css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('performance-standart'),
    }">
      <div class="calculation-summary__cell-content">
           <div class="position-performance-standart">

            <div class="position-performance-standart__label" data-bind="html: position.performanceStandartType + ', ' + $root.getUnitsSuffixHtml(position.performanceStandartUnits)"></div>


            <div class="position-performance-standart__value" data-bind="text: position.performanceStandart"></div>
           </div>
      </div>
    </td>

    <!-- Опоздания -->
    <td class="calculation-summary__cell calculation-summary__cell--lateness"  data-bind="css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('lateness'),
    }">
      <div class="calculation-summary__cell-content">
        <!-- ko template: { name: 'lateness-template', data: {lateness: position.lateness(), total: position.totalLateness } } -->
        <!-- /ko -->
      </div>
    </td>
  </tr>
</script>

<script type="text/html"
        id="summary-total-row-template">

  <tr class="calculation-summary__row calculation-summary__row--total">
    <!-- Должность -->
    <td class="calculation-summary__cell calculation-summary__cell--job calculation-summary__cell--empty"  data-bind="css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('job'),
    }"></td>

    <!-- Тип нагрузки -->
    <td class="calculation-summary__cell calculation-summary__cell--workload-type calculation-summary__cell--empty"  data-bind="css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('workload-type'),
    }"></td>


    <!-- Нагрузка -->
    <td class="calculation-summary__cell calculation-summary__cell--workload-value"  data-bind="css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('workload'),
    }">
      <div class="calculation-summary__cell-content" data-bind="text: total.workload()">
      </div>
    </td>

    <td class="calculation-summary__cell calculation-summary__cell--workload-units"  data-bind="css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('workload'),
    }">
      <div class="calculation-summary__cell-content" data-bind="text: $root.getUnitsSuffixHtml(total.workloadUnits())">
      </div>
    </td>

    <!-- Доп. нагрузка -->
    <td class="calculation-summary__cell calculation-summary__cell--additional-workload calculation-summary__cell--empty"  data-bind="css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('additional-workload'),
    }"></td>

    <!-- Сотрудники -->
    <td class="calculation-summary__cell calculation-summary__cell--count"  data-bind="css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('count'),
    }">
      <div class="calculation-summary__cell-content"
           data-bind="text: total.employees()"></div>
    </td>

    <!-- ФОТ, % в категории -->
    <td class="calculation-summary__cell calculation-summary__cell--fot-category"
      data-bind="style: {
        background: '#D0F4E3'
      }, css: {
        'calculation-summary__cell--column-clicked': table.getColumnClicked('fot-category'),
      }">
      <div class="calculation-summary__cell-content" data-bind="text: total.fotCategory()"></div>
    </td>

    <!-- ФОТ, % от выручки -->
    <td class="calculation-summary__cell calculation-summary__cell--fot-revenue"
      data-bind="style: {
        background: '#D0F4E3'
      }, css: {
        'calculation-summary__cell--column-clicked': table.getColumnClicked('fot-revenue'),
      }">
      <div class="calculation-summary__cell-content" data-bind="text: total.fotRevenue()"></div>
    </td>

    <!-- Норм. выработки -->
    <td class="calculation-summary__cell calculation-summary__cell--performance-standart"
      data-bind="style: {
        background: '#D0F4E3'
      }, css: {
        'calculation-summary__cell--column-clicked': table.getColumnClicked('performance-standart'),
      }">
      <div class="calculation-summary__cell-content" data-bind="text: total.performanceStandart()"></div>
    </td>

    <!-- Опоздания -->
    <td class="calculation-summary__cell calculation-summary__cell--lateness"  data-bind="css: {
      'calculation-summary__cell--column-clicked': table.getColumnClicked('lateness'),
    }">
      <div class="calculation-summary__cell-content">
        <!-- ko template: { name: 'lateness-template', data: {lateness: total.lateness(), total: total.lateness().total} } -->
        <!-- /ko -->
      </div>
    </td>
  </tr>

</script>

<script type="text/html"
        id="lateness-template">
  <div class="lateness">
    <div class="lateness__cell lateness__cell--light"
    data-bind="
    text: lateness.light > 0 ? lateness.light : '',
    style: {
      'background-color': lateness.light > 0 ? '#D0F4E3' : 'transparent',
    }"></div>
    <div class="lateness__cell lateness__cell--medium"
    data-bind="
    text: lateness.medium > 0 ? lateness.medium : '',
    style: {
      'background-color': lateness.medium > 0 ? '#FDFFB3' : 'transparent',
    }"></div>
    <div class="lateness__cell lateness__cell--hard"
    data-bind="
    text: lateness.hard > 0 ? lateness.hard : '',
    style: {
      'background-color': lateness.hard > 0 ? '#FFD3E8' : 'transparent',
    }"></div>
    <div class="lateness__cell lateness__cell--total"
    data-bind="text: total || '0'"></div>
  </div>
</script>

<template id="calculation-page-summary-table-template">

  <div class="calculation-summary"
       data-bind="let: {table: $component}">

    <!-- ko if: $root.utils.viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
    <div data-bind="component: {
      name: 'hrm-scrollable-wrapper',
      params: { options: {} }
     }">
      <table class="calculation-summary__table calculation-summary__desktop"
             data-bind="hrmTable">

        <thead>
          <tr class="calculation-summary__row">
            <!-- ko foreach: { data: table.columns, as: 'column' } -->
            <!-- ko let: { nextColumn: table.columns[$index() + 1] } -->
            <th class="calculation-summary__cell calculation-summary__head-cell"
                data-bind="class: 'calculation-summary__cell--' + column.id, attr: {
                  'colspan': column.colspan || 1
                }, click: function() { column.clicked(!column.clicked()) }, css: {
                  'calculation-summary__cell--column-clicked': column.clicked,
                  'calculation-summary__cell--column-clicked-top': column.clicked,
                }">
              <div class="calculation-summary__cell-content">
                <span data-bind="text: column.title"></span>
                <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-table__head-cell-info-button  calculation-summary__info-icon"
                        data-bind="hrmTooltip, hrmTooltipText: column.fullTitle"></button>
              </div>
            </th>
            <!-- /ko -->
            <!-- /ko -->
          </tr>
        </thead>

        <tbody>
          <!-- ko foreach: table.visiblePositions -->

          <!-- ko template: {name: 'summary-position-row-template', data: {position: $data }} -->
          <!-- /ko -->

          <!-- /ko -->

          <!-- ko template: {name: 'summary-drivers-row-template', data: {position: driversData }} -->
          <!-- /ko -->

          <!-- ko template: {name: 'summary-total-row-template', data: {total: total}} -->
          <!-- /ko -->



        </tbody>
      </table>
    </div>
    <!-- /ko -->

    <!-- ko ifnot: $root.utils.viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
    <div class="">

      <div data-bind="component: {
                     name: 'hrm-scrollable-wrapper',
                     params: { options: {left: {disabled: true}} }
                    }">
        <table class=" calculation-summary__table calculation-summary__mobile"
               data-bind="hrmTable">
          <tbody>
            <tr class="calculation-summary__row calculation-summary__row--job" data-bind="css: {
              'calculation-summary__row--column-clicked': table.getColumnClicked('job'),
            }">
              <th class="calculation-summary__cell calculation-summary__head-cell calculation-summary__cell--job">
                <div class="calculation-summary__cell-content">
                  Должность
                </div>
              </th>

              <!-- ko foreach: table.visiblePositions -->

              <td class="calculation-summary__cell calculation-summary__cell--job"
                  colspan="2" data-bind="css: {
                    'calculation-summary__cell--clicked': $data.clicked,
                    'calculation-summary__cell--clicked-top': $data.clicked,
                  }, click: function() { $data.clicked(!$data.clicked()); }">
                <div class="calculation-summary__cell-content"
                     data-bind="text: name"></div>
              </td>

              <!-- /ko -->

              <td class="calculation-summary__cell calculation-summary__cell--job"
                  colspan="2" data-bind="click: function() { table.driversData.clicked(!table.driversData.clicked()); }, css: {
                    'calculation-summary__cell--clicked': table.driversData.clicked,
                    'calculation-summary__cell--clicked-top': table.driversData.clicked,
                  }">
                <div class="calculation-summary__cell-content"
                     data-bind="text: driversData.name"></div>
              </td>

              <td class="calculation-summary__cell  calculation-summary__cell--job calculation-summary__cell--total">
                <div class="calculation-summary__cell-content">Итого</div>
              </td>
            </tr>

            <tr class="calculation-summary__row calculation-summary__row--workload-type" data-bind="css: {
              'calculation-summary__row--column-clicked': table.getColumnClicked('workload-type'),
            }">
              <th class="calculation-summary__cell calculation-summary__head-cell calculation-summary__cell--workload-type">
                <div class="calculation-summary__cell-content">
                  Тип нагрузки
                </div>
              </th>

              <!-- ko foreach: table.visiblePositions -->

              <td class="calculation-summary__cell calculation-summary__cell--workload-type" colspan="2"
              data-bind="css: {
                'calculation-summary__cell--clicked': $data.clicked,
              }, click: function() { $data.clicked(!$data.clicked()); }">
                <div class="calculation-summary__cell-content"
                     data-bind="text: workloadType"></div>
              </td>

              <!-- /ko -->

              <td class="calculation-summary__cell calculation-summary__cell--workload-type" colspan="2"
              data-bind="click: function() { table.driversData.clicked(!table.driversData.clicked()); }, css: {
                'calculation-summary__cell--clicked': table.driversData.clicked,
              }">
                <div class="calculation-summary__cell-content"
                     data-bind="text: table.driversData.workloadType"
                     ></div>
              </td>

              <td
                  class="calculation-summary__cell calculation-summary__cell--workload-type  calculation-summary__cell--total">
                <div class="calculation-summary__cell-content"
                     data-bind="text: table.total.workloadType"></div>
              </td>
            </tr>

            <tr class="calculation-summary__row calculation-summary__row--workload" data-bind="css: {
              'calculation-summary__row--column-clicked': table.getColumnClicked('workload'),
            }">
              <th class="calculation-summary__cell  calculation-summary__head-cell calculation-summary__cell--workload">
                <div class="calculation-summary__cell-content">
                  Нагрузка
                </div>
              </th>

              <!-- ko foreach: table.visiblePositions -->

              <!-- ko let: {editableCell: ko.observable(null)} -->

              <td class="calculation-summary__cell calculation-summary__cell--workload-value"
                  data-bind="hrmTableEditableCell: editableCell, css: {
                    'calculation-summary__cell--clicked': $data.clicked,
                  }, click: function(_, e) { e.stopPropagation() }" aligh="right">

                <input data-bind="
                  hrmMask, hrmMaskPattern: 'decimal',
                    value: workload,
                    hrmTableEditableCellInputControl,
                    hrmTableEditableCellInputControlOwner: editableCell
                ">

              </td>
              <!-- /ko -->
              <td class="calculation-summary__cell calculation-summary__cell--workload-units"  data-bind="html: $root.getUnitsSuffixHtml(workloadUnits), css: {
                'calculation-summary__cell--clicked': $data.clicked,
              }, click: function() { $data.clicked(!$data.clicked()); }">
                <div class="position-workload__units"></div>
              </td>

              <!-- /ko -->


              <td class="calculation-summary__cell calculation-summary__cell--workload-value"
              data-bind="click: function() { table.driversData.clicked(!table.driversData.clicked()); }, css: {
                'calculation-summary__cell--clicked': table.driversData.clicked,
              }" align="right">
                <div class="position-workload__value"
                     data-bind="text: table.driversData.workload"></div>
              </td>
              <td class="calculation-summary__cell calculation-summary__cell--workload-units"
              data-bind="click: function() { table.driversData.clicked(!table.driversData.clicked()); }, css: {
                'calculation-summary__cell--clicked': table.driversData.clicked,
              }">
                <div class="position-workload__units"
                     data-bind="html: $root.getUnitsSuffixHtml(table.driversData.workloadUnits)"></div>
              </td>

              <td
                  class="calculation-summary__cell calculation-summary__cell--workload-value  calculation-summary__cell--total">
                <div class="calculation-summary__cell-content"
                     data-bind="html: table.total.workload() + ' ' + $root.getUnitsSuffixHtml(table.total.workloadUnits())">
                </div>
              </td>
            </tr>

            <tr class="calculation-summary__row calculation-summary__row--additional-workload" data-bind="css: {
              'calculation-summary__row--column-clicked': table.getColumnClicked('additional-workload'),
            }">
              <th
                  class="calculation-summary__cell  calculation-summary__head-cell calculation-summary__cell--additional-workload">
                <div class="calculation-summary__cell-content">
                  Доп. нагрузка
                </div>
              </th>

              <!-- ko foreach: table.visiblePositions -->

              <td class="calculation-summary__cell calculation-summary__cell--additional-workload"
                  colspan="2" data-bind="css: {
                    'calculation-summary__cell--clicked': $data.clicked,
                  }, click: function() { $data.clicked(!$data.clicked()); }">
                <div class="calculation-summary__cell-content">
                  <!-- ko if: $data.additionalWorkload -->
                  <div class="position-additional-workload">
                    <div class="position-additional-workload__type"
                         data-bind="text: additionalWorkloadType"></div>
                    <div class="position-additional-workload__value"
                         data-bind="text: additionalWorkload"></div>

                  </div>
                  <!-- /ko -->
                </div>
              </td>

              <!-- /ko -->

              <td class="calculation-summary__cell calculation-summary__cell--additional-wokload"
                  colspan="2"  data-bind="click: function() { table.driversData.clicked(!table.driversData.clicked()); }, css: {
                    'calculation-summary__cell--clicked': table.driversData.clicked,
                  }">
                <div class="calculation-summary__cell-content">
                  <div class="position-additional-workload position-additional-workload--delivery">
                    <div class="position-additional-workload__type">Время без дела:</div>
                    <div class="position-additional-workload__value">
                      <!-- ko text: table.driversData.additionalWorkload() + '%' -->
                      <!-- /ko -->
                    </div>
                  </div>
                </div>
              </td>

              <td class="calculation-summary__cell calculation-summary__cell--additional-wokload  calculation-summary__cell--total">
              </td>
            </tr>

            <tr class="calculation-summary__row calculation-summary__row--count" data-bind="css: {
              'calculation-summary__row--column-clicked': table.getColumnClicked('count'),
            }">
              <th class="calculation-summary__cell calculation-summary__head-cell calculation-summary__cell--count">
                <div class="calculation-summary__cell-content">
                  Сотрудники
                </div>
              </th>

              <!-- ko foreach: table.visiblePositions -->

              <td class="calculation-summary__cell calculation-summary__cell--count"
                  colspan="2" data-bind="css: {
                    'calculation-summary__cell--clicked': $data.clicked,
                  }, click: function() { $data.clicked(!$data.clicked()); }">
                <div class="calculation-summary__cell-content"
                     data-bind="text: visibleEmployees().length"></div>
              </td>

              <!-- /ko -->

              <td class="calculation-summary__cell calculation-summary__cell--count"
                  colspan="2"  data-bind="click: function() { table.driversData.clicked(!table.driversData.clicked()); }, css: {
                    'calculation-summary__cell--clicked': table.driversData.clicked,
                  }">
                <div class="calculation-summary__cell-content"
                     data-bind="text: table.driversData.employees.length"></div>
              </td>

              <td class="calculation-summary__cell calculation-summary__cell--count  calculation-summary__cell--total">
                <div class="calculation-summary__cell-content"
                     data-bind="text: table.total.employees()"></div>
              </td>
            </tr>

            <tr class="calculation-summary__row calculation-summary__row--fot-category" data-bind="css: {
              'calculation-summary__row--column-clicked': table.getColumnClicked('fot-category'),
            }">
              <th class="calculation-summary__cell  calculation-summary__head-cell calculation-summary__cell--fot-category">
                <div class="calculation-summary__cell-content">
                  ФОТ, % в категории
                </div>
              </th>

              <!-- ko foreach: table.visiblePositions -->

              <td class="calculation-summary__cell calculation-summary__cell--fot-category"
                  colspan="2" data-bind="style: {
                    'background-color': '#FFD3E8'
                  }, css: {
                    'calculation-summary__cell--clicked': $data.clicked,
                  }, click: function() { $data.clicked(!$data.clicked()); }">
                <div class="calculation-summary__cell-content"
                     data-bind="text: fotCategory"></div>
              </td>

              <!-- /ko -->

              <td class="calculation-summary__cell calculation-summary__cell--fot-category"
                  colspan="2" data-bind="click: function() { table.driversData.clicked(!table.driversData.clicked()); }, css: {
                    'calculation-summary__cell--clicked': table.driversData.clicked,
                  }">
                <div class="calculation-summary__cell-content"
                     data-bind="text: table.driversData.fotCategory"></div>
              </td>

              <td class="calculation-summary__cell  calculation-summary__cell--fot-category calculation-summary__cell--total">
                <div class="calculation-summary__cell-content"
                     data-bind="text: table.total.fotCategory()"></div>
              </td>
            </tr>

            <tr class="calculation-summary__row calculation-summary__row--fot-revenue" data-bind="css: {
              'calculation-summary__row--column-clicked': table.getColumnClicked('fot-revenue'),
            }">
              <th class="calculation-summary__cell  calculation-summary__head-cell calculation-summary__cell--fot-revenue">
                <div class="calculation-summary__cell-content">
                  ФОТ, % от выручки
                </div>
              </th>

              <!-- ko foreach: table.visiblePositions -->

              <td class="calculation-summary__cell calculation-summary__cell--fot-revenue" data-bind="style: {
                'background-color': '#FFD3E8'
              }, css: {
                'calculation-summary__cell--clicked': $data.clicked,
              }, click: function() { $data.clicked(!$data.clicked()); }"
                  colspan="2">
                <div class="calculation-summary__cell-content"
                     data-bind="text: fotRevenue"></div>
              </td>

              <!-- /ko -->

              <td class="calculation-summary__cell calculation-summary__cell--fot-revenue"
                  colspan="2" data-bind="click: function() { table.driversData.clicked(!table.driversData.clicked()); }, css: {
                    'calculation-summary__cell--clicked': table.driversData.clicked,
                  }">
                <div class="calculation-summary__cell-content"
                     data-bind="text: table.driversData.fotRevenue"></div>
              </td>

              <td class="calculation-summary__cell calculation-summary__cell--fot-revenue  calculation-summary__cell--total">
                <div class="calculation-summary__cell-content"
                     data-bind="text: table.total.fotRevenue()"></div>
              </td>
            </tr>

            <tr class="calculation-summary__row calculation-summary__row--performance-standart" data-bind="css: {
              'calculation-summary__row--column-clicked': table.getColumnClicked('performance-standart'),
            }">
              <th class="calculation-summary__cell  calculation-summary__head-cell calculation-summary__cell--performance-standart">
                <div class="calculation-summary__cell-content">
                  Норм. выр-ки, %
                </div>
              </th>



              <!-- ko foreach: table.visiblePositions -->

              <td class="calculation-summary__cell calculation-summary__cell--performance-standart"
                  colspan="2" data-bind="style: {
                    'background-color': '#D0F4E3'
                  }, css: {
                    'calculation-summary__cell--clicked': $data.clicked,
                  }, click: function() { $data.clicked(!$data.clicked()); }">
                <div class="calculation-summary__cell-content">
                  <div class="position-performance-standart">
                    <div class="position-performance-standart__value"
                         data-bind="text: performanceStandart"></div>
                  </div>
                </div>
              </td>

              <!-- /ko -->

              <td class="calculation-summary__cell calculation-summary__cell--performance-standart"
                  colspan="2" data-bind="click: function() { table.driversData.clicked(!table.driversData.clicked()); }, css: {
                    'calculation-summary__cell--clicked': table.driversData.clicked,
                  }">
                <div class="calculation-summary__cell-content">
                  <div class="position-performance-standart">

                    <div class="position-performance-standart__label"
                         data-bind="html: table.driversData.performanceStandartType  + ', ' + $root.getUnitsSuffixHtml(table.driversData.performanceStandartUnits)"></div>


                    <div class="position-performance-standart__value"
                         data-bind="text: table.driversData.performanceStandart"></div>
                  </div>
                </div>
              </td>

              <td class="calculation-summary__cell calculation-summary__cell--performance-standart  calculation-summary__cell--total">
                <div class="calculation-summary__cell-content"
                     data-bind="text: table.total.performanceStandart()"></div>
              </td>
            </tr>

            <tr class="calculation-summary__row calculation-summary__row--lateness" data-bind="css: {
              'calculation-summary__row--column-clicked': table.getColumnClicked('lateness'),
            }">
              <th class="calculation-summary__cell  calculation-summary__head-cell calculation-summary__cell--lateness">
                <div class="calculation-summary__cell-content">
                  Опоздания
                </div>
              </th>

              <!-- ko foreach: table.visiblePositions -->

              <td class="calculation-summary__cell calculation-summary__cell--lateness"
                  colspan="2" data-bind="css: {
                    'calculation-summary__cell--clicked': $data.clicked,
                    'calculation-summary__cell--clicked-bottom': $data.clicked,
                  }, click: function() { $data.clicked(!$data.clicked()); }">
                <!-- ko template: { name: 'lateness-template', data: {lateness: lateness(), total: totalLateness} } -->
                <!-- /ko -->
              </td>

              <!-- /ko -->

              <td class="calculation-summary__cell calculation-summary__cell--lateness"
                  colspan="2" data-bind="click: function() { table.driversData.clicked(!table.driversData.clicked()); }, css: {
                    'calculation-summary__cell--clicked': table.driversData.clicked,
                    'calculation-summary__cell--clicked-bottom': table.driversData.clicked,
                  }">
                <!-- ko template: { name: 'lateness-template', data: {lateness: table.driversData.lateness(), total: table.driversData.totalLateness} } -->
                <!-- /ko -->
              </td>

              <td class="calculation-summary__cell calculation-summary__cell--lateness   calculation-summary__cell--total">
                <div class="calculation-summary__cell-content">
                  <!-- ko template: { name: 'lateness-template', data: {lateness: table.total.lateness(), total: table.total.lateness().total} } -->
                  <!-- /ko -->
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <!-- /ko -->
  </div>
</template>


<script type="text/javascript">
  $(function () {
    function Column(id, title, fullTitle, colspan) {
      return {
        id,
        title,
        fullTitle,
        colspan,
        clicked: ko.observable(false)
      }
    }

    ko.components.register('calculation-page-summary-table', {
      viewModel: {
        /**
        * @param {ObservableArray} params.positions
        */
        createViewModel: function (params, componentInfo) {
          const model = params.model;
          const positions = model.positions;

          const visiblePositions = ko.computed(() => {
            return positions().filter(p => {
              if (p.visible()) return true;
              if (p.visibleEmployees().length > 0) return true;
            });
          });

          const driversData = model.driversData();

          const total = model.total;

          const columns = [
            Column('job', 'Должность', 'Должность'),
            Column('workload-type', 'Тип нагрузки', 'Тип нагрузки'),
            Column('workload', 'Нагрузка', 'Нагрузка', 2),
            Column('additional-workload', 'Доп. нагрузка', 'Дополнительная нагрузка'),
            Column('count', 'Сотр.', 'Сотрудники'),
            Column('fot-category', 'ФОТ, % в категории', 'ФОТ, % в категории'),
            Column('fot-revenue', 'ФОТ, % от выручки', 'ФОТ, % от выручки'),
            Column('performance-standart', 'Норм. выр-ки, %', 'Норма выработки, %'),
            Column('lateness', 'Опоздания', 'Опоздания'),
          ];

          const getColumnClicked = (columnId) => {
            let column = columns.find(c => c.id === columnId);
            if (!column) return false;
            return column.clicked;
          };


          return {
            getColumnClicked,
            positions,
            visiblePositions,
            total,
            columns,
            driversData
          };
        }
      },
      template: {
        element: document.getElementById('calculation-page-summary-table-template')
      }
    });
  })
</script>

  <!-- Выпадающее меню сотрудников -->
<script id="employees-dropdown-template" type="text/html">
        <div class="hrm-dropdown-menu__item" data-bind="click: addEmployees">Добавить сотрудников</div>
        <div class="hrm-dropdown-menu__item" data-bind="click: createEmployee">Новый сотрудник</div>
</script>

<!-- Заголовок позиции в таблице -->
<script id="position-header-template" type="text/html">
  <button data-bind="hrmTooltip, hrmTooltipHideOnClick, hrmTooltipText: 'Добавить сотрудников', click: table.addEmployeesInPosition"
    class="positions-table__add-employee hrm-button hrm-circle-icon-button hrm-circle-plus-icon-button hrm-circle-icon-button--theme_neutral positions-table__action">
  </button>
  <span data-bind="text: name"></span>
</script>

<!-- Блок сотрудника в таблице -->
<script id="employee-block-template" type="text/html">
  <div class="employee">
    <div class="employee__remove">
      <button data-bind="
      hrmTooltip,
      hrmTooltipText: 'Удалить из расчета',,
      click: table.removeEmployee.bind(table, employee)"
              class="hrm-button hrm-circle-icon-button hrm-circle-times-icon-button hrm-circle-icon-button--theme_secondary positions-table__action employe__remove-button">
      </button>
    </div>

    <div class="employee__info">
      <!-- ko if: employee.link -->
      <a class="employee__name"
        href="#"
        data-bind="text: employee.name, click: function(_, e) { e.stopPropagation(); }"></a>
      <!-- /ko -->
      <!-- ko ifnot: employee.link -->
      <span class="employee__name" data-bind="text: employee.name"></span>
      <!-- /ko -->
      <!-- ko if: positionName -->
        <div class="employee__position" data-bind="text: positionName"></div>
      <!-- /ko -->
    </div>

    <div class="employee__actions">
      <!-- ko if: employee.hasProblems -->
      <button
              class="hrm-button hrm-icon-button hrm-icon-button--theme_negative hrm-sheet-icon-button employee__action employee__action--documents" data-bind="hrmTooltip, hrmTooltipText: 'Есть проблемы с документами'"></button>
      <!-- /ko -->
      <!-- ko if: employee.downRecommended -->
      <button
              class="hrm-button hrm-icon-button hrm-icon-button--theme_negative hrm-arrow-down-icon-button employee__action employee__action--down" data-bind="hrmTooltip, hrmTooltipText: 'Рекомендуется понижение разряда'"></button>
      <!-- /ko -->
      <!-- ko if: employee.upRecommended -->
      <button
              class="hrm-button hrm-icon-button hrm-icon-button--theme_positive hrm-arrow-up-icon-button employee__action employee__action--up" data-bind="hrmTooltip, hrmTooltipText: 'Рекомендуется повышение разряда'"></button>
      <!-- /ko -->

    </div>
  </div>
</script>

<!-- Рабочий интервал -->
<script id="working-interval-template" type="text/html">

  <!-- ko let: {editableCell: ko.observable(null)} -->
<td class="hrm-table__cell positions-table__cell working-interval__cell" data-bind="hrmTableEditableCell: editableCell,
              hrmTableEditableCellError: table.editableCellErrorStateMatcher(interval.value)">
  <div class="working-interval">
    <input class="working-interval__input" data-bind="
                  textInput: interval.value,
                  hrmMask,
                  hrmMaskPattern: '99:99 – 99:99',
                  hrmTableEditableCellInputControl,
                  hrmTableEditableCellInputControlOwner: editableCell
              " placeholder="00:00 – 00:00">

    <div class="working-interval__actions">
      <div class="working-interval__action">
        <!-- ko if: canRemove -->
        <button class="hrm-button hrm-icon-button hrm-times-icon-button
                                    hrm-icon-button--theme_negative
                                    working-interval__remove" data-bind="
                                  click: function () {employee.removeWorkingInterval(interval);},
                                  attr: {title: 'Удалить интервал ' }
                              ">
        </button>
        <!-- /ko -->
      </div>
      <div class="working-interval__action">
        <!-- ko if: canAdd -->
        <button class="hrm-button hrm-icon-button hrm-plus-icon-button
                                  hrm-icon-button--theme_positive
                                  working-interval__add" title="Добавить рабочий интервал"
          data-bind="click: function () { employee.addWorkingInterval() }">
        </button>
        <!-- /ko -->
      </div>
    </div>
  </div>

</td>
<!-- /ko -->
</script>

<!-- Строка сотрудника в таблице -->
<script id="employee-row-template" type="text/html">

<tr class="positions-table__row"
data-bind="click: function() {
  employee.clicked(!employee.clicked());
},
css: {
  'positions-table__row--clicked': employee.clicked,
}">
  <td class="positions-table__cell positions-table__cell--name">
    <div class="positions-table__cell-content">

      <!-- Данные сотрудника -->
      <div
           data-bind="template: { name: 'employee-block-template', data: {employee: employee, positionName: positionName} }">
      </div>
      <!-- /Данные сотрудника -->

    </div>
  </td>

  <!-- ko if: table.isColumnVisible('account') -->
    <td class="positions-table__cell positions-table__cell--account" data-bind="css: {
      'positions-table__cell--clicked': table.getColumnClicked('account'),
    }" align="right">
      <div class="positions-table__cell-content">
        <!-- ko text: employee.premiumAccount() + '/' + employee.account() -->
        <!-- /ko -->
      </div>
    </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('account-operations') -->
    <!-- ko let: {editableCell: ko.observable(null)} -->
    <td class="positions-table__cell positions-table__cell--account-operations"
        data-bind="click: function(_, e) {
          e.stopPropagation();
          table.performAccountOperations(employee);
        }, hrmTableEditableCell: editableCell, css: {
          'positions-table__cell--clicked': table.getColumnClicked('account-operations'),
        }" align="right">
        <div class="positions-table__cell-content" data-bind="text: $root.utils.formatSign(employee.accountState), hrmColoredSign: employee.accountState"></div>
    </td>
    <!-- /ko -->
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('level') -->
    <!-- ko if: position.levels.length > 0 -->
    <!-- ko let: {editableCell: ko.observable(null)} -->
    <td data-bind="hrmTableEditableCell: editableCell, click: function(_, e) { e.stopPropagation(); },
    css: {
      'positions-table__cell--clicked': table.getColumnClicked('level'),
    }"
        class="positions-table__cell positions-table__cell--level">
      <select data-bind="
                    options: position.levels,
                    value: employee.level,
                    hrmSelect,
                    hrmTableEditableCellSelectControl,
                    hrmTableEditableCellSelectControlOwner: editableCell
                ">
      </select>
    </td>
    <!-- /ko -->
    <!-- /ko -->

    <!-- ko ifnot: position.levels.length > 0 -->
    <td class="positions-table__cell positions-table__cell--level positions-table__cell--inactive"  data-bind="css: {
      'positions-table__cell--clicked': table.getColumnClicked('level'),
    }">
    </td>
    <!-- /ko -->
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('interval') -->
    <td class="positions-table__cell positions-table__cell--interval" data-bind="click: function(_, e) { e.stopPropagation(); }, css: {
      'positions-table__cell--clicked': table.getColumnClicked('interval'),
    }">
      <table class="working-intervals">
        <tbody data-bind="let: {intervalsCount: employee.workingIntervals().length}">
          <!-- ko foreach: employee.workingIntervals() -->
          <tr class="working-intervals__row">

              <!-- ko template: { name: 'working-interval-template', data: { interval: $data, canRemove: intervalsCount > 1, canAdd: $index() === intervalsCount - 1 } } -->
              <!-- /ko -->

          </tr>
          <!-- /ko -->
        </tbody>
      </table>
    </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('work-time') -->
    <td class="positions-table__cell positions-table__cell--work-time"  data-bind="css: {
      'positions-table__cell--clicked': table.getColumnClicked('work-time'),
    }" align="right">
      <div class="positions-table__cell-content" data-bind="text: $root.utils.formatTime(employee.workingTime())"></div>
    </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('compensation') -->
    <!-- ko if: employee.isCompensationEditable -->
    <!-- ko let: { editableCell: ko.observable(null) } -->
    <td class="positions-table__cell positions-table__cell--compensation"  data-bind="hrmTableEditableCell: editableCell,
    hrmTableEditableCellError: $root.formControlErrorStateMatcher(employee.compensation),
    click: function(_, e) {
      e.stopPropagation();
      editableCell().hideError();
      employee.editCompensation();
    },
    css: {
      'positions-table__cell--clicked': table.getColumnClicked('compensation'),
    }" align="right">
      <div class="positions-table__cell-content" data-bind="text: employee.compensation() ? employee.compensation().sum : 0"></div>
    </td>
    <!-- /ko -->
    <!-- /ko -->


    <!-- ko ifnot: employee.isCompensationEditable -->
    <td class="positions-table__cell positions-table__cell--compensation"  data-bind="css: {
      'positions-table__cell--clicked': table.getColumnClicked('compensation'),
    }" align="right">
      <div class="positions-table__cell-content">0</div>
    </td>
  <!-- /ko -->
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('remove-workload') -->
  <td class="positions-table__cell positions-table__cell--remove-workload"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('remove-workload'),
  }" align="right">
    <div class="positions-table__cell-content">
      <div class="d-flex">
        <button class="battery-icon hrm-button hrm-icon-button hrm-battery-full-icon-button hrm-icon-button--theme_secondary"
          data-bind="hrmTooltip, hrmTooltipHideOnClick, hrmTooltipText: 'Частично освободить от нагрузки',
          click: function(_, e) {
            e.stopPropagation();
            employee.removeWorkloadPartially();
        }"></button>
      <button class="battery-icon hrm-button hrm-icon-button hrm-battery-empty-icon-button hrm-icon-button--theme_secondary"
        data-bind="hrmTooltip, hrmTooltipHideOnClick, hrmTooltipText: 'Полностью освободить от нагрузки',
        click: function(_, e) {
          e.stopPropagation();
          employee.removeWorkloadCompletely();
      }"></button>
      </div>
    </div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('workload') -->
  <td class="positions-table__cell positions-table__cell--workload"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('workload'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: employee.workload"></div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('salary') -->
  <td class="positions-table__cell positions-table__cell--salary"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('salary'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: employee.salary"></div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('salary-bulk') -->
  <td class="positions-table__cell positions-table__cell--salary-bulk"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('salary-bulk'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: employee.salaryBulk"></div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('revenue-standart-hour') -->
  <td class="positions-table__cell positions-table__cell--revenue-standart-hour"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('revenue-standart-hour'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: employee.revenueStandartPerHour"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('normalization-ratio') -->
  <td class="positions-table__cell positions-table__cell--normalization-ratio"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('normalization-ratio'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: employee.normRatio"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('revenue-standart') -->
  <td class="positions-table__cell positions-table__cell--revenue-standart"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('revenue-standart'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: employee.revenueStandart"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('bonus-ratio') -->
  <td class="positions-table__cell positions-table__cell--bonus-ratio"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('bonus-ratio'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: employee.bonusRatio"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('depremation-ratio') -->
  <td class="positions-table__cell positions-table__cell--depremation-ratio"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('depremation-ratio'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: employee.depremationRatio"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('corrected-time') -->
  <td class="positions-table__cell positions-table__cell--corrected-time"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('corrected-time'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: $root.utils.formatTime(employee.correctedTime)"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('bonus-exceed') -->
  <td class="positions-table__cell positions-table__cell--bonus-exceed"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('bonus-exceed'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: employee.bonusExceed"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('depremation') -->
  <td class="positions-table__cell positions-table__cell--depremation"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('depremation'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: employee.depremation"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('premation') -->
    <!-- ko let: {editableCell: ko.observable(null)} -->
    <td class="positions-table__cell positions-table__cell--premation" align="right"
        data-bind="click: function(_, e) {
          e.stopPropagation();
          table.giveBonus(employee);
        }, hrmTableEditableCell: editableCell, style: {
          'background-color': employee.bonusesState() > 0 ? '#D0F4E3' : ''
        }, css: {
          'positions-table__cell--clicked': table.getColumnClicked('premation'),
        }" align="right">
        <div class="positions-table__cell-content" data-bind="text: employee.bonusesState"></div>
    </td>
    <!-- /ko -->
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('fine') -->
    <!-- ko let: {editableCell: ko.observable(null)} -->
    <td class="positions-table__cell positions-table__cell--fine" align="right"
        data-bind="click: function(_,e) {
          e.stopPropagation();
          table.giveFine(employee);
        }, hrmTableEditableCell: editableCell,
        style: {
          'background-color': employee.finesState() > 0 ? '#FFD3E8' : ''
        }, css: {
          'positions-table__cell--clicked': table.getColumnClicked('fine'),
        }" align="right">
        <div class="positions-table__cell-content" data-bind="text: employee.finesState"></div>
    </td>
    <!-- /ko -->
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('total') -->
  <td class="positions-table__cell  positions-table__cell--total positions-table__cell--colored"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('total'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: employee.total"></div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('payment') -->
  <td class="positions-table__cell  positions-table__cell--payment positions-table__cell--colored"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('payment'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: employee.toPayment"></div>
  </td>
  <!-- /ko -->
</tr>

</script>

<!-- Строка Итого -->
<script id="total-row-template" type="text/html">

<tr class="positions-table__row positions-table__row--highlighted positions-table__total">
  <td class="positions-table__cell positions-table__cell--name positions-table__cell--empty"></td>

  <!-- ko if: table.isColumnVisible('account') -->
  <td class="positions-table__cell positions-table__cell--account positions-table__cell--empty" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('account'),
  }" align="right"></td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('account-operations') -->
  <td class="positions-table__cell positions-table__cell--account-operations positions-table__cell--empty" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('account-operations'),
  }" ></td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('level') -->
  <td class="positions-table__cell positions-table__cell--level positions-table__cell--empty" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('level'),
  }"></td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('interval') -->
  <td class="positions-table__cell positions-table__cell--interval positions-table__cell--empty" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('interval'),
  }"></td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('work-time') -->
  <td class="positions-table__cell positions-table__cell--work-time" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('work-time'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: $root.utils.formatTime(total.workingTime())"></div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('compensation') -->
  <td class="positions-table__cell positions-table__cell--compensation positions-table__cell--empty" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('compensation'),
  }" align="right"></td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('workload') -->
  <td class="positions-table__cell positions-table__cell--workload positions-table__cell--empty" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('workload'),
  }" align="right"></td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('remove-workload') -->
  <td class="positions-table__cell positions-table__cell--remove-workload positions-table__cell--empty" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('remove-workload'),
  }" align="right"></td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('salary') -->
  <td class="positions-table__cell positions-table__cell--salary positions-table__cell--empty" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('salary'),
  }" align="right">
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('salary-bulk') -->
  <td class="positions-table__cell positions-table__cell--salary-bulk" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('salary-bulk'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: total.salaryBulk()"></div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('revenue-standart-hour') -->
  <td class="positions-table__cell positions-table__cell--revenue-standart-hour positions-table__cell--empty" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('revenue-standart-hour'),
  }" align="right" ></td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('normalization-ratio') -->
  <td class="positions-table__cell positions-table__cell--normalization-ratio" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('normalization-ratio'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: total.normRatio()"></div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('revenue-standart') -->
  <td class="positions-table__cell positions-table__cell--revenue-standart" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('revenue-standart'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: total.revenueStandart()"></div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('bonus-ratio') -->
  <td class="positions-table__cell positions-table__cell--bonus-ratio" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('bonus-ratio'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: total.bonusRatio()"></div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('depremation-ratio') -->
  <td class="positions-table__cell positions-table__cell--depremation-ratio" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('depremation-ratio'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: total.depremationRatio()"></div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('corrected-time') -->
  <td class="positions-table__cell positions-table__cell--corrected-time" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('corrected-time'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: $root.utils.formatTime(total.correctedTime())"></div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('bonus-exceed') -->
  <td class="positions-table__cell positions-table__cell--bonus-exceed" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('bonus-exceed'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: total.bonusExceed()"></div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('depremation') -->
  <td class="positions-table__cell positions-table__cell--depremation positions-table__cell--empty" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('depremation'),
  }" align="right"></td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('premation') -->
  <td class="positions-table__cell positions-table__cell--premation positions-table__cell--empty" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('premation'),
  }" align="right"></td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('fine') -->
  <td class="positions-table__cell positions-table__cell--fine positions-table__cell--empty" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('fine'),
  }" align="right"></td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('total') -->
  <td class="positions-table__cell  positions-table__cell--total positions-table__cell--colored" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('total'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: total.total()"></div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('payment') -->
  <td class="positions-table__cell  positions-table__cell--payment positions-table__cell--colored" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('payment'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: total.toPayment()"></div>
  </td>
  <!-- /ko -->
</tr>

</script>

<template id="calculation-page-positions-table-template">
  <div class="calculation-tab"
       data-bind="class: 'calculation-' + tabName">

    <div class="calculation-tab__settings">
      <div class="calculation-tab__settings-group">
        <!-- ko if: viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
        <!-- Сотрудники -->
        <button class="hrm-button hrm-button-with-icon-right hrm-button-with-arrow-down-icon-right hrm-button-with-icon--theme_secondary calculation-tab__settings-button calculation-tab__settings-employees"
                data-bind="hrmDropdownMenu, hrmDropdownMenuTemplate: 'employees-dropdown-template'">
          Сотрудники
        </button>

        <!-- Должности -->
        <button class="hrm-button hrm-basic-button hrm-button--size_medium  calculation-tab__settings-button calculation-tab__settings-positions"
                data-bind="click: setPositions">
          Должности
        </button>

        <!-- Штраф/премия -->
        <button class="hrm-button hrm-basic-button hrm-button--size_medium  calculation-tab__settings-button calculation-tab__settings-stimulation"
                data-bind="click: function() { $root.stimulation.set('production'); }, disable: $root.stimulation.isProductionBlocked">
          Штраф/премия смене
        </button>
        <!-- /ko -->

        <!-- ko ifnot: viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
        <!-- Сотрудники -->
        <button class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_desktop hrm-button-with-person-icon hrm-button-with-icon--theme_secondary  calculation-tab__settings-button calculation-tab__settings-employees"
                data-bind="hrmDropdownMenu, hrmDropdownMenuTemplate: 'employees-dropdown-template'"></button>

        <!-- Должности -->
        <button class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_desktop hrm-button-with-badge-icon hrm-button-with-icon--theme_secondary  calculation-tab__settings-button calculation-tab__settings-positions"
                data-bind="click: setPositions"></button>

        <!-- Штраф/премия -->
        <button data-bind="click: function() { $root.stimulation.set('production') }"
                class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_desktop hrm-button-with-money-icon hrm-button-with-icon--theme_secondary  calculation-tab__settings-button calculation-tab__settings-stimulation"></button>
        <!-- /ko -->
      </div><!-- .calculation-tab__settings-group -->
      <div class="calculation-tab__settings-group">
        <!-- Столбцы -->
        <button class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_tablet hrm-button-with-icon--theme_secondary hrm-button-with-settings-icon templates__button-with-icon calculation-tab__settings-button calculation-tab__settings-columns"
                data-bind="click: setColumns">
          Настроить столбцы
        </button>

        <!-- Меньше информации -->
        <button
                class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_tablet hrm-button-with-icon--theme_secondary hrm-button-with-less-icon templates__button-with-icon  calculation-tab__settings-button calculation-tab__settings-less-info"
                data-bind="click: lessInfo, disable: blockLessInfo">
          Меньше информации
        </button>

        <!-- Больше информации -->
        <button
                class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_tablet hrm-button-with-icon--theme_secondary hrm-button-with-more-icon templates__button-with-icon hrm-button-with-icon--hide_tablet  calculation-tab__settings-button calculation-tab__settings-more-info"
                data-bind="click: moreInfo, disable: blockMoreInfo">
          Больше информации
        </button>
      </div><!-- .calculation-tab__settings-group -->
    </div><!-- .calculation-tab__settings -->

    <div class="positions-table"
         data-bind="let: {table: $data}">

      <div data-bind="component: { name: 'hrm-scrollable-wrapper', params: { options: {left: {disabled: true}} }}">
        <table data-bind="hrmTable"
               class="positions-table__main-table">

          <colgroup>
            <col class="positions-table__col positions-table__col--name">
            <!-- ko foreach: table.columns -->
            <!-- ko if: $data.visible -->
            <col class="positions-table__col"
                 data-bind="class: 'position-table__col--' + id">
            <!-- /ko -->
            <!-- /ko -->
          </colgroup>

          <thead>
            <tr class="positions-table__row positions-table__head-row">
              <th class="positions-table__cell positions-table__head-cell positions-table__cell--name">
                <div class="positions-table__cell-content">Сотрудник</div>
              </th>

              <!-- ko foreach: table.columns -->
              <!-- ko if: $data.visible -->
              <th class="positions-table__cell positions-table__head-cell"
                  data-bind="class: 'positions-table__cell--' + id, css: {
                    'positions-table__cell--colored': colored,
                      'positions-table__cell--clicked': table.getColumnClicked($data.id),
                  }, click: function() { $data.clicked(!$data.clicked())}">
                <div class="positions-table__cell-content">
                  <span data-bind="text: title"></span>
                  <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-table__head-cell-info-button positions-table__info-icon"
                          data-bind="hrmTooltip, hrmTooltipText: fullTitle"></button>
                </div>
              </th>
              <!-- /ko -->
              <!-- /ko -->
            </tr>
          </thead>

          <tbody>
            <!-- Блок позиции -->
            <!-- ko foreach: { data: table.positions, as: 'position' } -->
            <!-- Название позиции -->
            <!-- ko if: position.visible -->
            <tr class="positions-table__row positions-table__row--highlighted positions-table__section-header">
              <td class="positions-table__cell positions-table__position-title">

                <div class="positions-table__cell-content">

                  <div data-bind="template: {name: 'position-header-template', data: position}"></div>

                </div>
              </td>
              <td data-bind="attr: {colspan: $parent.columnCount() - 1}"></td>
            </tr>
            <!-- /Название позиции -->

            <!-- Список сотрудников по позиции -->
            <!-- ko foreach: { data: position.visibleEmployees, as: 'employee', beforeRemove: hrmFadeBeforeRemoveFactory(500) } -->

            <!-- ko template: {
              name: 'employee-row-template',
              data: { employee: employee, position: position, positionName: false }
            } -->
            <!-- /ko -->

            <!-- /ko -->
            <!-- Список сотрудников по позиции -->

            <!-- /ko -->
            <!-- /ko -->
            <!-- /Блок позиции -->

            <!-- Блок Прочие -->
            <!-- ko if: table.hasOtherSection -->
            <tr class="positions-table__row positions-table__row--highlighted positions-table__section-header">
              <td class="positions-table__cell  positions-table__position-title">
                <div class="positions-table__cell-content">
                  <div data-bind="template: {name: 'position-header-template', data: {name: 'Прочие'}}"></div>
                </div>
              </td>
              <td data-bind="attr: {colspan: columnCount() - 1}"></td>
            </tr>

            <!-- ko foreach: { data: table.positions, as: 'position' } -->
            <!-- ko ifnot: position.visible -->
            <!-- ko foreach: { data: position.visibleEmployees, as: 'employee', beforeRemove: hrmFadeBeforeRemoveFactory(500) } -->




            <!-- ko template: {
              name: 'employee-row-template',
              data: {
                employee: employee, position: position, positionName: position.name,
              }
            } -->
            <!-- /ko -->



            <!-- /ko -->
            <!-- /ko -->
            <!-- /ko -->
            <!-- /ko -->
            <!-- /Блок Прочее -->

            <!-- Total section -->
            <!-- ko template: { name: 'total-row-template', data: { total: table.total } } -->
            <!-- /ko -->
            <!-- /Total section -->
          </tbody>
        </table>

      </div>
    </div>
  </div>
</template>


<script type="text/javascript">
  $(function () {
    function Column(id, title, fullTitle, colored) {
      return {
        id,
        title,
        fullTitle,
        colored,
        visible: ko.observable(true),
        clicked: ko.observable(false)
      }
    }

    ko.components.register('calculation-page-positions-table', {
      viewModel: {
        /**
        * @param {ObservableArray} params.positions
        */
        createViewModel: function (params, componentInfo) {
          const editableCellErrorStateMatcher = (control) => {
            return ko.pureComputed(() => {
              return !control.isValid() ? { message: control.error() } : null;

            });
          };



          const positions = params.positions;
          const model = params.model;

          /** Invisible positions */
          const hasOtherSection = ko.pureComputed(() => {
            return positions().some(position => {
              return !position.visible();
            });
          });

          const total = params.total;


          /* Table columns */
          const columns = [
            Column('account', 'Прем./ЛС, ₽', 'Премиальный счет/личный счет, ₽'),
            Column('account-operations', 'Операции с ЛС, ₽', 'Операции с личным счетом, ₽'),
            Column('level', 'Разряд', 'Разряд'),
            Column('interval', 'Начало/конец работы', 'Начало/конец работы'),
            Column('work-time', 'Рабочее время', 'Рабочее время'),
            Column('compensation', 'Компенс.', 'Компенсация'),
            Column('remove-workload', 'Освободить от нагрузки', 'Освободить от нагрузки'),
            Column('workload', 'Нагрузка', 'Нагрузка'),
            Column('salary', 'Оклад, ₽', 'Оклад, ₽'),
            Column('salary-bulk', 'Осн. часть зп, ₽', 'Основная часть зарплаты, ₽'),
            Column('revenue-standart-hour', 'Норм. выр-ки/ч', 'Норматив выручки/ч'),
            Column('normalization-ratio', 'Коэфф. норм.', 'Коэффициент  норматива'),
            Column('revenue-standart', 'Норм. выр-ки', 'Норматив выручки'),
            Column('bonus-ratio', 'Коэфф. прем.-я', 'Коэффициент премирования'),
            Column('depremation-ratio', 'Коэфф. депр.-я', 'Коэффициент депремирования'),
            Column('corrected-time', 'Корр. время', 'Корректированное время'),
            Column('bonus-exceed', 'Премия за прев. норм., ₽', 'Премия за превышение норматива, ₽'),
            Column('depremation', 'Депр., ₽', 'Депремирование, ₽'),
            Column('premation', 'Премия, ₽', 'Премия, ₽'),
            Column('fine', 'Штраф, ₽', 'Штраф, ₽'),

            Column('total', 'Всего начислено, ₽', 'Всего начислено, ₽', true),
            Column('payment', 'К выплате, ₽', 'К выплате, ₽', true)
          ];
          const defaultColumnsState = localStorage.getItem('calculation-page-employees-columns');
          if (defaultColumnsState) {
            const state = JSON.parse(defaultColumnsState);
            columns.forEach(column => {
              if (column.id in state && state[column.id] === 0) {
                column.visible(false);
              }
            })
          };

          const activeColumns = ko.pureComputed(() => {
            return columns.filter(c => c.visible()).length;
          });
          const isColumnVisible = (columnName) => {
            const column = columns.find(c => c.id === columnName);
            if (column) return column.visible;
            else return false;
          };
          const columnCount = ko.pureComputed(() => {
            return activeColumns() + 1;
          });

          const getColumnClicked = (columnName) => {
            const column = columns.find(c => c.id === columnName);
            if (column) return column.clicked;
          }


          /** Sets positions visibility */
          function setPositions() {
            params.utils.openModal('positions', { positions: positions })
          }

          /** Sets columns visibility */
          function setColumns() {
            params.utils.openModal('columns', { columns: columns }, () => {
              saveColumnsState();
            });
          }

          function setColumnsState(set) {
            columns.forEach(c => {
              const isVisible = set ? set.includes(c.id) : true;
              c.visible(isVisible);
            });
            saveColumnsState();
          }

          function saveColumnsState() {
            const state = columns.reduce((acc, column) => {
              return {
                ...acc,
                [column.id]: column.visible() ? 1 : 0
              }
            }, {});
            localStorage.setItem('calculation-page-employees-columns', JSON.stringify(state));
          }



          const columnSets = [
            ['account', 'account-operations', 'level', 'interval', 'compensation', 'salary-bulk', 'bonus-exceed', 'depremation', 'premation', 'fine', 'payment'],
            ['payment']
          ];
          const columnSetsIndex = ko.observable(-1);
          const blockMoreInfo = ko.pureComputed(() => {
            return !columns.some(c => !c.visible());
          });
          const blockLessInfo = ko.pureComputed(() => {
            return !columns
              .filter(c => !columnSets[1].includes(c.id))
              .some(c => c.visible());
          });

          const moreInfo = () => {
            const hasInvisibleColumns = columns.filter(c => columnSets[0].includes(c.id))
            .some(c => !c.visible());
            if (hasInvisibleColumns) setColumnsState(columnSets[0]);
            else setColumnsState();
            $(window).resize();
          };

          const lessInfo = () => {
            const hasVisibleColumns = columns.filter(c => !columnSets[0].includes(c.id))
                .some(c => c.visible());
            if (hasVisibleColumns) setColumnsState(columnSets[0]);
            else setColumnsState(columnSets[1]);
            $(window).resize();
          };


          function updatePositionEmployees(positionData) {
            const positionModel = model.getPositionById(positionData.id);
            positionModel.allEmployeesLoaded(positionData.loaded);
            positionModel.updateEmployees(positionData.employees);
          }

          /** Creates new employee */
          function createEmployee() {
            params.utils.openModal(
              'create-employee',
              { positions: positions() },
              (data) => {
                const position = model.getPositionById(data.position);
                position.addEmployee({
                  name: data.name,
                  level: data.level,
                });
              });
          };

          /** Adds employees to calculation */
          function addEmployees() {
            params.utils.openModal('add-employees', {
              positions: positions(),
              mode: 'tabs',
            }, (updatedList) => {
              updatedList.forEach(updatePositionEmployees)
            });
          };

          /**
          * Adds employees to calculation (specified position)
          * @param {Object} position
          */
          function addEmployeesInPosition(position) {
            const originalPosition = model.getPositionById(position.id);

            if (originalPosition) {
              params.utils.openModal('add-employees',
                { position: originalPosition, mode: 'single' },
                (updatedList) => {
                  updatedList.forEach(updatePositionEmployees)
                });
            } else {
              const invisiblePositions = positions().filter(p => !p.visible());
              params.utils.openModal('add-employees',
                { positions: invisiblePositions, mode: 'list' },
                (updatedList) => {
                  updatedList.forEach(updatePositionEmployees)
                });
            }
          };

          /**
          * Removes employee from calculation
          * @param {Object} employee
          */
          function removeEmployee(employee) {
            employee.visible(false);
          };

          /**
          * Opens Account Operations modal
          * @param {Object} employee
          */
          function performAccountOperations(employee) {
            params.utils.openModal('account-operations', {
              employee: employee,
            });
          }

          /**
          * Opens Employee bonus modal
          * @param {Object} employee
          */
          function giveBonus(employee) {
            params.utils.openModal('employee-bonus', {
              employee: employee,
              bonuses: window.directories.bonuses,
              authors: window.directories.authors,
            }, (result) => {
              console.log('after bonus', result)
            });
          }

          /**
          * Opens Employee fine modal
          * @param {Object} employee
          */
          function giveFine(employee) {
            params.utils.openModal('employee-fine', {
              employee: employee,
              fines: window.directories.fines,
              authors: window.directories.authors,
            }, (result) => {
              console.log('after fine', result)
            });
          }

          return {
            getColumnClicked,

            viewportSize: params.utils.viewportSize,
            tabName: params.tabName,

            editableCellErrorStateMatcher,
            columns,
            activeColumns,
            columnCount,
            isColumnVisible,
            setColumns,

            moreInfo,
            blockMoreInfo,
            lessInfo,
            blockLessInfo,

            setPositions,
            positions,
            hasOtherSection,
            total,

            addEmployees,
            addEmployeesInPosition,
            createEmployee,
            removeEmployee,

            performAccountOperations,
            giveBonus,
            giveFine
          };
        }
      },
      template: {
        element: document.getElementById('calculation-page-positions-table-template')
      }
    });
  })
</script>

  

<!-- Блок сотрудника в таблице -->
<script id="delivery-employee-block-template"
        type="text/html">
  <div class="employee">
    <div class="employee__remove">
      <button data-bind="
      hrmTooltip,
      hrmTooltipText: 'Удалить из расчета',,
      click: table.removeEmployee.bind(table, employee)"
              class="hrm-button hrm-circle-icon-button hrm-circle-times-icon-button hrm-circle-icon-button--theme_secondary positions-table__action employe__remove-button">
      </button>
    </div>

    <div class="employee__info">
      <a class="employee__name"
        href="#"
        data-bind="text: employee.name, click: function(_, e) { e.stopPropagation(); }"></a>

    </div>

    <div class="employee__actions">
      <!-- ko if: employee.hasProblems -->
      <button
              class="hrm-button hrm-icon-button hrm-icon-button--theme_negative hrm-sheet-icon-button employee__action employee__action--documents" data-bind="hrmTooltip, hrmTooltipText: 'Есть проблемы с документами'"></button>
      <!-- /ko -->
    </div>
  </div>
</script>

<!-- Строка сотрудника в таблице -->
<script id="delivery-employee-row-template"
        type="text/html">

<tr class="positions-table__row" data-bind="click: function() { employee.clicked(!employee.clicked())}, css: {
  'positions-table__row--clicked': employee.clicked,
}">
  <td class="positions-table__cell positions-table__cell--name">
    <div class="positions-table__cell-content">

      <!-- Данные сотрудника -->
      <div
           data-bind="template: { name: 'delivery-employee-block-template', data: {employee: employee } }">
      </div>
      <!-- /Данные сотрудника -->

    </div>
  </td>

  <!-- ko if: table.isColumnVisible('account') -->
    <td class="positions-table__cell positions-table__cell--account" data-bind="css: {
      'positions-table__cell--clicked': table.getColumnClicked('account'),
    }" align="right">
      <div class="positions-table__cell-content">
        <!-- ko text: employee.premiumAccount() + '/' + employee.account() -->
        <!-- /ko -->
      </div>
    </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('account-operations') -->
    <!-- ko let: {editableCell: ko.observable(null)} -->
    <td class="positions-table__cell positions-table__cell--account-operations"
        data-bind="click: function(_, e) {
          e.stopPropagation();
          table.performAccountOperations(employee);
        }, hrmTableEditableCell: editableCell, css: {
          'positions-table__cell--clicked': table.getColumnClicked('account-operations'),
        }" align="right">
        <div class="positions-table__cell-content" data-bind="text: $root.utils.formatSign(employee.accountState), hrmColoredSign: employee.accountState"></div>
    </td>
    <!-- /ko -->
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('interval') -->
    <td class="positions-table__cell positions-table__cell--interval" data-bind="click: function(_, e) { e.stopPropagation(); }, css: {
      'positions-table__cell--clicked': table.getColumnClicked('interval'),
    }">
      <table class="working-intervals">
        <tbody data-bind="let: {intervalsCount: employee.workingIntervals().length}">
          <!-- ko foreach: employee.workingIntervals() -->
          <tr class="working-intervals__row">

              <!-- ko template: { name: 'working-interval-template', data: { interval: $data, canRemove: intervalsCount > 1, canAdd: $index() === intervalsCount - 1 } } -->
              <!-- /ko -->

          </tr>
          <!-- /ko -->
        </tbody>
      </table>
    </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('work-time') -->
    <td class="positions-table__cell positions-table__cell--work-time"  data-bind="css: {
      'positions-table__cell--clicked': table.getColumnClicked('work-time'),
    }" align="right">
      <div class="positions-table__cell-content" data-bind="text: $root.utils.formatTime(employee.workingTime())"></div>
    </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('orders-count') -->
    <td class="positions-table__cell positions-table__cell--orders-count"  data-bind="css: {
      'positions-table__cell--clicked': table.getColumnClicked('orders-count'),
    }, click: function(_, e) { e.stopPropagation(); table.openDriverModal(employee); } " align="right">
      <a class="positions-table__cell-content" href="javascript: void(0)" data-bind="text: employee.ordersCount">

      </a>
    </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('orders-value') -->
  <td class="positions-table__cell positions-table__cell--orders-value"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('orders-value'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: employee.ordersValue"></div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('average-bill') -->
  <td class="positions-table__cell positions-table__cell--average-bill"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('average-bill'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: employee.averageBill"></div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('dist-km') -->
  <td class="positions-table__cell positions-table__cell--dist-km"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('dist-km'),
  }, click: function(_, e) {e.stopPropagation(); table.openRoutesModal(employee); } " align="right">
    <a href="javascript: void(0)" data-bind="text: employee.distKm" class="positions-table__cell-content"></a>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('estimated-time') -->
  <td class="positions-table__cell positions-table__cell--estimated-time"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('estimated-time'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: employee.estimatedTime"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('actual-time') -->
  <td class="positions-table__cell positions-table__cell--actual-time"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('actual-time'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: employee.actualTime"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('kpi') -->
  <td class="positions-table__cell positions-table__cell--kpi"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('kpi'),
    'highlighted-success': true,
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: employee.kpi"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('time-without-case') -->
  <td class="positions-table__cell positions-table__cell--time-without-case"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('time-without-case'),
    'highlighted-danger': true
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: employee.timeWithoutCase"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('time') -->
  <td class="positions-table__cell positions-table__cell--time"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('time'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: $root.utils.formatTime(employee.time)"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('orders') -->
  <td class="positions-table__cell positions-table__cell--orders"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('orders'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: employee.orders"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('dist') -->
  <td class="positions-table__cell positions-table__cell--dist"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('dist'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: employee.dist"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('min-payment') -->
  <td class="positions-table__cell positions-table__cell--min-payment"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('min-payment'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: employee.minPayment"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('surcharge') -->
  <td class="positions-table__cell positions-table__cell--surcharge"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('surcharge'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: employee.surcharge"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('late-surcharge') -->
  <td class="positions-table__cell positions-table__cell--late-surcharge"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('late-surcharge'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: employee.lateSurcharge"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('short-shift-surcharge') -->
  <td class="positions-table__cell positions-table__cell--short-shift-surcharge"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('short-shift-surcharge'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: employee.shortShiftSurcharge"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('premation') -->
    <!-- ko let: {editableCell: ko.observable(null)} -->
    <td class="positions-table__cell positions-table__cell--premation" align="right"
        data-bind="click: function(_, e) {
          e.stopPropagation();
          table.giveBonus(employee);
        }, hrmTableEditableCell: editableCell, style: {
          'background-color': employee.bonusesState() > 0 ? '#D0F4E3' : ''
        }, css: {
          'positions-table__cell--clicked': table.getColumnClicked('premation'),
        }">
        <div class="positions-table__cell-content" data-bind="text: employee.bonusesState"></div>
    </td>
    <!-- /ko -->
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('fine') -->
    <!-- ko let: {editableCell: ko.observable(null)} -->
    <td class="positions-table__cell positions-table__cell--fine" align="right"
        data-bind="click: function(_,e) {
          e.stopPropagation();
          table.giveFine(employee);
        }, hrmTableEditableCell: editableCell,
        style: {
          'background-color': employee.finesState() > 0 ? '#FFD3E8' : ''
        }, css: {
          'positions-table__cell--clicked': table.getColumnClicked('fine'),
        }">
        <div class="positions-table__cell-content" data-bind="text: employee.finesState"></div>
    </td>
    <!-- /ko -->
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('total') -->
  <td class="positions-table__cell  positions-table__cell--total positions-table__cell--colored"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('total'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: employee.total"></div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('payment') -->
  <td class="positions-table__cell  positions-table__cell--payment positions-table__cell--colored"  data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('payment'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: employee.toPayment"></div>
  </td>
  <!-- /ko -->
</tr>

</script>

<!-- Строка Итого -->
<script id="delivery-total-row-template"
        type="text/html">

<tr class="positions-table__row positions-table__row--highlighted positions-table__total">
  <td class="positions-table__cell positions-table__cell--name positions-table__cell--empty"></td>

  <!-- ko if: table.isColumnVisible('account') -->
  <td class="positions-table__cell positions-table__cell--account positions-table__cell--empty" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('account'),
  }" align="right"></td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('account-operations') -->
  <td class="positions-table__cell positions-table__cell--account-operations positions-table__cell--empty" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('account-operations'),
  }"></td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('interval') -->
  <td class="positions-table__cell positions-table__cell--interval positions-table__cell--empty" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('interval'),
  }"></td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('work-time') -->
  <td class="positions-table__cell positions-table__cell--work-time" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('work-time'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: $root.utils.formatTime(total.workingTime())"></div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('orders-count') -->
  <td class="positions-table__cell positions-table__cell--orders-count" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('orders-count'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: total.ordersCount()"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('orders-value') -->
  <td class="positions-table__cell positions-table__cell--orders-value" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('orders-value'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: total.ordersValue()"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('average-bill') -->
  <td class="positions-table__cell positions-table__cell--average-bill" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('average-bill'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: total.averageBill()"></div>

  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('dist-km') -->
  <td class="positions-table__cell positions-table__cell--dist-km" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('dist-km'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: total.distKm()"></div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('estimated-time') -->
  <td class="positions-table__cell positions-table__cell--estimated-time" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('estimated-time'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: total.estimatedTime()"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('actual-time') -->
  <td class="positions-table__cell positions-table__cell--actual-time" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('actual-time'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: total.actualTime()"></div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('kpi') -->
  <td class="positions-table__cell positions-table__cell--kpi" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('kpi'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: total.kpi()"></div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('time-without-case') -->
  <td class="positions-table__cell positions-table__cell--time-without-case" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('time-without-case'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: total.timeWithoutCase()"></div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('time') -->
  <td class="positions-table__cell positions-table__cell--time" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('time'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: total.time()"></div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('orders') -->
  <td class="positions-table__cell positions-table__cell--orders" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('orders'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: total.orders()"></div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('dist') -->
  <td class="positions-table__cell positions-table__cell--dist positions-table__cell--empty" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('dist'),
  }" align="right"></td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('min-payment') -->
  <td class="positions-table__cell positions-table__cell--min-payment positions-table__cell--empty" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('min-payment'),
  }" align="right"></td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('surcharge') -->
  <td class="positions-table__cell positions-table__cell--surcharge positions-table__cell--empty" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('surcharge'),
  }" align="right"></td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('late-surcharge') -->
  <td class="positions-table__cell positions-table__cell--late-surcharge" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('late-surcharge'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: total.lateSurcharge()"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('short-shift-surcharge') -->
  <td class="positions-table__cell positions-table__cell--short-shift-surcharge " data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('short-shift-surcharge'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: total.shortShiftSurcharge()"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('premation') -->
  <td class="positions-table__cell positions-table__cell--premation" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('premation'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: total.bonus()"></div>
</td >
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('fine') -->
  <td class="positions-table__cell positions-table__cell--fine" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('fine'),
  }" align="right">
  <div class="positions-table__cell-content" data-bind="text: total.fine()"></div>
</td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('total') -->
  <td class="positions-table__cell  positions-table__cell--total positions-table__cell--colored" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('total'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: total.total()"></div>
  </td>
  <!-- /ko -->

  <!-- ko if: table.isColumnVisible('payment') -->
  <td class="positions-table__cell  positions-table__cell--payment positions-table__cell--colored" data-bind="css: {
    'positions-table__cell--clicked': table.getColumnClicked('payment'),
  }" align="right">
    <div class="positions-table__cell-content" data-bind="text: total.toPayment()"></div>
  </td>
  <!-- /ko -->
</tr>

</script>


<template id="calculation-page-delivery-table-template">
  <div class="calculation-tab"
       data-bind="class: 'calculation-' + tabName">

    <div class="calculation-tab__settings">
      <div class="calculation-tab__settings-group">

        <!-- Пересчитать маршруты -->
        <button class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_mobile hrm-button-with-icon--theme_secondary hrm-button-with-route-icon  calculation-tab__settings-button calculation-tab__recalculate-routes"
                data-bind="click: $root.recalculateRoutes">
          Пересчитать маршруты
        </button>

        <!-- ko if: viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
        <!-- Штраф/премия -->
        <button class="hrm-button hrm-basic-button hrm-button--size_medium  calculation-tab__settings-button calculation-tab__settings-stimulation"
                data-bind="click: function() { $root.stimulation.set('delivery'); }, disable: $root.stimulation.isDeliveryBlocked">
          Штраф/премия смене
        </button>
        <!-- /ko -->

        <!-- ko ifnot: viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
        <!-- Штраф/премия -->
        <button data-bind="click: function() { $root.stimulation.set('delivery'); }"
                class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_desktop hrm-button-with-money-icon hrm-button-with-icon--theme_secondary  calculation-tab__settings-button calculation-tab__settings-stimulation"></button>
        <!-- /ko -->



        <!-- ko let: {control: ko.observable(null), label: ko.observable(null)} -->
        <div class="holiday-surcharge" data-bind="hrmFormField, hrmFormFieldControlRef: control">

          <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
            <input data-bind="value: $root.summaryModel.holidaySurcharge,
                            hrmMask,
                            hrmMaskPattern: 'decimal',
                            hrmFormFieldInputControl: control"
                   placeholder="Праздничная надбавка">
          </div>

          <div class="holiday-surcharge__append">%</div>
        </div>
        <!-- /ko -->


      </div><!-- .calculation-tab__settings-group -->
      <div class="calculation-tab__settings-group">
        <!-- Столбцы -->
        <button class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_tablet hrm-button-with-icon--theme_secondary hrm-button-with-settings-icon templates__button-with-icon calculation-tab__settings-button calculation-tab__settings-columns"
                data-bind="click: setColumns">
          Настроить столбцы
        </button>

        <!-- Меньше информации -->
        <button class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_tablet hrm-button-with-icon--theme_secondary hrm-button-with-less-icon templates__button-with-icon  calculation-tab__settings-button calculation-tab__settings-less-info"
                data-bind="click: lessInfo, disable: blockLessInfo">
          Меньше информации
        </button>

        <!-- Больше информации -->
        <button class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_tablet hrm-button-with-icon--theme_secondary hrm-button-with-more-icon templates__button-with-icon hrm-button-with-icon--hide_tablet  calculation-tab__settings-button calculation-tab__settings-more-info"
                data-bind="click: moreInfo, disable: blockMoreInfo">
          Больше информации
        </button>
      </div><!-- .calculation-tab__settings-group -->
    </div><!-- .calculation-tab__settings -->

    <div class="hrm-table__fixed-section-container positions-table positions-table--delivery"
         data-bind="let: {table: $data}">

      <div
           data-bind="component: { name: 'hrm-scrollable-wrapper', params: { options: {left: {disabled: true}} }}">
        <table data-bind="hrmTable"
               class="positions-table__main-table">

          <colgroup>
            <col class="positions-table__col positions-table__col--name">
            <!-- ko foreach: table.columns -->
            <!-- ko if: $data.visible -->
            <col class="positions-table__col"
                 data-bind="class: 'position-table__col--' + id">
            <!-- /ko -->
            <!-- /ko -->
          </colgroup>

          <thead>
            <tr class="positions-table__row positions-table__head-row">
              <th class="positions-table__cell positions-table__head-cell positions-table__cell--name">
                <div class="positions-table__cell-content">Сотрудник</div>
              </th>

              <!-- ko foreach: table.columns -->
              <!-- ko if: $data.visible -->
              <th class="positions-table__cell positions-table__head-cell"
                  data-bind="class: 'positions-table__cell--' + id, css: {
                    'positions-table__cell--colored': colored,
                      'positions-table__cell--clicked': table.getColumnClicked($data.id),
                  }, click: function() { $data.clicked(!$data.clicked())}">
                <div class="positions-table__cell-content">
                  <span data-bind="text: title"></span>
                  <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-table__head-cell-info-button positions-table__info-icon"
                          data-bind="hrmTooltip, hrmTooltipText: fullTitle"></button>
                </div>
              </th>
              <!-- /ko -->
              <!-- /ko -->
            </tr>
          </thead>

          <tbody>

            <!-- Список сотрудников по позиции -->
            <!-- ko foreach: { data: position().visibleEmployees, as: 'employee', beforeRemove: $root.fadePosition } -->

            <!-- ko template: {
              name: 'delivery-employee-row-template',
              data: { employee: employee, position: position }
            } -->
            <!-- /ko -->

            <!-- /ko -->
            <!-- Список сотрудников по позиции -->

            <!-- Total section -->
            <!-- ko template: { name: 'delivery-total-row-template', data: { total: table.total } } -->
            <!-- /ko -->
            <!-- /Total section -->
          </tbody>
        </table>

      </div>
    </div>
  </div>
</template>


<script type="text/javascript">
  $(function () {
    function Column(id, title, fullTitle, colored) {
      return {
        id,
        title,
        fullTitle,
        colored,
        visible: ko.observable(true),
        clicked: ko.observable(false)
      }
    }

    ko.components.register('calculation-page-delivery-table', {
      viewModel: {
        /**
        * @param {ObservableArray} params.positions
        */
        createViewModel: function (params, componentInfo) {
          const editableCellErrorStateMatcher = (control) => {
            return ko.pureComputed(() => {
              return !control.isValid() ? { message: control.error() } : null;

            });
          };

          const position = params.position;
          const model = params.model;
          const total = params.total;


          /* Table columns */
          const columns = [
            Column('account', 'Прем./ЛС, ₽', 'Премиальный счет/личный счет'),
            Column('account-operations', 'Операции с ЛС, ₽', 'Операции с личным счетом'),
            Column('interval', 'Начало/конец работы', 'Начало/конец работы'),
            Column('work-time', 'Рабочее время', 'Рабочее время'),
            Column('orders-count', 'Кол-во заказов', 'Кол-во заказов'),
            Column('orders-value', 'Стоимость заказов, ₽', 'Стоимость заказов'),
            Column('average-bill', 'Средний чек, ₽', 'Средний чек'),
            Column('dist-km', 'Расст-е, км', 'Расст-е, км'),
            Column('estimated-time', 'Расчет. время в пути', 'Расчет. время в пути'),
            Column('actual-time', 'Факт. время в пути', 'Факт. время в пути'),
            Column('kpi', 'KPI', 'KPI'),
            Column('time-without-case', 'Время без дела, %', 'Время без дела, %'),
            Column('time', 'Время', 'Время'),
            Column('orders', 'Заказы', 'Заказы'),
            Column('dist', 'Расст.', 'Расст.'),
            Column('min-payment', 'Min оплата., ₽', 'Min оплата., ₽'),
            Column('surcharge', 'Надбавка, ₽', 'Надбавка, ₽'),
            Column('late-surcharge', 'Надб. за поздний выезд, ₽', 'Надб. за поздний выезд, ₽'),
            Column('short-shift-surcharge', 'Надб. за короткую смену, ₽', 'Надб. за короткую смену, ₽'),
            Column('premation', 'Прем., ₽', 'Премирование'),
            Column('fine', 'Штраф, ₽', 'Штраф'),
            Column('total', 'Всего начислено, ₽', 'Всего начислено, ₽', true),
            Column('payment', 'К выплате, ₽', 'К выплате, ₽', true)
          ];
          const defaultColumnsState = localStorage.getItem('calculation-page-delivery-columns');
          if (defaultColumnsState) {
            const state = JSON.parse(defaultColumnsState);
            columns.forEach(column => {
              if (column.id in state && state[column.id] === 0) {
                column.visible(false);
              }
            })
          };

          const activeColumns = ko.pureComputed(() => {
            return columns.filter(c => c.visible()).length;
          });
          const isColumnVisible = (columnName) => {
            const column = columns.find(c => c.id === columnName);
            if (column) return column.visible;
            else return false;
          };
          const columnCount = ko.pureComputed(() => {
            return activeColumns() + 1;
          });

          const getColumnClicked = (columnName) => {
            const column = columns.find(c => c.id === columnName);
            if (column) return column.clicked;
          }

          /** Sets columns visibility */
          function setColumns() {
            params.utils.openModal('columns', { columns: columns }, () => {
              saveColumnsState();
            });
          }

          function setColumnsState(set) {
            columns.forEach(c => {
              const isVisible = set ? set.includes(c.id) : true;
              c.visible(isVisible);
            });
            saveColumnsState();
          }

          function saveColumnsState() {
            const state = columns.reduce((acc, column) => {
              return {
                ...acc,
                [column.id]: column.visible() ? 1 : 0
              }
            }, {});
            localStorage.setItem('calculation-page-delivery-columns', JSON.stringify(state));
          }

          const columnSets = [
            ['account', 'account-operations', 'interval', 'orders-count', 'orders-value', 'average-bill', 'dist-km', 'actual-time', 'kpi', 'time-without-case', 'premation', 'fine', 'payment'],
            ['time-without-case', 'payment']
          ];
          const columnSetsIndex = ko.observable(-1);
          const blockMoreInfo = ko.pureComputed(() => {
            return !columns.some(c => !c.visible());
          });
          const blockLessInfo = ko.pureComputed(() => {
            return !columns
              .filter(c => !columnSets[1].includes(c.id))
              .some(c => c.visible());
          });

          const moreInfo = () => {
            const hasInvisibleColumns = columns.filter(c => columnSets[0].includes(c.id))
            .some(c => !c.visible());
            if (hasInvisibleColumns) setColumnsState(columnSets[0]);
            else setColumnsState();
            $(window).resize();
          };

          const lessInfo = () => {
            const hasVisibleColumns = columns.filter(c => !columnSets[0].includes(c.id))
                .some(c => c.visible());
            if (hasVisibleColumns) setColumnsState(columnSets[0]);
            else setColumnsState(columnSets[1]);
            $(window).resize();
          };


          /**
          * Opens Account Operations modal
          * @param {Object} employee
          */
          function performAccountOperations(employee) {
            params.utils.openModal('account-operations', {
              employee: employee,
            });
          }

          /**
          * Opens Employee bonus modal
          * @param {Object} employee
          */
          function giveBonus(employee) {
            params.utils.openModal('employee-bonus', {
              employee: employee,
              bonuses: window.directories.bonuses,
              authors: window.directories.authors,
            }, (result) => {
              console.log('after bonus', result)
            });
          }

          /**
          * Opens Employee fine modal
          * @param {Object} employee
          */
          function giveFine(employee) {
            params.utils.openModal('employee-fine', {
              employee: employee,
              fines: window.directories.fines,
              authors: window.directories.authors,
            }, (result) => {
              console.log('after fine', result)
            });
          }

          /**
          * Removes employee from calculation
          * @param {Object} employee
          */
          function removeEmployee(employee) {
            employee.visible(false);
          };



          const openDriverModal = (employee) => {
            params.utils.openModal('driver-details', {
              employee: employee,
              employees: position().visibleEmployees()
            }, () => {

            });
          }

          const openRoutesModal = (employee) => {
            params.utils.openModal('routes', {
              employee: employee
            }, () => {

            });
          }

          return {
            getColumnClicked,

            viewportSize: params.utils.viewportSize,
            tabName: params.tabName,

            editableCellErrorStateMatcher,
            columns,
            activeColumns,
            columnCount,
            isColumnVisible,
            setColumns,

            moreInfo,
            blockMoreInfo,
            lessInfo,
            blockLessInfo,

            position,
            total,

            removeEmployee,

            performAccountOperations,
            giveBonus,
            giveFine,

            openDriverModal,
            openRoutesModal,
          };
        }
      },
      template: {
        element: document.getElementById('calculation-page-delivery-table-template')
      }
    });
  })
</script>

  <script type="text/javascript">
  // Справочники
  window.directories = {
    fines: [
      {
        name: 'Группа 1',
        items: [
          {
            id: '1',
            name: 'Основание штрафа 1',
            sum: 200
          },
          {
            id: '2',
            name: 'Основание штрафа 2',
            sum: 300
          }
        ]
      },
      {
        name: 'Группа 2',
        items: [
          {
            id: '3',
            name: 'Основание штрафа 3',
            sum: 200
          },
          {
            id: '4',
            name: 'Основание штрафа 4',
            sum: 300
          }
        ]
      },
    ],
    bonuses: [
      {
        name: 'Группа 1',
        items: [
          {
            id: '1',
            name: 'Основание премии 1',
            sum: 200
          },
          {
            id: '2',
            name: 'Основание премии 2',
            sum: 300
          }
        ]
      },
      {
        name: 'Группа 2',
        items: [
          {
            id: '3',
            name: 'Основание премии 3',
            sum: 200
          },
          {
            id: '4',
            name: 'Основание премии 4',
            sum: 300
          }
        ]
      },
    ],
    authors: [
      {
        id: 1,
        name: 'Иван Иванов',
        avatar: '/assets/examples/avatar.jpg',
      }, {
        id: 2,
        name: 'Петр Петров',
        avatar: '/assets/examples/avatar.jpg',
      }, {
        id: 3,
        name: 'Николай Николаев',
        avatar: '/assets/examples/avatar.jpg',
      }, {
        id: 4,
        name: 'Сергей Сергеев',
        avatar: '/assets/examples/avatar.jpg',
      }
    ],
    compensations: [
      {
        id: 1,
        name: 'Смена 6 или менее часов',
        sum: 100
      },
      {
        id: 2,
        name: 'Отпустили в связи с производственной необходимостью',
        sum: 100
      },
      {
        id: 3,
        name: 'Сотрудник отпросился',
        sum: 0
      },
      {
        id: 4,
        name: 'Замена сотрудника',
        sum: 0
      },
      {
        id: 5,
        name: 'Вызвали с выходного дня',
        sum: 100
      }
    ]
  };

  $(function () {
    const $page = $(document.documentElement);

    const PositionsModel = function (root) {
      this.root = root;

      this._defaultState = {
        positions: null,
        drivers: null,
        holidaySurcharge: '',
      };

      this.positions = ko.observableArray([]);
      this.driversData = ko.observable();

      this.holidaySurcharge = ko.observable('');
      this.holidaySurcharge.subscribe(_ => {
        this.root.calculate('delivery');
      });

      this.getPositionById = (id) => {
        return this.positions().find(position => position.id === id);
      };

      this.setPositions = (positionsList) => {
        this.positions(positionsList.map(positionData => {
          return new PositionModel(positionData, root)
        }));
        this._defaultState.positions = positionsList;
      }

      this.setDriversData = (driversData) => {
        this.driversData(new DeliveryPositionModel(driversData, root));
        this._defaultState.drivers = driversData;
      }

      this.reset = () => {
        this.setPositions(this._defaultState.positions);
        this.setDriversData(this._defaultState.drivers);
        this.holidaySurcharge(this._defaultState.holidaySurcharge);
      };

      this.getData = () => {
        return {
          positions: this.positions().map(p => p.getData()),
          drivers: this.driversData().getData()
        };
      };

      this.save = () => {
        this._defaultState = this.getData();
        console.log('after save', this._defaultState.positions.employees)
      };


      this.productionTotal = {
        workingTime: ko.observable(0),
        salaryBulk: ko.observable(0),
        normRatio: ko.observable(0),
        revenueStandart: ko.observable(0),
        bonusRatio: ko.observable(0),
        depremationRatio: ko.observable(0),
        correctedTime: ko.observable(0),
        bonusExceed: ko.observable(0),
        total: ko.observable(0),
        toPayment: ko.observable(0),
      };

      this.deliveryTotal = {
        workingTime: ko.observable(0),
        ordersCount: ko.observable(0),
        ordersValue: ko.observable(0),
        averageBill: ko.observable(0),
        distKm: ko.observable(0),
        estimatedTime: ko.observable(0),
        actualTime: ko.observable(0),
        kpi: ko.observable(0),
        timeWithoutCase: ko.observable(0),
        time: ko.observable(0),
        orders: ko.observable(0),
        dist: ko.observable(0),
        minPayment: ko.observable(0),
        lateSurcharge: ko.observable(0),
        shortShiftSurcharge: ko.observable(0),
        bonus: ko.observable(0),
        fine: ko.observable(0),
        total: ko.observable(0),
        toPayment: ko.observable(0),
      };

      this.total = {
        workload: ko.observable(0),
        workloadUnits: ko.observable(''),
        fotCategory: ko.observable(100),
        fotRevenue: ko.observable(100),
        performanceStandart: ko.observable(-100),
        employees: ko.observable(0)
      };

      this.total.lateness = ko.pureComputed(() => {
        let result = {
          light: 0,
          medium: 0,
          hard: 0,
        }
        root.activePositions().forEach(p => {
          let lateness = p.lateness();
          result.light += lateness.light;
          result.medium += lateness.medium;
          result.hard += lateness.hard;
        });

        let driversDataLateness = this.driversData().lateness();
        result.light += driversDataLateness.light;
        result.medium += driversDataLateness.medium;
        result.hard += driversDataLateness.hard;

        result.total = result.light + result.medium + result.hard;
        return result;
      })

      this.isValid = () => {
        if (this.positions().some(p => !p.isValid())) {
          return false;
        }

        return true;
      };

      function WorkingIntervalModel(interval) {
        const value = ko.observable(interval).extend({
          required: {
            message: 'Обязательное поле'
          },
          validation: {
            validator: value => {
              if (!/^\d\d:\d\d – \d\d:\d\d$/.test(value)) {
                return false;
              } else {
                const boundaries = value.split(' – ');

                if (boundaries[0] === boundaries[1]) {
                  return false;
                }

                return boundaries.every(b => moment(b, 'HH:mm', true).isValid());
              }
            },
            message: 'Неверный формат интервала'
          }
        });

        /**
        * @returns {number}
        */
        function getInterval() {
          const boundaries = value().split(' – ').map(b => moment(b, 'HH:mm'));

          if (boundaries[0].isAfter(boundaries[1])) {
            boundaries[1].add(1, 'd');
          }

          return boundaries[1].diff(boundaries[0], 'minutes');
        }

        return {
          value,
          getInterval
        };
      }

      function EmployeeModel(employee, positionModel) {
        this.position = positionModel;
        this.root = this.position.root;

        this.clicked = ko.observable(false);

        this.name = employee.name;                   // имя сотрудника
        this.id = employee.id;                       // идентификатор сотрудника
        this.link = employee.link;                   // ссылка на личное дело

        this.level = ko.observable(employee.level);  // разряд
        this.level.subscribe(_ => this.root.calculate('production'));

        this.hasProblems = employee.hasProblems;                         // есть проблемы с документами
        this.upRecommended = ko.observable(employee.upRecommended);      // рекомендуется повышение
        this.downRecommended = ko.observable(employee.downRecommended);  // рекомендуется понижение

        // компенсация
        this.isCompensationEditable = ko.observable(false);
        this.compensation = ko.observable(employee.compensation || '').extend({
          required: {
            message: () => 'Обязательное поле',
            onlyIf: () => {
              return this.isCompensationEditable();
            }
          }
        });
        this.compensation.subscribe(_ => this.root.calculate('production'));

        this.checkCompensation = () => {
          if (this.workingTime() < this.position.minDurationWithoutCompensation * 60) {
            this.isCompensationEditable(true);
          } else {
            this.isCompensationEditable(false);
          }
        };
        this.editCompensation = () => {
          this.root.utils.openModal("compensations", {
            employee: this,
            compensations: window.directories.compensations
          });
        };

        // рабочее время
        const defaultIntervals = employee.workingIntervals || ['11:00 – 23:00'];
        this.workingIntervals = ko.observableArray(
          defaultIntervals.map(i => WorkingIntervalModel(i))
        );
        const isWorkingIntervalsValid = ko.pureComputed(() => {
          return this.workingIntervals().every(i => i.value.isValid())
        });
        this.workingTime = ko.pureComputed(() => {
          if (!isWorkingIntervalsValid()) return 0;

          return this.workingIntervals().reduce((minutes, interval) => {
            return minutes + interval.getInterval();
          }, 0);
        });

        this.checkCompensation();

        this.addWorkingInterval = () => {
          const model = WorkingIntervalModel('');
          this.workingIntervals.push(model);
        };
        this.removeWorkingInterval = (interval) => {
          this.workingIntervals.remove(interval);
        };

        this.workingTime.subscribe(v => {
          this.checkCompensation();

          this.root.calculate('production');
        });

        this.account = ko.observable(employee.account || 0);             // личный счет
        this.premiumAccount = ko.observable(employee.account || 0);      // премиальный счет

        // операции с ЛС
        this.accountOperations = ko.observableArray(employee.accountOperations || []);
        this.accountState = ko.pureComputed(() => {
          return this.accountOperations().reduce((sum, operation) => {
            const operationSum = operation.type === 'fine' ? operation.sum * -1 : operation.sum;
            return sum + operationSum;
          }, 0);
        });

        this.accountOperations.subscribe(_ => this.root.calculate('production'));

        // штрафы
        this.fines = ko.observableArray(employee.fines || []);
        this.finesState = ko.pureComputed(() => {
          return this.fines().reduce((sum, fine) => {
            return sum + fine.sum;
          }, 0);
        });

        this.fines.subscribe(_ => this.root.calculate('production'));

        // бонусы
        this.bonuses = ko.observableArray(employee.bonuses || []);
        this.bonusesState = ko.pureComputed(() => {
          return this.bonuses().reduce((sum, bonus) => {
            return sum + bonus.sum;
          }, 0);
        });

        this.bonuses.subscribe(_ => this.root.calculate('production'));

        this.workload = ko.observable(employee.workload || '');
        this.workloadUnits = this.position.workloadUnits;

        this.salary = ko.observable(employee.salary || this.positionSalary);
        this.salaryBulk = ko.observable(employee.salaryBulk || this.positionSalaryBulk);

        this.revenueStandartUnits = employee.revenueStandartUnits || this.position.revenueStandartUnits;
        this.revenueStandartPerHour = ko.observable(employee.revenueStandartPerHour || this.position.revenueStandartUnits);
        this.revenueStandart = ko.observable(employee.revenueStandart || this.position.revenueStandart);

        this.normRatio = ko.observable(employee.normRatio || this.position.normRatio);
        this.bonusRatio = ko.observable(employee.bonusRatio || this.position.bonusRatio);
        this.depremationRatio = ko.observable(employee.depremationRatio || this.position.depremationRatio);

        this.bonusExceed = ko.observable(employee.bonusExceed || '');
        this.depremation = ko.observable(employee.depremation || '');

        this.correctedTime = ko.observable(employee.correctedTime || this.position.correctedTime);

        this.total = ko.observable(employee.total || 0);
        this.toPayment = ko.observable(employee.toPayment || 0);

        this.visible = ko.observable(employee.visible) // участвует в расчете
        this.visible.subscribe(_ => this.root.calculate('production'));

        this.loaded = employee.loaded; // загружен для Все филиалы

        this.removeWorkloadPartially = () => {
          this.root.utils.openModal('employee-remove-workload-partially', {
            employee: this
          }, () => {
            this.root.calculate('production', ['normRatio', 'bonusRatio', 'depremationRatio', 'salary']);
          });
        };

        this.removeWorkloadCompletely = () => {
          this.root.utils.openModal('employee-remove-workload-completely', {
            employee: this
          }, () => {
            this.root.calculate('production', ['normRatio', 'bonusRatio', 'depremationRatio']);
          });
        }

        this.getData = () => {
          return {
            name: this.name,
            id: this.id,
            link: this.link,
            hasProblems: this.hasProblems,
            upRecommended: this.upRecommended(),
            downRecommended: this.downRecommended(),
            premiumAccount: this.premiumAccount(),
            account: this.account(),
            accountOperations: this.accountOperations(),
            level: this.level(),
            workingIntervals: this.workingIntervals().map(i => i.value()),
            compensation: this.compensation(),
            workload: this.workload(),
            workloadUnits: this.workloadUnits,
            salary: this.salary(),
            salaryBulk: this.salaryBulk(),
            revenueStandartUnits: this.revenueStandartUnits,
            revenueStandartPerHour: this.revenueStandartPerHour(),
            revenueStandart: this.revenueStandart(),
            normRatio: this.normRatio(),
            bonusRatio: this.bonusRatio(),
            depremationRatio: this.depremationRatio(),
            bonusExceed: this.bonusExceed(),
            bonuses: this.bonuses(),
            fines: this.fines(),
            depremation: this.depremation(),
            correctedTime: this.correctedTime(),
            total: this.total(),
            toPayment: this.toPayment(),
            visible: this.visible() ? 1 : 0
          }
        };

        this.validationObject = ko.validatedObservable({
          compensation: this.compensation,

        }, { live: true })
        this.isValid = () => {
          if(!this.validationObject.isValid()) return false;
          if (this.workingIntervals().some(i => !i.value.isValid())) {
            console.log('w i not valid')
            return false;
          }
        }
      }

      function DriverEmployeeModel(employee, positionModel) {
        this.position = positionModel;
        this.root = this.position.root;

        this.clicked = ko.observable(false);

        this.name = employee.name;                   // имя сотрудника
        this.id = employee.id;                       // идентификатор сотрудника
        this.link = employee.link;                   // ссылка на личное дело

        this.hasProblems = employee.hasProblems;                         // есть проблемы с документами

        // рабочее время
        const defaultIntervals = employee.workingIntervals || ['11:00 – 23:00'];
        this.workingIntervals = ko.observableArray(
          defaultIntervals.map(i => WorkingIntervalModel(i))
        );
        const isWorkingIntervalsValid = ko.pureComputed(() => {
          return this.workingIntervals().every(i => i.value.isValid())
        });
        this.workingTime = ko.pureComputed(() => {
          if (!isWorkingIntervalsValid()) return 0;

          return this.workingIntervals().reduce((minutes, interval) => {
            return minutes + interval.getInterval();
          }, 0);
        });
        this.addWorkingInterval = () => {
          const model = WorkingIntervalModel('');
          this.workingIntervals.push(model);
        };
        this.removeWorkingInterval = (interval) => {
          this.workingIntervals.remove(interval);
        };

        this.workingTime.subscribe(_ => this.root.calculate('delivery'));

        this.account = ko.observable(employee.account || 0);             // личный счет
        this.premiumAccount = ko.observable(employee.account || 0);      // премиальный счет

        // операции с ЛС
        this.accountOperations = ko.observableArray(employee.accountOperations || []);
        this.accountState = ko.pureComputed(() => {
          return this.accountOperations().reduce((sum, operation) => {
            const operationSum = operation.type === 'fine' ? operation.sum * -1 : operation.sum;
            return sum + operationSum;
          }, 0);
        });

        this.accountOperations.subscribe(_ => this.root.calculate('delivery'));

        this.ordersCount = ko.observable(employee.ordersCount);
        this.ordersValue = ko.observable(employee.ordersValue);
        this.averageBill = ko.observable(employee.averageBill);
        this.distKm = ko.observable(employee.distKm);
        this.estimatedTime = ko.observable(employee.estimatedTime);
        this.actualTime = ko.observable(employee.actualTime);
        this.kpi = ko.observable(employee.kpi);
        this.timeWithoutCase = ko.observable(employee.timeWithoutCase);
        this.time = ko.observable(employee.time);
        this.orders = ko.observable(employee.orders);
        this.dist = ko.observable(employee.dist);
        this.minPayment = ko.observable(employee.minPayment);
        this.surcharge = ko.observable(employee.surcharge);
        this.lateSurcharge = ko.observable(employee.lateSurcharge);
        this.shortShiftSurcharge = ko.observable(employee.shortShirtSurcharge);

        // штрафы
        this.fines = ko.observableArray(employee.fines || []);
        this.finesState = ko.pureComputed(() => {
          return this.fines().reduce((sum, fine) => {
            return sum + fine.sum;
          }, 0);
        });

        this.fines.subscribe(_ => this.root.calculate('delivery'));

        // бонусы
        this.bonuses = ko.observableArray(employee.bonuses || []);
        this.bonusesState = ko.pureComputed(() => {
          return this.bonuses().reduce((sum, bonus) => {
            return sum + bonus.sum;
          }, 0);
        });

        this.bonuses.subscribe(_ => this.root.calculate('delivery'));


        this.total = ko.observable(employee.total || 0);
        this.toPayment = ko.observable(employee.toPayment || 0);

        this.visible = ko.observable(employee.visible) // участвует в расчете
        this.visible.subscribe(_ => this.root.calculate('delivery'));

        this.getData = () => {
          return {
            name: this.name,
            id: this.id,
            link: this.link,
            hasProblems: this.hasProblems,
            premiumAccount: this.premiumAccount(),
            account: this.account(),
            accountOperations: this.accountOperations(),
            workingIntervals: this.workingIntervals().map(i => i.value()),
            ordersCount: this.ordersCount(),
            ordersValue: this.ordersValue(),
            averageBill: this.averageBill(),
            distKm: this.distKm(),
            estimatedTime: this.estimatedTime(),
            actualTime: this.actualTime(),
            kpi: this.kpi(),
            timeWithoutCase: this.timeWithoutCase(),
            orders: this.orders(),
            dist: this.dist(),
            minPayment: this.minPayment(),
            surcharge: this.surcharge(),
            lateSurcharge: this.lateSurcharge(),
            shortShiftSurcharge: this.shortShiftSurcharge(),
            bonuses: this.bonuses(),
            fines: this.fines(),
            total: this.total(),
            toPayment: this.toPayment(),
            visible: this.visible() ? 1 : 0
          }
        }
      }

      function PositionModel(positionData, root) {
        this.root = root;

        this.clicked = ko.observable(false);

        this.type = 'production';

        this.id = positionData.id;
        this.name = positionData.name;
        this.levels = positionData.levels; // разряды

        // нагрузка
        this.workloadType = positionData.workloadType;
        this.workload = ko.observable(positionData.workload);
        this.workloadUnits = positionData.workloadUnits;

        this.workload.subscribe(v => {
          root.calculate('production');
        });

        // доп. нагрузка
        this.additionalWorkloadType = positionData.additionalWorkloadType;
        this.additionalWorkload = ko.observable(positionData.additionalWorkload);
        this.additionalWorkloadUnits = positionData.additionalWorkloadUnits;

        // ФОТ, % в категории
        this.fotCategory = ko.observable(positionData.fotCategory);

        // ФОТ, % от выручки
        this.fotRevenue = ko.observable(positionData.fotRevenue);

        this.salary = positionData.salary; // оклад
        this.salaryBulk = positionData.salaryBulk; // основная часть зарплаты

        this.revenueStandart = positionData.revenueStandart; // Норматив выручки
        this.revenueStandartPerHour = positionData.revenueStandartPerHour; // Норматив выручки в час
        this.revenueStandartUnits = positionData.revenueStandartUnits; // Единицы измерения

        // Норм. выработки
        this.performanceStandart = ko.observable(positionData.performanceStandart);
        this.performanceStandartType = positionData.performanceStandartType;
        this.performanceStandartUnits = positionData.performanceStandartUnits;

        this.minDurationWithoutCompensation = positionData.minDurationWithoutCompensation;

        this.visible = ko.observable(positionData.visible); // Отображается в таблице
        this.visible.subscribe(_ => this.root.calculate('production'));

        this.employees = ko.observableArray(positionData.employees.map((e) => new EmployeeModel(e, this)));

        this.visibleEmployees = ko.pureComputed(() => {
          return this.employees().filter(e => e.visible());
        });

        this.allEmployeesLoaded = ko.observable(false);

        this.workingTime = ko.pureComputed(() => {
          return this.employees().reduce((minutes, employee) => {
            if (!employee.visible()) return minutes;
            return minutes + employee.workingTime();
          }, 0)
        });

        this.findEmployeeById = (employeeId) => {
          return this.employees().find(employee => employee.id === employeeId);
        };

        this.addEmployee = (employee) => {
          employee.visible = true;
          this.employees.push(new EmployeeModel(employee, this));
          this.root.calculate('production');
        };

        this.updateEmployees = (updatedList) => {
          const updatedIds = updatedList.map(e => e.id);
          const originalIds = this.employees().map(e => e.id);

          const notFoundIds = _.difference(originalIds, updatedIds);
          const newEmployeesIds = _.difference(updatedIds, originalIds);

          // remove not found-s
          const updated = this.employees().filter(e => notFoundIds.indexOf(e.id) === -1);

          // set visibility
          updated.forEach(employee => {
            const updatedEmployeeData = updatedList.find(updatedEmployee => updatedEmployee.id == employee.id);
            employee.visible(updatedEmployeeData.checked);
          });

          // add new-s
          const newEmployees = newEmployeesIds.map(id => {
            const employeeData = updatedList.find(e => e.id === id);
            employeeData.visible = employeeData.checked;
            const employee = new EmployeeModel(employeeData, this);
            return employee;
          });

          // update list
          this.employees(updated.concat(newEmployees));
        }

        this.lateness = ko.observable(positionData.lateness);

        this.totalLateness = ko.pureComputed(() => {
          let lateness= this.lateness();
          return (lateness.light + lateness.medium + lateness.hard) || 0;
        });

        this.toggleClicked = () => {
          if (this.visibleEmployees().some(e => !e.clicked())) {
            this.visibleEmployees().forEach(e => e.clicked(true));
          } else {
            this.visibleEmployees().forEach(e => e.clicked(false));
          }
        };

        this.getData = () => {
          return {
            id: this.id,
            name: this.name,
            levels: this.levels,
            workloadType: this.workloadType,
            workload: this.workload(),
            workloadUnits: this.workloadUnits,
            additionalWorkloadType: this.additionalWorkloadType,
            additionalWorkload: this.additionalWorkload(),
            additionalWorkloadUnits: this.additionalWorkloadUnits,
            fotCategory: this.fotCategory(),
            fotRevenue: this.fotRevenue(),
            performanceStandart: this.performanceStandart(),
            performanceStandartType: this.performanceStandartType,
            salary: this.salary,
            salaryBulk: this.salaryBulk,
            lateness: this.lateness(),
            revenueStandart: this.revenueStandart,
            revenueStandartPerHour: this.revenueStandartPerHour,
            revenueStandartUnits: this.revenueStandartUnits,
            employees: this.employees().map(e => e.getData()),
            visible: this.visible() ? 1 : 0,
          };
        };

        this.isValid = () => {
          let invalidEmployee = this.visibleEmployees().find(e => !e.isValid());
          if (invalidEmployee) return false;
          return true;
        }
      }

      function DeliveryPositionModel(positionData, root) {
        this.root = root;
        this.clicked = ko.observable(false);
        this.type = 'delivery';

        this.id = positionData.id;
        this.name = positionData.name;

        this.employees = ko.observableArray(positionData.employees.map((e) => new DriverEmployeeModel(e, this)));

        this.visibleEmployees = ko.pureComputed(() => {
          return this.employees().filter(e => e.visible());
        });

        this.workingTime = ko.pureComputed(() => {
          return this.employees().reduce((minutes, employee) => {
            if (!employee.visible()) return minutes;
            return minutes + employee.workingTime();
          }, 0)
        });

        this.findEmployeeById = (employeeId) => {
          return this.employees().find(employee => employee.id === employeeId);
        };

        this.toggleClicked = () => {
          if (this.visibleEmployees().some(e => !e.clicked())) {
            this.visibleEmployees().forEach(e => e.clicked(true));
          } else {
            this.visibleEmployees().forEach(e => e.clicked(false));
          }
        }

        // нагрузка
        this.workloadType = positionData.workloadType;
        this.workload = ko.observable(positionData.workload);
        this.workloadUnits = positionData.workloadUnits;

        this.workload.subscribe(v => {
          root.calculate('delivery');
        });

        // доп. нагрузка
        this.additionalWorkloadType = positionData.additionalWorkloadType;
        this.additionalWorkload = ko.observable(positionData.additionalWorkload);
        this.additionalWorkloadUnits = positionData.additionalWorkloadUnits;

        this.minDurationWithoutCompensation = positionData.minDurationWithoutCompensation;

        // ФОТ, % в категории
        this.fotCategory = ko.observable(positionData.fotCategory);

        // ФОТ, % от выручки
        this.fotRevenue = ko.observable(positionData.fotRevenue);

        this.salary = positionData.salary; // оклад
        this.salaryBulk = positionData.salaryBulk; // основная часть зарплаты

        this.revenueStandart = positionData.revenueStandart; // Норматив выручки
        this.revenueStandartPerHour = positionData.revenueStandartPerHour; // Норматив выручки в час
        this.revenueStandartUnits = positionData.revenueStandartUnits; // Единицы измерения

        // Норм. выработки
        this.performanceStandart = ko.observable(positionData.performanceStandart);
        this.performanceStandartType = positionData.performanceStandartType;
        this.performanceStandartUnits = positionData.performanceStandartUnits;

        this.lateness = ko.observable(positionData.lateness);

        this.totalLateness = ko.pureComputed(() => {
          let lateness = this.lateness();
          return (lateness.light + lateness.medium + lateness.hard) || 0;
        });

        this.getData = () => {
          return {
            id: this.id,
            name: this.name,
            workloadType: this.workloadType,
            workload: this.workload(),
            workloadUnits: this.workloadUnits,
            additionalWorkloadType: this.additionalWorkloadType,
            additionalWorkload: this.additionalWorkload(),
            additionalWorkloadUnits: this.additionalWorkloadUnits,
            fotCategory: this.fotCategory(),
            fotRevenue: this.fotRevenue(),
            performanceStandart: this.performanceStandart(),
            performanceStandartType: this.performanceStandartType,
            performanceStandart: this.performanceStandartUnits,
            salary: this.salary,
            salaryBulk: this.salaryBulk,
            revenueStandart: this.revenueStandart,
            revenueStandartPerHour: this.revenueStandartPerHour,
            revenueStandartUnits: this.revenueStandartUnits,
            employees: this.employees().map(e => e.getData()),
          };
        }
      }
    };

    const LatenessModel = function (root) {
      this.root = root;
      this.loaded = ko.observable(false);

      this.activate = () => {
        setTimeout(() => {
          this.loaded(true);
        }, 1000);
      };

      this.deactivate = () => {
        this.loaded(false);
      }

      function getIntervalString(interval) {
        if (!interval[0]) return '<' + interval[1];
        if (!interval[1]) return '>' + interval[0];

        return interval[0] + '-' + interval[1];
      }

      this.intervals = [
        [null, 12],
        [12, 13],
        [13, 14],
        [14, 15],
        [15, 16],
        [16, 17],
        [17, 18],
        [18, 19],
        [19, 20],
        [20, 21],
        [21, 22],
        [22, 23],
        [23, null],
      ];

      this.getIntervalString = getIntervalString;

      this.operator = new PositionModel({
        id: 'operator',
        name: 'Оператор',
        params: [
          { id: 'ordersCount', name: 'Кол-во заказов', sum: true, format: 0 },
        ],
      }, this.intervals, root);

      this.administrator = new PositionModel({
        id: 'administrator',
        name: 'Администратор филиала',
        params: [
          { id: 'ordersCount', name: 'Кол-во заказов', sum: true, format: 0 }
        ],
      }, this.intervals, root);

      this.sushiMaster = new PositionModel({
        id: 'sushi-master',
        name: 'Повар-сушист',
        params: [
          { id: 'employeesWithNorm', name: 'Сотр. с норм.', sum: false, format: 2, noTotal: true },
          { id: 'revenue', name: 'Выручка', sum: true, format: 0 }
        ],
      }, this.intervals, root);

      this.pizzaMaster = new PositionModel({
        id: 'pizza-master',
        name: 'Повар-пиццемейкер',
        params: [
          { id: 'employeesWithNorm', name: 'Сотр. с норм.', sum: false, format: 2 },
          { id: 'pizzaCount', name: 'Кол-во пицц' }
        ],
      }, this.intervals, root);

      this.hotShop = new PositionModel({
        id: 'hot-shop',
        name: 'Горячий цех',
        params: [
          { id: 'revenue', name: 'Выручка', sum: true, format: 0 }
        ],
      }, this.intervals, root);

      this.driver = new PositionModel({
        id: 'driver',
        name: 'Водитель',
        params: [
          { id: 'ordersCount', name: 'Кол-во заказов', sum: true, format: 0 }
        ],
      }, this.intervals, root);

      this.positions = [
        this.operator,
        this.administrator,
        this.sushiMaster,
        this.pizzaMaster,
        this.hotShop,
        this.driver
      ];

      this.total = ko.pureComputed(() => {
        let positions = this.positions.filter(p => p.visible())
          .map(position => position.lateness.intervals());
        let intervals = this.intervals.map((_, intervalIndex) => {
          return positions.map(p => p[intervalIndex]);
        });
        intervals = intervals.map(interval => {
          return interval.reduce((acc, i) => {
            return {
              light: acc.light + i.light,
              medium: acc.medium + i.medium,
              hard: acc.hard + i.hard,
            }
          }, { light: 0, medium: 0, hard: 0 })
        });
        intervals.forEach(i => {
          i.total = i.light + i.medium + i.hard;
        });
        let total = intervals.reduce((acc, i) => {
          return {
            light: acc.light + i.light,
            medium: acc.medium + i.medium,
            hard: acc.hard + i.hard,
            total: acc.total + i.total,
          };
        }, { light: 0, medium: 0, hard: 0, total: 0 });

        return {
          intervals, total
        }
      });

      this.filters = {
        lateness: ko.observable(null),
        positions: ko.observableArray([]),
      };

      this.filters.positions.subscribe(v => {
        this.positions.forEach(p => {
          if (!v.length) p.visible(true);
          else if (v.includes(p.id)) p.visible(true);
          else p.visible(false);
        })
      });

      this.setData = (data) => {
        this.operator.setData(data.operator);
        this.administrator.setData(data.administrator);
        this.sushiMaster.setData(data.sushiMaster);
        this.pizzaMaster.setData(data.pizzaMaster);
        this.hotShop.setData(data.hotShop);
        this.driver.setData(data.driver);
      }

      this.isValid = () => {
        return true;
      }

      function PositionModel(positionData, intervals, root) {
        this.root = root;

        this.id = positionData.id;
        this.name = positionData.name;

        this.visible = ko.observable(true);

        this.korf = {
          intervals: ko.observableArray(intervals.map(_ => 0)),
          total: ko.observable(0)
        };

        this.workload = {
          intervals: ko.observableArray(intervals.map(_ => 0)),
          total: ko.observable(0)
        };

        this.getWorkloadColor = (intervalIndex) => {
          if (intervalIndex % 5) return '#FDFFB3';
          if (intervalIndex % 4) return '#D0F4E3';
          if (intervalIndex % 3) return '#B8EFD5';
          if (intervalIndex % 2) return '#FFE6F2';
          return '#FFD3E8';
        }

        this.employees = {
          intervals: ko.observableArray(intervals.map(_ => 0)),
        };
        this.employees.total = ko.pureComputed(() => {
          return this.employees.intervals().reduce((acc, i) => acc + i, 0);
        });

        this.lateness = {
          intervals: ko.observableArray(intervals.map(_ => {
            return {
              light: 0,
              medium: 0,
              hard: 0
            }
          })),
        };
        this.lateness.intervalsTotal = ko.pureComputed(() => {
          return this.lateness.intervals().map((i) => {
            return i.light + i.medium + i.hard;
          });
        });
        this.lateness.total = ko.pureComputed(() => {
          let result = this.lateness.intervals().reduce((acc, i) => {
            return {
              light: acc.light + i.light,
              medium: acc.medium + i.medium,
              hard: acc.hard + i.hard,
            }
          }, { light: 0, medium: 0, hard: 0 });
          result.total = result.light + result.medium + result.hard;
          return result;
        });

        this.params = [

        ];

        const params = positionData.params || [];
        params.forEach(param => {
          const paramModel = {
            intervals: ko.observableArray(intervals.map(_ => 0)),
          };
          if (param.sum) {
            paramModel.total = ko.pureComputed(() => {
              return paramModel.intervals().reduce((acc, i) => acc + i, 0);
            });
          } else {
            paramModel.total = ko.observable(param.noTotal ? '' : 0);
          }
          this[param.id] = paramModel;
          this.params.push(param);
        });

        this.paramsCount = this.params.length + 3;

        this.openLatenessModal = (intervalIndex, latenessDegree) => {
          const interval = intervals[intervalIndex];
          this.root.utils.openModal('lateness-details', {
            interval,
            position: this,
            title: `Опоздания - ${this.name} - ${getIntervalString(interval)}`,

          });
        };

        this.setData = (data) => {
          this.korf.intervals(data.korf.intervals);
          this.korf.total(data.korf.total);

          this.workload.intervals(data.workload.intervals);
          this.workload.total(data.workload.total);

          this.employees.intervals(data.employees.intervals);

          this.params.forEach(param => {
            this[param.id].intervals(data[param.id].intervals);
            if (!param.sum) {
              this[param.id].total(data[param.id].total);
            }
          });

          this.lateness.intervals(data.lateness.intervals);
        }
      };
    }

    const ViewModel = function () {
      /** Initialization */
      (() => {
        this.subscriptions = [];
        const viewportSize = ko.observable({ width: $(window).width(), height: $(window).height() });
        this.windowResizeHandler = () => {
          viewportSize({ width: $(window).width(), height: $(window).height() });
        };
        this.childrenComplete = function () {
          $page.removeClass('hrm-page--initializing');
        };
        this.modalOpens = ko.observableArray([]);

        function createModalDialog(id, data, onSave) {
          return {
            dialogTemplateName: id + '-modal-template',
            data: data,
            options: {
              modalClass: 'calculation-modal calculation-modal--' + id
            },
            close: result => {
              if (result !== undefined && typeof onSave === 'function') {
                onSave(result);
              }
            }
          }
        }

        this.utils = {
          openModal: (id, data, onSave) => {
            const modal = createModalDialog(id, data, onSave);

            this.modalOpens.push(modal);
          },

          formatSign: (number) => {
            const formattedNumber = parseFloat(ko.unwrap(number));
            if (!formattedNumber) return number;
            if (formattedNumber > 0) return '+' + formattedNumber;
            return formattedNumber;
          },

          formatTime: (minutes) => {
            if (!minutes) return '00:00';
            minutes = ko.unwrap(minutes);
            minutes = parseInt(minutes);
            if (!minutes || minutes <= 0) return '00:00';

            let h = Math.floor(minutes / 60).toString();
            h = h.length === 1 ? '0' + h : h;
            let m = (minutes % 60).toString();
            m = m.length === 1 ? '0' + m : m;

            return h + ':' + m;
          },

          viewportSize: viewportSize
        }
      })();

      this.summaryModel = new PositionsModel(this);
      this.latenessModel = new LatenessModel(this);

      this.inputModel = {
        filial: ko.observable(''),
        date: ko.observable(moment().format('DD.MM.YYYY')),
        shift: ko.observable(''),
        interval: {
          start: ko.observable(''),
          end: ko.observable(''),
        }
      };

      this.isNew = ko.observable(true);
      this.isBuilt = ko.observable(false);
      this.loading = ko.observable(false);
      this.isSubmitted = ko.observable(false);

      this.showSuccessMessage = ko.observable(false);
      this.showErrorMessage = ko.observable(false);

      this.versions = ko.observableArray([]);
      this.currentVersion = ko.observable(this.versions[0]);

      this.inBookmarks = ko.observable(false);
      this.addToBookmarks = () => {
        this.inBookmarks(true);
      };
      this.removeFromBookmarks = () => {
        this.inBookmarks(false);
      };

      this.hasChanges = ko.observable(false);
      this.checkChanges = () => {
        return new Promise((resolve) => {
          if (this.hasChanges()) {
            this.utils.openModal('confirm', {
              text: 'Текущий расчёт не сохранён. Данные могут быть потеряны. Произвести новый расчёт?',
            }, () => {
              resolve();
            })
          } else {
            resolve();
          }
        });
      }

      this.buildForNow = () => {
        this.buildCalculation();
      };

      // Построение расчета
      this.buildCalculation = () => {
        this.checkChanges()
          .then(() => {
            this.loading(true);
            const inputData = ko.toJS(this.inputModel);

            // Показывать лоадер 3с
            const delay = 3000
            const loadingDelay = new Promise(resolve => {
              setTimeout(() => {
                resolve();
              }, delay);
            });

            setTimeout(() => {
              // Производственные позиции
              const positions = [
                {
                  name: 'Администратор филиала',             // название должности
                  id: '1',                                   // идентификато позиции
                  levels: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],                            // разряды
                  workloadType: 'Выручка',                   // тип нагрузки
                  workload: 0,                               // нагрузка (величина)
                  workloadUnits: 2,                        // единицы измерения нагрузки
                  additionalWorkloadType: '',  // тип доп. нагрузки
                  additionalWorkload: '',                   // доп. нагрузка (величина)
                  additionalWorkloadUnits: '%',              // единицы измерения доп. нагрузки
                  fotCategory: 0,                            // ФОТ, % в категории
                  fotRevenue: 0,                             // ФОТ, % от выручки
                  performanceStandart: 0,                    // Норм. выработки, %
                  performanceStandartType: '',               //
                  salary: 30000,                             // Оклад
                  salaryBulk: 7200,                          // основная часть зарплаты
                  revenueStandart: 30,                       // Норматив выручки
                  revenueStandartPerHour: 0,
                  revenueStandartUnits: 2,
                  lateness: {
                    light: 0,
                    medium: 0,
                    hard: 0
                  },
                  employees: [                               // сотрудники
                    {
                      name: 'Администратор #1 Up',            // имя сотрудника
                      id: '11',                               // идентификатор сотрудника
                      link: '#',                              // ссылка на личное дело
                      hasProblems: 0,                         // проблемы с документами
                      upRecommended: 1,                       // рекомендуется повышение
                      downRecommended: 0,                     // рекомендуется понижение
                      premiumAccount: 100,                    // премиальный счет
                      account: 0,                             // личный счет
                      accountOperations: [],                  // операции со счетом
                      level: 1,                               // разряд сотрудника
                      workingIntervals: ['09:00 – 16:00'],    // рабочее время сотрудника
                      compensation: 0,                        // компенсация
                      workload: 0,                            // нагрузка
                      workloadUnits: 2,
                      salary: 3000,                           // зарплата
                      salaryBulk: 2000,                       // основная часть зарплаты
                      revenueStandartUnits: 2,
                      revenueStandartPerHour: 10000,          // норматив выручки в час
                      revenueStandart: 130000,                // Норматив выручки
                      normRatio: 0.5,                // Коэф. нормализации
                      bonusRatio: 0.5,                        // Коэф. премирования
                      depremationRatio: 0.5,                  // Коэф. депремирования
                      bonusExceed: 100,                       // прем. за превыш. норм
                      bonuses: [],                            // бонусы
                      fines: [],                              // штрафы
                      depremation: 0,                         // депр.
                      correctedTime: '0',                  // корр. время
                      total: 7300,                            // всего
                      toPayment: 7300,
                      visible: false,
                    },
                    {
                      name: 'Администратор #2 Down',
                      id: '12',
                      link: '#',
                      hasProblems: 0,
                      upRecommended: 0,
                      downRecommended: 1,
                      premiumAccount: 100,
                      account: 0,
                      accountOperations: [],
                      level: 2,
                      workingIntervals: ['09:00 – 16:00'],
                      compensation: 0,
                      workload: 0,
                      workloadUnits: 2,
                      salary: 3000,
                      salaryBulk: 2000,
                      revenueStandartUnits: 2,
                      revenueStandartPerHour: 10000,
                      revenueStandart: 130000,
                      normRatio: 0.5,
                      bonusRatio: 0.5,
                      depremationRatio: 0.5,
                      bonusExceed: 100,
                      bonuses: [],
                      fines: [],
                      depremation: 0,
                      correctedTime: '0',
                      total: 7300,
                      toPayment: 7300,
                      visible: false,
                    }
                  ],
                  minDurationWithoutCompensation: 3,
                  visible: 0,
                },
                {
                  name: 'Повар-сушист',
                  id: '2',
                  levels: [],
                  workloadType: 'Выручка',
                  workload: 0,
                  workloadUnits: 2,
                  additionalWorkloadType: 'Лосось, кг',
                  additionalWorkload: 200,
                  additionalWorkloadUnits: '',
                  fotCategory: 0,
                  fotRevenue: 0,
                  performanceStandart: 0,
                  performanceStandartType: '',
                  salary: 30000,
                  salaryBulk: 7200,
                  revenueStandart: 30,
                  revenueStandartPerHour: 0,
                  revenueStandartUnits: 2,
                  lateness: {
                    light: 0,
                    medium: 0,
                    hard: 0
                  },
                  employees: [
                    {
                      name: 'Повар-сушист #1 problems',
                      id: '21',
                      link: '#',
                      hasProblems: 1,
                      upRecommended: 0,
                      downRecommended: 0,
                      premiumAccount: 100,
                      account: 3000,
                      accountOperations: [],
                      level: 0,
                      workingIntervals: ['09:00 – 16:00'],
                      compensation: 0,
                      workload: 0,
                      workloadUnits: 2,
                      salary: 3000,
                      salaryBulk: 2000,
                      revenueStandartUnits: 2,
                      revenueStandartPerHour: 10000,
                      revenueStandart: 130000,
                      normRatio: 0.5,
                      bonusRatio: 0.5,
                      depremationRatio: 0.5,
                      bonusExceed: 100,
                      bonuses: [],
                      fines: [],
                      depremation: 0,
                      correctedTime: '0',
                      total: 7300,
                      toPayment: 7300,
                      visible: false,
                    },
                    {
                      name: 'Повар-сушист #2 problems + up',
                      id: '22',
                      link: '#',
                      hasProblems: 1,
                      upRecommended: 1,
                      downRecommended: 0,
                      premiumAccount: 100,
                      account: 3000,
                      accountOperations: [],
                      level: 0,
                      workingIntervals: ['09:00 – 16:00'],
                      compensation: 0,
                      workload: 0,
                      workloadUnits: 2,
                      salary: 3000,
                      salaryBulk: 2000,
                      revenueStandartUnits: 2,
                      revenueStandartPerHour: 10000,
                      revenueStandart: 130000,
                      normRatio: 0.5,
                      bonusRatio: 0.5,
                      depremationRatio: 0.5,
                      bonusExceed: 100,
                      bonuses: [],
                      fines: [],
                      depremation: 0,
                      correctedTime: '0',
                      total: 7300,
                      toPayment: 7300,
                      visible: false,
                    }
                  ],
                  minDurationWithoutCompensation: 3,
                  visible: 0,
                },
                {
                  name: 'Повар-пиццмейкер',
                  id: '3',
                  levels: [1, 2, 3],
                  workloadType: 'Пиццы',
                  workload: 30,
                  workloadUnits: 1,
                  additionalWorkloadType: 'Лосось, кг',
                  additionalWorkload: 200,
                  additionalWorkloadUnits: '',
                  fotCategory: 0,
                  fotRevenue: 0,
                  performanceStandart: 0,
                  performanceStandartType: '',
                  salary: 30000,
                  salaryBulk: 7200,
                  revenueStandart: 30,
                  revenueStandartPerHour: 0,
                  revenueStandartUnits: 2,
                  lateness: {
                    light: 0,
                    medium: 0,
                    hard: 0
                  },
                  employees: [
                    {
                      name: 'Повар-пиццмейкер #1 problems + down',
                      id: '31',
                      link: '#',
                      hasProblems: 1,
                      upRecommended: 0,
                      downRecommended: 1,
                      premiumAccount: 100,
                      account: 3000,
                      accountOperations: [],
                      level: 1,
                      workingIntervals: ['09:00 – 16:00'],
                      compensation: 0,
                      workload: 0,
                      workloadUnits: 2,
                      salary: 3000,
                      salaryBulk: 2000,
                      revenueStandartUnits: 2,
                      revenueStandartPerHour: 10000,
                      revenueStandart: 130000,
                      normRatio: 0.5,
                      bonusRatio: 0.5,
                      depremationRatio: 0.5,
                      bonusExceed: 100,
                      bonuses: [],
                      fines: [],
                      depremation: 0,
                      correctedTime: '0',
                      total: 7300,
                      toPayment: 7300,
                      visible: false,
                    },
                    {
                      name: 'Повар-пиццмейкер #2',
                      id: '32',
                      link: '#',
                      hasProblems: 0,
                      upRecommended: 0,
                      downRecommended: 0,
                      premiumAccount: 100,
                      account: 3000,
                      accountOperations: [],
                      level: 3,
                      workingIntervals: ['09:00 – 16:00'],
                      compensation: 0,
                      workload: 0,
                      workloadUnits: 2,
                      salary: 3000,
                      salaryBulk: 2000,
                      revenueStandartUnits: 2,
                      revenueStandartPerHour: 10000,
                      revenueStandart: 130000,
                      normRatio: 0.5,
                      bonusRatio: 0.5,
                      depremationRatio: 0.5,
                      bonusExceed: 100,
                      bonuses: [],
                      fines: [],
                      depremation: 0,
                      correctedTime: '0',
                      total: 7300,
                      toPayment: 7300,
                      visible: false,
                    }
                  ],
                  minDurationWithoutCompensation: 3,
                  visible: 0,
                },
                {
                  name: 'Официант',
                  id: '4',
                  levels: [1, 2],
                  workloadType: 'Выручка',
                  workload: 0,
                  workloadUnits: 2,
                  additionalWorkloadType: '',
                  additionalWorkload: 0,
                  additionalWorkloadUnits: '',
                  fotCategory: 0,
                  fotRevenue: 0,
                  performanceStandart: 0,
                  performanceStandartType: '',
                  salary: 30000,
                  salaryBulk: 7200,
                  revenueStandart: 30,
                  revenueStandartPerHour: 0,
                  revenueStandartUnits: 2,
                  lateness: {
                    light: 0,
                    medium: 0,
                    hard: 0
                  },
                  employees: [
                    {
                      name: 'Официант #1',
                      id: '41',
                      link: '#',
                      hasProblems: 0,
                      upRecommended: 0,
                      downRecommended: 0,
                      premiumAccount: 100,
                      account: 3000,
                      accountOperations: [],
                      level: 1,
                      workingIntervals: ['09:00 – 16:00'],
                      compensation: 0,
                      workload: 0,
                      workloadUnits: 2,
                      salary: 3000,
                      salaryBulk: 2000,
                      revenueStandartUnits: 2,
                      revenueStandartPerHour: 10000,
                      revenueStandart: 130000,
                      normRatio: 0.5,
                      bonusRatio: 0.5,
                      depremationRatio: 0.5,
                      bonusExceed: 100,
                      bonuses: [],
                      fines: [],
                      depremation: 0,
                      correctedTime: '0',
                      total: 7300,
                      toPayment: 7300,
                      visible: false,
                    },
                    {
                      name: 'Официант #2',
                      id: '42',
                      link: '#',
                      hasProblems: 0,
                      upRecommended: 0,
                      downRecommended: 0,
                      premiumAccount: 100,
                      account: 3000,
                      accountOperations: [],
                      level: 2,
                      workingIntervals: ['09:00 – 16:00'],
                      compensation: 0,
                      workload: 0,
                      workloadUnits: 2,
                      salary: 3000,
                      salaryBulk: 2000,
                      revenueStandartUnits: 2,
                      revenueStandartPerHour: 10000,
                      revenueStandart: 130000,
                      normRatio: 0.5,
                      bonusRatio: 0.5,
                      depremationRatio: 0.5,
                      bonusExceed: 100,
                      bonuses: [],
                      fines: [],
                      depremation: 0,
                      correctedTime: '0',
                      total: 7300,
                      toPayment: 7300,
                      visible: false,
                    }
                  ],

                  minDurationWithoutCompensation: 3,
                  visible: 0,
                },
                {
                  name: 'Официант2',
                  id: '5',
                  levels: [1, 2],
                  workloadType: 'Выручка',
                  workload: 0,
                  workloadUnits: 2,
                  additionalWorkloadType: '',
                  additionalWorkload: 0,
                  additionalWorkloadUnits: '',
                  fotCategory: 0,
                  fotRevenue: 0,
                  performanceStandart: 0,
                  performanceStandartType: '',
                  salary: 30000,
                  salaryBulk: 7200,
                  revenueStandart: 30,
                  revenueStandartPerHour: 0,
                  revenueStandartUnits: 2,
                  employees: [
                    {
                      name: 'Официант #1',
                      id: '51',
                      link: '#',
                      hasProblems: 0,
                      upRecommended: 0,
                      downRecommended: 0,
                      premiumAccount: 100,
                      account: 3000,
                      accountOperations: [],
                      level: 1,
                      workingIntervals: ['09:00 – 16:00'],
                      compensation: 0,
                      workload: 0,
                      workloadUnits: 2,
                      salary: 3000,
                      salaryBulk: 2000,
                      revenueStandartUnits: 2,
                      revenueStandartPerHour: 10000,
                      revenueStandart: 130000,
                      normRatio: 0.5,
                      bonusRatio: 0.5,
                      depremationRatio: 0.5,
                      bonusExceed: 100,
                      bonuses: [],
                      fines: [],
                      depremation: 0,
                      correctedTime: '0',
                      total: 7300,
                      toPayment: 7300,
                      visible: false,
                    },
                    {
                      name: 'Официант #2',
                      id: '52',
                      link: '#',
                      hasProblems: 0,
                      upRecommended: 0,
                      downRecommended: 0,
                      premiumAccount: 100,
                      account: 3000,
                      accountOperations: [],
                      level: 2,
                      workingIntervals: ['09:00 – 16:00'],
                      compensation: 0,
                      workload: 0,
                      workloadUnits: 2,
                      salary: 3000,
                      salaryBulk: 2000,
                      revenueStandartUnits: 2,
                      revenueStandartPerHour: 10000,
                      revenueStandart: 130000,
                      normRatio: 0.5,
                      bonusRatio: 0.5,
                      depremationRatio: 0.5,
                      bonusExceed: 100,
                      bonuses: [],
                      fines: [],
                      depremation: 0,
                      correctedTime: '0',
                      total: 7300,
                      toPayment: 7300,
                      visible: false,
                    }
                  ],
                  minDurationWithoutCompensation: 3,
                  lateness: {
                    light: 0,
                    medium: 0,
                    hard: 0
                  },
                  visible: 0,
                },
                {
                  name: 'Официант3',
                  id: '6',
                  levels: [1, 2],
                  workloadType: 'Выручка',
                  workload: 0,
                  workloadUnits: 2,
                  additionalWorkloadType: '',
                  additionalWorkload: 0,
                  additionalWorkloadUnits: '',
                  fotCategory: 0,
                  fotRevenue: 0,
                  performanceStandart: 0,
                  performanceStandartType: '',
                  salary: 30000,
                  salaryBulk: 7200,
                  revenueStandart: 30,
                  revenueStandartPerHour: 0,
                  revenueStandartUnits: 2,
                  employees: [],
                  minDurationWithoutCompensation: 3,
                  lateness: {
                    light: 0,
                    medium: 0,
                    hard: 0
                  },
                  visible: 0,
                },
                {
                  name: 'Официант4',
                  id: '7',
                  levels: [1, 2],
                  workloadType: 'Выручка',
                  workload: 0,
                  workloadUnits: 2,
                  additionalWorkloadType: '',
                  additionalWorkload: 0,
                  additionalWorkloadUnits: '',
                  fotCategory: 0,
                  fotRevenue: 0,
                  performanceStandart: 0,
                  performanceStandartType: '',
                  salary: 30000,
                  salaryBulk: 7200,
                  revenueStandart: 30,
                  revenueStandartPerHour: 0,
                  revenueStandartUnits: 2,
                  employees: [],
                  minDurationWithoutCompensation: 3,
                  lateness: {
                    light: 0,
                    medium: 0,
                    hard: 0
                  },
                  visible: 0,
                },
                {
                  name: 'Официант5',
                  id: '8',
                  levels: [1, 2],
                  workloadType: 'Выручка',
                  workload: 0,
                  workloadUnits: 2,
                  additionalWorkloadType: '',
                  additionalWorkload: 0,
                  additionalWorkloadUnits: '',
                  fotCategory: 0,
                  fotRevenue: 0,
                  performanceStandart: 0,
                  performanceStandartType: '',
                  salary: 30000,
                  salaryBulk: 7200,
                  revenueStandart: 30,
                  revenueStandartPerHour: 0,
                  revenueStandartUnits: 2,
                  employees: [],
                  minDurationWithoutCompensation: 3,
                  lateness: {
                    light: 0,
                    medium: 0,
                    hard: 0
                  },
                  visible: 0,
                },
                {
                  name: 'Официант6',
                  id: '9',
                  levels: [1, 2],
                  workloadType: 'Выручка',
                  workload: 0,
                  workloadUnits: 2,
                  additionalWorkloadType: '',
                  additionalWorkload: 0,
                  additionalWorkloadUnits: '',
                  fotCategory: 0,
                  fotRevenue: 0,
                  performanceStandart: 0,
                  performanceStandartType: '',
                  salary: 30000,
                  salaryBulk: 7200,
                  revenueStandart: 30,
                  revenueStandartPerHour: 0,
                  revenueStandartUnits: 2,
                  employees: [],
                  minDurationWithoutCompensation: 3,
                  visible: 0,
                },
                {
                  name: 'Официант7',
                  id: '10',
                  levels: [1, 2],
                  workloadType: 'Выручка',
                  workload: 0,
                  workloadUnits: 2,
                  additionalWorkloadType: '',
                  additionalWorkload: 0,
                  additionalWorkloadUnits: '',
                  fotCategory: 0,
                  fotRevenue: 0,
                  performanceStandart: 0,
                  performanceStandartType: '',
                  salary: 30000,
                  salaryBulk: 7200,
                  revenueStandart: 30,
                  revenueStandartPerHour: 0,
                  revenueStandartUnits: 2,
                  employees: [],
                  visible: 0
                },
              ];

              // Обновление производственных позиций
              this.summaryModel.setPositions(positions);

              // Данные водителей
              const driversData = {
                type: 'delivery',
                name: 'Водители',                           // название должности
                id: 'drivers',                              // идентификато позиции
                workloadType: 'Выручка',                    // тип нагрузки
                workload: 0,                                // нагрузка (величина)
                workloadUnits: 2,                         // единицы измерения нагрузки
                additionalWorkloadType: '',                 // тип доп. нагрузки
                additionalWorkload: '52',                   // доп. нагрузка (величина)
                additionalWorkloadUnits: '',                // единицы измерения доп. нагрузки
                fotCategory: 0,                             // ФОТ, % в категории
                fotRevenue: 0,                              // ФОТ, % от выручки
                performanceStandart: 0,                     // Норм. выработки, %
                performanceStandartType: 'Цена заказа',
                performanceStandartUnits: 2,
                salary: 30000,                              // Оклад
                salaryBulk: 7200,                           // основная часть зарплаты
                revenueStandart: 30,                        // Норматив выручки
                revenueStandartPerHour: 0,
                revenueStandartUnits: 2,
                minDurationWithoutCompensation: 3,
                lateness: {
                  light: 0,
                  medium: 0,
                  hard: 0
                },
                employees: [                                // сотрудники
                  {
                    name: 'Водитель #1',                    // имя сотрудника
                    id: 'driver1',                          // идентификатор сотрудника
                    link: '#',                              // ссылка на личное дело
                    hasProblems: 1,                         // проблемы с документами
                    premiumAccount: 0,                      // премиальный счет
                    account: 100,                           // личный счет
                    accountOperations: [],                  // операции со счетом
                    workingIntervals: ['09:00 – 16:00'],    // рабочее время сотрудника
                    ordersCount: 10,
                    ordersValue: 10,
                    averageBill: 100,
                    distKm: 100,
                    estimatedTime: 10000,
                    actualTime: 10000,
                    kpi: 23,
                    timeWithoutCase: 1000,
                    orders: 45,
                    dist: 234,
                    minPayment: 2345,
                    surcharge: 24,
                    lateSurcharge: 3,
                    shortShiftSurcharge: 23,
                    bonuses: [],                            // бонусы
                    fines: [],                              // штрафы
                    total: 7300,                            // всего
                    toPayment: 7300,                        // к выплате
                    lateness: {                             // опоздания сотрудника
                      light: 0,                             // меньше 5 минут
                      medium: 0,                            // 5-10 минут
                      hard: 0                               // больше 10 минут
                    },
                    visible: true,
                  },
                  {
                    name: 'Водитель #2',
                    id: 'driver2',
                    link: '#',
                    hasProblems: 0,
                    premiumAccount: 100,
                    account: 0,
                    accountOperations: [],
                    workingIntervals: ['09:00 – 16:00'],
                    ordersCount: 10,
                    ordersValue: 10,
                    averageBill: 100,
                    distKm: 100,
                    estimatedTime: 10000,
                    actualTime: 10000,
                    kpi: 23,
                    timeWithoutCase: 1000,
                    orders: 45,
                    dist: 234,
                    minPayment: 2345,
                    surcharge: 24,
                    lateSurcharge: 3,
                    shortShiftSurcharge: 23,
                    bonuses: [],
                    fines: [],
                    depremation: 0,
                    correctedTime: '0',
                    total: 7300,
                    toPayment: 7300,
                    lateness: {
                      light: 0,
                      medium: 0,
                      hard: 0
                    },
                    visible: true
                  }
                ],
              };
              // Обновить данные водителей
              this.summaryModel.setDriversData(driversData);

              // Опоздания
              const latenessData = {
                operator: {
                  korf: {
                    intervals: [0.3, 1.5, 0.1, 2.0, 0.1, 0.1, 0.3, 1.0, 0.8, 0.6, 2.2, 0.4],
                    total: 0.0
                  },
                  workload: {
                    intervals: [300.0, 1452.4, 911.8, 2020.0, 2759.2, 2019.5, 340.8, 1018.4, 794.7, 3325.5, 2212.9, 2443.4],
                    total: 300.0
                  },
                  employees: {
                    intervals: [5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 0]
                  },
                  ordersCount: {
                    intervals: [3, 2, 3, 7, 9, 3, 4, 5, 5, 9, 9, 5, 3],
                  },
                  lateness: {
                    intervals: [
                      { light: 0, medium: 1, hard: 0 },
                      { light: 2, medium: 1, hard: 0 },
                      { light: 1, medium: 0, hard: 1 },
                      { light: 2, medium: 1, hard: 0 },
                      { light: 2, medium: 0, hard: 0 },
                      { light: 1, medium: 0, hard: 0 },
                      { light: 1, medium: 0, hard: 0 },
                      { light: 2, medium: 1, hard: 0 },
                      { light: 2, medium: 0, hard: 1 },
                      { light: 1, medium: 2, hard: 0 },
                      { light: 1, medium: 0, hard: 0 },
                      { light: 0, medium: 0, hard: 0 },
                      { light: 0, medium: 0, hard: 0 },
                    ]
                  }
                },
                administrator: {
                  korf: {
                    intervals: [1.5, 0.1, 2.0, 0.1, 0.1, 0.3, 1.0, 0.8, 0.6, 2.2, 0.4, 0.3],
                    total: 0.0
                  },
                  workload: {
                    intervals: [1452.4, 911.8, 2020.0, 2759.2, 2019.5, 340.8, 1018.4, 794.7, 3325.5, 2212.9, 2443.4, 300.0],
                    total: 300.0
                  },
                  employees: {
                    intervals: [4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 0]
                  },
                  ordersCount: {
                    intervals: [2, 3, 7, 9, 3, 4, 5, 5, 9, 9, 5, 3, 0],
                  },
                  lateness: {
                    intervals: [
                      { light: 0, medium: 1, hard: 0 },
                      { light: 2, medium: 1, hard: 0 },
                      { light: 1, medium: 0, hard: 1 },
                      { light: 2, medium: 1, hard: 0 },
                      { light: 2, medium: 0, hard: 0 },
                      { light: 1, medium: 0, hard: 0 },
                      { light: 1, medium: 0, hard: 0 },
                      { light: 2, medium: 1, hard: 0 },
                      { light: 2, medium: 0, hard: 1 },
                      { light: 1, medium: 2, hard: 0 },
                      { light: 1, medium: 0, hard: 0 },
                      { light: 0, medium: 0, hard: 0 },
                      { light: 0, medium: 0, hard: 0 },
                    ]
                  }
                },
                sushiMaster: {
                  korf: {
                    intervals: [1.5, 0.1, 2.0, 0.1, 0.1, 0.3, 1.0, 0.8, 0.6, 2.2, 0.4, 0.3],
                    total: 0.0
                  },
                  workload: {
                    intervals: [1452.4, 911.8, 2020.0, 2759.2, 2019.5, 340.8, 1018.4, 794.7, 3325.5, 2212.9, 2443.4, 300.0],
                    total: 300.0
                  },
                  employees: {
                    intervals: [4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 0]
                  },
                  employeesWithNorm: {
                    intervals: [3.80, 3.80, 3.80, 3, 80, 3.80, 3.80, 3.80, 3.80, 3.80, 3.80, 3.80, 3.80, 0.00],
                  },
                  revenue: {
                    intervals: [5519, 3465, 7714, 10485, 7674, 1295, 3870, 3020, 12637, 8409, 9285, 1140, 0],
                  },
                  lateness: {
                    intervals: [
                      { light: 0, medium: 1, hard: 0 },
                      { light: 2, medium: 1, hard: 0 },
                      { light: 1, medium: 0, hard: 1 },
                      { light: 2, medium: 1, hard: 0 },
                      { light: 2, medium: 0, hard: 0 },
                      { light: 1, medium: 0, hard: 0 },
                      { light: 1, medium: 0, hard: 0 },
                      { light: 2, medium: 1, hard: 0 },
                      { light: 2, medium: 0, hard: 1 },
                      { light: 1, medium: 2, hard: 0 },
                      { light: 1, medium: 0, hard: 0 },
                      { light: 0, medium: 0, hard: 0 },
                      { light: 0, medium: 0, hard: 0 },
                    ]
                  }
                },
                pizzaMaster: {
                  korf: {
                    intervals: [1.5, 0.1, 2.0, 0.1, 0.1, 0.3, 1.0, 0.8, 0.6, 2.2, 0.4, 0.3],
                    total: 0.0
                  },
                  workload: {
                    intervals: [1452.4, 911.8, 2020.0, 2759.2, 2019.5, 340.8, 1018.4, 794.7, 3325.5, 2212.9, 2443.4, 300.0],
                    total: 300.0
                  },
                  employees: {
                    intervals: [4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 0]
                  },
                  employeesWithNorm: {
                    intervals: [3.80, 3.80, 3.80, 3, 80, 3.80, 3.80, 3.80, 3.80, 3.80, 3.80, 3.80, 3.80, 0.00],
                  },
                  pizzaCount: {
                    intervals: [20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32],
                  },
                  lateness: {
                    intervals: [
                      { light: 0, medium: 1, hard: 0 },
                      { light: 2, medium: 1, hard: 0 },
                      { light: 1, medium: 0, hard: 1 },
                      { light: 2, medium: 1, hard: 0 },
                      { light: 2, medium: 0, hard: 0 },
                      { light: 1, medium: 0, hard: 0 },
                      { light: 1, medium: 0, hard: 0 },
                      { light: 2, medium: 1, hard: 0 },
                      { light: 2, medium: 0, hard: 1 },
                      { light: 1, medium: 2, hard: 0 },
                      { light: 1, medium: 0, hard: 0 },
                      { light: 0, medium: 0, hard: 0 },
                      { light: 0, medium: 0, hard: 0 },
                    ]
                  }
                },
                hotShop: {
                  korf: {
                    intervals: [1.5, 0.1, 2.0, 0.1, 0.1, 0.3, 1.0, 0.8, 0.6, 2.2, 0.4, 0.3],
                    total: 0.0
                  },
                  workload: {
                    intervals: [1452.4, 911.8, 2020.0, 2759.2, 2019.5, 340.8, 1018.4, 794.7, 3325.5, 2212.9, 2443.4, 300.0],
                    total: 300.0
                  },
                  employees: {
                    intervals: [4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 0]
                  },
                  revenue: {
                    intervals: [5519, 3465, 7714, 10485, 7674, 1295, 3870, 3020, 12637, 8409, 9285, 1140, 0],
                  },
                  lateness: {
                    intervals: [
                      { light: 0, medium: 1, hard: 0 },
                      { light: 2, medium: 1, hard: 0 },
                      { light: 1, medium: 0, hard: 1 },
                      { light: 2, medium: 1, hard: 0 },
                      { light: 2, medium: 0, hard: 0 },
                      { light: 1, medium: 0, hard: 0 },
                      { light: 1, medium: 0, hard: 0 },
                      { light: 2, medium: 1, hard: 0 },
                      { light: 2, medium: 0, hard: 1 },
                      { light: 1, medium: 2, hard: 0 },
                      { light: 1, medium: 0, hard: 0 },
                      { light: 0, medium: 0, hard: 0 },
                      { light: 0, medium: 0, hard: 0 },
                    ]
                  }
                },
                driver: {
                  korf: {
                    intervals: [1.5, 0.1, 2.0, 0.1, 0.1, 0.3, 1.0, 0.8, 0.6, 2.2, 0.4, 0.3],
                    total: 0.0
                  },
                  workload: {
                    intervals: [1452.4, 911.8, 2020.0, 2759.2, 2019.5, 340.8, 1018.4, 794.7, 3325.5, 2212.9, 2443.4, 300.0],
                    total: 300.0
                  },
                  employees: {
                    intervals: [4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 0]
                  },
                  ordersCount: {
                    intervals: [2, 3, 7, 9, 3, 4, 5, 5, 9, 9, 5, 3, 0],
                  },
                  lateness: {
                    intervals: [
                      { light: 0, medium: 1, hard: 0 },
                      { light: 2, medium: 1, hard: 0 },
                      { light: 1, medium: 0, hard: 1 },
                      { light: 2, medium: 1, hard: 0 },
                      { light: 2, medium: 0, hard: 0 },
                      { light: 1, medium: 0, hard: 0 },
                      { light: 1, medium: 0, hard: 0 },
                      { light: 2, medium: 1, hard: 0 },
                      { light: 2, medium: 0, hard: 1 },
                      { light: 1, medium: 2, hard: 0 },
                      { light: 1, medium: 0, hard: 0 },
                      { light: 0, medium: 0, hard: 0 },
                      { light: 0, medium: 0, hard: 0 },
                    ]
                  }
                },


              };
              this.latenessModel.setData(latenessData);

              loadingDelay.then(() => {
                this.isBuilt(true);
                this.hasChanges(false);
                this.loading(false);
              });


            }, 10);
          })

      };

      this.recalculateRoutes = () => {
        this.buildCalculation();
      };

      /** Tabs: production, delivery, lateness */
      this.tabs = (() => {
        const tabs = [
          new HrmTabGroupItem('Производство'),
          new HrmTabGroupItem('Доставка'),
          new HrmTabGroupItem('Опоздания')
        ];
        const activeTab = ko.observable(0);
        return {
          tabs,
          activeTab,
          afterOpen: (el) => {
            $(el).hide().delay(200).fadeIn(200, function () {
              $(window).delay(1).resize()
            })
          }
        }
      })();
      this.tabs.activeTab.subscribe(v => {
        if (v == 2) {
          this.latenessModel.activate();
        } else {
          this.latenessModel.deactivate();
        }
      })

      this.productionPositions = ko.pureComputed(() => {
        return this.summaryModel.positions();
      });

      this.activePositions = ko.pureComputed(() => {
        return this.summaryModel.positions().filter(p => {
          if (p.visible()) return true;
          if (p.visibleEmployees().length) return true;
        })
      });

      /** Shift stimulation model (fine/bonus) */
      this.stimulation = ((root) => {
        function Stimulation() {
          return {
            base: ko.observable(''),
            author: ko.observable(''),
            sum: ko.observable(0),
            comment: ko.observable('')
          }
        }

        const fine = {
          production: Stimulation(),
          delivery: Stimulation()
        };

        const bonus = {
          production: Stimulation(),
          delivery: Stimulation()
        };

        const setStimulation = (category) => {
          this.utils.openModal(
            'stimulation',
            {
              category: category,
              fines: window.directories.fines,
              bonuses: window.directories.bonuses,
              authors: window.directories.authors
            },
            (data) => {
              let stimulationObject = {
                base: data.base,
                comment: data.comment,
                author: data.author,
                sum: data.sum
              };
              let positions = [];
              if (data.category === 'production') {
                positions = root.summaryModel.positions();
              } else {
                positions = [root.summaryModel.driversData()];
              }
              positions.forEach(p => {
                let employees = p.visibleEmployees();
                employees.forEach(e => {
                  if (data.stimulationType === 'fine') {
                    e.fines.push(stimulationObject);
                  } else if (data.stimulationType === 'bonus') {
                    e.bonuses.push(stimulationObject);
                  }
                })
              });
            }
          )
        };

        const isProductionBlocked = ko.pureComputed(() => {
          return !root.activePositions().some(p => p.visibleEmployees().length > 0);
        });

        const isDeliveryBlocked = ko.pureComputed(() => {
          return false;
        });

        return {
          isProductionBlocked,
          isDeliveryBlocked,
          fine,
          bonus,
          set: setStimulation
        };
      })(this);

      this.isEmployeesCalculated = ko.observable(false);

      this.calculateEmployees = function () {
        this.isEmployeesCalculated(true);
      };

      this.recalculateEmployees = function () {
        this.isEmployeesCalculated(false);

        // TODO
        this.formModel().positions().forEach((position, index) => {
          position.employees(positions[index].employees.map(e => this.createEmployeeModel(e)));
        });

        this.isEmployeesCalculated(true);
      };

      this.addWorkingInterval = function (employee) {
        employee.workingIntervals.push(this.createEmployeeWorkingIntervalModel(''));
      };

      this.onRateInput = function (position) {
        position.employees().forEach(employee => {
          employee.rate(position.rate());
        });
      };

      this.onEmployeeRateInput = function (position) {
        position.rate('');
      };

      this.getEmployeeWorkingHours = function (employee) {
        return ko.pureComputed(() => {
          if (employee.workingIntervalsValidationObject.isValid()) {
            return employee.workingIntervals().reduce((minutes, interval) => {
              const boundaries = interval.value().split(' – ').map(b => moment(b, 'HH:mm'));

              if (boundaries[0].isAfter(boundaries[1])) {
                boundaries[1].add(1, 'd');
              }

              return minutes + boundaries[1].diff(boundaries[0], 'minutes');
            }, 0);
          } else {
            return 0;
          }
        });
      };

      this.getEmployeeSalaryBulk = function (employee) {
        return ko.pureComputed(() => {
          const minutes = this.getEmployeeWorkingHours(employee)();

          return this.unmaskDecimal(employee.rate()) * (minutes / 60);
        });
      };

      this.getEmployeeSalary = function (employee) {
        return ko.pureComputed(() => {
          const bulk = this.getEmployeeSalaryBulk(employee)();
          const bonus = this.unmaskDecimal(employee.bonus());
          const fine = this.unmaskDecimal(employee.fine());

          return this.unmaskDecimal(bulk + bonus - fine);
        });
      };

      this.getPositionMaxWorkingIntervalCount = function (position) {
        return ko.pureComputed(() => {
          return Math.max(...position.employees().map(e => e.workingIntervals().length));
        });
      };

      this.getCategoriesTooltipText = function (categories) {
        return categories.map(c => c.name).join(', ');
      };

      this.getUnitsSuffixHtml = function (units) {
        switch ('' + units) {
          case '1': return 'шт.';
          case '2': return '₽';
          case '3': return 'ч.';
          default: return '';
        }
      };

      this.formatDecimal = function (value) {
        return Inputmask.format(value, { alias: 'decimal', digits: '2', groupSeparator: ' ', autoGroup: true, allowMinus: false }).replace('.00', '');
      };

      this.unmaskDecimal = function (value) {
        const result = Inputmask.unmask(value, { alias: 'decimal', digits: '2', groupSeparator: ' ', autoGroup: true, allowMinus: false, unmaskAsNumber: true });

        if (result === '') {
          return 0;
        }

        return result;
      };

      this.editableCellControlErrorExtractor = function (control) {
        return ko.pureComputed(() => {
          return !control.isValid() ? { message: control.error() } : null;
        });
      };

      this.afterRenderBuild = function (el) {
        $(el).hide().delay(300).fadeIn(200, () => {
          $(window).resize();
        })
      }

      this.isSidebarCollapsed = ko.observable(localStorage.getItem(HRM_SIDEBAR_COLLAPSED_LOCAL_STORAGE_KEY) === 'true');

      (() => {
        $(window).on('resize', this.windowResizeHandler);

        this.subscriptions.push(this.isSidebarCollapsed.subscribe(collapsed => {
          localStorage.setItem(HRM_SIDEBAR_COLLAPSED_LOCAL_STORAGE_KEY, collapsed);
        }));
      })();

      function getRandom(from, to) {
        return Math.floor(Math.random() * (to - from)) + from;
      }

      // Перерасчет значений в таблицах
      this.calculate = (changeSource, changedFields = []) => {
        this.hasChanges(true);

        // changeSource: 'production', 'delivery'
        // changedFields: массив названий измененных полей
        console.log('recalculate', changeSource, changedFields);


        /** УСТАНОВКА ДАННЫХ ДЛЯ ВОДИТЕЛЕЙ */

        // Позиция Водители
        const driversPosition = this.summaryModel.driversData();
        // Сотрудники, участвующие в расчете
        const activeDrivers = driversPosition.visibleEmployees();
        // Праздничная надбавка
        const holidaySurcharge = this.summaryModel.holidaySurcharge();

        // Обновление данных сотрудников (Водители)
        activeDrivers.forEach(employee => {
          const account = getRandom(0, 2000);
          const premiumAccount = getRandom(0, 2000);
          const ordersCount = getRandom(0, 2000);
          const ordersValue = getRandom(0, 2000);
          const averageBill = getRandom(0, 2000);
          const distKm = getRandom(0, 2000);
          const estimatedTime = getRandom(0, 2000);
          const actualTime = getRandom(0, 2000);
          const kpi = getRandom(0, 2000);
          const timeWithoutCase = getRandom(0, 2000);
          const time = getRandom(0, 2000);
          const orders = getRandom(0, 2000);
          const dist = getRandom(0, 2000);
          const minPayment = getRandom(0, 2000);
          const surcharge = getRandom(0, 2000);
          const lateSurcharge = getRandom(0, 2000);
          const shortShiftSurcharge = getRandom(0, 2000);
          const total = getRandom(0, 2000);
          const toPayment = getRandom(0, 2000);

          employee.account(account);
          employee.premiumAccount(premiumAccount);
          employee.ordersCount(ordersCount);
          employee.ordersValue(ordersValue);
          employee.averageBill(averageBill);
          employee.distKm(distKm);
          employee.estimatedTime(estimatedTime);
          employee.actualTime(actualTime);
          employee.kpi(kpi);
          employee.timeWithoutCase(timeWithoutCase);
          employee.time(time);
          employee.orders(orders);
          employee.dist(dist);
          employee.minPayment(minPayment);
          employee.surcharge(surcharge);
          employee.lateSurcharge(lateSurcharge);
          employee.shortShiftSurcharge(shortShiftSurcharge);
          employee.total(total);
          employee.toPayment(toPayment);
        });

        // Обновление данных позиции (Водители)
        (() => {
          const fotCategory = getRandom(0, 80);
          const fotRevenue = getRandom(0, 80);
          const performanceStandart = getRandom(-80, 0);
          const lateness = {
            light: getRandom(0, 5),
            medium: getRandom(0, 5),
            hard: getRandom(0, 5),
          };

          driversPosition.fotCategory(fotCategory);
          driversPosition.fotRevenue(fotRevenue);
          driversPosition.performanceStandart(performanceStandart);
          driversPosition.lateness(lateness);
        })();

        /** УСТАНОВКА ИТОГОВЫХ ДАННЫХ ТАБЛИЦЫ ДОЛЖНОСТЕЙ (ВОДИТЕЛИ) */
        (() => {
          const totalModel = this.summaryModel.deliveryTotal;

          // время в минутах
          const workingTime = activeDrivers.reduce((acc, p) => {
            return acc + p.workingTime();
          }, 0);

          const ordersCount = getRandom(0, 1000);
          const ordersValue = getRandom(0, 1000);
          const averageBill = getRandom(0, 1000);
          const distKm = getRandom(0, 1000);
          const estimatedTime = getRandom(0, 1000);
          const actualTime = getRandom(0, 1000);
          const kpi = getRandom(0, 1000);
          const timeWithoutCase = getRandom(0, 1000);
          const time = getRandom(0, 1000);
          const orders = getRandom(0, 1000);
          const dist = getRandom(0, 1000);
          const minPayment = getRandom(0, 1000);
          const lateSurcharge = getRandom(0, 1000);
          const shortShiftSurcharge = getRandom(0, 1000);
          const bonus = getRandom(0, 1000);
          const fine = getRandom(0, 1000);
          const total = getRandom(0, 1000);
          const toPayment = getRandom(0, 1000);

          totalModel.workingTime(workingTime);
          totalModel.ordersCount(ordersCount);
          totalModel.ordersValue(ordersValue);
          totalModel.averageBill(averageBill);
          totalModel.distKm(distKm);
          totalModel.estimatedTime(estimatedTime);
          totalModel.actualTime(actualTime);
          totalModel.kpi(kpi);
          totalModel.timeWithoutCase(timeWithoutCase);
          totalModel.time(time);
          totalModel.orders(orders);
          totalModel.dist(dist);
          totalModel.minPayment(minPayment);
          totalModel.lateSurcharge(lateSurcharge);
          totalModel.shortShiftSurcharge(shortShiftSurcharge);
          totalModel.bonus(bonus);
          totalModel.fine(fine);
          totalModel.total(total);
          totalModel.toPayment(toPayment);
        })();




        /** УСТАНОВКА ДАННЫХ ДЛЯ ПРОИЗВОДСТВЕННЫХ ПОЗИЦИЙ */

        // Позиции, участвующие в расчете
        const activePositions = this.activePositions();
        activePositions.forEach(position => {

          // нагрузка из первой таблицы
          const positionWorkload = position.workload();
          // сотрудники, участвующие в расчете
          const visibleEmployees = position.visibleEmployees();

          // Данные сотрудников
          visibleEmployees.forEach(employee => {
            const account = getRandom(0, 2000);
            const premiumAccount = getRandom(0, 2000);
            const workload = getRandom(0, 2000);
            const salaryBulk = getRandom(0, 2000);
            const revenueStandart = getRandom(0, 2000);
            const revenueStandartPerHour = getRandom(0, 2000);

            // время в минутах
            const correctedTime = getRandom(0, 2000);
            const bonusExceed = getRandom(0, 2000);
            const depremation = getRandom(0, 2000);
            const total = getRandom(0, 2000);
            const toPayment = getRandom(0, 2000);

            employee.account(account);
            employee.premiumAccount(premiumAccount);
            employee.workload(workload);
            employee.salaryBulk(salaryBulk);
            employee.revenueStandart(revenueStandart);
            employee.revenueStandartPerHour(revenueStandartPerHour);
            employee.correctedTime(correctedTime);
            employee.bonusExceed(bonusExceed);
            employee.depremation(depremation);
            employee.total(total);
            employee.toPayment(toPayment);

            if (!changedFields.includes('salary')) {
              const salary = getRandom(0, 2000);
              employee.salary(salary);
            }

            if (!changedFields.includes('normRatio')) {
              const normRatio = getRandom(0, 2000);
              employee.normRatio(normRatio);
            }

            if (!changedFields.includes('bonusRatio')) {
              const bonusRatio = getRandom(0, 2000);
              employee.bonusRatio(bonusRatio);
            }

            if (!changedFields.includes('depremationRatio')) {
              const depremationRatio = getRandom(0, 2000);
              employee.depremationRatio(depremationRatio);
            }
          });

          // данные позиции
          const fotCategory = getRandom(0, 80);
          const fotRevenue = getRandom(0, 80);
          const performanceStandart = getRandom(-80, 0);
          const lateness = {
            light: getRandom(0, 5),
            medium: getRandom(0, 5),
            hard: getRandom(0, 5),
          };

          position.fotCategory(fotCategory);
          position.fotRevenue(fotRevenue);
          position.performanceStandart(performanceStandart);
          position.lateness(lateness);
        });


        /** УСТАНОВКА ИТОГОВЫХ ДАННЫХ ТАБЛИЦЫ ДОЛЖНОСТЕЙ (ПРОИЗВОДСТВО) */
        (() => {
          const totalModel = this.summaryModel.productionTotal;

          // время в минутах
          const workingTime = activePositions.reduce((acc, p) => {
            return acc + p.workingTime();
          }, 0);

          const salaryBulk = getRandom(0, 2000);
          const normRatio = getRandom(0, 3);
          const revenueStandart = getRandom(0, 2000);
          const bonusRatio = getRandom(0, 3);
          const depremationRatio = getRandom(0, 3);

          // время в минутах
          const correctedTime = activePositions.reduce((acc, p) => {
            const employees = p.employees().filter(e => e.visible());
            return employees.reduce((acc, e) => acc + e.correctedTime(), acc);
          }, 0);

          const bonusExceed = getRandom(0, 2000);
          const total = getRandom(0, 34000);
          const toPayment = getRandom(0, 65000);

          totalModel.workingTime(workingTime);
          totalModel.salaryBulk(salaryBulk);
          totalModel.normRatio(normRatio);
          totalModel.revenueStandart(revenueStandart);
          totalModel.bonusRatio(bonusRatio);
          totalModel.depremationRatio(depremationRatio);
          totalModel.correctedTime(correctedTime);
          totalModel.bonusExceed(bonusExceed);
          totalModel.total(total);
          totalModel.toPayment(toPayment);
        })();


        /** УСТАНОВКА ДАННЫХ ТАБЛИЦЫ ОПОЗДАНИЯ */
        (() => {
          const model = this.latenessModel;

          // Оператор
          (() => {
            const position = model.operator;
            position.korf.intervals([1.5, 0.1, 2.0, 0.1, 0.1, 0.3, 1.0, 0.8, 0.6, 2.2, 0.4, 0.3]);
            position.korf.total(0.0);

            position.workload.intervals([1452.4, 911.8, 2020.0, 2759.2, 2019.5, 340.8, 1018.4, 794.7, 3325.5, 2212.9, 2443.4, 300.0]);
            position.workload.total(300.0);

            position.employees.intervals([4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 0]);

            position.ordersCount.intervals([2, 3, 7, 9, 3, 4, 5, 5, 9, 9, 5, 3, 0]);

            position.lateness.intervals([
              { light: 0, medium: 1, hard: 0 },
              { light: 2, medium: 1, hard: 0 },
              { light: 1, medium: 0, hard: 1 },
              { light: 2, medium: 1, hard: 0 },
              { light: 2, medium: 0, hard: 0 },
              { light: 1, medium: 0, hard: 0 },
              { light: 1, medium: 0, hard: 0 },
              { light: 2, medium: 1, hard: 0 },
              { light: 2, medium: 0, hard: 1 },
              { light: 1, medium: 2, hard: 0 },
              { light: 1, medium: 0, hard: 0 },
              { light: 0, medium: 0, hard: 0 },
              { light: 0, medium: 0, hard: 0 },
            ]);
          })();

          // Администратор
          (() => {
            const position = model.administrator;
            position.korf.intervals([1.5, 0.1, 2.0, 0.1, 0.1, 0.3, 1.0, 0.8, 0.6, 2.2, 0.4, 0.3]);
            position.korf.total(0.0);

            position.workload.intervals([1452.4, 911.8, 2020.0, 2759.2, 2019.5, 340.8, 1018.4, 794.7, 3325.5, 2212.9, 2443.4, 300.0]);
            position.workload.total(300.0);

            position.employees.intervals([4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 0]);

            position.ordersCount.intervals([2, 3, 7, 9, 3, 4, 5, 5, 9, 9, 5, 3, 0]);

            position.lateness.intervals([
              { light: 0, medium: 1, hard: 0 },
              { light: 2, medium: 1, hard: 0 },
              { light: 1, medium: 0, hard: 1 },
              { light: 2, medium: 1, hard: 0 },
              { light: 2, medium: 0, hard: 0 },
              { light: 1, medium: 0, hard: 0 },
              { light: 1, medium: 0, hard: 0 },
              { light: 2, medium: 1, hard: 0 },
              { light: 2, medium: 0, hard: 1 },
              { light: 1, medium: 2, hard: 0 },
              { light: 1, medium: 0, hard: 0 },
              { light: 0, medium: 0, hard: 0 },
              { light: 0, medium: 0, hard: 0 },
            ]);
          })();

          // Повар-сушист
          (() => {
            const position = model.sushiMaster;
            position.korf.intervals([1.5, 0.1, 2.0, 0.1, 0.1, 0.3, 1.0, 0.8, 0.6, 2.2, 0.4, 0.3]);
            position.korf.total(0.0);

            position.workload.intervals([1452.4, 911.8, 2020.0, 2759.2, 2019.5, 340.8, 1018.4, 794.7, 3325.5, 2212.9, 2443.4, 300.0]);
            position.workload.total(300.0);

            position.employees.intervals([4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 0]);

            position.employeesWithNorm.intervals([3.80, 3.80, 3.80, 3, 80, 3.80, 3.80, 3.80, 3.80, 3.80, 3.80, 3.80, 3.80, 0.00]);

            position.revenue.intervals([5519, 3465, 7714, 10485, 7674, 1295, 3870, 3020, 12637, 8409, 9285, 1140, 0]);

            position.lateness.intervals([
              { light: 0, medium: 1, hard: 0 },
              { light: 2, medium: 1, hard: 0 },
              { light: 1, medium: 0, hard: 1 },
              { light: 2, medium: 1, hard: 0 },
              { light: 2, medium: 0, hard: 0 },
              { light: 1, medium: 0, hard: 0 },
              { light: 1, medium: 0, hard: 0 },
              { light: 2, medium: 1, hard: 0 },
              { light: 2, medium: 0, hard: 1 },
              { light: 1, medium: 2, hard: 0 },
              { light: 1, medium: 0, hard: 0 },
              { light: 0, medium: 0, hard: 0 },
              { light: 0, medium: 0, hard: 0 },
            ]);
          })();

          // Повар-пиццемейкер
          (() => {
            // Повар-пиццемейкер (интервалы)
            const position = model.pizzaMaster;
            position.korf.intervals([1.5, 0.1, 2.0, 0.1, 0.1, 0.3, 1.0, 0.8, 0.6, 2.2, 0.4, 0.3]);
            position.korf.total(0.0);

            position.workload.intervals([1452.4, 911.8, 2020.0, 2759.2, 2019.5, 340.8, 1018.4, 794.7, 3325.5, 2212.9, 2443.4, 300.0]);
            position.workload.total(300.0);

            position.employees.intervals([4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 0]);

            position.employeesWithNorm.intervals([3.80, 3.80, 3.80, 3, 80, 3.80, 3.80, 3.80, 3.80, 3.80, 3.80, 3.80, 3.80, 0.00]);

            position.pizzaCount.intervals([20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32]);

            position.lateness.intervals([
              { light: 0, medium: 1, hard: 0 },
              { light: 2, medium: 1, hard: 0 },
              { light: 1, medium: 0, hard: 1 },
              { light: 2, medium: 1, hard: 0 },
              { light: 2, medium: 0, hard: 0 },
              { light: 1, medium: 0, hard: 0 },
              { light: 1, medium: 0, hard: 0 },
              { light: 2, medium: 1, hard: 0 },
              { light: 2, medium: 0, hard: 1 },
              { light: 1, medium: 2, hard: 0 },
              { light: 1, medium: 0, hard: 0 },
              { light: 0, medium: 0, hard: 0 },
              { light: 0, medium: 0, hard: 0 },
            ]);
          })();

          // Горячий цех
          (() => {
            // Горячий цех (интервалы)
            const position = model.hotShop;
            position.korf.intervals([1.5, 0.1, 2.0, 0.1, 0.1, 0.3, 1.0, 0.8, 0.6, 2.2, 0.4, 0.3]);
            position.korf.total(0.0);

            position.workload.intervals([1452.4, 911.8, 2020.0, 2759.2, 2019.5, 340.8, 1018.4, 794.7, 3325.5, 2212.9, 2443.4, 300.0]);
            position.workload.total(300.0);

            position.employees.intervals([4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 0]);

            position.revenue.intervals([5519, 3465, 7714, 10485, 7674, 1295, 3870, 3020, 12637, 8409, 9285, 1140, 0]);

            position.lateness.intervals([
              { light: 0, medium: 1, hard: 0 },
              { light: 2, medium: 1, hard: 0 },
              { light: 1, medium: 0, hard: 1 },
              { light: 2, medium: 1, hard: 0 },
              { light: 2, medium: 0, hard: 0 },
              { light: 1, medium: 0, hard: 0 },
              { light: 1, medium: 0, hard: 0 },
              { light: 2, medium: 1, hard: 0 },
              { light: 2, medium: 0, hard: 1 },
              { light: 1, medium: 2, hard: 0 },
              { light: 1, medium: 0, hard: 0 },
              { light: 0, medium: 0, hard: 0 },
              { light: 0, medium: 0, hard: 0 },
            ]);
          })();

          // Водитель
          (() => {
            // Водитель (интервалы)
            const position = model.driver;
            position.korf.intervals([1.5, 0.1, 2.0, 0.1, 0.1, 0.3, 1.0, 0.8, 0.6, 2.2, 0.4, 0.3]);
            position.korf.total(0.0);

            position.workload.intervals([1452.4, 911.8, 2020.0, 2759.2, 2019.5, 340.8, 1018.4, 794.7, 3325.5, 2212.9, 2443.4, 300.0]);
            position.workload.total(300.0);

            position.employees.intervals([4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 0]);

            position.ordersCount.intervals([2, 3, 7, 9, 3, 4, 5, 5, 9, 9, 5, 3, 0]);

            position.lateness.intervals([
              { light: 0, medium: 1, hard: 0 },
              { light: 2, medium: 1, hard: 0 },
              { light: 1, medium: 0, hard: 1 },
              { light: 2, medium: 1, hard: 0 },
              { light: 2, medium: 0, hard: 0 },
              { light: 1, medium: 0, hard: 0 },
              { light: 1, medium: 0, hard: 0 },
              { light: 2, medium: 1, hard: 0 },
              { light: 2, medium: 0, hard: 1 },
              { light: 1, medium: 2, hard: 0 },
              { light: 1, medium: 0, hard: 0 },
              { light: 0, medium: 0, hard: 0 },
              { light: 0, medium: 0, hard: 0 },
            ]);
          })();

        })();


        /** УСТАНОВКА ИТОГОВЫХ ДАННЫХ СВОДНОЙ ТАБЛИЦЫ */
        (() => {
          const totalModel = this.summaryModel.total;

          const workload = getRandom(0, 2000);
          const workloadUnits = 2;
          const fotCategory = getRandom(0, 2000);
          const fotRevenue = getRandom(0, 2000);
          const performanceStandart = getRandom(0, 2000);

          totalModel.workload(workload);
          totalModel.workloadUnits(workloadUnits);
          totalModel.fotCategory(fotCategory);
          totalModel.fotRevenue(fotRevenue);
          totalModel.performanceStandart(performanceStandart);
        })();
      };

      this.getData = () => {
        const positionsData = this.summaryModel.getData();
        return positionsData;
      }

      this.blockSaveButton = ko.observable(false);
      this.blockResetButton = ko.observable(false);

      this.formControlErrorStateMatcher = (formControl) => {
        return ko.pureComputed(() => {
          if (!this.isSubmitted()) return null;
          if (formControl.isValid()) return null;
          return { message: formControl.error() };
        });
      }

      this.submit = (testError) => {
        this.isSubmitted(true);

        if (this.summaryModel.isValid() && this.latenessModel.isValid()) {
          this.blockSaveButton(true);

          const data = this.getData();
          // Отправка данных
          setTimeout(() => {
            // Данные сохранены
            if (!testError) {
              this.isSubmitted(false);
              this.isNew(false);
              // Обновление данных
              this.summaryModel.save();
              this.blockSaveButton(false);
              this.showSuccessMessage(true);
              const newVersion = {
                link: '#',
                name: 'Константинопольский Константин Константинович',
                avatar: '/assets/examples/avatar.jpg',
                time: moment().format('DD.MM.YYYY HH:mm')
              };
              this.versions.unshift(newVersion);
              this.currentVersion(newVersion);
              setTimeout(() => {

                this.showSuccessMessage(false);
                this.hasChanges(false);
              }, 3000)
            } else { // Ошибка сохранения
              this.showErrorMessage(true);
              this.blockSaveButton(false);
              setTimeout(() => {
                this.showErrorMessage(false);
              }, 3000)
            }

          }, 3000);
        }
      }

      this.blocked = ko.observable(false);
      this.fadePosition = el => {
        const duration = this.blocked() ? 0 : 500;
        $(el).fadeOut(duration, () => {
          $(el).remove();
        })
      }

      this.reset = () => {
        this.blocked(true);
        this.blockResetButton(true);
        this.summaryModel.reset();
        this.calculate();
        this.hasChanges(false);
        this.blockResetButton(false);
        this.blocked(false);
      }
    };

    ViewModel.prototype.dispose = function () {
      $(window).off('resize', this.windowResizeHandler);
      this.subscriptions.forEach(s => s.dispose());
    };

    const viewModel = new ViewModel();

    ko.applyBindings(
      viewModel,
      $page.get()[0]
    );

  });
</script>

</body>

</html>