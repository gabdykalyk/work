<!DOCTYPE html>
<html class="hrm-page calculation-page hrm-page--initializing"
      data-bind="childrenComplete: childrenComplete"
      lang="ru">

<head>
  <title>Sakura</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="HandheldFriendly" content="true" />
<meta content="IE=edge" http-equiv="X-UA-Compatible" />
<link href="https://fonts.googleapis.com/css?family=Fira+Sans:100,200,300,400,500,600,700,800,900&display=swap&subset=cyrillic" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2@4.0.12/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/overlayscrollbars/1.10.2/css/OverlayScrollbars.min.css" integrity="sha256-zUBmWpj0DsZzFautKgMOtiOkT6ECQ+a6RitMns7+HRM=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://unpkg.com/tippy.js@5/dist/backdrop.css" />
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
<link rel="stylesheet" href="assets/fonts/fontawesome/css/all.css" />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.css" integrity="sha256-vZ3SaLOjnKO/gGvcUWegySoDU6ff33CS5i9ot8J9Czk=" crossorigin="anonymous" />

<link rel="stylesheet" href="assets/css/main.css" />

</head>

<body>
  <div class="hrm-scaffold">
    <div class="hrm-scaffold__sidebar"
         data-bind="component: {name: 'hrm-main-sidebar', params: {collapsed: isSidebarCollapsed}}"></div>
    <div class="hrm-scaffold__body">
      <!-- Page content  -->
      <div class="hrm-scaffold__content calculation-page__content">

        <div class="calculation-page__header">
          <span class="calculation-page__title">
            Новый расчет
          </span>
          <div class="calculation-page__actions">
            <a href="#"
               class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_tablet hrm-button-with-icon--theme_secondary hrm-button-with-arrow-left-icon">
              К списку расчетов
            </a>

          </div>
        </div>

        <div class="calculation-form">
          <!-- Input table -->
          <div data-bind="component: {name: 'calculation-page-input-form', params: { model: $root.inputModel, onSubmit: $root.buildCalculation.bind($root) }}"></div>
          <!-- /Input table -->

          <!-- ko template: {
            foreach: hrmTemplateIf(isBuilt(), $data),
            afterAdd: hrmFadeAfterAddFactory(200, 200),
            beforeRemove: hrmFadeBeforeRemoveFactory(200)
          } -->
          <div class="calculation-form__content">
            <!-- Summary table -->
            <div data-bind="component: {name: 'calculation-page-summary-table', params: { model: $root.summaryModel, settings: $root.settings }}"></div>
            <!-- /Summary table -->

            <!-- Tabs -->
              <div class="calculation-page__tabs"
                  data-bind="component: {name: 'hrm-tab-group', params: {items: tabs.tabs, activeItem: tabs.activeTab }}">
              </div>

              <script type="text/html"
        id="positions-modal-template">

  <div data-bind="component: {
      name: 'positions-modal-dialog',
      params: {
        data, modalElement,
        cancel: function () { close(); },
        submit: function ($data) {close($data);}
      }}" role="document">
  </div>

</script>

<script type="text/html"
        id="stimulation-modal-template">

  <div data-bind="component: {
      name: 'stimulation-modal-dialog',
      params: {
        data, modalElement,
        cancel: function () { close(); },
        submit: function ($data) {close($data);}
      }}" role="document">
  </div>

</script>

<script type="text/html"
        id="create-employee-modal-template">

  <div data-bind="component: {
      name: 'create-employee-modal-dialog',
      params: {
        data, modalElement,
        cancel: function () { close(); },
        submit: function ($data) {close($data);}
      }}" role="document">
  </div>

</script>

<script type="text/html"
        id="add-employees-modal-template">

  <div data-bind="component: {
      name: 'add-employees-modal-dialog',
      params: {
        data, modalElement,
        cancel: function () { close(); },
        submit: function ($data) {close($data);}
      }}" role="document">
  </div>

</script>


<!-- ko component: {name: 'hrm-modal-container', params: {opens: modalOpens}} --><!-- /ko -->


              <!-- ko template: {
                foreach: hrmTemplateIf(tabs.activeTab() === 0, $data),
                afterAdd: hrmFadeAfterAddFactory(200, 200),
                beforeRemove: hrmFadeBeforeRemoveFactory(200)
              } -->
                <div class="calculation-page__tab">
                  <!-- ko let: {'$tab': $root.settings.production, tabName: 'production'} -->
<div data-bind="component: {name: 'calculation-page-positions-table', params: { tabName: 'production', positions: $root.productionPositions, settings: $root.settings, model: $root.summaryModel }}"></div>
<!-- /ko -->

                </div>
              <!-- /ko -->

              <!-- ko template: {
                foreach: hrmTemplateIf(tabs.activeTab() === 1, $data),
                afterAdd: hrmFadeAfterAddFactory(200, 200),
                beforeRemove: hrmFadeBeforeRemoveFactory(200)
              } -->
                <div class="calculation-page__tab">
                  delivery

                </div>
              <!-- /ko -->

              <!-- ko template: {
                foreach: hrmTemplateIf(tabs.activeTab() === 2, $data),
                afterAdd: hrmFadeAfterAddFactory(200, 200),
                beforeRemove: hrmFadeBeforeRemoveFactory(200)
              } -->
                <div class="calculation-page__tab">
                  lateness

                </div>
              <!-- /ko -->
            <!-- /Tabs -->

            <div class="calculation-form__actions">
              <button class="hrm-button hrm-button--size_large hrm-basic-button calculation-form__action">
                Отменить
              </button>

              <button class="hrm-button hrm-button--size_large hrm-basic-button hrm-accent-button calculation-form__action">
                Сохранить
              </button>
            </div>
          </div>
          <!-- /ko -->
        </div>
      </div>
      <!-- /Page content  -->



    </div>
  </div>


  <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-debug.js" integrity="sha256-M5ZomNNnrnEB2WjSbnty5GWGqq6UuAAVNnWECisgEis=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/knockout.validation@2.0.4/dist/knockout.validation.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.12/js/select2.full.min.js" integrity="sha256-vucLmrjdfi9YwjGY/3CQ7HnccFSS/XRS1M/3k/FDXJw=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.10/js/i18n/ru.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/simplebar/5.1.0/simplebar.min.js" integrity="sha256-hFddD6XMIwFba4ITQjpv5WWE557w6O0w9RRfmGjIz4k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/overlayscrollbars/1.10.2/js/OverlayScrollbars.min.js" integrity="sha256-5Tj3ZUgjHEGwF7TxpOgbPpjhq+WxXvpfb+qr9OxRHtY=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/overlayscrollbars/1.10.2/js/jquery.overlayScrollbars.min.js" integrity="sha256-RE+oy7ofA6XerySMpTlDcg0gFUwHN3n0qQ5fUIZVq/M=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/gh/RobinHerbots/jquery.inputmask@4.0.9/dist/jquery.inputmask.bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment-with-locales.min.js" integrity="sha256-AdQN98MVZs44Eq2yTwtoKufhnU+uZ7v2kXnD5vqzZVo=" crossorigin="anonymous"></script>
<script src="https://unpkg.com/popper.js@1"></script>
<script src="https://unpkg.com/tippy.js@5"></script>
<script src="https://unpkg.com/sticky-events@3.1.1/dist/sticky-events.umd.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min.js" integrity="sha256-VeNaFBVDhoX3H+gJ37DpT/nTuZTdjYro9yBruHjVmoQ=" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.js" integrity="sha256-id5Qk/MwQJxgNlDFDpVymUuReXfTUZiaQKb8arrddQM=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/mode/xml/xml.min.js" integrity="sha256-Lfk8z6WUsBN6YiCaMpH6bxBHyRqkPK4O2QbQHFNUS40=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/autoresize-textarea@1.1.3/src/autoresize-textarea.min.js"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

<script src="assets/js/main.js"></script>

  <template id="calculation-page-input-form-template">
  <div class="calculation-input-form">
    <div class="calculation-input-form__header">

      <!-- Filial select -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null)} -->
      <div class="calculation-input-form__field calculation-input-form__filial"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">
          Филиал
        </label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <select data-bind="value: filial,
                    options: filialsList,
                    optionsText: 'name',
                    optionsValue: 'id',
                    hrmSelect,
                    hrmFormFieldSelectControl: control,
                    hrmFormFieldSelectControlErrorStateMatcher: formControlErrorStateMatcher">
          </select>
        </div>

        <div data-bind="component: {name: 'hrm-form-field-error'},
                      hrmSlide,
                      hrmSlideValue: control() !== null ? control().errorState : false,
                      hrmSlideDuration: 150">
          <!-- ko text: $parent.filial.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /Filial select -->

      <!-- Date select -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null)} -->
      <div class="calculation-input-form__field calculation-input-form__date"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">Расчёт на дату</label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <input data-bind="textInput: date,
                        hrmDatepicker,
                        hrmFormFieldDatepickerControl: control,
                        hrmFormFieldDatepickerControlErrorStateMatcher: formControlErrorStateMatcher" />

          <i class="hrm-form-field__suffix hrm-form-field-icon hrm-form-field-calendar-icon"></i>
        </div>

        <div data-bind="component: {name: 'hrm-form-field-error'},
                      hrmSlide,
                      hrmSlideValue: control() !== null ? control().errorState : false,
                      hrmSlideDuration: 150">
          <!-- ko text: $parent.date.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /Date select -->

      <!-- Shift block -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null)} -->
      <div class="calculation-input-form__field calculation-input-form__shift"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label class=""
               data-bind="hrmFormFieldLabel: label">
          Смена
        </label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <select data-bind="value: shift,
                options: shiftsList,
                optionsText: 'name',
                optionsValue: 'id',
                hrmSelect,
                hrmFormFieldSelectControl: control,
                hrmFormFieldSelectControlErrorStateMatcher: formControlErrorStateMatcher">
          </select>
        </div>

        <div data-bind="component: {name: 'hrm-form-field-error'},
                hrmSlide,
                hrmSlideValue: control() !== null ? control().errorState : false,
                hrmSlideDuration: 150">
          <!-- ko text: $parent.shift.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /Shift select -->

      <!-- Interval select -->
      <!-- ko let: {control: ko.observable(null)} -->
      <div class="calculation-input-form__field calculation-input-form__interval"
           data-bind="hrmFormField, hrmFormFieldControlRef: control">

        <div class="calculation-input-form__interval-controls"
             data-bind="hrmFormFieldComplexControl: control">

          <!-- ko let: {control: ko.observable(null)} -->
          <div class="calculation-input-form__interval-control"
               data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
            <input data-bind="value: interval.start,
                            hrmTimeAutocompleter,
                            hrmMask,
                            hrmMaskPattern: 'datetime',
                            hrmMaskOptions: {
                                inputFormat: 'HH:MM',
                                placeholder: ' '
                            },
                            hrmFormFieldInputControl: control,
                            hrmFormFieldInputControlErrorStateMatcher: formControlErrorStateMatcher"
                   placeholder="00:00">
          </div>

          <!-- /ko -->

          <span class="calculation-input-form__interval-separator">-</span>

          <!-- ko let: {control: ko.observable(null)} -->
          <div class="calculation-input-form__interval-control"
               data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
            <input data-bind="value: interval.end,
                            hrmTimeAutocompleter,
                            hrmMask,
                            hrmMaskPattern: 'datetime',
                            hrmMaskOptions: {
                                inputFormat: 'HH:MM',
                                placeholder: ' '
                            },
                            hrmFormFieldInputControl: control,
                            hrmFormFieldInputControlErrorStateMatcher: formControlErrorStateMatcher"
                   placeholder="00:00">
          </div>
          <!-- /ko -->

        </div><!-- .calculation-input__interval-controls -->

        <div data-bind="component: {name: 'hrm-form-field-error'},
                      hrmSlide,
                      hrmSlideValue: !interval.isCorrect(),
                      hrmSlideDuration: 150">
          <!-- ko text: 'Некорректно задан интервал' -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /Interval select -->
      <!-- /Shift block -->


      <div class="calculation-input-form__field calculation-input-form__actions">
        <button class="hrm-button hrm-button--size_large hrm-basic-button hrm-accent-button calculation-input-form__action"
                data-bind="click: $root.buildCalculation, enable: isValid">
          Рассчитать
        </button>

        <button class="hrm-button hrm-button--size_large hrm-basic-button calculation-input-form__action">
          На сейчас
        </button>
      </div>


    </div><!-- .calculaton-form__header -->
  </div>

</template>


<script type="text/javascript">
  $(function () {
    /** Список филиалов */
    const filialsList = [
      {
        id: 1,
        name: 'Филиал 1'
      },
      {
        id: 2,
        name: 'Филиал 2'
      },
      {
        id: 3,
        name: 'Филиал 12345'
      },
      {
        id: 4,
        name: 'Филиал 4'
      },
    ];

    /** Список смен */
    const shifts = [
      {
        id: 'day',
        name: 'Дневная',
        start: '11:00',
        end: '23:00',
      }, {
        id: 'night',
        name: 'Ночная',
        start: '23:00',
        end: '11:00'
      }
    ];

    /** Получить объект смены по ее id */
    function getShift(value) {
      return shifts.find(shift => shift.id === value);
    }

    /** Модель интервала времени */
    function createIntervalModel(data, needCheck) {
      const start = data.start;
      const end = data.end;

      const correct = ko.pureComputed(() => {
        const endMoment = moment(end(), 'HH:mm');
        const startMoment = moment(start(), 'HH:mm');
        if (!needCheck()) return true;
        return endMoment.isAfter(startMoment);
      });

      start.extend({
        required: {
          message: 'Обязательное поле'
        },
        hrmDate: {
          params: 'HH:mm',
          message: 'Неверный формат времени'
        },
        validation: { validator: () => correct() }
      });

      end.extend({
        required: {
          message: 'Обязательное поле'
        },
        hrmDate: {
          params: 'HH:mm',
          message: 'Неверный формат времени'
        },
        validation: { validator: () => correct() }
      });

      return {
        start,
        end,
        isCorrect: correct
      };
    }


    ko.components.register('calculation-page-input-form', {
      viewModel: {
        createViewModel: function (params, componentInfo) {
          const model = params.model;

          const filial = model.filial.extend({
            required: {
              message: 'Обязательное поле'
            }
          });

          const date = model.date.extend({
            required: {
              message: 'Обязательное поле'
            },
            hrmDate: {
              params: 'DD.MM.YYYY, dddd',
              message: 'Неверный формат даты'
            }
          });

          const shift = model.shift.extend({
            required: {
              message: 'Обязательное поле'
            }
          });
          shift(shifts[0].value);
          const needCheck = ['day'];
          const changeShift = ko.observable(false);

          const start = model.interval.start;
          const end = model.interval.end;
          start(shifts[0].start);
          end(shifts[0].end);
          const interval = createIntervalModel({
            start: start,
            end: end,
          }, () => {
            return !changeShift() && needCheck.indexOf(shift()) !== -1;
          });

          shift.subscribe((value) => {
            changeShift(true);

            const shiftData = getShift(value);
            if (shiftData) {
              interval.start(shiftData.start);
              interval.end(shiftData.end);
            }

            changeShift(0);
          });

          const isValid = ko.pureComputed(() => {
            return date.isValid() && interval.isCorrect();
          }, this);

          return {
            filial,
            filialsList,

            date,

            shift,
            shiftsList: shifts,

            interval,
            isValid,

            formControlErrorStateMatcher: function (formControl) {
              return ko.pureComputed(() => {
                return !formControl.isValid();
              });
            }
          };
        }
      },

      template: {
        element: 'calculation-page-input-form-template'
      }
    })
  })
</script>

  <script type="text/html"
        id="position-row-template">
  <tr class="calculation-summary__row" data-bind="hrmLog">
    <!-- Должность -->
    <td class="calculation-summary__cell calculation-summary__cell--job">
      <div class="calculation-summary__cell-content"
           data-bind="text: position.name"></div>
    </td>

    <!-- Тип нагрузки -->
    <td class="calculation-summary__cell calculation-summary__cell--workload-type">
      <div class="calculation-summary__cell-content"
           data-bind="text: position.workloadType"></div>
    </td>

    <!-- Нагрузка -->
    <td class="calculation-summary__cell calculation-summary__cell--workload">
      <div class="calculation-summary__cell-content">
        <div class="position-workload">
          <div class="position-workload__value" data-bind="text: position.workload"></div>
          <div class="position-workload__units" data-bind="text: position.units"></div>
        </div>
      </div>

    </td>

    <!-- Доп. нагрузка -->
    <td class="calculation-summary__cell calculation-summary__cell--additional-workload">
      <div class="calculation-summary__cell-content"
           data-bind="text: position.additionalWorkload"></div>
    </td>

    <!-- Сотрудники -->
    <td class="calculation-summary__cell calculation-summary__cell--count">
      <div class="calculation-summary__cell-content"
           data-bind="text: ko.isObservable(position.employees) ? position.employees().length : position.employees"></div>
    </td>

    <!-- ФОТ, % в категории -->
    <td class="calculation-summary__cell calculation-summary__cell--fot-category">
      <div class="calculation-summary__cell-content"
           data-bind="text: position.fotCategory"></div>
    </td>

    <!-- ФОТ, % от выручки -->
    <td class="calculation-summary__cell calculation-summary__cell--fot-revenue" >
      <div class="calculation-summary__cell-content"
           data-bind="text: position.fotRevenue"></div>
    </td>

    <!-- Норм. выработки -->
    <td class="calculation-summary__cell calculation-summary__cell--performance-standart">
      <div class="calculation-summary__cell-content"
           data-bind="text: position.performanceStandart"></div>
    </td>

    <!-- Опоздания -->
    <td class="calculation-summary__cell calculation-summary__cell--lateness">
      <div class="calculation-summary__cell-content">
        <!-- ko template: { name: 'lateness-template', data: {lateness: position.lateness} } -->
        <!-- /ko -->
      </div>
    </td>
  </tr>

</script>

<script type="text/html"
        id="lateness-template">
<div class="lateness">
  <div class="lateness__cell"></div>
  <div class="lateness__cell"></div>
  <div class="lateness__cell"></div>
  <div class="lateness__cell"></div>
</div>
</script>

<template id="calculation-page-summary-table-template">

  <div class="calculation-summary"
       data-bind="let: {table: $component}">

    <!-- ko if: viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
    <div data-bind="component: {
      name: 'hrm-scrollable-wrapper',
      params: { options: {left: {disabled: true}} }
     }">
      <table class="calculation-summary__table calculation-summary__desktop"
             data-bind="hrmTable">

        <thead>
          <tr class="calculation-summary__row">
            <!-- ko foreach: { data: table.columns, as: 'column' } -->
            <th class="calculation-summary__cell calculation-summary__head-cell"
                data-bind="class: 'calculation-summary__cell--' + column.id">
              <div class="calculation-summary__cell-content">
                <span data-bind="text: column.title"></span>
                <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-table__head-cell-info-button  calculation-summary__info-icon"
                        data-bind="hrmTooltip, hrmTooltipText: column.fullTitle"></button>
              </div>
            </th>
            <!-- /ko -->
          </tr>
        </thead>

        <tbody>
          <!-- ko foreach: table.positions -->
          <!-- ko template: {name: 'position-row-template', data: {position: $data}} -->
          <!-- /ko -->
          <!-- /ko -->

          <tr class="calculation-summary__row calculation-summary__row--total">
            <!-- ko foreach: { data: table.columns, as: 'column' } -->
            <td class="calculation-summary__cell"
                data-bind="css: {'calculation-summary__cell--empty': !column.hasTotal }">
              <!-- ko if: column.hasTotal -->
              <div class="calculation-summary__cell-content"
                   data-bind="text: column.total">
              </div>
              <!-- /ko -->
            </td>
            <!-- /ko -->
          </tr>

        </tbody>
      </table>
    </div>
    <!-- /ko -->

    <!-- ko ifnot: viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
    <div class="hrm-table__fixed-section-container">

      <table class="hrm-table__fixed-section hrm-table__fixed-section--position_left calculation-summary__table calculation-summary__fixed"
             data-bind="hrmTable">
        <tbody>
          <!-- ko foreach: { data: table.columns, as: 'column' } -->
          <tr class="calculation-form__row">
            <th class="calculation-summary__cell calculation-summary__head-cell"
                data-bind="class: 'calculation-summary__cell--' + column.id">
              <div class="calculation-summary__cell-content"
                   data-bind="text: column.title"></div>
            </th>
          </tr>
          <!-- /ko -->
        </tbody>
      </table>


      <div data-bind="component: {
                     name: 'hrm-scrollable-wrapper',
                     params: { options: {left: {disabled: true}} }
                    }">
        <table class=" calculation-summary__table calculation-summary__mobile"
               data-bind="hrmTable">
          <tbody>
            <tr class="calculation-summary__row calculation-summary__row--job">
              <th class="calculation-summary__cell calculation-summary__head-cell calculation-summary__cell--job">
                <div class="calculation-summary__cell-content">
                  Должность
                </div>
              </th>

              <!-- ko foreach: table.positions -->
              <td class="calculation-summary__cell calculation-summary__cell--job">
                <div class="calculation-summary__cell-content"
                     data-bind="text: name"></div>
              </td>
              <!-- /ko -->

              <td class="calculation-summary__cell  calculation-summary__cell--job calculation-summary__cell--total">
                <div class="calculation-summary__cell-content">Итого</div>
              </td>
            </tr>

            <tr class="calculation-summary__row calculation-summary__row--workload-type">
              <th
                  class="calculation-summary__cell calculation-summary__head-cell calculation-summary__cell--workload-type">
                <div class="calculation-summary__cell-content">
                  Тип нагрузки
                </div>
              </th>

              <!-- ko foreach: table.positions -->
              <td class="calculation-summary__cell calculation-summary__cell--workload-type">
                <div class="calculation-summary__cell-content"
                     data-bind="text: workloadType"></div>
              </td>
              <!-- /ko -->

              <td
                  class="calculation-summary__cell calculation-summary__cell--workload-type  calculation-summary__cell--total">
                <div class="calculation-summary__cell-content"
                     data-bind="text: table.total().workloadType"></div>
              </td>
            </tr>

            <tr class="calculation-summary__row calculation-summary__row--workload">
              <th class="calculation-summary__cell  calculation-summary__head-cell calculation-summary__cell--workload">
                <div class="calculation-summary__cell-content">
                  Нагрузка
                </div>
              </th>

              <!-- ko foreach: table.positions -->
              <td class="calculation-summary__cell calculation-summary__cell--workload">
                <div class="position-workload">

                  <div class="position-workload__value"
                       data-bind="text: workload"></div>
                  <div class="position-workload__units"
                       data-bind="text: units"></div>

                </div>
              </td>
              <!-- /ko -->

              <td
                  class="calculation-summary__cell calculation-summary__cell--workload  calculation-summary__cell--total">
                <div class="calculation-summary__cell-content"
                     data-bind="text: table.total().workload"></div>
              </td>
            </tr>

            <tr class="calculation-summary__row calculation-summary__row--additional-workload">
              <th
                  class="calculation-summary__cell  calculation-summary__head-cell calculation-summary__cell--additional-wokload">
                <div class="calculation-summary__cell-content">
                  Доп. нагрузка
                </div>
              </th>

              <!-- ko foreach: table.positions -->
              <td class="calculation-summary__cell calculation-summary__cell--additional-wokload">
                <div class="calculation-summary__cell-content"
                     data-bind="text: additionalWorkload"></div>
              </td>
              <!-- /ko -->

              <td
                  class="calculation-summary__cell calculation-summary__cell--additional-wokload  calculation-summary__cell--total">
                <div class="calculation-summary__cell-content"
                     data-bind="text: table.total().additionalWorkload"></div>
              </td>
            </tr>

            <tr class="calculation-summary__row calculation-summary__row--count">
              <th class="calculation-summary__cell  calculation-summary__head-cell calculation-summary__cell--count">
                <div class="calculation-summary__cell-content">
                  Сотрудники
                </div>
              </th>

              <!-- ko foreach: table.positions -->
              <td class="calculation-summary__cell calculation-summary__cell--count">
                <div class="calculation-summary__cell-content"
                     data-bind="text: employees.length"></div>
              </td>
              <!-- /ko -->

              <td class="calculation-summary__cell calculation-summary__cell--count  calculation-summary__cell--total">
                <div class="calculation-summary__cell-content"
                     data-bind="text: table.total().employees.length"></div>
              </td>
            </tr>

            <tr class="calculation-summary__row calculation-summary__row--fot-category">
              <th
                  class="calculation-summary__cell  calculation-summary__head-cell calculation-summary__cell--fot-category">
                <div class="calculation-summary__cell-content">
                  ФОТ, % в категории
                </div>
              </th>

              <!-- ko foreach: table.positions -->
              <td class="calculation-summary__cell calculation-summary__cell--fot-category">
                <div class="calculation-summary__cell-content"
                     data-bind="text: fotCategory"></div>
              </td>
              <!-- /ko -->

              <td
                  class="calculation-summary__cell  calculation-summary__cell--fot-category calculation-summary__cell--total">
                <div class="calculation-summary__cell-content"
                     data-bind="text: table.total().fotCategory"></div>
              </td>
            </tr>

            <tr class="calculation-summary__row calculation-summary__row--fot-revenue">
              <th
                  class="calculation-summary__cell  calculation-summary__head-cell calculation-summary__cell--fot-revenue">
                <div class="calculation-summary__cell-content">
                  ФОТ, % от выручки
                </div>
              </th>

              <!-- ko foreach: table.positions -->
              <td class="calculation-summary__cell calculation-summary__cell--fot-revenue">
                <div class="calculation-summary__cell-content"
                     data-bind="text: fotRevenue"></div>
              </td>
              <!-- /ko -->

              <td
                  class="calculation-summary__cell calculation-summary__cell--fot-revenue  calculation-summary__cell--total">
                <div class="calculation-summary__cell-content"
                     data-bind="text: table.total().fotRevenue"></div>
              </td>
            </tr>

            <tr class="calculation-summary__row calculation-summary__row--performance-standart">
              <th
                  class="calculation-summary__cell  calculation-summary__head-cell calculation-summary__cell--performance-standart">
                <div class="calculation-summary__cell-content">
                  Норм. выр-ки, %
                </div>
              </th>

              <!-- ko foreach: table.positions -->
              <td class="calculation-summary__cell calculation-summary__cell--performance-standart">
                <div class="calculation-summary__cell-content"
                     data-bind="text: fotRevenue"></div>
              </td>
              <!-- /ko -->

              <td
                  class="calculation-summary__cell calculation-summary__cell--performance-standart  calculation-summary__cell--total">
                <div class="calculation-summary__cell-content"
                     data-bind="text: table.total().performanceStandart"></div>
              </td>
            </tr>

            <tr class="calculation-summary__row calculation-summary__row--lateness">
              <th class="calculation-summary__cell  calculation-summary__head-cell calculation-summary__cell--lateness">
                <div class="calculation-summary__cell-content">
                  Опоздания
                </div>
              </th>

              <!-- ko foreach: table.positions -->
              <td class="calculation-summary__cell calculation-summary__cell--lateness">
                <!-- ko template: { name: 'lateness-template', data: {lateness: $data.lateness} } -->
                <!-- /ko -->
              </td>
              <!-- /ko -->

              <td class="calculation-summary__cell calculation-summary__cell--lateness   calculation-summary__cell--total">
                <div class="calculation-summary__cell-content">
                  <!-- ko template: { name: 'lateness-template', data: {lateness: $data.lateness} } -->
                  <!-- /ko -->
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <!-- /ko -->
  </div>
</template>


<script type="text/javascript">
  $(function () {
    function Column(id, title, fullTitle, total) {

      return {
        id,
        title,
        fullTitle,
        hasTotal: !!total,
        total
      }
    }



    ko.components.register('calculation-page-summary-table', {
      viewModel: {
        createViewModel: function (params, componentInfo) {
          const model = params.model;
          const positions = model.positions;

          const total = ko.pureComputed(() => {
            return positions().reduce((acc, p) => {
              p = p();
              return {
                name: '',
                workload: (acc.workload || 0) + p.workload,
                workloadType: '',
                units: '',
                additionalWorkload: '',
                fotCategory: 100,
                fotRevenue: 100,
                performanceStandart: -100,
                lateness: {
                  green: 0,
                  yellow: 0,
                  red: 0
                },
                employees: (acc.employees || 0) + p.employees().length
              }
            }, {})
          });

          const columns = [
            Column('job', 'Должность', 'Должность'),
            Column('workload-type', 'Тип нагрузки', 'Тип нагрузки'),
            Column('workload', 'Нагрузка', 'Нагрузка'),
            Column('additional-workload', 'Доп. нагрузка', 'Дополнительная нагрузка'),
            Column('count', 'Сотр.', 'Сотрудники'),
            Column('fot-category', 'ФОТ, % в категории', 'ФОТ, % в категории'),
            Column('fot-revenue', 'ФОТ, % от выручки', 'ФОТ, % от выручки'),
            Column('performance-standart', 'Норм. выр-ки, %', 'Норма выработки, %'),
            Column('lateness', 'Опоздания', 'Опоздания'),
          ];

          return {
            viewportSize: params.settings.viewportSize,
            positions,
            total,
            columns
          };
        }
      },
      template: {
        element: document.getElementById('calculation-page-summary-table-template')
      }
    });
  })
</script>

  <!-- Выпадающее меню сотрудников -->
<script id="employees-dropdown-template"
        type="text/html">
        <div class="hrm-dropdown-menu__item" data-bind="click: addEmployees">Добавить сотрудников</div>
        <div class="hrm-dropdown-menu__item" data-bind="click: createEmployee">Новый сотрудник</div>
</script>

<!-- Заголовок позиции в таблице -->
<script id="position-header-template"
        type="text/html">
  <button data-bind="hrmTooltip, hrmTooltipText: 'Добавить сотрудников', click: table.addEmployeesInPosition"
    class="positions-table__add-employee hrm-button hrm-circle-icon-button hrm-circle-plus-icon-button hrm-circle-icon-button--theme_neutral positions-table__action">
  </button>
  <span data-bind="text: name"></span>
</script>

<!-- Блок сотрудника в таблице -->
<script id="employee-block-template"
        type="text/html">
  <div class="employee">
    <div class="employee__remove">
      <button data-bind="
      hrmTooltip,
      hrmTooltipText: 'Удалить из расчета',
      click: function(a) { employee.visible(false) }"
              class="hrm-button hrm-circle-icon-button hrm-circle-times-icon-button hrm-circle-icon-button--theme_secondary positions-table__action employe__remove-button">
      </button>
    </div>

    <div class="employee__info">
      <a class="employee__name"
        href="#"
        data-bind="text: employee.name"></a>
      <!-- ko if: position -->
        <div class="employee__position" data-bind="text: position"></div>
      <!-- /ko -->
    </div>

    <div class="employee__actions">
      <button
              class="hrm-button hrm-icon-button hrm-icon-button--theme_negative hrm-sheet-icon-button employee__action employee__action--documents" data-bind="hrmTooltip, hrmTooltipText: 'Есть проблемы с документами'"></button>
      <button
              class="hrm-button hrm-icon-button hrm-icon-button--theme_negative hrm-arrow-down-icon-button employee__action employee__action--down" data-bind="hrmTooltip, hrmTooltipText: 'Рекомендуется понижение разряда'"></button>
      <!-- ko if: false -->
      <button
              class="hrm-button hrm-icon-button hrm-icon-button--theme_negative hrm-arrow-up-icon-button employee__action employee__action--up" data-bind="hrmTooltip, hrmTooltipText: 'Рекомендуется повышение разряда'"></button>
      <!-- /ko -->

    </div>
  </div>
</script>


<template id="calculation-page-positions-table-template">
  <div class="calculation-tab"
       data-bind="class: 'calculation-' + tabName">

    <div class="calculation-tab__settings">
      <div class="calculation-tab__settings-group">
        <!-- ko if: viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
        <!-- Сотрудники -->
        <button class="hrm-button hrm-button-with-icon-right hrm-button-with-arrow-down-icon-right hrm-button-with-icon--theme_secondary calculation-tab__settings-button calculation-tab__settings-employees"
                data-bind="hrmDropdownMenu, hrmDropdownMenuTemplate: 'employees-dropdown-template'">
          Сотрудники
        </button>

        <!-- Должности -->
        <button class="hrm-button hrm-basic-button hrm-button--size_medium  calculation-tab__settings-button calculation-tab__settings-positions"
                data-bind="click: setPositions">
          Должности
        </button>

        <!-- Штраф/премия -->
        <button class="hrm-button hrm-basic-button hrm-button--size_medium  calculation-tab__settings-button calculation-tab__settings-stimulation"
                data-bind="click: $root.stimulation.set">
          Штраф/премия смене
        </button>
        <!-- /ko -->

        <!-- ko ifnot: viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
        <!-- Сотрудники -->
        <button class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_desktop hrm-button-with-person-icon hrm-button-with-icon--theme_secondary  calculation-tab__settings-button calculation-tab__settings-employees"
                data-bind="hrmDropdownMenu, hrmDropdownMenuTemplate: 'employees-dropdown-template'"></button>

        <!-- Должности -->
        <button class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_desktop hrm-button-with-badge-icon hrm-button-with-icon--theme_secondary  calculation-tab__settings-button calculation-tab__settings-positions"
                data-bind="click: setPositions"></button>

        <!-- Штраф/премия -->
        <button data-bind="click: $root.stimulation.set"
                class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_desktop hrm-button-with-money-icon hrm-button-with-icon--theme_secondary  calculation-tab__settings-button calculation-tab__settings-stimulation"></button>
        <!-- /ko -->
      </div><!-- .calculation-tab__settings-group -->
      <div class="calculation-tab__settings-group">
        <!-- Столбцы -->
        <button
                class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_tablet hrm-button-with-icon--theme_secondary hrm-button-with-settings-icon templates__button-with-icon calculation-tab__settings-button calculation-tab__settings-columns">
          Настроить столбцы
        </button>

        <!-- Меньше информации -->
        <button
                class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_tablet hrm-button-with-icon--theme_secondary hrm-button-with-less-icon templates__button-with-icon  calculation-tab__settings-button calculation-tab__settings-less-info">
          Меньше информации
        </button>

        <!-- Больше информации -->
        <button
                class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_tablet hrm-button-with-icon--theme_secondary hrm-button-with-more-icon templates__button-with-icon hrm-button-with-icon--hide_tablet  calculation-tab__settings-button calculation-tab__settings-more-info">
          Больше информации
        </button>
      </div><!-- .calculation-tab__settings-group -->
    </div><!-- .calculation-tab__settings -->

    <div class="hrm-table__fixed-section-container positions-table"
         data-bind="let: {table: $data}">
      <!-- Fixed section -->
      <!-- ko ifnot: viewportSize().width > HRM_BREAKPOINTS.tabletMaxWidth -->
      <table data-bind="hrmTable"
             class="hrm-table__fixed-section hrm-table__fixed-section--position_left positions-table__fixed-section">
        <thead>
          <tr class="positions-table__row positions-table__head-row">
            <th class="positions-table__cell positions-table__head-cell">
              <div class="positions-table__cell-content">Сотрудник</div>
            </th>
          </tr>
        </thead>
        <tbody>
          <!-- ko foreach: { data: table.positions, as: 'position' } -->

          <!-- Блок позиции -->
          <!-- ko if: position.visible -->
          <!-- Заголовок позиции -->
          <tr class="positions-table__row positions-table__row--highlighted positions-table__section-header">
            <td class="positions-table__cell positions-table__position-title">
              <div class="positions-table__cell-content">
                <div data-bind="template: {name: 'position-header-template', data: position}"></div>
              </div>
            </td>
          </tr>
          <!-- /Заголовок позиции -->

          <!-- Список сотрудников по позиции -->
          <!-- ko foreach: { data: position.employees, as: 'employee' } -->
          <!-- ko template: {
              foreach: hrmTemplateIf(employee.visible(), $data),
              beforeRemove: hrmFadeBeforeRemoveFactory(500)
          } -->
          <tr class="positions-table__row">
            <td class="positions-table__cell">
              <div class="positions-table__cell-content">

                <!-- Данные сотрудника -->
                <div
                     data-bind="template: { name: 'employee-block-template', data: {employee: employee, position: false} }">
                </div>
                <!-- /Данные сотрудника -->

              </div>

            </td>
          </tr>
          <!-- /ko -->
          <!-- /ko -->
          <!-- /Список сотрудников по позиции -->
          <!-- /ko -->
          <!-- /Блок позиции -->

          <!-- /ko -->

          <!-- Блок Прочее -->
          <!-- ko if: table.hasOtherSection -->
          <tr class="positions-table__row positions-table__row--highlighted positions-table__section-header">
            <td class="positions-table__cell positions-table__position-title">
              <div class="positions-table__cell-content">
                <div data-bind="template: {name: 'position-header-template', data: {name: 'Прочее'}}"></div>
              </div>
            </td>
          </tr>

          <!-- Список сотрудников по остальным позициям -->
          <!-- ko foreach: { data: table.positions, as: 'position' } -->
          <!-- ko ifnot: position.visible -->
          <!-- ko foreach: { data: position.employees, as: 'employee' } -->
          <!-- ko template: {
              foreach: hrmTemplateIf(employee.visible(), $data),
              beforeRemove: hrmFadeBeforeRemoveFactory(500)
          } -->
          <tr class="positions-table__row">
            <td class="positions-table__cell">
              <div class="positions-table__cell-content">

                <!-- Данные сотрудника -->
                <div
                     data-bind="template: { name: 'employee-block-template', data: {employee: employee, position: position.name} }">
                </div>
                <!-- /Данные сотрудника -->

              </div>
            </td>
          </tr>
          <!-- /ko -->
          <!-- /ko -->
          <!-- /ko -->
          <!-- /ko -->
          <!-- /Список сотрудников по остальным позициям -->
          <!-- /ko -->
          <!-- /Блок Прочее -->


          <!-- Total section -->
          <tr class="positions-table__row positions-table__row--highlighted positions-table__total">
            <td class="positions-table__cell">
              <div class="positions-table__cell-content"></div>
            </td>
          </tr>
          <!-- /Total section -->
        </tbody>
      </table>
      <!-- /ko -->
      <!-- /Fixed section -->


      <div data-bind="component: { name: 'hrm-scrollable-wrapper', params: { options: {left: {disabled: true}} }}">
        <table data-bind="hrmTable"
               class="positions-table__main-table">

          <colgroup>
            <col class="positions-table__col positions-table__col--name">
            <!-- ko foreach: table.columns -->
            <col class="positions-table__col"
                 data-bind="class: 'position-table__col--' + id">
            <!-- /ko -->
            <col class="positions-table__col positions-table__col--total">
            <col class="positions-table__col positions-table__col--payment">
          </colgroup>

          <thead>
            <tr class="positions-table__row positions-table__head-row">
              <th class="positions-table__cell positions-table__head-cell positions-table__cell--name">
                <div class="positions-table__cell-content">Сотрудник</div>
              </th>

              <!-- ko foreach: table.columns -->
              <th class="positions-table__cell positions-table__head-cell"
                  data-bind="class: 'positions-table__cell--' + id">
                <div class="positions-table__cell-content">
                  <span data-bind="text: title"></span>
                  <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-table__head-cell-info-button positions-table__info-icon"
                          data-bind="hrmTooltip, hrmTooltipText: fullTitle"></button>
                </div>
              </th>
              <!-- /ko -->

              <th
                  class="positions-table__cell positions-table__head-cell positions-table__cell--total positions-table__cell--colored">
                <div class="positions-table__cell-content">
                  <span>Всего начислено, ₽</span>
                  <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-table__head-cell-info-button positions-table__info-icon"
                          data-bind="hrmTooltip, hrmTooltipText: 'Всего начислено'"></button>
                </div>
              </th>

              <th
                  class="positions-table__cell positions-table__head-cell positions-table__cell--payment positions-table__cell--colored">
                <div class="positions-table__cell-content">
                  <span>К выплате, ₽</span>
                  <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral hrm-table__head-cell-info-button positions-table__info-icon"
                          data-bind="hrmTooltip, hrmTooltipText: 'К выплате'"></button>
                </div>
              </th>
            </tr>
          </thead>

          <tbody>
            <!-- Блок позиции -->
            <!-- ko foreach: { data: table.positions, as: 'position' } -->
            <!-- Название позиции -->
            <!-- ko if: position.visible -->
            <tr class="positions-table__row positions-table__row--highlighted positions-table__section-header">
              <td class="positions-table__cell positions-table__position-title"
                  data-bind="attr: {colspan: $parent.columnCount}">

                <div class="positions-table__cell-content">
                  <div data-bind="template: {name: 'position-header-template', data: position}"></div>
                </div>
              </td>
            </tr>
            <!-- /Название позиции -->

            <!-- Список сотрудников по позиции -->
            <!-- ko foreach: position.employees -->
            <!-- ko template: {
              foreach: hrmTemplateIf($data.visible(), $data),
              beforeRemove: hrmFadeBeforeRemoveFactory(500)
          } -->
            <tr class="positions-table__row">
              <td class="positions-table__cell positions-table__cell--name">
                <div class="positions-table__cell-content">

                  <!-- Данные сотрудника -->
                  <div
                       data-bind="template: { name: 'employee-block-template', data: {employee: $data, position: false} }">
                  </div>
                  <!-- /Данные сотрудника -->

                </div>
              </td>

              <!-- ko foreach: table.columns -->
              <td class="positions-table__cell"
                  data-bind="class: 'positions-table__cell--' + id"></td>
              <!-- /ko -->

              <td class="positions-table__cell  positions-table__cell--total positions-table__cell--colored"></td>
              <td class="positions-table__cell  positions-table__cell--payment positions-table__cell--colored"></td>
            </tr>
            <!-- /ko -->
            <!-- /ko -->
            <!-- Список сотрудников по позиции -->

            <!-- /ko -->
            <!-- /ko -->
            <!-- /Блок позиции -->

            <!-- Блок Прочее -->
            <!-- ko if: table.hasOtherSection -->
            <tr class="positions-table__row positions-table__row--highlighted positions-table__section-header">
              <td class="positions-table__cell  positions-table__position-title"
                  data-bind="attr: {colspan: columnCount}">
                <div class="positions-table__cell-content">
                  <div data-bind="template: {name: 'position-header-template', data: {name: 'Прочее'}}"></div>
                </div>
              </td>
            </tr>

            <!-- ko foreach: { data: table.positions, as: 'position' } -->
            <!-- ko ifnot: position.visible -->
            <!-- ko foreach: { data: position.employees, as: 'employee' } -->
            <!-- ko template: {
              foreach: hrmTemplateIf(employee.visible(), $data),
              beforeRemove: hrmFadeBeforeRemoveFactory(500)
          } -->
            <tr class="positions-table__row">
              <td class="positions-table__cell  positions-table__cell--name">
                <div class="positions-table__cell-content">

                  <!-- Данные сотрудника -->
                  <div
                       data-bind="template: { name: 'employee-block-template', data: {employee: $data, position: position.name} }">
                  </div>
                  <!-- /Данные сотрудника -->

                </div>
              </td>


              <!-- ko foreach: table.columns -->
              <td class="positions-table__cell"
                  data-bind="class: 'positions-table__cell--' + id"></td>
              <!-- /ko -->

              <td class="positions-table__cell  positions-table__cell--total positions-table__cell--colored"></td>
              <td class="positions-table__cell positions-table__cell--payment positions-table__cell--colored"></td>

            </tr>
            <!-- /ko -->
            <!-- /ko -->
            <!-- /ko -->
            <!-- /ko -->
            <!-- /ko -->
            <!-- /Блок Прочее -->

            <!-- Total section -->
            <tr class="positions-table__row positions-table__row--highlighted positions-table__total">
              <td class="positions-table__cell  positions-table__cell--name positions-table__empty">

              </td>

              <!-- ko foreach: table.columns -->
              <td class="positions-table__cell"
                  data-bind="class: 'positions-table__cell--' + id, css: {'positions-table__cell--empty': !hasTotal}">
                <div class="positions-table__cell-content">
                  <span data-bind="text: total"></span>
                </div>
              </td>
              <!-- /ko -->

              <td class="positions-table__cell positions-table__cell--total positions-table__cell--colored">
                <div class="positions-table__cell-content">
                  <span data-bind="text: total.total"></span>
                </div>
              </td>

              <td class="positions-table__cell positions-table__cell--payment positions-table__cell--colored">
                <div class="positions-table__cell-content">
                  <span data-bind="text: total.toPayment"></span>
                </div>
              </td>
            </tr>
            <!-- /Total section -->
          </tbody>
        </table>

      </div>
    </div>
  </div>
</template>

<template id="positions-modal-dialog-template">

  <button class="hrm-button hrm-basic-modal-dialog__close-button"
          data-bind="click: function() { cancel(); }"
          aria-label="Close">
  </button>

  <div class="hrm-basic-modal-dialog__header">
    <h2 class="hrm-basic-modal-dialog__title">
      Показывать в таблице должности
    </h2>
  </div>

  <div class="hrm-basic-modal-dialog__body positions-settings">
    <div class="positions-settings__search"
         data-bind="component: {name: 'hrm-search-field', params: { termModel: term, placeholder: 'Поиск' }}"></div>

    <div class="positions-settings__list">
      <!-- ko foreach: { data: $component.positions, as: 'position' } -->

      <!-- ko let: {checkboxGroup: ko.observable(null), visible: position.visible} -->
      <div class="positions-settings__list-item"
           data-bind="if: visible">
        <div data-bind="component: {name: 'hrm-checkbox-group', params: {exportAs: checkboxGroup}}">
          <div
               data-bind="component: {name: 'hrm-checkbox', params: {owner: checkboxGroup, checked: position.checked }}">
          </div>
          <label
                 data-bind="hrmCheckboxGroupLabel, hrmCheckboxGroupLabelOwner: checkboxGroup, text: position.name"></label>
        </div>
      </div>
      <!-- /ko -->

      <!-- /ko -->
    </div>

  </div>

  <div class="hrm-basic-modal-dialog__action-list">
    <button class="hrm-button hrm-basic-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-cancel-button"
            data-bind="click: function() {reset();}">
      Сбросить
    </button>

    <button class="hrm-button hrm-basic-button hrm-accent-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-submit-button"
            data-bind="click: function() {submit();}">
      Применить
    </button>
  </div>

</template>

<script type="text/javascript">
    $(function () {
        ko.components.register('positions-modal-dialog', {
            viewModel: {
                createViewModel: function (params, componentInfo) {
                    const $element = $(componentInfo.element);
                    $element.addClass([
                        'modal-dialog',
                        'modal-dialog-centered',
                        'hrm-modal-dialog',
                        'hrm-basic-modal-dialog',
                        'hrm-modal-dialog--size_large'
                    ]);

                    return new (function () {
                        /** Positions model */
                        this.positions = params.data.positions().map((p) => {
                            const positionData = p();
                            return {
                                name: positionData.name,
                                checked: ko.observable(positionData.visible()),
                                position: p,
                                visible: ko.observable(true)
                            }
                        });

                        /** Поисковый запрос */
                        this.term = ko.observable('');
                        /** Скрыть/Показать позиции в списке */
                        this.term.subscribe(value => {
                            const formattedTerm = value.toLowerCase();

                            this.positions.forEach(p => {
                                let isVisible = true;
                                if (formattedTerm.length >= 2) {
                                    const formattedName = p.name.toLowerCase();
                                    isVisible = formattedName.indexOf(formattedTerm) !== -1;
                                }
                                p.visible(isVisible);
                            })
                        });

                        /** Сбросить все чекбоксы и поисковый запрос */
                        this.reset = function () {
                            this.term('');
                            this.positions.forEach(p => {
                                p.checked(false);
                            });
                        }

                        /** Закрыть окно без изменений */
                        this.cancel = function () {
                            if ('cancel' in params) {
                                params.cancel();
                            }
                        };

                        /** Применить изменения */
                        this.apply = function() {
                            this.positions.forEach(p => {
                                p.position().visible(p.checked());
                            });
                        }

                        this.submit = function () {
                            if ('submit' in params) {
                                this.apply();
                                params.submit(true);
                            }
                        };
                    });
                }
            },
            template: {
                element: document.getElementById('positions-modal-dialog-template')
            }
        });
    });
</script>


<script type="text/javascript">
  $(function () {
    function Column(id, title, fullTitle, total) {
      return ko.observable({
        id,
        title,
        fullTitle,
        visible: true,
        total,
        hasTotal: total !== undefined
      })
    }

    ko.components.register('calculation-page-positions-table', {
      viewModel: {
        createViewModel: function (params, componentInfo) {
          const positions = params.positions;
          const model = params.model;

          /** Наличие неактивных позиций - для секции Прочее */
          const hasOtherSection = ko.pureComputed(() => {
            return positions().some(p => {
              return !p().visible();
            });
          });

          /** Итого: вычисляемые значения - последний ряд таблицы */
          const total = {
            workTime: ko.pureComputed(() => {
              return 0;
            }),
            salaryMain: ko.pureComputed(() => {
              return 0;
            }),
            bonusExceed: ko.pureComputed(() => {
              return 0;
            }),
            normalizationRatio: ko.pureComputed(() => {
              return 0;
            }),
            revenueStandart: ko.pureComputed(() => {
              return 0;
            }),
            bonusRatio: ko.pureComputed(() => {
              return 0;
            }),
            correctedTime: ko.pureComputed(() => {
              return 0;
            }),
            total: ko.pureComputed(() => {
              return 0;
            }),
            toPayment: ko.pureComputed(() => {
              return 0;
            }),
          }

          /* Настраиваемые колонки таблицы */
          const columns = [
            Column('account', 'Прем./ЛС, ₽', 'Премиальный счет/личный счет'),
            Column('account-operations', 'Операции с ЛС, ₽', 'Операции с личным счетом'),
            Column('level', 'Разряд', 'Разряд'),
            Column('interval', 'Начало/конец работы', 'Начало/конец работы'),
            Column('workTime', 'Рабочее время', 'Рабочее время', total.workTime),
            Column('compensation', 'Компенс.', 'Компенсация'),
            Column('workload', 'Нагрузка', 'Нагрузка'),
            Column('salary', 'Оклад, ₽', 'Оклад'),
            Column('salary-main', 'Осн. часть зп, ₽', 'Основная часть зарплаты', total.salaryMain),
            Column('revenue-standart-hour', 'Норм. выр-ки/ч', 'Норматив выручки/ч'),
            Column('normalization-ratio', 'Коэфф. норм.-я', 'Коэффициент. нормирования', total.normalizationRatio),
            Column('revenue-standart', 'Норм. выр-ки/ч', 'Норматив выручки', total.revenueStandart),
            Column('bonus-ratio', 'Коэфф. прем.-я', 'Коэффициент премирования', total.bonusRatio),
            Column('corrected-time', 'Корр. время', 'Корректированное время', total.correctedTime),
            Column('bonus-exceed', 'Прем. за превыш. норм., ₽', 'Премия за превышение норматива', total.bonusExceed),
            Column('depremation', 'Депр., ₽', 'Депремирование'),
            Column('premation', 'Прем., ₽', 'Премирование'),
            Column('fine', 'Штраф, ₽', 'Штраф'),
          ];
          const activeColumns = ko.pureComputed(() => {
            return columns.filter(c => c().visible).length;
          });

          /** Общее количество колонок (для растягивания заголовков) */
          const columnCount = ko.pureComputed(() => {
            return activeColumns() + 3;
          });

          /** Установить видимость позиций (модальное окно) */
          const setPositions = () => {
            params.settings.openModal('positions', { positions: positions })
          }

          /* Создать сотрудника*/
          const createEmployee = () => {
            params.settings.openModal(
              'create-employee',
              null,
              (data) => {
                console.log('employee created', data);
              });
          };

          /* Добавить сотрудников */
          const addEmployees = () => {
            params.settings.openModal('add-employees', {
              positions: positions(),
              mode: 'tabs',
            }, (updatedPositionsList) => {
              model.updateEmployeesList(updatedPositionsList);
            });
          };

          const addEmployeesInPosition = (position) => {
            const originalPosition = positions().find(p => p().id === position.id);

            if (originalPosition) {
              params.settings.openModal('add-employees',
                { position: originalPosition, mode: 'single' },
                (updatedPositionsList) => {
                  model.updateEmployeesList(updatedPositionsList);
                });
            } else {
              const invisiblePositions = positions().filter(p => !p().visible());
              params.settings.openModal('add-employees',
                { positions: invisiblePositions, mode: 'list' },
                (updatedPositionsList) => {
                  model.updateEmployeesList(updatedPositionsList);
                });
            }
          }

          return {
            viewportSize: params.settings.viewportSize,
            tabName: params.tabName,

            columns,
            activeColumns,
            columnCount,

            setPositions,
            positions,
            hasOtherSection,
            total,

            addEmployees,
            addEmployeesInPosition,
            createEmployee
          };
        }
      },
      template: {
        element: document.getElementById('calculation-page-positions-table-template')
      }
    });
  })
</script>

  <template id="create-employee-modal-dialog-template">

  <button class="hrm-button hrm-basic-modal-dialog__close-button"
          data-bind="click: function() { cancel(); }"
          aria-label="Close">
  </button>

  <div class="hrm-basic-modal-dialog__header">
    <h2 class="hrm-basic-modal-dialog__title">
      Создать сотрудника
    </h2>
  </div>

  <div class="hrm-basic-modal-dialog__body employee-form"
       data-bind="using: formModel">

    <div class="employee-form__row">
      <!-- Name field -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null)} -->
      <div class="employee-form__name"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">ФИО сотрудника</label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control, hrmFormFieldBasisAllowClear">
          <input data-bind="
              textInput: name,
              hrmFormFieldInputControl: control,
              hrmFormFieldInputControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)
          ">
        </div>

        <div data-bind="
          component: {name: 'hrm-form-field-error'},
          hrmSlide,
          hrmSlideValue: control() !== null ? control().errorState : false,
          hrmSlideDuration: 150
      ">
          <!-- ko text: $parent.name.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /Name field -->
    </div>

    <div class="employee-form__row">
      <!-- Position select -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
      <div class="employee-form__position"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">
          Должность
        </label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <select data-bind="value: position,
              options: $component.positions,
              optionsText: 'name',
              optionsValue: 'id',
              valueAllowUnset: true,
              hrmSelect,
              hrmSelectPlaceholder: 'Не выбрано',
              hrmSelectSearchEnabled: true,
              hrmSelectAllowClear: true,
              hrmFormFieldSelectControl: control,
              hrmFormFieldSelectControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)">
          </select>
        </div>

        <div data-bind="
          component: {name: 'hrm-form-field-error'},
          hrmSlide,
          hrmSlideValue: control() !== null ? control().errorState : false,
          hrmSlideDuration: 150
      ">
          <!-- ko text: $parent.position.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /Position select -->


      <!-- Levels select -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
      <div class="employee-form__level"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">
          Разряд
        </label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <select data-bind="value: level,
              disable: $component.levels().length === 0,
              options: $component.levels,
              valueAllowUnset: true,
              hrmSelect,
              hrmSelectPlaceholder: 'Не выбрано', hrmSelectAllowClear: true,
              hrmFormFieldSelectControl: control">
          </select>
        </div>
      </div>
      <!-- /ko -->
      <!-- /Levels select -->
    </div>


  </div>

  <div class="hrm-basic-modal-dialog__action-list">
    <button class="hrm-button hrm-basic-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-cancel-button"
            data-bind="click: function() {cancel();}">
      Отменить
    </button>

    <button class="hrm-button hrm-basic-button hrm-accent-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-submit-button"
            data-bind="click: function() {submit();}">
      Сохранить
    </button>
  </div>

</template>


<script type="text/javascript">
  $(function () {
    const positionsTable = [
      {
        id: 1,
        name: 'Администратор филиала',
        levels: [1, 2, 3]
      }, {
        id: 2,
        name: 'Повар-пиццмейкер',
        levels: [1, 2]
      }, {
        id: 3,
        name: 'Повар-сушист',
        levels: [1, 2]
      }, {
        id: 4,
        name: 'Официант',
        levels: []
      }, {
        id: 5,
        name: 'Водитель',
        levels: []
      }
    ];

    ko.components.register('create-employee-modal-dialog', {
      viewModel: {
        createViewModel: function (params, componentInfo) {
          const $element = $(componentInfo.element);

          $element.addClass([
            'modal-dialog',
            'modal-dialog-centered',
            'hrm-modal-dialog',
            'hrm-basic-modal-dialog',
            'hrm-modal-dialog--size_large'
          ]);

          const ViewModel = function () {
            this.isSubmitted = ko.observable(false);

            this.formControlErrorStateMatcher = (formControl) => {
              return ko.pureComputed(() => {
                console.log(formControl, formControl())
                return this.isSubmitted() && !formControl.isValid();
              });
            };

            this.positions = positionsTable;
            this.levels = ko.observable([]);

            this.formModel = {
              position: ko.observable('').extend({
                required: {
                  message: 'Обязательное поле'
                }
              }),
              level: ko.observable(null),
              name: ko.observable('').extend({
                required: {
                  message: 'Обязательное поле'
                }
              })
            }

            this.validationObject = ko.validatedObservable({
              name: this.formModel.name,
              position: this.formModel.position,
            });

            this.formModel.position.subscribe(positionId => {
              this.formModel.level(null);
              if (!positionId) {
                this.levels([]);
                return;
              }

              const position = positionsTable.find(p => p.id === positionId);
              if (!position) this.levels([]);
              else this.levels(position.levels);
            })

            this.cancel = function () {
              if ('cancel' in params) {
                params.cancel();
              }
            };

            this.submit = function () {
              this.isSubmitted(true);

              if (this.validationObject.isValid()) {
                if ('submit' in params) {
                  params.submit(ko.toJS(this.formModel));
                }
              }
            };
          }

          return new ViewModel();
        }
      },
      template: {
        element: document.getElementById('create-employee-modal-dialog-template')
      }
    });
  });
</script>

  <script type="text/html"
        id="add-employees-modal-employee-template">
  <!-- ko let: {checkboxGroup: ko.observable(null)} -->
<div data-bind="component: {name: 'hrm-checkbox-group', params: {exportAs: checkboxGroup}}">
  <div data-bind="component: {name: 'hrm-checkbox', params: {owner: checkboxGroup, checked: employee.checked }}">
  </div>
  <label data-bind="hrmCheckboxGroupLabel, hrmCheckboxGroupLabelOwner: checkboxGroup, text: employee.name"></label>
</div>
<!-- /ko -->
</script>

<script type="text/html"
        id="add-employees-modal-position-list-template">

        <div class="employees-form__employees-scrollable-list"
        data-bind="hrmScrollable">

        <!-- ko let: {checkboxGroup: ko.observable(null)} -->
        <div class="employees-form__checkbox-group">
          <div data-bind="component: {name: 'hrm-checkbox-group', params: {exportAs: checkboxGroup}}">

              <!-- ko foreach: {data: $parent.position.employees, as: 'employee'} -->
              <div class="employees-form__checkbox">

                    <!-- ko template: { name: 'add-employees-modal-employee-template', data: {employee: employee} } -->
                    <!-- /ko -->
              </div>
              <!-- /ko -->


          </div>
        </div>
        <!-- /ko -->

        </div>
</script>

<script type="text/html"
        id="add-employees-modal-other-list-template">

  <div class="employees-form__employees-scrollable-list"
  data-bind="hrmScrollable">

  <!-- ko let: {checkboxGroup: ko.observable(null)} -->
  <div class="employees-form__checkbox-group">
    <div data-bind="component: {name: 'hrm-checkbox-group', params: {exportAs: checkboxGroup}}">

      <!-- ko foreach: { data: $parent.positions, as: 'position' } -->
      <div class="employees-form__position"
            data-bind="if: position.hasVisibleEmployees">
        <div class="employees-form__position-name"
              data-bind="text: position.name"></div>

        <!-- ko foreach: {data: position.employees, as: 'employee'} -->
        <div class="employees-form__checkbox">

              <!-- ko template: { name: 'add-employees-modal-employee-template', data: {employee: employee} } -->
              <!-- /ko -->
        </div>
        <!-- /ko -->

      </div>
      <!-- /ko -->
    </div>
  </div>
  <!-- /ko -->

  </div>

</script>


<template id="add-employees-position-tab-template">
  <div class="employees-form__row">
    <!-- ko let: {control: ko.observable(null), label: ko.observable(null)} -->
    <div class="hrm-form-field-switch-group"
         data-bind="hrmSwitchGroup, hrmSwitchGroupControlRef: control, hrmSwitchGroupLabelRef: label">
      <div data-bind="component: {name: 'hrm-switch', params: {exportAs: control, checked: allBranches}}"></div>
      <label data-bind="hrmSwitchGroupLabel: label">
        Все филиалы
      </label>
    </div>
    <!-- /ko -->

    <div class="templates__form-field"
         data-bind="component: {name: 'hrm-search-field', params: { termModel: term, placeholder: 'Поиск по ФИО' }}">
    </div>
  </div><!-- .employees-form__row -->


  <!-- Подгрузка сотрудников -->
  <!-- ko template: {
        foreach: hrmTemplateIf(loadingBranches(), $data),
        afterAdd: hrmFadeAfterAddFactory(200, 200),
        beforeRemove: hrmFadeBeforeRemoveFactory(200)
      } -->
  <div>
    <div class="employees-form__calculating">
      <i class="fa fa-spinner fa-pulse
                            employees-form__calculating-indicator">
      </i>
    </div>
  </div>
  <!-- /ko -->


  <!-- Отображение сотрудников -->
  <!-- ko template: {
        foreach: hrmTemplateIf(!loadingBranches(), $data),
        afterAdd: hrmFadeAfterAddFactory(200, 200),
        beforeRemove: hrmFadeBeforeRemoveFactory(200)
      } -->

  <!-- Список позиций -->
  <!-- ko ifnot: isSingle -->
  <!-- ko template: { name: 'add-employees-modal-other-list-template', data: {positions: positions} } -->
  <!-- /ko -->
  <!-- /ko -->
  <!-- /Список позиций -->

  <!-- Одна позиция -->
  <!-- ko if: isSingle -->
  <!-- ko template: { name: 'add-employees-modal-position-list-template', data: {position: positions[0]} } -->
  <!-- /ko -->
  <!-- /ko -->
  <!-- /Одна позиция -->

  <!-- /ko -->
  <!-- /Отображение сотрудников -->

</template>

<template id="add-employees-modal-dialog-template">

  <button class="hrm-button hrm-basic-modal-dialog__close-button"
          data-bind="click: function() { cancel(); }"
          aria-label="Close">
  </button>

  <div class="hrm-basic-modal-dialog__header">
    <h2 class="hrm-basic-modal-dialog__title">
      Добавить сотрудников
    </h2>
  </div>

  <div class="hrm-basic-modal-dialog__body employees-form">
    <!-- ko if: tabs -->
    <div class="employees-form__tabs">
      <div style="width: 100%"
           data-bind="component: {name: 'hrm-tab-group', params: {items: tabs, activeItem: activeTab }}">
      </div>
    </div>
    <!-- /ko -->

    <div class="employees-form__tab">
      <!-- ko if: activePosition -->
        <!-- ko component: {
          name: 'add-employees-position-tab',
          params: {
            term: term,
            mode: 'single',
            position: activePosition()
          }
        } -->
        <!-- /ko -->
      <!-- /ko -->


      <!-- ko ifnot: activePosition -->
      <!-- Вкладка Прочие -->
        <!-- ko component: {
          name: 'add-employees-position-tab',
          params: {
            term: term,
            mode: 'list',
            positions: list
          }
        } -->
        <!-- /ko -->
      <!-- /Вкладка Прочие -->
      <!-- /ko -->
    </div>
  </div>

  <div class="hrm-basic-modal-dialog__action-list">
    <button class="hrm-button hrm-basic-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-cancel-button"
            data-bind="click: function() {cancel();}">
      Отменить
    </button>

    <button class="hrm-button hrm-basic-button hrm-accent-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-submit-button"
            data-bind="click: function() {submit();}">
      Сохранить
    </button>
  </div>

</template>


<script type="text/javascript">
  $(function () {
    const modes = {
      SINGLE: 'single',
      TABS: 'tabs',
      LIST: 'list'
    };

    function EmployeeModel(employee) {
      return {
        id: employee.id,
        name: employee.name,
        checked: ko.observable(employee.visible()),
        visible: ko.observable(true)
      }
    }

    function PositionModel(positionObservable) {
      const positionData = positionObservable();
      const employees = ko.observableArray(positionData.employees().map(EmployeeModel));
      const hasVisibleEmployees = ko.observable(true);

      return {
        name: positionData.name,
        id: positionData.id,
        employees,
        visible: positionData.visible(),
        hasVisibleEmployees,
      }
    }

    function NewEmployeeModel(employeeData) {
      return {
        id: employeeData.id,
        name: employeeData.name,
        checked: ko.observable(false),
        visible: ko.observable(true),
        loaded: true,
      }
    }

    ko.components.register('add-employees-position-tab', {
      viewModel: function (params) {
        this.term = params.term;
        this.mode = params.mode || ('position' in params ? modes.SINGLE : modes.LIST);

        this.isSingle = this.mode === modes.SINGLE;

        if (this.isSingle) {
          this.positions = [params.position];
        } else {
          this.positions = params.positions;
        }

        this.allBranches = ko.observable(false);
        this.loadingBranches = ko.observable(false);
        this.allBranches.subscribe(value => {
          if (value) {
            this.loadingBranches(true)
            this.loadBranches(() => {
              this.loadingBranches(false);
            });
          } else {
            this.restoreEmployeesList();
          }
        });

        this.restoreEmployeesList = () => {
          this.positions.forEach(p => {
            const oldEmployeesList = p.employees().filter(e => !e.loaded)
            p.employees(oldEmployeesList)
          })
        };

        this.loadBranches = (cb) => {
          if (this.isSingle) {
            const position = this.positions[0];
            console.log('Сделать запрос, категория', position.name);
            // Данные
            const employeesList = [
              { name: 'Рабочий #1', id: activePosition.name + '1' },
              { name: 'Рабочий #2', id: activePosition.name + '2' },
              { name: 'Рабочий #3', id: activePosition.name + '3' }
            ];

            // Добавить новых работников
            employeesList.forEach(e => {
              position.employees.push(NewEmployeeModel(e))
            });
          } else {
            const positionsList = this.positions.map(p => p.name)
            console.log('Сделать запрос, категории', positionsList);
            // Добавить новых работников в каждую категию
            updatedEmployees = this.positions.forEach(p => {
              const employeesList = [
                { name: 'Рабочий #1', id: p.name + '1' },
                { name: 'Рабочий #2', id: p.name + '2' },
                { name: 'Рабочий #3', id: p.name + '3' }
              ];
              employeesList.forEach(e => {
                p.employees.push(NewEmployeeModel(e))
              });
            })
          }

          setTimeout(cb, 3000)
        }
      },
      template: {
        element: 'add-employees-position-tab-template'
      }
    })

    ko.components.register('add-employees-modal-dialog', {
      viewModel: {
        createViewModel: function (params, componentInfo) {
          const $element = $(componentInfo.element);
          $element.addClass([
            'modal-dialog',
            'modal-dialog-centered',
            'hrm-modal-dialog',
            'hrm-basic-modal-dialog',
            'hrm-modal-dialog--size_large'
          ]);


          const ViewModel = function () {
            this.isSubmitted = ko.observable(false);

            this.formControlErrorStateMatcher = (formControl) => {
              return ko.pureComputed(() => {
                return this.isSubmitted() && !formControl.isValid();
              });
            };

            this.mode = params.data.mode || ('position' in params.data ? modes.SINGLE : modes.TABS);

            this.positions = this.mode === modes.SINGLE
              ? [PositionModel(params.data.position)]
              : params.data.positions.map(PositionModel);

            this.term = ko.observable('');
            function termUpdateHandler(value) {
              const formattedValue = value.toLowerCase();
              this.positions.forEach(p => {
                let hasVisibleEmployees = 0;
                p.employees().forEach(e => {
                  let isVisible = true;
                  if (formattedValue.length >= 2) {
                    const name = e.name.toLowerCase();
                    isVisible = name.indexOf(formattedValue) !== -1;
                  }
                  e.visible(isVisible);
                  if (isVisible) hasVisibleEmployees++;
                });
                p.hasVisibleEmployees(hasVisibleEmployees);
              })
            }
            this.term.subscribe(value => {
              termUpdateHandler(value);
            });

            this.tabs = null;
            this.activePosition = null;
            this.list = null;

            if (this.mode === modes.SINGLE) {
              this.activePosition = ko.observable(this.positions[0]);
            } else if (this.mode === modes.LIST) {
              this.list = this.positions;
            } else {
              this.list = this.positions.filter(position => !position.visible);
              const visiblePositions = this.positions.filter(position => position.visible);
              this.tabs = (() => {
                const tabs = visiblePositions.map(position => new HrmTabGroupItem(position.name));
                if (this.list.length) tabs.push(new HrmTabGroupItem('Прочие'));
                return tabs;
              })();
              this.activeTab = ko.observable(0);
              this.activePosition = ko.pureComputed(() => {
                return visiblePositions[this.activeTab()];
              });
              this.activeTab(0);
            }

            this.cancel = function () {
              if ('cancel' in params) {
                params.cancel();
              }
            };

            this.submit = function () {
              this.isSubmitted(true);
              if ('submit' in params) {
                params.submit(ko.toJS(this.positions));
              }
            };
          }

          return new ViewModel();
        }
      },
      template: {
        element: document.getElementById('add-employees-modal-dialog-template')
      }
    });
  });
</script>

  <template id="stimulation-modal-dialog-template">

  <button class="hrm-button hrm-basic-modal-dialog__close-button"
          data-bind="click: function() { cancel(); }"
          aria-label="Close">
  </button>

  <div class="hrm-basic-modal-dialog__header">
    <h2 class="hrm-basic-modal-dialog__title">
      Выписать штраф/премию смене
    </h2>
  </div>

  <div class="hrm-basic-modal-dialog__body stimulation-settings"
       data-bind="using: formModel">
    <div class="stimulation-settings__row">
      <!-- Category select -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
      <div class="stimulation-settings__select stimulation-settings__category"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">
          Категория
        </label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <select data-bind="value: category,
                   hrmSelect,
                   hrmSelectPlaceholder: 'Все', hrmSelectAllowClear: true,
                   hrmFormFieldSelectControl: control">
            <option></option>
            <option value="production">Производство</option>
            <option value="delivery">Доставка</option>
          </select>
        </div>
      </div>
      <!-- /ko -->
      <!-- /Category select -->


      <!-- Type toggler -->
      <div class="hrm-radio-group stimulation-settings__type">
        <div class="hrm-radio-group__radio hrm-radio-group__radio--theme_negative">
          <input class="hrm-radio-group__radio-input"
                 data-bind="checked: stimulationType"
                 type="radio"
                 value="fine"
                 id="fine-radio" />
          <label class="hrm-radio-group__radio-label"
                 for="fine-radio">
            Штраф
          </label>
        </div>

        <div class="hrm-radio-group__radio hrm-radio-group__radio--theme_positive">
          <input class="hrm-radio-group__radio-input"
                 data-bind="checked: stimulationType"
                 type="radio"
                 value="bonus"
                 id="bonus-radio" />
          <label class="hrm-radio-group__radio-label"
                 for="bonus-radio">
            Премия
          </label>
        </div>
      </div>
      <!-- /Type toggler -->
    </div>


    <div class="stimulation-settings__row">
      <!-- Base select -->

      <!-- ko if: stimulationType() === 'fine' -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
      <div class="stimulation-settings__select stimulation-settings__base"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">
          Основание штрафа
        </label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <select data-bind="value: base,
              hrmSelect,
              hrmSelectSearchEnabled: true,
              hrmSelectPlaceholder: 'Не выбрано', hrmSelectAllowClear: true,
              hrmFormFieldSelectControl: control,
              hrmFormFieldSelectControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)">

            <option></option>
            <optgroup label="Безопасность">
              <option value="0">Возврат в кассу</option>
            </optgroup>
            <optgroup label="Дисциплина">
              <option value="1">За отсутствие объяснительной</option>
              <option value="2">Халатное отношение к работе</option>
            </optgroup>
            <optgroup label="Документы">
              <option value="3">Налог</option>
            </optgroup>
            <optgroup label="Производство">
              <option value="4">Выкуп готовой продукции</option>
              <option value="5">Порча инвентаря и оборудования</option>
              <option value="6">Компенсация за халатность</option>
            </optgroup>
          </select>
        </div>

        <div data-bind="component: {name: 'hrm-form-field-error'},
            hrmSlide,
            hrmSlideValue: control() !== null ? control().errorState : false,
            hrmSlideDuration: 150">
          <!-- ko text: $parent.base.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /ko -->


      <!-- ko ifnot: stimulationType() === 'fine' -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
      <div class="stimulation-settings__select stimulation-settings__base"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">
          Основание премии
        </label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <select data-bind="value: base,
              hrmSelect,
              hrmSelectSearchEnabled: true,
              hrmSelectPlaceholder: 'Не выбрано', hrmSelectAllowClear: true,
              hrmFormFieldSelectControl: control,
              hrmFormFieldSelectControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)">

            <option></option>
            <optgroup label="Безопасность">
              <option value="0">Возврат в кассу</option>
            </optgroup>
            <optgroup label="Дисциплина">
              <option value="1">За отсутствие объяснительной</option>
              <option value="2">Халатное отношение к работе</option>
            </optgroup>
            <optgroup label="Документы">
              <option value="3">Налог</option>
            </optgroup>
            <optgroup label="Производство">
              <option value="4">Выкуп готовой продукции</option>
              <option value="5">Порча инвентаря и оборудования</option>
              <option value="6">Компенсация за халатность</option>
            </optgroup>
          </select>
        </div>

        <div data-bind="component: {name: 'hrm-form-field-error'},
            hrmSlide,
            hrmSlideValue: control() !== null ? control().errorState : false,
            hrmSlideDuration: 150">
          <!-- ko text: $parent.base.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /ko -->
      <!-- /Base select -->


    </div>

    <div class="stimulation-settings__row">
      <!-- Author select -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
      <div class="stimulation-settings__select stimulation-settings__author"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">
          <!-- ko text: stimulationType() === 'fine' ? 'Автор штрафа' : 'Автор премии' -->
          <!-- /ko -->
        </label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <select data-bind="value: author,
            hrmSelect,
            hrmSelectSearchEnabled: true,
            hrmSelectPlaceholder: 'Не выбран', hrmSelectAllowClear: true,
            hrmFormFieldSelectControl: control,
            hrmFormFieldSelectControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)">
            <option></option>
            <option value="0">Иван Иванов</option>
            <option value="1">Петр Петров</option>
            <option value="2">Николай Николаев</option>
            <option value="3">Дмитрий Дмитриев</option>
          </select>
        </div>

        <div data-bind="component: {name: 'hrm-form-field-error'},
        hrmSlide,
        hrmSlideValue: control() !== null ? control().errorState : false,
        hrmSlideDuration: 150">
          <!-- ko text: $parent.author.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /Author select -->

      <!-- Sum field -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null)} -->
      <div class="stimulation-settings__sum"
           data-bind="
           hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label
       ">
        <label data-bind="hrmFormFieldLabel: label">Сумма, ₽</label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <input data-bind="
                   attr: {readonly: stimulationType() === 'fine'},
                   textInput: sum,
                   hrmFormFieldInputControl: control,
                   hrmFormFieldInputControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)
               "
                 type="number">
        </div>

        <div data-bind="
               component: {name: 'hrm-form-field-error'},
               hrmSlide,
               hrmSlideValue: control() !== null ? control().errorState : false,
               hrmSlideDuration: 150
           ">
          <!-- ko text: $parent.sum.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /Sum field -->
    </div>

    <div class="stimulation-settings__row">
      <!-- Comment field -->
      <!-- ko let: {control: ko.observable(null)} -->
      <div class="stimulation-settings__comment"
           data-bind="
           hrmFormField, hrmFormFieldControlRef: control
       ">

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control, hrmFormFieldBasisAllowClear">
          <textarea data-bind="
                   textInput: comment,
                   hrmFormFieldInputControl: control,
                   hrmAutoResize
               "
                    placeholder="Комментарий"></textarea>
        </div>

      </div>
      <!-- /ko -->
      <!-- /Comment field -->
    </div>


  </div>

  <div class="hrm-basic-modal-dialog__action-list">
    <button class="hrm-button hrm-basic-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-cancel-button"
            data-bind="click: function() {cancel();}">
      Отменить
    </button>

    <button class="hrm-button hrm-basic-button hrm-accent-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-submit-button"
            data-bind="click: function() {submit();}">
      Сохранить
    </button>
  </div>

</template>


<script type="text/javascript">
  $(function () {
    /* Справочник штрафов */
    const finesTable = {
      '0': 200,
      '1': 300,
      '2': 400,
      '3': 500,
      '4': 600,
      '5': 700,
      '6': 800,
    };

    ko.components.register('stimulation-modal-dialog', {
      viewModel: {
        createViewModel: function (params, componentInfo) {
          const $element = $(componentInfo.element);

          $element.addClass([
            'modal-dialog',
            'modal-dialog-centered',
            'hrm-modal-dialog',
            'hrm-basic-modal-dialog',
            'hrm-modal-dialog--size_large'
          ]);

          const ViewModel = function () {
            this.isSubmitted = ko.observable(false);

            this.formControlErrorStateMatcher = (formControl) => {
              return ko.pureComputed(() => {
                return this.isSubmitted() && !formControl.isValid();
              });
            };

            /* fine/bonus */
            this.stimulationTypes = {
              "FINE": 'fine',
              "BONUS": 'bonus'
            }

            this.formModel = {
              category: ko.observable(''),
              stimulationType: ko.observable(this.stimulationTypes.FINE),
              base: ko.observable('').extend({
                required: {
                  message: 'Обязательное поле'
                }
              }),
              author: ko.observable('').extend({
                required: {
                  message: 'Обязательное поле'
                }
              }),
              sum: ko.observable(0).extend({
                required: {
                  message: 'Обязательное поле'
                },
                number: {
                  message: 'Некорректный формат'
                }
              }),
              comment: ko.observable('').extend({

              }),
            };

            this.reset = function () {
              this.formModel.base('');
              this.formModel.sum(0);
              this.formModel.author('');
              this.formModel.comment('');
            }

            this.formModel.stimulationType.subscribe(() => {
              this.reset();
            })

            this.formModel.base.subscribe((value) => {
              if (this.formModel.stimulationType() !== this.stimulationTypes.FINE) return;
              if (!value) this.formModel.sum(0);
              this.formModel.sum(finesTable[value] || 0);
            })

            this.validationObject = ko.validatedObservable({
              base: this.formModel.base,
              author: this.formModel.author,
              sum: this.formModel.sum,
            })

            this.cancel = function () {
              if ('cancel' in params) {
                params.cancel();
              }
            };

            this.submit = function () {
              this.isSubmitted(true);

              if (this.validationObject.isValid()) {
                if ('submit' in params) {
                  params.submit(ko.toJS(this.formModel));
                }
              }

            };
          }

          return new ViewModel();
        }
      },
      template: {
        element: document.getElementById('stimulation-modal-dialog-template')
      }
    });
  });
</script>

  <script type="text/javascript">
  $(function () {
    const $page = $(document.documentElement);

    const ViewModel = function (defaultPositions, settings) {
      /** Initialization */
      (() => {
        this.subscriptions = [];
        this.viewportSize = ko.observable({ width: $(window).width(), height: $(window).height() });
        this.windowResizeHandler = () => {
          this.viewportSize({ width: $(window).width(), height: $(window).height() });
        };
        this.childrenComplete = function () {
          $page.removeClass('hrm-page--initializing');
        };
        this.modalOpens = ko.observableArray([]);

        this.settings = {
          openModal: (id, data, onSave) => {
            const modal = createModalDialog(id, data, onSave);
            this.modalOpens.push(modal)
          },
          viewportSize: this.viewportSize
        }
      })();

      this.summaryModel = (() => {
        const positions = ko.observableArray([]);

        /* Creates new list from data */
        function setPositions(positionsList) {
          positions(positionsList.map(position => {
            return PositionModel(position)
          }))
        }

        /* Updates employees set and visibility */
        function updateEmployeesList(updatedPositionsList) {
          const originalPositionsList = positions();

          updatedPositionsList.forEach(updatedPosition => {
            const employees = updatedPosition.employees;
            const updatedIds = employees.map(e => e.id);

            const originalPosition = originalPositionsList.find(p => p().id === updatedPosition.id);

            const originalPositionEmployees = originalPosition().employees();
            const originalIds = originalPositionEmployees.map(e => e.id);

            const notFoundIds = _.difference(originalIds, updatedIds);
            const newEmployeesIds = _.difference(updatedIds, originalIds);

            // удалить тех, которых нет
            const updated = originalPositionEmployees.filter(e => notFoundIds.indexOf(e.id) === -1);

            // отметить видимость
            updated.forEach(e => {
              const updatedEmployee = employees.find(employee => employee.id === e.id);
              e.visible(updatedEmployee.checked);
            });

            // добавить новых
            newEmployees = newEmployeesIds.map(id => {
              const data = employees.find(e => e.id === id);
              const employee = EmployeeModel(data, data.checked);
              return employee;
            });

            originalPosition().employees(updated.concat(newEmployees));
          });
        }

        function EmployeeModel(employee, visible) {
          return {
            name: employee.name,
            id: employee.id,
            visible: ko.observable(!!visible),
          }
        }

        function PositionModel(positionData) {
          const visible = ko.observable(false);
          const employees = ko.observableArray(positionData.employees.map((e) => EmployeeModel(e, false)));

          return ko.observable({
            ...positionData,
            employees,
            visible
          });
        };

        return {
          positions,
          setPositions,
          updateEmployeesList,
        }
      })();

      this.summaryModel.setPositions(defaultPositions);

      /** Input data */
      this.inputModel = {
        filial: ko.observable(''),
        date: ko.observable(moment().format('DD.MM.YYYY, dddd')),
        shift: ko.observable(''),
        interval: {
          start: ko.observable(''),
          end: ko.observable(''),
        }
      };

      /** Calculation */
      this.isBuilt = ko.observable(false);
      /** Get data for calculation */
      this.buildCalculation = () => {
        /** Данные */
        const inputData = ko.toJS(this.inputModel);

        /* Получение списка позиций */
        const positions = [
          {
            name: 'Администратор филиала',
            id: 1,
            type: 'production',
            workloadType: 'Выручка',
            workload: 0,
            units: '₽',
            additionalWorkload: 'Время без дела 0%',
            fotCategory: 0,
            fotRevenue: 0,
            performanceStandart: -100,
            lateness: {
              green: 0,
              yellow: 0,
              red: 0
            },
            employees: [
              {
                name: 'Администратор #1',
                id: '1'
              }
            ]
          },
          {
            name: 'Повар-сушист',
            id: 3,
            type: 'production',
            workloadType: 'Выручка',
            workload: 0,
            units: '₽',
            additionalWorkload: 'Время без дела 0%',
            fotCategory: 0,
            fotRevenue: 0,
            performanceStandart: -100,
            lateness: {
              green: 0,
              yellow: 0,
              red: 0
            },
            employees: [
              {
                name: 'Сушист #1',
                id: '2'
              }
            ]
          },
          {
            name: 'Повар-пиццмейкер',
            id: 2,
            type: 'production',
            workloadType: 'Выручка',
            workload: 0,
            units: '₽',
            additionalWorkload: 'Время без дела 0%',
            fotCategory: 0,
            fotRevenue: 0,
            performanceStandart: -100,
            lateness: {
              green: 0,
              yellow: 0,
              red: 0
            },
            employees: [
              {
                name: 'Пиццмейкер #1',
                id: '3'
              }, {
                name: 'Пиццмейкер #2',
                id: '4'
              }
            ]
          },
          {
            name: 'Официант',
            id: 4,
            type: 'production',
            workloadType: 'Выручка',
            workload: 0,
            units: '₽',
            additionalWorkload: 'Время без дела 0%',
            fotCategory: 0,
            fotRevenue: 0,
            performanceStandart: -100,
            lateness: {
              green: 0,
              yellow: 0,
              red: 0
            },
            employees: [
              {
                name: 'Официант #1',
                id: '5'
              }
            ]
          },
          {
            name: 'Водители',
            id: 5,
            type: 'delivery',
            workloadType: 'Выручка',
            workload: 0,
            units: '₽',
            additionalWorkload: '',
            fotCategory: 0,
            fotRevenue: 0,
            performanceStandart: -100,
            lateness: {
              green: 0,
              yellow: 0,
              red: 0
            },
            employees: [
              { name: 'Водитель #1', id: '6' },
              { name: 'Водитель #2', id: '6' },
              { name: 'Водитель #3', id: '6' }
            ]
          },
        ];

        /** Обновление представления */
        this.summaryModel.setPositions(positions);
        this.isBuilt(true);
      };

      /** Tabs: production, delivery, lateness */
      this.tabs = (() => {
        const tabs = [
          new HrmTabGroupItem('Производство'),
          new HrmTabGroupItem('Доставка'),
          new HrmTabGroupItem('Опоздания')
        ];
        const activeTab = ko.observable(0);
        return {
          tabs,
          activeTab,
        }
      })();

      this.productionPositions = ko.pureComputed(() => {
        return this.summaryModel.positions()
          .filter(position => position().type === 'production');
      })


      /** Stimulation model (fine/bonus) */
      this.stimulation = (() => {
        function Stimulation() {
          return {
            base: ko.observable(''),
            author: ko.observable(''),
            sum: ko.observable(0),
            comment: ko.observable('')
          }
        }

        const fine = {
          production: Stimulation(),
          delivery: Stimulation()
        };
        const bonus = {
          production: Stimulation(),
          delivery: Stimulation()
        };

        const setStimulation = () => {
          this.settings.openModal(
            'stimulation',
            null,
            (data) => {
              console.log('stimulation saved', data)
            }
          )
        }

        return {
          fine,
          bonus,
          set: setStimulation
        }
      })();





      /*
        addEmployee
      const index = Math.floor(Math.random() * 1000);

        position.employees.push(this.createEmployeeModel({
          name: position.name + ' #' + index,
          workingIntervals: [''],
          rate: position.rate() !== '' ? position.rate() : 600,
          returnRate: 30,
          salaryBulk: 7200,
          bonus: 100,
          fine: 20
        }));*/


      this.isEmployeesCalculated = ko.observable(false);

      this.calculateEmployees = function () {
        this.isEmployeesCalculated(true);
      };

      this.recalculateEmployees = function () {
        this.isEmployeesCalculated(false);

        this.formModel().positions().forEach((position, index) => {
          position.employees(positions[index].employees.map(e => this.createEmployeeModel(e)));
        });

        this.isEmployeesCalculated(true);
      };

      this.addWorkingInterval = function (employee) {
        employee.workingIntervals.push(this.createEmployeeWorkingIntervalModel(''));
      };



      this.onRateInput = function (position) {
        position.employees().forEach(employee => {
          employee.rate(position.rate());
        });
      };

      this.onEmployeeRateInput = function (position) {
        position.rate('');
      };


      this.getWorkloadTypeName = function (workloadType) {
        switch (workloadType) {
          case 1: return 'Объём товара по всему предприятию';
          case 2: return 'Объём товара по категориям';
        }
      };

      this.getEmployeeWorkingHours = function (employee) {
        return ko.pureComputed(() => {
          if (employee.workingIntervalsValidationObject.isValid()) {
            return employee.workingIntervals().reduce((minutes, interval) => {
              const boundaries = interval.value().split(' – ').map(b => moment(b, 'HH:mm'));

              if (boundaries[0].isAfter(boundaries[1])) {
                boundaries[1].add(1, 'd');
              }

              return minutes + boundaries[1].diff(boundaries[0], 'minutes');
            }, 0);
          } else {
            return 0;
          }
        });
      };

      this.getEmployeeSalaryBulk = function (employee) {
        return ko.pureComputed(() => {
          const minutes = this.getEmployeeWorkingHours(employee)();

          return this.unmaskDecimal(employee.rate()) * (minutes / 60);
        });
      };

      this.getEmployeeSalary = function (employee) {
        return ko.pureComputed(() => {
          const bulk = this.getEmployeeSalaryBulk(employee)();
          const bonus = this.unmaskDecimal(employee.bonus());
          const fine = this.unmaskDecimal(employee.fine());

          return this.unmaskDecimal(bulk + bonus - fine);
        });
      };

      this.getPositionMaxWorkingIntervalCount = function (position) {
        return ko.pureComputed(() => {
          return Math.max(...position.employees().map(e => e.workingIntervals().length));
        });
      };

      this.getCategoriesTooltipText = function (categories) {
        return categories.map(c => c.name).join(', ');
      };

      this.getUnitsSuffixHtml = function (units) {
        switch (units) {
          case '1': return 'шт.';
          case '2': return '<i class="far fa-ruble-sign"></i>';
          case '3': return 'ч.';
        }
      };

      this.formatDecimal = function (value) {
        return Inputmask.format(value, { alias: 'decimal', digits: '2', groupSeparator: ' ', autoGroup: true, allowMinus: false }).replace('.00', '');
      };

      this.unmaskDecimal = function (value) {
        const result = Inputmask.unmask(value, { alias: 'decimal', digits: '2', groupSeparator: ' ', autoGroup: true, allowMinus: false, unmaskAsNumber: true });

        if (result === '') {
          return 0;
        }

        return result;
      };

      this.editableCellControlErrorExtractor = function (control) {
        return ko.pureComputed(() => {
          return !control.isValid() ? { message: control.error() } : null;
        });
      };

      this.formatDuration = function (minutes) {
        let h = Math.floor(minutes / 60).toString();
        h = h.length === 1 ? '0' + h : h;
        let m = (minutes % 60).toString();
        m = m.length === 1 ? '0' + m : m;

        return h + ':' + m;
      };

      this.isSidebarCollapsed = ko.observable(localStorage.getItem(HRM_SIDEBAR_COLLAPSED_LOCAL_STORAGE_KEY) === 'true');

      (() => {
        $(window).on('resize', this.windowResizeHandler);

        this.subscriptions.push(this.isSidebarCollapsed.subscribe(collapsed => {
          localStorage.setItem(HRM_SIDEBAR_COLLAPSED_LOCAL_STORAGE_KEY, collapsed);
        }));
      })();
    };


    ViewModel.prototype.dispose = function () {
      $(window).off('resize', this.windowResizeHandler);
      this.subscriptions.forEach(s => s.dispose());
    };

    /***** Model activation *******/
    const defaultPositions = [];
    const viewModel = new ViewModel(defaultPositions);

    ko.applyBindings(
      viewModel,
      $page.get()[0]
    );


    /*****/



    function createModalDialog(id, data, onSave) {
      return {
        dialogTemplateName: id + '-modal-template',
        data: data,
        options: {
          modalClass: 'calculation-modal calculation-modal--' + id
        },
        close: result => {
          if (result !== undefined && typeof onSave === 'function') {
            onSave(result);
          }
        }
      }
    }
  });
</script>


</body>

</html>
