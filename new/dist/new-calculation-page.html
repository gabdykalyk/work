<!DOCTYPE html>
<html class="hrm-page calculation-page hrm-page--initializing"
      data-bind="childrenComplete: childrenComplete"
      lang="ru">

<head>
  <title>Sakura</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="HandheldFriendly" content="true" />
<meta content="IE=edge" http-equiv="X-UA-Compatible" />
<link href="https://fonts.googleapis.com/css?family=Fira+Sans:100,200,300,400,500,600,700,800,900&display=swap&subset=cyrillic" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2@4.0.12/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/overlayscrollbars/1.10.2/css/OverlayScrollbars.min.css" integrity="sha256-zUBmWpj0DsZzFautKgMOtiOkT6ECQ+a6RitMns7+HRM=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://unpkg.com/tippy.js@5/dist/backdrop.css" />
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
<link rel="stylesheet" href="assets/fonts/fontawesome/css/all.css" />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.css" integrity="sha256-vZ3SaLOjnKO/gGvcUWegySoDU6ff33CS5i9ot8J9Czk=" crossorigin="anonymous" />

<link rel="stylesheet" href="assets/css/main.css" />

</head>

<body>
  <div class="hrm-scaffold">
    <div class="hrm-scaffold__sidebar"
         data-bind="component: {name: 'hrm-main-sidebar', params: {collapsed: isSidebarCollapsed}}"></div>
    <div class="hrm-scaffold__body">
      <!-- Page content  -->
      <div class="hrm-scaffold__content calculation-page__content">

        <div class="calculation-page__header">
          <span class="calculation-page__title">
            Новый расчет
          </span>
          <div class="calculation-page__actions">
            <a href="#"
               class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_tablet hrm-button-with-icon--theme_secondary hrm-button-with-arrow-left-icon">
              К списку расчетов
            </a>

          </div>
        </div>

        <div class="calculation-form">
          <!-- Input table -->
          <div class="calculation-input__header"
     data-bind="let: { errorStateMatcher: $root.formControlErrorStateMatcher.bind($root), input: $root.inputModel }">

    <!-- Filial select -->
    <!-- ko let: {control: ko.observable(null), label: ko.observable(null)} -->
    <div class="calculation-input__field calculation-input__filial"
         data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
      <label data-bind="hrmFormFieldLabel: label">
        Филиал
      </label>

      <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
        <select data-bind="value: input.filial,
                        hrmSelect,
                        hrmFormFieldSelectControl: control,
                        hrmFormFieldSelectControlErrorStateMatcher: errorStateMatcher">
          <option value="0">Филиал #1</option>
          <option value="1">Филиал #2123123</option>
          <option value="2">Филиал #3</option>
          <option value="3">Филиал #4</option>
          <option value="4">Филиал #5</option>
        </select>
      </div>

      <div data-bind="component: {name: 'hrm-form-field-error'},
                    hrmSlide,
                    hrmSlideValue: control() !== null ? control().errorState : false,
                    hrmSlideDuration: 150">
        <!-- ko text: input.filial.error() -->
        <!-- /ko -->
      </div>
    </div>
    <!-- /ko -->
    <!-- /Filial select -->

    <!-- Date select -->
    <!-- ko let: {control: ko.observable(null), label: ko.observable(null)} -->
    <div class="calculation-input__field calculation-input__date"
         data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
      <label data-bind="hrmFormFieldLabel: label">Расчёт на дату</label>

      <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
        <input data-bind="textInput: input.date,
                      hrmDatepicker,
                      hrmFormFieldDatepickerControl: control,
                      hrmFormFieldDatepickerControlErrorStateMatcher: errorStateMatcher" />

        <i class="hrm-form-field__suffix hrm-form-field-icon hrm-form-field-calendar-icon"></i>
      </div>

      <div data-bind="component: {name: 'hrm-form-field-error'},
                    hrmSlide,
                    hrmSlideValue: control() !== null ? control() !== null ? control().errorState : false : false,
                    hrmSlideDuration: 150">
        <!-- ko text: input.date.error() -->
        <!-- /ko -->
      </div>
    </div>
    <!-- /ko -->
    <!-- /Date select -->

    <!-- Shift block -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null)} -->
      <div class="calculation-input__field"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label class=""
               data-bind="hrmFormFieldLabel: label">
          Смена
        </label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <select data-bind="value: input.shift,
             hrmSelect,
             hrmFormFieldSelectControl: control,
             hrmFormFieldSelectControlErrorStateMatcher: errorStateMatcher">
            <option value="day">Дневная</option>
            <option value="night">Ночная</option>
          </select>
        </div>

        <div data-bind="component: {name: 'hrm-form-field-error'},
              hrmSlide,
              hrmSlideValue: control() !== null ? control().errorState : false,
              hrmSlideDuration: 150">
          <!-- ko text: input.shift.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /Shift select -->

      <!-- Interval select -->
      <!-- ko let: {control: ko.observable(null)} -->
      <div class="calculation-input__field calculation-input__interval"
           data-bind="hrmFormField, hrmFormFieldControlRef: control">

        <div class="calculation-input__interval-controls"
             data-bind="hrmFormFieldComplexControl: control">

          <!-- ko let: {control: ko.observable(null)} -->
          <div class="calculation-input__interval-control"
               data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
            <input data-bind="value: input.interval().start,
                          hrmTimeAutocompleter,
                          hrmMask,
                          hrmMaskPattern: 'datetime',
                          hrmMaskOptions: {
                              inputFormat: 'HH:MM',
                              placeholder: ' '
                          },
                          hrmFormFieldInputControl: control,
                          hrmFormFieldInputControlErrorStateMatcher: errorStateMatcher"
                   placeholder="00:00">
          </div>

          <!-- /ko -->

          <span class="calculation-input__interval-separator">-</span>

          <!-- ko let: {control: ko.observable(null)} -->
          <div class="calculation-input__interval-control"
               data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
            <input data-bind="value: input.interval().end,
                          hrmTimeAutocompleter,
                          hrmMask,
                          hrmMaskPattern: 'datetime',
                          hrmMaskOptions: {
                              inputFormat: 'HH:MM',
                              placeholder: ' '
                          },
                          hrmFormFieldInputControl: control,
                          hrmFormFieldInputControlErrorStateMatcher: errorStateMatcher"
                   placeholder="00:00">
          </div>
          <!-- /ko -->

        </div><!-- .calculation-input__interval-controls -->

        <div data-bind="component: {name: 'hrm-form-field-error'},
            hrmSlide,
            hrmSlideValue: !inputModel.interval().correct(),
            hrmSlideDuration: 150">
            Некорректно задан интервал
        </div>
      </div>
      <!-- /ko -->
      <!-- /Interval select -->
    <!-- /Shift block -->


  <div class="calculation-input__field calculation-input__actions">
    <button class="hrm-button hrm-button--size_large hrm-basic-button hrm-accent-button calculation-input__action"
            data-bind="click: buildCalculation, enable: inputModel.isValid">
      Рассчитать
    </button>

    <button class="hrm-button hrm-button--size_large hrm-basic-button calculation-input__action">
      На сейчас
    </button>
  </div>


</div><!-- .calculaton-form__header -->

          <!-- /Input table -->

          <!-- ko template: {
            foreach: hrmTemplateIf(isBuilt(), $data),
            afterAdd: hrmFadeAfterAddFactory(200, 200),
            beforeRemove: hrmFadeBeforeRemoveFactory(200)
          } -->
          <div class="calculation-form__content">
            <!-- Summary table -->
            <div class="calculation-summary">

  <!-- ko if: $root.viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
  <div data-bind="component: {
    name: 'hrm-scrollable-wrapper',
    params: { options: {left: {disabled: true}} }
   }">
    <table class="calculation-summary__table"
           data-bind="hrmTable">
      <thead>

        <tr>
          <!-- ko foreach: [
            ['job', 'Должность', 'Должность'],
            ['workload-type', 'Тип нагрузки', 'Тип нагрузки'],
            ['workload', 'Нагрузка', 'Нагрузка', 2],
            ['additional-workload', 'Доп. нагрузка', 'Дополнительная нагрузка'],
            ['count', 'Сотр.', 'Сотрудники'],
            ['fot-category', 'ФОТ, % в категории', 'ФОТ, % в категории'],
            ['fot-revenue', 'ФОТ, % от выручки', 'ФОТ, % от выручки'],
            ['performance-standart', 'Норм. выработки, %', 'Норма выработки, %'],
            ['lateness', 'Опоздания', 'Опоздания'],
        ] -->
          <th class="calculation-summary__cell"
              data-bind="class: 'calculation-summary__' + $data[0], attr: {colspan: $data[3] || 1}">
            <div class="hrm-table__head-cell-content">
              <span data-bind="text: $data[1]"></span>
              <button class="hrm-button hrm-circle-icon-button hrm-circle-info-icon-button hrm-circle-icon-button--theme_neutral calculation-summary__info hrm-table__head-cell-info-button"
                      data-bind="hrmTooltip, hrmTooltipText: $data[2]"></button>
            </div>
          </th>
          <!-- /ko -->
        </tr>
      </thead>

      <tbody>
        <!-- ko foreach: $root.summaryModel.positions -->
        <!-- ko  let: { isTotal: false } -->
        <tr data-bind="css: { 'calculation-summary__total': isTotal }">
  <!-- Должность -->
  <td class="calculation-summary__cell">
    <div class=""
         data-bind="text: name"></div>
  </td>

  <!-- Тип нагрузки -->
  <td class="calculation-summary__cell">
    <div class=""
         data-bind="text: workloadType"></div>
  </td>

  <!-- Нагрузка -->
  <td class="calculation-summary__cell" align="right">
    <div class=""
         data-bind="text: workload"></div>
  </td>

  <!-- Юниты нагрузки -->
  <td class="calculation-summary__cell">
    <div class=""
         data-bind="text: units"></div>
  </td>

  <!-- Доп. нагрузка -->
  <td class="calculation-summary__cell">
    <div class=""
         data-bind="text: additionalWorkload"></div>
  </td>

  <!-- Сотрудники -->
  <td class="calculation-summary__cell" align="right">
    <div class=""
         data-bind="text: ko.isObservable(employees) ? employees().length : employees"></div>
  </td>

  <!-- ФОТ, % в категории -->
  <td class="calculation-summary__cell"
      data-bind="style: { backgroundColor: isTotal ? '#D0F4E3' : 'transparent'}"  align="right">
    <div class=""
         data-bind="text: fotCategory"></div>
  </td>

  <!-- ФОТ, % от выручки -->
  <td class="calculation-summary__cell"
      data-bind="style: { backgroundColor: isTotal ? '#D0F4E3' : 'transparent'}" align="right">
    <div class=""
         data-bind="text: fotRevenue"></div>
  </td>

  <!-- Норм. выработки -->
  <td class="calculation-summary__cell"
      data-bind="style: { backgroundColor: isTotal ? '#D0F4E3' : 'transparent'}" align="right">
    <div class=""
         data-bind="text: performanceStandart"></div>
  </td>

  <!-- Опоздания -->
  <td class="calculation-summary__cell calculation-summary__lateness-row-cell">
    <div class="calculation-summary__lateness-row">
      <div class="calculation-summary__lateness-cell"
           data-bind="style: {
        backgroundColor: lateness.green > 0 ? '#D0F4E3' : 'transparent'
      }">
        <!-- ko text: lateness.green > 0 ? lateness.green : '' -->
        <!-- /ko -->
      </div>
      <div class="calculation-summary__lateness-cell"
           data-bind="style: {
        backgroundColor: lateness.yellow > 0 ? '#FDFFB3' : 'transparent'
      }">
        <!-- ko text: lateness.yellow > 0 ? lateness.yellow : '' -->
        <!-- /ko -->
      </div>
      <div class="calculation-summary__lateness-cell"
           data-bind="style: {
        backgroundColor: lateness.red > 0 ? '#FFD3E8' : 'transparent'
      }">
        <!-- ko text: lateness.red > 0 ? lateness.red : '' -->
        <!-- /ko -->
      </div>
      <div class="calculation-summary__lateness-cell">
        <!-- ko text: lateness.green + lateness.yellow + lateness.red -->
        <!-- /ko -->
      </div>
    </div>
  </td>
</tr>

        <!-- /ko -->
        <!-- /ko -->


        <!-- ko using: $root.summaryModel.total() -->
        <!-- ko  let: { isTotal: true } -->
        <tr data-bind="css: { 'calculation-summary__total': isTotal }">
  <!-- Должность -->
  <td class="calculation-summary__cell">
    <div class=""
         data-bind="text: name"></div>
  </td>

  <!-- Тип нагрузки -->
  <td class="calculation-summary__cell">
    <div class=""
         data-bind="text: workloadType"></div>
  </td>

  <!-- Нагрузка -->
  <td class="calculation-summary__cell" align="right">
    <div class=""
         data-bind="text: workload"></div>
  </td>

  <!-- Юниты нагрузки -->
  <td class="calculation-summary__cell">
    <div class=""
         data-bind="text: units"></div>
  </td>

  <!-- Доп. нагрузка -->
  <td class="calculation-summary__cell">
    <div class=""
         data-bind="text: additionalWorkload"></div>
  </td>

  <!-- Сотрудники -->
  <td class="calculation-summary__cell" align="right">
    <div class=""
         data-bind="text: ko.isObservable(employees) ? employees().length : employees"></div>
  </td>

  <!-- ФОТ, % в категории -->
  <td class="calculation-summary__cell"
      data-bind="style: { backgroundColor: isTotal ? '#D0F4E3' : 'transparent'}"  align="right">
    <div class=""
         data-bind="text: fotCategory"></div>
  </td>

  <!-- ФОТ, % от выручки -->
  <td class="calculation-summary__cell"
      data-bind="style: { backgroundColor: isTotal ? '#D0F4E3' : 'transparent'}" align="right">
    <div class=""
         data-bind="text: fotRevenue"></div>
  </td>

  <!-- Норм. выработки -->
  <td class="calculation-summary__cell"
      data-bind="style: { backgroundColor: isTotal ? '#D0F4E3' : 'transparent'}" align="right">
    <div class=""
         data-bind="text: performanceStandart"></div>
  </td>

  <!-- Опоздания -->
  <td class="calculation-summary__cell calculation-summary__lateness-row-cell">
    <div class="calculation-summary__lateness-row">
      <div class="calculation-summary__lateness-cell"
           data-bind="style: {
        backgroundColor: lateness.green > 0 ? '#D0F4E3' : 'transparent'
      }">
        <!-- ko text: lateness.green > 0 ? lateness.green : '' -->
        <!-- /ko -->
      </div>
      <div class="calculation-summary__lateness-cell"
           data-bind="style: {
        backgroundColor: lateness.yellow > 0 ? '#FDFFB3' : 'transparent'
      }">
        <!-- ko text: lateness.yellow > 0 ? lateness.yellow : '' -->
        <!-- /ko -->
      </div>
      <div class="calculation-summary__lateness-cell"
           data-bind="style: {
        backgroundColor: lateness.red > 0 ? '#FFD3E8' : 'transparent'
      }">
        <!-- ko text: lateness.red > 0 ? lateness.red : '' -->
        <!-- /ko -->
      </div>
      <div class="calculation-summary__lateness-cell">
        <!-- ko text: lateness.green + lateness.yellow + lateness.red -->
        <!-- /ko -->
      </div>
    </div>
  </td>
</tr>

        <!-- /ko -->
        <!-- /ko -->
      </tbody>
    </table>
  </div>
  <!-- /ko -->

  <!-- ko ifnot: $root.viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
  <div class="hrm-table__fixed-section-container calculation-page__positions-table">
    <table class="hrm-table__fixed-section hrm-table__fixed-section--position_left"
           data-bind="hrmTable">
      <tbody>
        <!-- ko foreach: [
            ['job', 'Должность', 'Должность'],
            ['workload-type', 'Тип нагрузки', 'Тип нагрузки'],
            ['workload', 'Нагрузка', 'Нагрузка', 2],
            ['additional-workload', 'Доп. нагрузка', 'Дополнительная нагрузка'],
            ['count', 'Сотрудники', 'Сотрудники'],
            ['fot-category', 'ФОТ, % в категории', 'ФОТ, % в категории'],
            ['fot-revenue', 'ФОТ, % от выручки', 'ФОТ, % от выручки'],
            ['performance-standart', 'Норм. выр-ки, %', 'Норма выработки, %'],
            ['lateness', 'Опоздания', 'Опоздания'],
        ] -->
        <tr>
          <th class="calculation-summary__cell"
              data-bind="class: 'calculation-summary__' + $data[0]">
            <div class="hrm-table__head-cell-content"
                 data-bind="text: $data[1]"></div>
          </th>
        </tr>
        <!-- /ko -->
      </tbody>
    </table>

    <div data-bind="component: {
                   name: 'hrm-scrollable-wrapper',
                   params: { options: {left: {disabled: true}} }
                  }">
      <table class=" calculation-summary__table calculation-summary__table--mobile"
             data-bind="hrmTable">
        <tbody>
          <tr>
            <th class="calculation-summary__cell calculation-summary__job">
              <div class="hrm-table__head-cell-content">
                Должность
              </div>
            </th>

            <!-- ko foreach: summaryModel.positions -->
            <td class="calculation-summary__cell">
              <div class="hrm-table__cell-content"
                   data-bind="text: name"></div>
            </td>
            <!-- /ko -->

            <td class="calculation-summary__cell calculation-summary__total">
              <div class="hrm-table__cell-content">Итого</div>
            </td>
          </tr>

          <tr>
            <th class="calculation-summary__cell calculation-summary__workload-type">
              <div class="hrm-table__head-cell-content">
                Тип нагрузки
              </div>
            </th>

            <!-- ko foreach: summaryModel.positions -->
            <td class="calculation-summary__cell">
              <div class="hrm-table__cell-content"
                   data-bind="text: workloadType"></div>
            </td>
            <!-- /ko -->

            <td class="calculation-summary__cell  calculation-summary__total">
              <div class="hrm-table__cell-content"
                   data-bind="text: summaryModel.total().workloadType"></div>
            </td>
          </tr>

          <tr>
            <th class="calculation-summary__cell calculation-summary__workload">
              <div class="hrm-table__head-cell-content">
                Нагрузка
              </div>
            </th>

            <!-- ko foreach: summaryModel.positions -->
            <td class="calculation-summary__cell calculation-summary__workload-cell">
              <div class="calculation-summary__workload-row">

                <div class="calculation-summary__workload-value"
                      data-bind="text: workload"></div>
                <div class="calculation-summary__workload-unit"
                      data-bind="text: units"></div>

              </div>
            </td>
            <!-- /ko -->

            <td class="calculation-summary__cell  calculation-summary__total">
              <div class="hrm-table__cell-content"
                   data-bind="text: summaryModel.total().workload"></div>
            </td>
          </tr>

          <tr>
            <th class="calculation-summary__cell calculation-summary__additional-workload">
              <div class="hrm-table__head-cell-content">
                Доп. нагрузка
              </div>
            </th>

            <!-- ko foreach: summaryModel.positions -->
            <td class="calculation-summary__cell">
              <div class="hrm-table__cell-content"
                   data-bind="text: additionalWorkload"></div>
            </td>
            <!-- /ko -->

            <td class="calculation-summary__cell  calculation-summary__total">
              <div class="hrm-table__cell-content"
                   data-bind="text: summaryModel.total().additionalWorkload"></div>
            </td>
          </tr>

          <tr>
            <th class="calculation-summary__cell calculation-summary__count">
              <div class="hrm-table__head-cell-content">
                Сотрудники
              </div>
            </th>

            <!-- ko foreach: summaryModel.positions -->
            <td class="calculation-summary__cell">
              <div class="hrm-table__cell-content"
                   data-bind="text: employees.length"></div>
            </td>
            <!-- /ko -->

            <td class="calculation-summary__cell  calculation-summary__total">
              <div class="hrm-table__cell-content"
                   data-bind="text: summaryModel.total().employees.length"></div>
            </td>
          </tr>

          <tr>
            <th class="calculation-summary__cell calculation-summary__fot-category">
              <div class="hrm-table__head-cell-content">
                ФОТ, % в категории
              </div>
            </th>

            <!-- ko foreach: summaryModel.positions -->
            <td class="calculation-summary__cell">
              <div class="hrm-table__cell-content"
                   data-bind="text: fotCategory"></div>
            </td>
            <!-- /ko -->

            <td class="calculation-summary__cell  calculation-summary__total">
              <div class="hrm-table__cell-content"
                   data-bind="text: summaryModel.total().fotCategory"></div>
            </td>
          </tr>

          <tr>
            <th class="calculation-summary__cell calculation-summary__fot-revenue">
              <div class="hrm-table__head-cell-content">
                ФОТ, % от выручки
              </div>
            </th>

            <!-- ko foreach: summaryModel.positions -->
            <td class="calculation-summary__cell">
              <div class="hrm-table__cell-content"
                   data-bind="text: fotRevenue"></div>
            </td>
            <!-- /ko -->

            <td class="calculation-summary__cell  calculation-summary__total">
              <div class="hrm-table__cell-content"
                   data-bind="text: summaryModel.total().fotRevenue"></div>
            </td>
          </tr>

          <tr>
            <th class="calculation-summary__cell calculation-summary__performance-standart">
              <div class="hrm-table__head-cell-content">
                Норм. выр-ки, %
              </div>
            </th>

            <!-- ko foreach: summaryModel.positions -->
            <td class="calculation-summary__cell">
              <div class="hrm-table__cell-content"
                   data-bind="text: fotRevenue"></div>
            </td>
            <!-- /ko -->

            <td class="calculation-summary__cell  calculation-summary__total">
              <div class="hrm-table__cell-content"
                   data-bind="text: summaryModel.total().performanceStandart"></div>
            </td>
          </tr>

          <tr>
            <th class="calculation-summary__cell calculation-summary__lateness">
              <div class="hrm-table__head-cell-content">
                Опоздания
              </div>
            </th>

            <!-- ko foreach: summaryModel.positions -->
            <td class="calculation-summary__cell calculation-summary__lateness-row-cell">
              <div class="calculation-summary__lateness-row">
                <div class="calculation-summary__lateness-cell calculation-summary__lateness-cell--green"
                     data-bind="style: {
                  backgroundColor: lateness.green > 0 ? '#D0F4E3' : 'transparent'
                }">
                  <!-- ko text: lateness.green > 0 ? lateness.green : '' -->
                  <!-- /ko -->
                </div>
                <div class="calculation-summary__lateness-cell calculation-summary__lateness-cell--yellow"
                     data-bind="style: {
                  backgroundColor: lateness.yellow > 0 ? '#FDFFB3' : 'transparent'
                }">
                  <!-- ko text: lateness.yellow > 0 ? lateness.yellow : '' -->
                  <!-- /ko -->
                </div>
                <div class="calculation-summary__lateness-cell calculation-summary__lateness-cell--red"
                     data-bind="style: {
                  backgroundColor: lateness.red > 0 ? '#FFD3E8' : 'transparent'
                }">
                  <!-- ko text: lateness.red > 0 ? lateness.red : '' -->
                  <!-- /ko -->
                </div>
              </div>

            </td>
            <!-- /ko -->

            <td class="calculation-summary__cell  calculation-summary__lateness-row-cell  calculation-summary__total"
                data-bind="using: $root.summaryModel.total()">
              <div class="hrm-table__cell-content">
                <div class="calculation-summary__lateness-row">
                  <div class="calculation-summary__lateness-cell calculation-summary__lateness-cell--green"
                       data-bind="style: {
                    backgroundColor: lateness.green > 0 ? '#D0F4E3' : 'transparent'
                  }">
                    <!-- ko text: lateness.green > 0 ? lateness.green : '' -->
                    <!-- /ko -->
                  </div>
                  <div class="calculation-summary__lateness-cell calculation-summary__lateness-cell--yellow"
                       data-bind="style: {
                    backgroundColor: lateness.yellow > 0 ? '#FDFFB3' : 'transparent'
                  }">
                    <!-- ko text: lateness.yellow > 0 ? lateness.yellow : '' -->
                    <!-- /ko -->
                  </div>
                  <div class="calculation-summary__lateness-cell calculation-summary__lateness-cell--red"
                       data-bind="style: {
                    backgroundColor: lateness.red > 0 ? '#FFD3E8' : 'transparent'
                  }">
                    <!-- ko text: lateness.red > 0 ? lateness.red : '' -->
                    <!-- /ko -->
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <!-- /ko -->
</div>

            <!-- /Summary table -->

            <!-- Tabs -->
              <div class="calculation-page__tabs"
                  data-bind="component: {name: 'hrm-tab-group', params: {items: settings.tabs, activeItem: settings.activeTab }}">
              </div>

              <script type="text/html"
        id="calculation-settings-positions-modal-template">

  <div data-bind="component: {
      name: 'calculation-settings-positions-modal-dialog',
      params: {
        data, modalElement,
        cancel: function () { close(); },
        submit: function ($data) {close($data);}
      }}" role="document">
  </div>

</script>

<script type="text/html"
        id="calculation-settings-stimulation-modal-template">

  <div data-bind="component: {
      name: 'calculation-settings-stimulation-modal-dialog',
      params: {
        data, modalElement,
        cancel: function () { close(); },
        submit: function ($data) {close($data);}
      }}" role="document">
  </div>

</script>


<!-- ko component: {name: 'hrm-modal-container', params: {opens: modalOpens}} --><!-- /ko -->


              <!-- ko template: {
                foreach: hrmTemplateIf(settings.activeTab() === 0, $data),
                afterAdd: hrmFadeAfterAddFactory(200, 200),
                beforeRemove: hrmFadeBeforeRemoveFactory(200)
              } -->
                <div class="calculation-page__tab">
                  <!-- ko let: {'$tab': $root.settings.production, tabName: 'production'} -->
  <div class="calculation-tab calculation-production"
     data-bind="class: 'calculation-' + tabName">
        <div class="calculation-tab__settings">
                <script id="employees-dropdown-template"
                        type="text/html">
                        <div class="hrm-dropdown-menu__item">Добавить сотрудников</div>
                        <div class="hrm-dropdown-menu__item">Новый сотрудник</div>
                </script>

                <div>
                        <!-- ko if: viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
                        <button class="hrm-button hrm-button-with-icon-right hrm-button-with-arrow-down-icon-right hrm-button-with-icon--theme_secondary"
                                data-bind="hrmDropdownMenu, hrmDropdownMenuTemplate: 'employees-dropdown-template'">
                                Сотрудники
                        </button>

                        <button class="hrm-button hrm-basic-button hrm-button--size_medium"
                                data-bind="click: $tab.openPositionsModal">
                                Должности
                        </button>

                        <button class="hrm-button hrm-basic-button hrm-button--size_medium" data-bind="click: $root.stimulation.set">
                                Штраф/премия смене
                        </button>
                        <!-- /ko -->

                        <!-- ko ifnot: viewportSize().width > HRM_BREAKPOINTS.mobileMaxWidth -->
                        <button class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_desktop hrm-button-with-person-icon hrm-button-with-icon--theme_secondary"
                                data-bind="hrmDropdownMenu, hrmDropdownMenuTemplate: 'employees-dropdown-template'"></button>

                        <button class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_desktop hrm-button-with-badge-icon hrm-button-with-icon--theme_secondary"
                                data-bind="click: $tab.openPositionsModal"></button>

                        <button  data-bind="click: $root.stimulation.set"
                                class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_desktop hrm-button-with-money-icon hrm-button-with-icon--theme_secondary"></button>
                        <!-- /ko -->
                </div>
                <div>
                        <button
                                class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_tablet hrm-button-with-icon--theme_secondary hrm-button-with-settings-icon templates__button-with-icon">
                                Настроить столбцы
                        </button>

                        <button
                                class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_tablet hrm-button-with-icon--theme_secondary hrm-button-with-less-icon templates__button-with-icon">
                                Меньше информации
                        </button>

                        <button
                                class="hrm-button hrm-button-with-icon hrm-button-with-icon--hide_tablet hrm-button-with-icon--theme_secondary hrm-button-with-more-icon templates__button-with-icon hrm-button-with-icon--hide_tablet">
                                Больше информации
                        </button>
                </div>
        </div>

        <!-- ko foreach: $tab.positions -->
        <div data-bind="text: $data.name"></div>
        <div data-bind="text: $data.visible()"></div>
        <!-- /ko -->
</div>

<!-- /ko -->

                </div>
              <!-- /ko -->

              <!-- ko template: {
                foreach: hrmTemplateIf(settings.activeTab() === 1, $data),
                afterAdd: hrmFadeAfterAddFactory(200, 200),
                beforeRemove: hrmFadeBeforeRemoveFactory(200)
              } -->
                <div class="calculation-page__tab">
                  delivery

                </div>
              <!-- /ko -->

              <!-- ko template: {
                foreach: hrmTemplateIf(settings.activeTab() === 2, $data),
                afterAdd: hrmFadeAfterAddFactory(200, 200),
                beforeRemove: hrmFadeBeforeRemoveFactory(200)
              } -->
                <div class="calculation-page__tab">
                  lateness

                </div>
              <!-- /ko -->
            <!-- /Tabs -->

            <div class="calculation-form__actions">
              <button class="hrm-button hrm-button--size_large hrm-basic-button calculation-form__action">
                Отменить
              </button>

              <button class="hrm-button hrm-button--size_large hrm-basic-button hrm-accent-button calculation-form__action">
                Сохранить
              </button>
            </div>
          </div>
          <!-- /ko -->
        </div>
      </div>
      <!-- /Page content  -->



    </div>
  </div>


  <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-debug.js" integrity="sha256-M5ZomNNnrnEB2WjSbnty5GWGqq6UuAAVNnWECisgEis=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/knockout.validation@2.0.4/dist/knockout.validation.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.12/js/select2.full.min.js" integrity="sha256-vucLmrjdfi9YwjGY/3CQ7HnccFSS/XRS1M/3k/FDXJw=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.10/js/i18n/ru.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/simplebar/5.1.0/simplebar.min.js" integrity="sha256-hFddD6XMIwFba4ITQjpv5WWE557w6O0w9RRfmGjIz4k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/overlayscrollbars/1.10.2/js/OverlayScrollbars.min.js" integrity="sha256-5Tj3ZUgjHEGwF7TxpOgbPpjhq+WxXvpfb+qr9OxRHtY=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/overlayscrollbars/1.10.2/js/jquery.overlayScrollbars.min.js" integrity="sha256-RE+oy7ofA6XerySMpTlDcg0gFUwHN3n0qQ5fUIZVq/M=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/gh/RobinHerbots/jquery.inputmask@4.0.9/dist/jquery.inputmask.bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment-with-locales.min.js" integrity="sha256-AdQN98MVZs44Eq2yTwtoKufhnU+uZ7v2kXnD5vqzZVo=" crossorigin="anonymous"></script>
<script src="https://unpkg.com/popper.js@1"></script>
<script src="https://unpkg.com/tippy.js@5"></script>
<script src="https://unpkg.com/sticky-events@3.1.1/dist/sticky-events.umd.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min.js" integrity="sha256-VeNaFBVDhoX3H+gJ37DpT/nTuZTdjYro9yBruHjVmoQ=" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.js" integrity="sha256-id5Qk/MwQJxgNlDFDpVymUuReXfTUZiaQKb8arrddQM=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/mode/xml/xml.min.js" integrity="sha256-Lfk8z6WUsBN6YiCaMpH6bxBHyRqkPK4O2QbQHFNUS40=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/autoresize-textarea@1.1.3/src/autoresize-textarea.min.js"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

<script src="assets/js/main.js"></script>

  <script type="text/javascript">
    $(function () {
        ko.components.register('calculation-settings-positions-modal-dialog', {
            viewModel: {
                createViewModel: function (params, componentInfo) {
                    const $element = $(componentInfo.element);

                    $element.addClass([
                        'modal-dialog',
                        'modal-dialog-centered',
                        'hrm-modal-dialog',
                        'hrm-basic-modal-dialog',
                        'hrm-modal-dialog--size_large'
                    ]);

                    return new (function () {
                        this.term = ko.observable('');

                        this.positions = params.data.positions.map((p) => {
                            const positionData = p();
                            return {
                                name: positionData.name,
                                checked: ko.observable(positionData.visible()),
                                position: p,
                                visible: ko.pureComputed(() => {
                                    const term = this.term();

                                    if (!term || term.length < 2) return true;

                                    const formattedTerm = term.toLowerCase();
                                    const formattedName = positionData.name.toLowerCase();
                                    return formattedName.indexOf(formattedTerm) !== -1;


                                })
                            }
                        });

                        this.reset = function () {
                            this.term('');
                            this.positions.forEach(p => {
                                p.checked(false);
                            });
                        }

                        this.cancel = function () {
                            if ('cancel' in params) {
                                params.cancel();
                            }
                        };

                        this.submit = function () {
                            if ('submit' in params) {
                                this.positions.forEach(p => {
                                    p.position().visible(p.checked());
                                });
                                params.submit(true);
                            }

                        };
                    });
                }
            },
            template: {
                element: document.getElementById('calculation-settings-positions-modal-dialog-template')
            }
        });
    });
</script>

<template id="calculation-settings-positions-modal-dialog-template">

    <button class="hrm-button hrm-basic-modal-dialog__close-button"
            data-bind="click: function() { cancel(); }"
            aria-label="Close">
    </button>

    <div class="hrm-basic-modal-dialog__header">
        <h2 class="hrm-basic-modal-dialog__title">
            Показывать в таблице должности
        </h2>
    </div>

    <div class="hrm-basic-modal-dialog__body positions-settings">
        <div class="positions-settings__search"
             data-bind="component: {name: 'hrm-search-field', params: { termModel: term, placeholder: 'Поиск' }}"></div>

        <div class="positions-settings__list">
            <!-- ko foreach: { data: $component.positions, as: 'position' } -->

            <!-- ko let: {checkboxGroup: ko.observable(null), visible: position.visible} -->
            <div class="positions-settings__list-item" data-bind="if: visible">
                <div data-bind="component: {name: 'hrm-checkbox-group', params: {exportAs: checkboxGroup}}">
                    <div
                         data-bind="component: {name: 'hrm-checkbox', params: {owner: checkboxGroup, checked: position.checked }}">
                    </div>
                    <label
                           data-bind="hrmCheckboxGroupLabel, hrmCheckboxGroupLabelOwner: checkboxGroup, text: position.name"></label>
                </div>
            </div>
            <!-- /ko -->

            <!-- /ko -->
        </div>

    </div>

    <div class="hrm-basic-modal-dialog__action-list">
        <button class="hrm-button hrm-basic-button hrm-basic-modal-dialog__action-list-item
           position-page__speciality-modal-dialog-cancel-button"
                data-bind="click: function() {reset();}">
            Сбросить
        </button>

        <button class="hrm-button hrm-basic-button hrm-accent-button hrm-basic-modal-dialog__action-list-item
           position-page__speciality-modal-dialog-submit-button"
                data-bind="click: function() {submit();}">
            Применить
        </button>
    </div>

</template>

  <script type="text/javascript">
  $(function () {
    /* Справочник штрафов */
    const finesTable = {
      '0': 200,
      '1': 300,
      '2': 400,
      '3': 500,
      '4': 600,
      '5': 700,
      '6': 800,
    };

    ko.components.register('calculation-settings-stimulation-modal-dialog', {
      viewModel: {
        createViewModel: function (params, componentInfo) {
          const $element = $(componentInfo.element);

          $element.addClass([
            'modal-dialog',
            'modal-dialog-centered',
            'hrm-modal-dialog',
            'hrm-basic-modal-dialog',
            'hrm-modal-dialog--size_large'
          ]);

          const ViewModel = function () {
            this.isSubmitted = ko.observable(false);

            this.formControlErrorStateMatcher = (formControl) => {
              return ko.pureComputed(() => {
                console.log(formControl, formControl())
                return this.isSubmitted() && !formControl.isValid();
              });
            };

            /* fine/bonus */
            this.stimulationTypes = {
              "FINE": 'fine',
              "BONUS": 'bonus'
            }

            this.formModel = {
              category: ko.observable(''),
              stimulationType: ko.observable(this.stimulationTypes.FINE),
              base: ko.observable('').extend({
                required: {
                  message: 'Обязательное поле'
                }
              }),
              author: ko.observable('').extend({
                required: {
                  message: 'Обязательное поле'
                }
              }),
              sum: ko.observable(0).extend({
                required: {
                  message: 'Обязательное поле'
                },
                number: {
                  message: 'Некорректный формат'
                }
              }),
              comment: ko.observable('').extend({

              }),
            };

            this.reset = function () {
              this.formModel.base('');
              this.formModel.sum(0);
              this.formModel.author('');
              this.formModel.comment('');
            }

            this.formModel.stimulationType.subscribe(() => {
              this.reset();
            })

            this.formModel.base.subscribe((value) => {
              if (this.formModel.stimulationType() !== this.stimulationTypes.FINE) return;
              if (!value) this.formModel.sum(0);
              this.formModel.sum(finesTable[value] || 0);
            })

            this.validationObject = ko.validatedObservable({
              base: this.formModel.base,
              author: this.formModel.author,
              sum: this.formModel.sum,
            })

            this.cancel = function () {
              if ('cancel' in params) {
                params.cancel();
              }
            };

            this.submit = function () {
              this.isSubmitted(true);

              if (this.validationObject.isValid()) {
                if ('submit' in params) {
                  params.submit(ko.toJS(this.formModel));
                }
              }

            };
          }

          return new ViewModel();
        }
      },
      template: {
        element: document.getElementById('calculation-settings-stimulation-modal-dialog-template')
      }
    });
  });
</script>

<template id="calculation-settings-stimulation-modal-dialog-template">

  <button class="hrm-button hrm-basic-modal-dialog__close-button"
          data-bind="click: function() { cancel(); }"
          aria-label="Close">
  </button>

  <div class="hrm-basic-modal-dialog__header">
    <h2 class="hrm-basic-modal-dialog__title">
      Выписать штраф/премию смене
    </h2>
  </div>

  <div class="hrm-basic-modal-dialog__body stimulation-settings"
       data-bind="using: formModel">
    <div class="stimulation-settings__row">
      <!-- Category select -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
      <div class="stimulation-settings__select stimulation-settings__category"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">
          Категория
        </label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <select data-bind="value: category,
                   hrmSelect,
                   hrmSelectPlaceholder: 'Все', hrmSelectAllowClear: true,
                   hrmFormFieldSelectControl: control">
            <option></option>
            <option value="production">Производство</option>
            <option value="delivery">Доставка</option>
          </select>
        </div>
      </div>
      <!-- /ko -->
      <!-- /Category select -->


      <!-- Type toggler -->
      <div class="hrm-radio-group stimulation-settings__type">
        <div class="hrm-radio-group__radio hrm-radio-group__radio--theme_negative">
          <input class="hrm-radio-group__radio-input"
                 data-bind="checked: stimulationType"
                 type="radio"
                 value="fine"
                 id="fine-radio" />
          <label class="hrm-radio-group__radio-label"
                 for="fine-radio">
            Штраф
          </label>
        </div>

        <div class="hrm-radio-group__radio hrm-radio-group__radio--theme_positive">
          <input class="hrm-radio-group__radio-input"
                 data-bind="checked: stimulationType"
                 type="radio"
                 value="bonus"
                 id="bonus-radio" />
          <label class="hrm-radio-group__radio-label"
                 for="bonus-radio">
            Премия
          </label>
        </div>
      </div>
      <!-- /Type toggler -->
    </div>


    <div class="stimulation-settings__row">
      <!-- Base select -->

      <!-- ko if: stimulationType() === 'fine' -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
      <div class="stimulation-settings__select stimulation-settings__base"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">
          Основание штрафа
        </label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <select data-bind="value: base,
              hrmSelect,
              hrmSelectSearchEnabled: true,
              hrmSelectPlaceholder: 'Не выбрано', hrmSelectAllowClear: true,
              hrmFormFieldSelectControl: control,
              hrmFormFieldSelectControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)">

            <option></option>
            <optgroup label="Безопасность">
              <option value="0">Возврат в кассу</option>
            </optgroup>
            <optgroup label="Дисциплина">
              <option value="1">За отсутствие объяснительной</option>
              <option value="2">Халатное отношение к работе</option>
            </optgroup>
            <optgroup label="Документы">
              <option value="3">Налог</option>
            </optgroup>
            <optgroup label="Производство">
              <option value="4">Выкуп готовой продукции</option>
              <option value="5">Порча инвентаря и оборудования</option>
              <option value="6">Компенсация за халатность</option>
            </optgroup>
          </select>
        </div>

        <div data-bind="component: {name: 'hrm-form-field-error'},
            hrmSlide,
            hrmSlideValue: control() !== null ? control().errorState : false,
            hrmSlideDuration: 150">
          <!-- ko text: $parent.base.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /ko -->


      <!-- ko ifnot: stimulationType() === 'fine' -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
      <div class="stimulation-settings__select stimulation-settings__base"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">
          Основание премии
        </label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <select data-bind="value: base,
              hrmSelect,
              hrmSelectSearchEnabled: true,
              hrmSelectPlaceholder: 'Не выбрано', hrmSelectAllowClear: true,
              hrmFormFieldSelectControl: control,
              hrmFormFieldSelectControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)">

            <option></option>
            <optgroup label="Безопасность">
              <option value="0">Возврат в кассу</option>
            </optgroup>
            <optgroup label="Дисциплина">
              <option value="1">За отсутствие объяснительной</option>
              <option value="2">Халатное отношение к работе</option>
            </optgroup>
            <optgroup label="Документы">
              <option value="3">Налог</option>
            </optgroup>
            <optgroup label="Производство">
              <option value="4">Выкуп готовой продукции</option>
              <option value="5">Порча инвентаря и оборудования</option>
              <option value="6">Компенсация за халатность</option>
            </optgroup>
          </select>
        </div>

        <div data-bind="component: {name: 'hrm-form-field-error'},
            hrmSlide,
            hrmSlideValue: control() !== null ? control().errorState : false,
            hrmSlideDuration: 150">
          <!-- ko text: $parent.base.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /ko -->
      <!-- /Base select -->


    </div>

    <div class="stimulation-settings__row">
      <!-- Author select -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null) } -->
      <div class="stimulation-settings__select stimulation-settings__author"
           data-bind="hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label">
        <label data-bind="hrmFormFieldLabel: label">
          <!-- ko text: stimulationType() === 'fine' ? 'Автор штрафа' : 'Автор премии' -->
          <!-- /ko -->
        </label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <select data-bind="value: author,
            hrmSelect,
            hrmSelectSearchEnabled: true,
            hrmSelectPlaceholder: 'Не выбран', hrmSelectAllowClear: true,
            hrmFormFieldSelectControl: control,
            hrmFormFieldSelectControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)">
            <option></option>
            <option value="0">Иван Иванов</option>
            <option value="1">Петр Петров</option>
            <option value="2">Николай Николаев</option>
            <option value="3">Дмитрий Дмитриев</option>
          </select>
        </div>

        <div data-bind="component: {name: 'hrm-form-field-error'},
        hrmSlide,
        hrmSlideValue: control() !== null ? control().errorState : false,
        hrmSlideDuration: 150">
          <!-- ko text: $parent.author.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /Author select -->

      <!-- Sum field -->
      <!-- ko let: {control: ko.observable(null), label: ko.observable(null)} -->
      <div class="stimulation-settings__sum"
           data-bind="
           hrmFormField, hrmFormFieldControlRef: control, hrmFormFieldLabelRef: label
       ">
        <label data-bind="hrmFormFieldLabel: label">Сумма, ₽</label>

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
          <input data-bind="
                   attr: {readonly: stimulationType() === 'fine'},
                   textInput: sum,
                   hrmFormFieldInputControl: control,
                   hrmFormFieldInputControlErrorStateMatcher: $component.formControlErrorStateMatcher.bind($component)
               "
                 type="number">
        </div>

        <div data-bind="
               component: {name: 'hrm-form-field-error'},
               hrmSlide,
               hrmSlideValue: control() !== null ? control().errorState : false,
               hrmSlideDuration: 150
           ">
          <!-- ko text: $parent.sum.error() -->
          <!-- /ko -->
        </div>
      </div>
      <!-- /ko -->
      <!-- /Sum field -->
    </div>

    <div class="stimulation-settings__row">
      <!-- Comment field -->
      <!-- ko let: {control: ko.observable(null)} -->
      <div class="stimulation-settings__comment"
           data-bind="
           hrmFormField, hrmFormFieldControlRef: control
       ">

        <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control, hrmFormFieldWithReset">
          <textarea data-bind="
                   textInput: comment,
                   hrmFormFieldInputControl: control,
                   hrmAutoresize
               "
                    placeholder="Комментарий"></textarea>
        </div>

      </div>
      <!-- /ko -->
      <!-- /Comment field -->
    </div>


  </div>

  <div class="hrm-basic-modal-dialog__action-list">
    <button class="hrm-button hrm-basic-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-cancel-button"
            data-bind="click: function() {cancel();}">
      Отменить
    </button>

    <button class="hrm-button hrm-basic-button hrm-accent-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-submit-button"
            data-bind="click: function() {submit();}">
      Сохранить
    </button>
  </div>

</template>

  <script type="text/javascript">
  $(function () {
    const $page = $(document.documentElement);

    const ViewModel = function (positions, settings) {
      /** Initialization */
      (() => {
        this.subscriptions = [];
        this.viewportSize = ko.observable({ width: $(window).width(), height: $(window).height() });
        this.windowResizeHandler = () => {
          this.viewportSize({ width: $(window).width(), height: $(window).height() });
        };
        this.childrenComplete = function () {
          $page.removeClass('hrm-page--initializing');
        };
        this.modalOpens = ko.observableArray([]);
      })();

      /** Calculation created */
      this.isBuilt = ko.observable(false);
      this.buildCalculation = () => {
        this.isBuilt(true);
      };

      this.formControlErrorStateMatcher = function (formControl) {
        return ko.pureComputed(() => {
          return !formControl.isValid();
        });
      };

      /** Input data for calculation */
      this.inputModel = (() => {
        const getShift = (value) => {
          return Object.keys(settings.shifts).find(shift => shift.value === value)
        }
        /* Shift select is changing */
        const changeShift = ko.observable(false);

        const filial = ko.observable('').extend({
          required: {
            message: 'Обязательное поле'
          }
        });
        const date = ko.observable(moment().format('DD.MM.YYYY, dddd')).extend({
          required: {
            message: 'Обязательное поле'
          },
          hrmDate: {
            params: 'DD.MM.YYYY, dddd',
            message: 'Неверный формат даты'
          }
        });
        const shift = ko.observable(settings.shifts.day.value).extend({
          required: {
            message: 'Обязательное поле'
          }
        });

        const interval = createIntervalModel({
          start: settings.shifts.day.start,
          end: settings.shifts.day.end,
        }, () => {
          const shiftData = getShift(shift());
          !changeShift && shiftData.needCheck
        });

        shift.subscribe((value) => {
          changeShift = 1;

          const shiftData = getShift(value);
          if (shift) {
            interval().start(shiftData.start);
            interval().end(shiftData.end);
          }

          changeShift = 0;
        });

        const isValid = ko.pureComputed(() => {
          return date.isValid() && interval.isValid();
        }, this);


        return {
          filial,
          date,
          shift,
          interval,
          isValid
        }
      })();

      /** Data for summary table */
      this.summaryModel = ((defaultPositions) => {
        const positions = defaultPositions.map(position => {
          return createPositionModel(position)
        });

        const total = ko.pureComputed(() => {
          return positions.reduce((acc, p) => {
            p = p();
            return {
              name: '',
              workload: (acc.workload || 0) + p.workload,
              workloadType: '',
              units: '',
              additionalWorkload: '',
              fotCategory: 100,
              fotRevenue: 100,
              performanceStandart: -100,
              lateness: {
                green: 0,
                yellow: 0,
                red: 0
              },
              employees: (acc.employees || 0) + p.employees().length
            }
          }, {})
        });

        return {
          positions, total
        }
      })(positions);

      this.settings = (() => {
        const tabs = [
          new HrmTabGroupItem('Производство'),
          new HrmTabGroupItem('Доставка'),
          new HrmTabGroupItem('Опоздания')
        ];

        const activeTab = ko.observable(0);

        const productionPositions = this.summaryModel.positions
          .filter(position => position().type === 'production');

        const productionModel = new PositionsModel(productionPositions, this.modalOpens);

        return {
          tabs,
          activeTab,
          production: productionModel
        }
      })();

      this.stimulation = (() => {
        function Stimulation() {
          return {
            base: ko.observable(''),
            author: ko.observable(''),
            sum: ko.observable(0),
            comment: ko.observable('')
          }
        }

        const fine = {
          production: Stimulation(),
          delivery: Stimulation()
        };
        const bonus = {
          production: Stimulation(),
          delivery: Stimulation()
        };

        const setStimulation = () => {
          this.modalOpens.push(createFineBonusModalDialog(
            (data) => {
              console.log('stimulation saved', data)
            }
          ))
        }

        return {
          fine,
          bonus,
          set: setStimulation
        }
      })();







      this.isEmployeesCalculated = ko.observable(false);

      this.calculateEmployees = function () {
        this.isEmployeesCalculated(true);
      };

      this.recalculateEmployees = function () {
        this.isEmployeesCalculated(false);

        this.formModel().positions().forEach((position, index) => {
          position.employees(positions[index].employees.map(e => this.createEmployeeModel(e)));
        });

        this.isEmployeesCalculated(true);
      };

      this.addWorkingInterval = function (employee) {
        employee.workingIntervals.push(this.createEmployeeWorkingIntervalModel(''));
      };

      this.addEmployee = function (position) {
        const index = Math.floor(Math.random() * 1000);

        position.employees.push(this.createEmployeeModel({
          name: position.name + ' #' + index,
          workingIntervals: [''],
          rate: position.rate() !== '' ? position.rate() : 600,
          returnRate: 30,
          salaryBulk: 7200,
          bonus: 100,
          fine: 20
        }));
      };

      this.onRateInput = function (position) {
        position.employees().forEach(employee => {
          employee.rate(position.rate());
        });
      };

      this.onEmployeeRateInput = function (position) {
        position.rate('');
      };


      this.getWorkloadTypeName = function (workloadType) {
        switch (workloadType) {
          case 1: return 'Объём товара по всему предприятию';
          case 2: return 'Объём товара по категориям';
        }
      };

      this.getEmployeeWorkingHours = function (employee) {
        return ko.pureComputed(() => {
          if (employee.workingIntervalsValidationObject.isValid()) {
            return employee.workingIntervals().reduce((minutes, interval) => {
              const boundaries = interval.value().split(' – ').map(b => moment(b, 'HH:mm'));

              if (boundaries[0].isAfter(boundaries[1])) {
                boundaries[1].add(1, 'd');
              }

              return minutes + boundaries[1].diff(boundaries[0], 'minutes');
            }, 0);
          } else {
            return 0;
          }
        });
      };

      this.getEmployeeSalaryBulk = function (employee) {
        return ko.pureComputed(() => {
          const minutes = this.getEmployeeWorkingHours(employee)();

          return this.unmaskDecimal(employee.rate()) * (minutes / 60);
        });
      };

      this.getEmployeeSalary = function (employee) {
        return ko.pureComputed(() => {
          const bulk = this.getEmployeeSalaryBulk(employee)();
          const bonus = this.unmaskDecimal(employee.bonus());
          const fine = this.unmaskDecimal(employee.fine());

          return this.unmaskDecimal(bulk + bonus - fine);
        });
      };

      this.getPositionMaxWorkingIntervalCount = function (position) {
        return ko.pureComputed(() => {
          return Math.max(...position.employees().map(e => e.workingIntervals().length));
        });
      };

      this.getCategoriesTooltipText = function (categories) {
        return categories.map(c => c.name).join(', ');
      };

      this.getUnitsSuffixHtml = function (units) {
        switch (units) {
          case '1': return 'шт.';
          case '2': return '<i class="far fa-ruble-sign"></i>';
          case '3': return 'ч.';
        }
      };

      this.formatDecimal = function (value) {
        return Inputmask.format(value, { alias: 'decimal', digits: '2', groupSeparator: ' ', autoGroup: true, allowMinus: false }).replace('.00', '');
      };

      this.unmaskDecimal = function (value) {
        const result = Inputmask.unmask(value, { alias: 'decimal', digits: '2', groupSeparator: ' ', autoGroup: true, allowMinus: false, unmaskAsNumber: true });

        if (result === '') {
          return 0;
        }

        return result;
      };

      this.editableCellControlErrorExtractor = function (control) {
        return ko.pureComputed(() => {
          return !control.isValid() ? { message: control.error() } : null;
        });
      };

      this.formatDuration = function (minutes) {
        let h = Math.floor(minutes / 60).toString();
        h = h.length === 1 ? '0' + h : h;
        let m = (minutes % 60).toString();
        m = m.length === 1 ? '0' + m : m;

        return h + ':' + m;
      };

      this.isSidebarCollapsed = ko.observable(localStorage.getItem(HRM_SIDEBAR_COLLAPSED_LOCAL_STORAGE_KEY) === 'true');

      (() => {
        $(window).on('resize', this.windowResizeHandler);

        this.subscriptions.push(this.isSidebarCollapsed.subscribe(collapsed => {
          localStorage.setItem(HRM_SIDEBAR_COLLAPSED_LOCAL_STORAGE_KEY, collapsed);
        }));
      })();
    };


    ViewModel.prototype.dispose = function () {
      $(window).off('resize', this.windowResizeHandler);
      this.subscriptions.forEach(s => s.dispose());
    };

    /***** Model activation *******/
    const positions = [
      {
        name: 'Администратор филиала',
        type: 'production',
        workloadType: 'Выручка',
        workload: 0,
        units: '₽',
        additionalWorkload: 'Время без дела 0%',
        fotCategory: 0,
        fotRevenue: 0,
        performanceStandart: -100,
        lateness: {
          green: 0,
          yellow: 0,
          red: 0
        },
        employees: [
          {
            name: 'Сергеева Мария Владиславовна',
          }
        ]
      },
      {
        name: 'Повар-сушист',
        type: 'production',
        workloadType: 'Выручка',
        workload: 0,
        units: '₽',
        additionalWorkload: 'Время без дела 0%',
        fotCategory: 0,
        fotRevenue: 0,
        performanceStandart: -100,
        lateness: {
          green: 0,
          yellow: 0,
          red: 0
        },
        employees: [
          {
            name: 'Сергеева Мария Владиславовна',
          }
        ]
      },
      {
        name: 'Официант',
        type: 'production',
        workloadType: 'Выручка',
        workload: 0,
        units: '₽',
        additionalWorkload: 'Время без дела 0%',
        fotCategory: 0,
        fotRevenue: 0,
        performanceStandart: -100,
        lateness: {
          green: 0,
          yellow: 0,
          red: 0
        },
        employees: [
          {
            name: 'Сергеева Мария Владиславовна',
          }
        ]
      },
      {
        name: 'Водители',
        type: 'delivery',
        workloadType: 'Выручка',
        workload: 0,
        units: '₽',
        additionalWorkload: '',
        fotCategory: 0,
        fotRevenue: 0,
        performanceStandart: -100,
        lateness: {
          green: 0,
          yellow: 0,
          red: 0
        },
        employees: [
          {},
          {},
          {}
        ]
      },
    ];

    const settings = {
      shifts: {
        day: {
          value: 'day',
          start: '11:00',
          end: '23:00',
          needCheck: true // start < end
        },
        night: {
          value: 'night',
          start: '23:00',
          end: '11:00'
        }
      }
    };

    const viewModel = new ViewModel(positions, settings);
    ko.applyBindings(
      viewModel,
      $page.get()[0]
    );




    function createTimeModel(defaultValue) {
      return ko.observable(defaultValue).extend({
        required: {
          message: 'Обязательное поле'
        },
        hrmDate: {
          params: 'HH:mm',
          message: 'Неверный формат времени'
        }
      })
    }

    function createIntervalModel(data, needCheck) {
      const model = ko.validatedObservable(null, { deep: true, live: true });
      const start = createTimeModel(data.start);
      const end = createTimeModel(data.end);

      const correct = ko.pureComputed(() => {
        const endMoment = moment(end(), 'HH:mm');
        const startMoment = moment(start(), 'HH:mm');
        if (!needCheck()) return true;
        return endMoment.isAfter(startMoment);
      });

      start.extend({
        validation: { validator: () => correct() }
      });
      end.extend({
        validation: { validator: () => correct() }
      });

      model({
        start,
        end,
        correct
      });

      return model;
    }

    function createPositionModel(positionData) {
      const visible = ko.observable(true);
      const employees = ko.observableArray(positionData.employees);

      return ko.observable({
        ...positionData,
        employees,
        visible
      });
    };

    function PositionsModel(positions, modals) {

      function createPositionsModalDialog() {
        return {
          dialogTemplateName: 'calculation-settings-positions-modal-template',
          data: {
            positions,
          },
          options: {
            modalClass: 'calculation-page__positions-modal'
          },
          close: result => {
            if (result !== undefined) {
              // console.log(result)
            }
          }
        }
      }



      return {
        positions,
        openPositionsModal: () => {
          modals.push(createPositionsModalDialog())
        },

      }

    }

    function createFineBonusModalDialog(onSave) {
      return {
        dialogTemplateName: 'calculation-settings-stimulation-modal-template',
        options: {
          modalClass: 'calculation-page__stimulation-modal'
        },
        close: result => {
          if (result !== undefined) {
            onSave(result);
          }
        }
      }
    }
  });
</script>


</body>

</html>
