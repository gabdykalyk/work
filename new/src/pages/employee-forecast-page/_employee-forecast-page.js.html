<script type="text/javascript">
    $(function () {
        const $page = $(document.documentElement);

        const ViewModel = function () {
            this.subscriptions = [];

            this.windowResizeHandler = () => {
                this.viewportSize({width: $(window).width(), height: $(window).height()});
            };
            this.viewportSize = ko.observable({width: $(window).width(), height: $(window).height()});

            this.childrenComplete = function () {
                $page.removeClass('hrm-page--initializing');
            };

            this.date = ko.observable(moment().format('DD.MM.YYYY, dddd')).extend({
                required: {
                    message: 'Обязательное поле'
                },
                hrmDate: {
                    params: 'DD.MM.YYYY, dddd',
                    message: 'Неверный формат даты'
                }
            });

            this.isBuilt = ko.observable(false);

            this.formModel = ko.validatedObservable({
                positions: ko.observable([
                    {
                        name: 'Повар-пицмейкер',
                        workloadType: 1,
                        categories: null,
                        units: ko.observable(1),
                        workload: ko.observable(90),
                        employeeCount: 3,
                        estimatedHours: 36
                    },
                    {
                        name: 'Повар-сушист',
                        workloadType: 2,
                        categories: [
                            {name: 'Роллы открытые'},
                            {name: 'Роллы закрытые'},
                            {name: 'Гунканы'},
                            {name: 'Суши'},
                            {name: 'Сашими'}
                        ],
                        units: ko.observable(2),
                        workload: ko.observable(10000),
                        employeeCount: 3,
                        estimatedHours: 36
                    },
                    {
                        name: 'Мороженщик',
                        workloadType: 1,
                        categories: null,
                        units: ko.observable(3),
                        workload: ko.observable(2.2),
                        employeeCount: 3,
                        estimatedHours: 36
                    }
                ])
            });

            this.buildForecast = function () {
                this.isBuilt(true);
            };

            this.formControlErrorStateMatcher = function (formControl) {
                return ko.computed(() => {
                    return !formControl.isValid();
                });
            };

            this.footerTextHtml = ko.computed(() => {
               if (this.viewportSize().width <= HRM_BREAKPOINTS.mobileMaxWidth) {
                   return 'Авторизация позволит <b>настраивать<br> должности</b> и <b>сохранять параметры</b> таблиц для следующих расчетов';
               } else {
                   return 'Авторизация позволит <b>настраивать должности</b><br> и <b>сохранять параметры</b> таблиц для следующих расчетов';
               }
            });

            this.getWorkloadTypeName = function (workloadType) {
                switch (workloadType) {
                    case 1: return 'Объём товара по всему предприятию';
                    case 2: return 'Объём товара по категориям';
                }
            };

            this.getCategoriesTooltipText = function (categories) {
                return categories.map(c => c.name).join(', ');
            };

            (() => {
                $(window).on('resize', this.windowResizeHandler);
            })();
        };

        const viewModel = new ViewModel();

        ViewModel.prototype.dispose = function() {
            $(window).off('resize', this.windowResizeHandler);
            this.subscriptions.forEach(s => s.dispose());
        };

        ko.applyBindings(
            viewModel,
            $page.get()[0]
        );
    });
</script>