<script type="text/javascript">
  $(function () {
    const $page = $(document.documentElement);

    const ViewModel = function (defaultPositions, settings) {
      /** Initialization */
      (() => {
        this.subscriptions = [];
        this.viewportSize = ko.observable({ width: $(window).width(), height: $(window).height() });
        this.windowResizeHandler = () => {
          this.viewportSize({ width: $(window).width(), height: $(window).height() });
        };
        this.childrenComplete = function () {
          $page.removeClass('hrm-page--initializing');
        };
        this.modalOpens = ko.observableArray([]);

        this.settings = {
          openModal: (modal) => { this.modalOpens.push(modal) },
          viewportSize: this.viewportSize
        }
      })();

      this.summaryModel = (() => {
        const positions = ko.observableArray([]);
        return {
          positions,
        }
      })();
      this.updateSummary = (positionsList) => {
        const positions = positionsList.map(position => {
          return createPositionModel(position)
        });
        this.summaryModel.positions(positions);
      }
      this.updateSummary(defaultPositions);

      this.inputModel = {
        filial: ko.observable(''),
        date: ko.observable(moment().format('DD.MM.YYYY, dddd')),
        shift: ko.observable(''),
        interval: {
          start: ko.observable(''),
          end: ko.observable(''),
        }
      };

      /** Calculation created */
      this.isBuilt = ko.observable(false);
      /** Получение данных для расчета */
      this.buildCalculation = () => {
        /** Данные */
        const inputData = ko.toJS(this.inputModel);

        /* Получение списка позиций */
        const positions = [
          {
            name: 'Администратор филиала',
            id: 1,
            type: 'production',
            workloadType: 'Выручка',
            workload: 0,
            units: '₽',
            additionalWorkload: 'Время без дела 0%',
            fotCategory: 0,
            fotRevenue: 0,
            performanceStandart: -100,
            lateness: {
              green: 0,
              yellow: 0,
              red: 0
            },
            employees: [
              {
                name: 'Администратор #1',
                id: '1'
              }
            ]
          },
          {
            name: 'Повар-сушист',
            id: 3,
            type: 'production',
            workloadType: 'Выручка',
            workload: 0,
            units: '₽',
            additionalWorkload: 'Время без дела 0%',
            fotCategory: 0,
            fotRevenue: 0,
            performanceStandart: -100,
            lateness: {
              green: 0,
              yellow: 0,
              red: 0
            },
            employees: [
              {
                name: 'Сушист #1',
                id: '2'
              }
            ]
          },
          {
            name: 'Повар-пиццмейкер',
            id: 2,
            type: 'production',
            workloadType: 'Выручка',
            workload: 0,
            units: '₽',
            additionalWorkload: 'Время без дела 0%',
            fotCategory: 0,
            fotRevenue: 0,
            performanceStandart: -100,
            lateness: {
              green: 0,
              yellow: 0,
              red: 0
            },
            employees: [
              {
                name: 'Пиццмейкер #1',
                id: '3'
              },{
                name: 'Пиццмейкер #2',
                id: '4'
              }
            ]
          },
          {
            name: 'Официант',
            id: 4,
            type: 'production',
            workloadType: 'Выручка',
            workload: 0,
            units: '₽',
            additionalWorkload: 'Время без дела 0%',
            fotCategory: 0,
            fotRevenue: 0,
            performanceStandart: -100,
            lateness: {
              green: 0,
              yellow: 0,
              red: 0
            },
            employees: [
              {
                name: 'Официант #1',
                id: '5'
              }
            ]
          },
          {
            name: 'Водители',
            id: 5,
            type: 'delivery',
            workloadType: 'Выручка',
            workload: 0,
            units: '₽',
            additionalWorkload: '',
            fotCategory: 0,
            fotRevenue: 0,
            performanceStandart: -100,
            lateness: {
              green: 0,
              yellow: 0,
              red: 0
            },
            employees: [
              { name: 'Водитель #1', id: '6' },
              { name: 'Водитель #2', id: '6' },
              { name: 'Водитель #3', id: '6' }
            ]
          },
        ];

        /** Обновление представления */
        this.updateSummary(positions);
        this.isBuilt(true);
      };

      this.tabs = (() => {
        const tabs = [
          new HrmTabGroupItem('Производство'),
          new HrmTabGroupItem('Доставка'),
          new HrmTabGroupItem('Опоздания')
        ];

        const activeTab = ko.observable(0);

        const productionPositions = ko.pureComputed(() => {
          return this.summaryModel.positions()
          .filter(position => position().type === 'production');
        })

        return {
          tabs,
          activeTab,
          production: {
            positions: productionPositions,
          }
        }
      })();


      this.stimulation = (() => {
        function Stimulation() {
          return {
            base: ko.observable(''),
            author: ko.observable(''),
            sum: ko.observable(0),
            comment: ko.observable('')
          }
        }

        const fine = {
          production: Stimulation(),
          delivery: Stimulation()
        };
        const bonus = {
          production: Stimulation(),
          delivery: Stimulation()
        };

        const setStimulation = () => {
          this.modalOpens.push(createFineBonusModalDialog(
            (data) => {
              console.log('stimulation saved', data)
            }
          ))
        }

        return {
          fine,
          bonus,
          set: setStimulation
        }
      })();

      this.addEmployee = () => {
        /*const index = Math.floor(Math.random() * 1000);

        position.employees.push(this.createEmployeeModel({
          name: position.name + ' #' + index,
          workingIntervals: [''],
          rate: position.rate() !== '' ? position.rate() : 600,
          returnRate: 30,
          salaryBulk: 7200,
          bonus: 100,
          fine: 20
        }));*/

        this.modalOpens.push(createEmployeeModalDialog((data) => {
          console.log('employee saved', data);
        }));
      };

      this.addEmployees = () => {
        this.modalOpens.push(createEmployeesModalDialog({
          positions: this.summaryModel.positions
        }, (updatedPositionsList) => {
          console.log('after save', ko.toJS(updatedPositionsList))
          const originalPositionsList = this.summaryModel.positions();

          updatedPositionsList.forEach(updatedPosition => {
            const employees = updatedPosition.employees;
            const updatedIds = employees.map(e => e.id);

            const originalPosition = originalPositionsList.find(p => p().id === updatedPosition.id);

            const originalPositionEmployees = originalPosition().employees();
            const originalIds = originalPositionEmployees.map(e => e.id);


            const notFoundIds = _.difference(originalIds, updatedIds);
            const newEmployeesIds = _.difference(updatedIds, originalIds);

            // удалить тех, которых нет
            const updated = originalPositionEmployees.filter(e => notFoundIds.indexOf(e.id) === -1);

            // отметить видимость
            updated.forEach(e => {
              const updatedEmployee = employees.find(employee => employee.id === e.id);
              e.visible(updatedEmployee.checked);
            });

            // добавить новых
            newEmployees = newEmployeesIds.map(id => {
              const data = employees.find(e => e.id === id);
              const employee = createEmployeeModel(data, data.checked);
              return employee;
            });

            originalPosition().employees(updated.concat(newEmployees));
          });

          console.log('after merge', ko.toJS(this.summaryModel.positions))
        }));

      };





      this.isEmployeesCalculated = ko.observable(false);

      this.calculateEmployees = function () {
        this.isEmployeesCalculated(true);
      };

      this.recalculateEmployees = function () {
        this.isEmployeesCalculated(false);

        this.formModel().positions().forEach((position, index) => {
          position.employees(positions[index].employees.map(e => this.createEmployeeModel(e)));
        });

        this.isEmployeesCalculated(true);
      };

      this.addWorkingInterval = function (employee) {
        employee.workingIntervals.push(this.createEmployeeWorkingIntervalModel(''));
      };



      this.onRateInput = function (position) {
        position.employees().forEach(employee => {
          employee.rate(position.rate());
        });
      };

      this.onEmployeeRateInput = function (position) {
        position.rate('');
      };


      this.getWorkloadTypeName = function (workloadType) {
        switch (workloadType) {
          case 1: return 'Объём товара по всему предприятию';
          case 2: return 'Объём товара по категориям';
        }
      };

      this.getEmployeeWorkingHours = function (employee) {
        return ko.pureComputed(() => {
          if (employee.workingIntervalsValidationObject.isValid()) {
            return employee.workingIntervals().reduce((minutes, interval) => {
              const boundaries = interval.value().split(' – ').map(b => moment(b, 'HH:mm'));

              if (boundaries[0].isAfter(boundaries[1])) {
                boundaries[1].add(1, 'd');
              }

              return minutes + boundaries[1].diff(boundaries[0], 'minutes');
            }, 0);
          } else {
            return 0;
          }
        });
      };

      this.getEmployeeSalaryBulk = function (employee) {
        return ko.pureComputed(() => {
          const minutes = this.getEmployeeWorkingHours(employee)();

          return this.unmaskDecimal(employee.rate()) * (minutes / 60);
        });
      };

      this.getEmployeeSalary = function (employee) {
        return ko.pureComputed(() => {
          const bulk = this.getEmployeeSalaryBulk(employee)();
          const bonus = this.unmaskDecimal(employee.bonus());
          const fine = this.unmaskDecimal(employee.fine());

          return this.unmaskDecimal(bulk + bonus - fine);
        });
      };

      this.getPositionMaxWorkingIntervalCount = function (position) {
        return ko.pureComputed(() => {
          return Math.max(...position.employees().map(e => e.workingIntervals().length));
        });
      };

      this.getCategoriesTooltipText = function (categories) {
        return categories.map(c => c.name).join(', ');
      };

      this.getUnitsSuffixHtml = function (units) {
        switch (units) {
          case '1': return 'шт.';
          case '2': return '<i class="far fa-ruble-sign"></i>';
          case '3': return 'ч.';
        }
      };

      this.formatDecimal = function (value) {
        return Inputmask.format(value, { alias: 'decimal', digits: '2', groupSeparator: ' ', autoGroup: true, allowMinus: false }).replace('.00', '');
      };

      this.unmaskDecimal = function (value) {
        const result = Inputmask.unmask(value, { alias: 'decimal', digits: '2', groupSeparator: ' ', autoGroup: true, allowMinus: false, unmaskAsNumber: true });

        if (result === '') {
          return 0;
        }

        return result;
      };

      this.editableCellControlErrorExtractor = function (control) {
        return ko.pureComputed(() => {
          return !control.isValid() ? { message: control.error() } : null;
        });
      };

      this.formatDuration = function (minutes) {
        let h = Math.floor(minutes / 60).toString();
        h = h.length === 1 ? '0' + h : h;
        let m = (minutes % 60).toString();
        m = m.length === 1 ? '0' + m : m;

        return h + ':' + m;
      };

      this.isSidebarCollapsed = ko.observable(localStorage.getItem(HRM_SIDEBAR_COLLAPSED_LOCAL_STORAGE_KEY) === 'true');

      (() => {
        $(window).on('resize', this.windowResizeHandler);

        this.subscriptions.push(this.isSidebarCollapsed.subscribe(collapsed => {
          localStorage.setItem(HRM_SIDEBAR_COLLAPSED_LOCAL_STORAGE_KEY, collapsed);
        }));
      })();
    };


    ViewModel.prototype.dispose = function () {
      $(window).off('resize', this.windowResizeHandler);
      this.subscriptions.forEach(s => s.dispose());
    };

    /***** Model activation *******/
    const defaultPositions = [];
    const viewModel = new ViewModel(defaultPositions);

    ko.applyBindings(
      viewModel,
      $page.get()[0]
    );


    /*****/


    function createEmployeeModel(employee, visible) {
      return {
        name: employee.name,
        id: employee.id,
        visible: ko.observable(!!visible),
      }
    }

    function createPositionModel(positionData) {
      const visible = ko.observable(false);
      const employees = ko.observableArray(positionData.employees.map((e) => createEmployeeModel(e, false)));

      return ko.observable({
        ...positionData,
        employees,
        visible
      });
    };



    function createFineBonusModalDialog(onSave) {
      return {
        dialogTemplateName: 'calculation-settings-stimulation-modal-template',
        options: {
          modalClass: 'calculation-modal calculation-page__stimulation-modal'
        },
        close: result => {
          if (result !== undefined) {
            onSave(result);
          }
        }
      }
    }

    function createEmployeeModalDialog(onSave) {
      return {
        dialogTemplateName: 'calculation-settings-employee-form-modal-template',
        options: {
          modalClass: 'calculation-modal calculation-page__employee-modal'
        },
        close: result => {
          if (result !== undefined) {
            onSave(result);
          }
        }
      }
    }

    function createEmployeesModalDialog(data, onSave) {
      return {
        dialogTemplateName: 'calculation-settings-employees-form-modal-template',
        data: data,
        options: {
          modalClass: 'calculation-modal calculation-page__employees-modal'
        },
        close: result => {
          if (result !== undefined) {
            onSave(result);
          }
        }
      }
    }
  });
</script>
