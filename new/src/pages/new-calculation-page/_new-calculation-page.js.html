<script type="text/javascript">
  // Справочники
  window.directories = {
    fines: [
      {
        name: 'Группа 1',
        items: [
          {
            id: '1',
            name: 'Основание штрафа 1',
            sum: 200
          },
          {
            id: '2',
            name: 'Основание штрафа 2',
            sum: 300
          }
        ]
      },
      {
        name: 'Группа 2',
        items: [
          {
            id: '3',
            name: 'Основание штрафа 3',
            sum: 200
          },
          {
            id: '4',
            name: 'Основание штрафа 4',
            sum: 300
          }
        ]
      },
    ],
    bonuses: [
      {
        name: 'Группа 1',
        items: [
          {
            id: '1',
            name: 'Основание премии 1',
            sum: 200
          },
          {
            id: '2',
            name: 'Основание премии 2',
            sum: 300
          }
        ]
      },
      {
        name: 'Группа 2',
        items: [
          {
            id: '3',
            name: 'Основание премии 3',
            sum: 200
          },
          {
            id: '4',
            name: 'Основание премии 4',
            sum: 300
          }
        ]
      },
    ],
    authors: [
      {
        id: 1,
        name: 'Иван Иванов'
      }, {
        id: 2,
        name: 'Петр Петров'
      }, {
        id: 3,
        name: 'Николай Николаев'
      }, {
        id: 4,
        name: 'Сергей Сергеев'
      }
    ],
  };

  $(function () {
    const $page = $(document.documentElement);

    const PositionsModel = function (root) {
      const positions = ko.observableArray([]);

      const driversData = ko.observable();

      /**
      * Returns position with specified id
      * @param {string|number} id
      * @returns {Observable}
      */
      function getPositionById(id) {
        return positions().find(position => position.id === id);
      }

      /**
      * Creates new positions list from data
      * @param {Object[]} positionsList
      */
      function setPositions(positionsList) {
        positions(positionsList.map(positionData => {
          return new PositionModel(positionData, root)
        }))
      }


      function setDriversData(driversData) {
        this.driversData(new PositionModel(driversData, root));
      }

      /**
      * @params {string} interval
      * @returns {{value: Observable, getInterval: function}}
      */
      function WorkingIntervalModel(interval) {
        const value = ko.observable(interval).extend({
          required: {
            message: 'Обязательное поле'
          },
          validation: {
            validator: value => {

              if (!/^\d\d:\d\d – \d\d:\d\d$/.test(value)) {
                return false;
              } else {
                const boundaries = value.split(' – ');

                if (boundaries[0] === boundaries[1]) {
                  return false;
                }

                return boundaries.every(b => moment(b, 'HH:mm', true).isValid());
              }
            },
            message: 'Неверный формат интервала'
          }
        });

        /**
        * @returns {number}
        */
        function getInterval() {
          const boundaries = value().split(' – ').map(b => moment(b, 'HH:mm'));

          if (boundaries[0].isAfter(boundaries[1])) {
            boundaries[1].add(1, 'd');
          }

          return boundaries[1].diff(boundaries[0], 'minutes');
        }

        return {
          value,
          getInterval
        };
      }


      function EmployeeModel(employee, positionModel, visible) {
        this.position = positionModel;
        this.root = this.position.root;

        this.name = employee.name;                   // имя сотрудника
        this.id = employee.id;                       // идентификатор сотрудника
        this.link = employee.link;                   // ссылка на личное дело

        this.level = ko.observable(employee.level);  // разряд
        this.level.subscribe(_ => this.root.calculate());

        this.hasProblems = employee.hasProblems;                         // есть проблемы с документами
        this.upRecommended = ko.observable(employee.upRecommended);      // рекомендуется повышение
        this.downRecommended = ko.observable(employee.downRecommended);  // рекомендуется понижение

        // рабочее время
        const defaultIntervals = employee.workingIntervals || ['11:00 – 23:00'];
        this.workingIntervals = ko.observableArray(
          defaultIntervals.map(i => WorkingIntervalModel(i))
        );
        const isWorkingIntervalsValid = ko.pureComputed(() => {
          return this.workingIntervals().every(i => i.value.isValid())
        });
        this.workingTime = ko.pureComputed(() => {
          if (!isWorkingIntervalsValid()) return 0;

          return this.workingIntervals().reduce((minutes, interval) => {
            return minutes + interval.getInterval();
          }, 0);
        });
        this.addWorkingInterval = () => {
          const model = WorkingIntervalModel('');
          this.workingIntervals.push(model);
        };
        this.removeWorkingInterval = (interval) => {
          this.workingIntervals.remove(interval);
        };

        this.workingIntervals.subscribe(_ => this.root.calculate());

        this.account = ko.observable(employee.account || 0);             // личный счет
        this.premiumAccount = ko.observable(employee.account || 0);      // премиальный счет

        // операции с ЛС
        this.accountOperations = ko.observableArray(employee.accountOperations || []);
        this.accountState = ko.pureComputed(() => {
          return this.accountOperations().reduce((sum, operation) => {
            const operationSum = operation.type === 'fine' ? operation.sum * -1 : operation.sum;
            return sum + operationSum;
          }, 0);
        });

        this.accountOperations.subscribe(_ => this.root.calculate());

        // штрафы
        this.fines = ko.observableArray(employee.fines || []);
        this.finesState = ko.pureComputed(() => {
          return this.fines().reduce((sum, fine) => {
            return sum + fine.sum;
          }, 0);
        });

        this.fines.subscribe(_ => this.root.calculate());

        // бонусы
        this.bonuses = ko.observableArray(employee.bonuses || []);
        this.bonusesState = ko.pureComputed(() => {
          return this.bonuses().reduce((sum, bonus) => {
            return sum + bonus.sum;
          }, 0);
        });

        this.bonuses.subscribe(_ => this.root.calculate());

        // компенсация
        this.compensation = ko.observable(employee.compensation || '');

        this.workload = ko.observable(employee.workload || '');
        this.workloadUnits = this.position.workloadUnits;

        this.salary = ko.observable(employee.salary || this.positionSalary);
        this.salaryBulk = ko.observable(employee.salaryBulk || this.positionSalaryBulk);

        this.revenueStandartUnits = employee.revenueStandartUnits || this.position.revenueStandartUnits;
        this.revenueStandartPerHour = ko.observable(employee.revenueStandartPerHour || this.position.revenueStandartUnits);
        this.revenueStandart = ko.observable(employee.revenueStandart || this.position.revenueStandart);

        this.normalizationRatio = employee.normalizationRatio || this.position.normalizationRatio;
        this.bonusRatio = employee.bonusRatio || this.position.bonusRatio;

        this.bonusExceed = ko.observable(employee.bonusExceed || '');
        this.depremation = ko.observable(employee.depremation || '');

        this.correctedTime = ko.observable(employee.correctedTime || this.position.correctedTime);

        // опоздания
        this.lateness = {
          light: ko.observable(0),
          medium: ko.observable(0),
          hard: ko.observable(0),
          total: ko.observable(0),
        };
        if (employee.lateness) {
          this.lateness.light(employee.lateness.light);
          this.lateness.medium(employee.lateness.medium);
          this.lateness.hard(employee.lateness.hard);
          this.lateness.total(employee.lateness.light + employee.lateness.medium + employee.lateness.hard);
        }

        this.total = ko.observable(employee.total || 0);
        this.toPayment = ko.observable(employee.toPayment || 0);

        this.visible = ko.observable(!!visible) // участвует в расчете
        this.visible.subscribe(_ => this.root.calculate());

        this.loaded = employee.loaded; // загружен для Все филиалы
      }

      /**
      * @param {Object} positionData
      */
      function PositionModel(positionData, root) {
        this.root = root;

        this.type = positionData.type || 'production';

        this.id = positionData.id;
        this.name = positionData.name;
        this.levels = positionData.levels; // разряды

        // нагрузка
        this.workloadType = positionData.workloadType;
        this.workload = ko.observable(positionData.workload);
        this.workloadUnits = positionData.workloadUnits;

        this.workload.subscribe(v => {
          root.calculate();
        });

        // доп. нагрузка
        this.additionalWorkloadType = positionData.additionalWorkloadType;
        this.additionalWorkload = ko.observable(positionData.additionalWorkload);
        this.additionalWorkloadUnits = positionData.additionalWorkloadUnits;

        // ФОТ, % в категории
        this.fotCategory = ko.observable(positionData.fotCategory);

        // ФОТ, % от выручки
        this.fotRevenue = ko.observable(positionData.fotRevenue);

        this.salary = positionData.salary; // оклад
        this.salaryBulk = positionData.salaryBulk; // основная часть зарплаты

        this.revenueStandart = positionData.revenueStandart; // Норматив выручки
        this.revenueStandartPerHour = positionData.revenueStandartPerHour; // Норматив выручки в час
        this.revenueStandartUnits = positionData.revenueStandartUnits; // Единицы измерения

        // Норм. выработки
        this.performanceStandart = ko.observable(positionData.performanceStandart);
        this.performanceStandartType = positionData.performanceStandartType;
        this.performanceStandartUnits = positionData.performanceStandartUnits;

        this.visible = ko.observable(positionData.visible); // Отображается в таблице
        this.visible.subscribe(_ => this.root.calculate());

        this.employees = ko.observableArray(positionData.employees.map((e) => new EmployeeModel(e, this, false)));

        this.visibleEmployees = ko.pureComputed(() => {
          return this.employees().filter(e => e.visible());
        });

        this.allEmployeesLoaded = ko.observable(false);

        this.workingTime = ko.pureComputed(() => {
          return this.employees().reduce((minutes, employee) => {
            if (!employee.visible()) return minutes;
            return minutes + employee.workingTime();
          }, 0)
        });

        this.findEmployeeById = (employeeId) => {
          return this.employees().find(employee => employee.id === employeeId);
        };

        this.addEmployee = (employee) => {
          this.employees.push(new EmployeeModel(employee, this, 'visible'));
          this.root.calculate();
        };

        this.updateEmployees = (updatedList) => {
          const updatedIds = updatedList.map(e => e.id);
          const originalIds = this.employees().map(e => e.id);

          const notFoundIds = _.difference(originalIds, updatedIds);
          const newEmployeesIds = _.difference(updatedIds, originalIds);

          // remove not found-s
          const updated = this.employees().filter(e => notFoundIds.indexOf(e.id) === -1);

          // set visibility
          updated.forEach(employee => {
            const updatedEmployeeData = updatedList.find(updatedEmployee => updatedEmployee.id == employee.id);
            employee.visible(updatedEmployeeData.checked);
          });

          // add new-s
          const newEmployees = newEmployeesIds.map(id => {
            const employeeData = updatedList.find(e => e.id === id);
            const employee = new EmployeeModel(employeeData, this, employeeData.checked);
            return employee;
          });

          // update list
          this.employees(updated.concat(newEmployees));
        }

        this.lateness = ko.pureComputed(() => {
          const result = {
            light: 0,
            medium: 0,
            hard: 0,
            total: 0,
          };
          this.employees().forEach(employee => {
            const employeeLateness = employee.lateness;
            result.light += employeeLateness.light() || 0;
            result.medium += employeeLateness.medium() || 0;
            result.hard += employeeLateness.hard() || 0;
            result.total += result.light + result.medium + result.hard;
          });

          return result;
        });

        this.totalLateness = ko.pureComputed(() => {
          return lateness.total;
        });
      };

      const productionTotal = {
        workingTime: ko.observable('00:00'),
        salaryBulk: ko.observable(0),
        normalizationRatio: ko.observable(0),
        revenueStandart: ko.observable(0),
        bonusRatio: ko.observable(0),
        correctedTime: ko.observable(0),
        bonusExceed: ko.observable(0),
        total: ko.observable(0),
        toPayment: ko.observable(0),
      };

      const total = {
        workload: ko.observable(0),
        workloadUnits: ko.observable(''),
        fotCategory: ko.observable(100),
        fotRevenue: ko.observable(100),
        performanceStandart: ko.observable(-100),
        lateness: {
          light: ko.observable(0),
          medium: ko.observable(0),
          hard: ko.observable(0),
          total: ko.observable(0),
        },
        employees: ko.observable(0)
      };

      return {
        positions,
        driversData,
        setPositions,
        setDriversData,
        getPositionById,
        productionTotal,
        total
      }
    }

    const ViewModel = function (defaultPositions, settings) {
      /** Initialization */
      (() => {
        this.subscriptions = [];
        const viewportSize = ko.observable({ width: $(window).width(), height: $(window).height() });
        this.windowResizeHandler = () => {
          viewportSize({ width: $(window).width(), height: $(window).height() });
        };
        this.childrenComplete = function () {
          $page.removeClass('hrm-page--initializing');
        };
        this.modalOpens = ko.observableArray([]);

        this.utils = {
          openModal: (id, data, onSave) => {
            const modal = createModalDialog(id, data, onSave);
            this.modalOpens.push(modal)
          },

          formatSign: (number) => {
            const formattedNumber = parseFloat(ko.unwrap(number));
            if (!formattedNumber) return number;
            if (formattedNumber > 0) return '+' + formattedNumber;
            return formattedNumber;
          },

          viewportSize: viewportSize
        }
      })();

      this.summaryModel = new PositionsModel(this);
      this.summaryModel.setPositions(defaultPositions);


      this.summaryModel.setDriversData({
        type: 'delivery',
        name: 'Водители',                           // название должности
        id: 'drivers',                              // идентификато позиции
        levels: [1, 2],                             // разряды
        workloadType: 'Выручка',                    // тип нагрузки
        workload: 0,                                // нагрузка (величина)
        workloadUnits: '₽',                         // единицы измерения нагрузки
        additionalWorkloadType: '',                 // тип доп. нагрузки
        additionalWorkload: '52',                   // доп. нагрузка (величина)
        additionalWorkloadUnits: '',                // единицы измерения доп. нагрузки
        fotCategory: 0,                             // ФОТ, % в категории
        fotRevenue: 0,                              // ФОТ, % от выручки
        performanceStandart: 0,                     // Норм. выработки, %
        performanceStandartType: 'Цена заказа',
        performanceStandartUnits: '₽',
        salary: 30000,                              // Оклад
        salaryBulk: 7200,                           // основная часть зарплаты
        revenueStandart: 30,                        // Норматив выручки
        revenueStandartPerHour: 0,
        revenueStandartUnits: '₽',
        employees: [                                // сотрудники
          {
            name: 'Водитель #1',                    // имя сотрудника
            id: 'driver1',                          // идентификатор сотрудника
            link: '#',                              // ссылка на личное дело
            hasProblems: 0,                         // проблемы с документами
            upRecommended: 0,                       // рекомендуется повышение
            downRecommended: 0,                     // рекомендуется понижение
            premiumAccount: 0,                      // премиальный счет
            account: 100,                           // личный счет
            accountOperations: [],                  // операции со счетом
            level: 1,                               // разряд сотрудника
            workingIntervals: ['09:00 – 16:00'],    // рабочее время сотрудника
            compensation: 0,                        // компенсация
            workload: 0,                            // нагрузка
            workloadUnits: '₽',
            salary: 3000,                           // зарплата
            salaryBulk: 2000,                       // основная часть зарплаты
            revenueStandartUnits: '₽',
            revenueStandartPerHour: 10000,          // норматив выручки в час
            revenueStandart: 130000,                // Норматив выручки
            normalizationRatio: 0.5,                // Коэф. нормализации
            bonusRatio: 0.5,                        // Коэф. премирования
            bonusExceed: 100,                       // прем. за превыш. норм
            bonuses: [],                            // бонусы
            fines: [],                              // штрафы
            depremation: 0,                         // депр.
            correctedTime: '6:00',                  // корр. время
            total: 7300,                            // всего
            toPayment: 7300,                        // к выплате
            lateness: {                             // опоздания сотрудника
              light: 0,                             // меньше 5 минут
              medium: 0,                            // 5-10 минут
              hard: 0                               // больше 10 минут
            },
          },
          {
            name: 'Водитель #2',
            id: 'driver2',
            link: '#',
            hasProblems: 0,
            upRecommended: 0,
            downRecommended: 0,
            premiumAccount: 100,
            account: 0,
            accountOperations: [],
            level: 2,
            workingIntervals: ['09:00 – 16:00'],
            compensation: 0,
            workload: 0,
            workloadUnits: '₽',
            salary: 3000,
            salaryBulk: 2000,
            revenueStandartUnits: '₽',
            revenueStandartPerHour: 10000,
            revenueStandart: 130000,
            normalizationRatio: 0.5,
            bonusRatio: 0.5,
            bonusExceed: 100,
            bonuses: [],
            fines: [],
            depremation: 0,
            correctedTime: '6:00',
            total: 7300,
            toPayment: 7300,
            lateness: {
              light: 0,
              medium: 0,
              hard: 0
            },
          }
        ],
      });


      /** Input data */
      this.inputModel = {
        filial: ko.observable(''),
        date: ko.observable(moment().format('DD.MM.YYYY')),
        shift: ko.observable(''),
        interval: {
          start: ko.observable(''),
          end: ko.observable(''),
        }
      };

      /** Calculation */
      this.isBuilt = ko.observable(false);
      this.loading = ko.observable(false);
      /** Get data for calculation */
      this.buildCalculation = () => {
        this.loading(true);
        const inputData = ko.toJS(this.inputModel);

        // Показывать лоадер 3с
        const delay = 3000
        const loadingDelay = new Promise(resolve => {
          setTimeout(() => {
            resolve();
          }, delay);
        });

        setTimeout(() => {
          /* Получение списка позиций */
          const positions = [
            {
              name: 'Администратор филиала',             // название должности
              id: '1',                                   // идентификато позиции
              levels: [1, 2],                            // разряды
              workloadType: 'Выручка',                   // тип нагрузки
              workload: 0,                               // нагрузка (величина)
              workloadUnits: '₽',                        // единицы измерения нагрузки
              additionalWorkloadType: 'Время без дела',  // тип доп. нагрузки
              additionalWorkload: '0',                   // доп. нагрузка (величина)
              additionalWorkloadUnits: '%',              // единицы измерения доп. нагрузки
              fotCategory: 0,                            // ФОТ, % в категории
              fotRevenue: 0,                             // ФОТ, % от выручки
              performanceStandart: 0,                    // Норм. выработки, %
              performanceStandartType: '',               //
              salary: 30000,                             // Оклад
              salaryBulk: 7200,                          // основная часть зарплаты
              revenueStandart: 30,                       // Норматив выручки
              revenueStandartPerHour: 0,
              revenueStandartUnits: '₽',
              employees: [                               // сотрудники
                {
                  name: 'Администратор #1 Up',            // имя сотрудника
                  id: '11',                               // идентификатор сотрудника
                  link: '#',                              // ссылка на личное дело
                  hasProblems: 0,                         // проблемы с документами
                  upRecommended: 1,                       // рекомендуется повышение
                  downRecommended: 0,                     // рекомендуется понижение
                  premiumAccount: 100,                    // премиальный счет
                  account: 0,                             // личный счет
                  accountOperations: [],                  // операции со счетом
                  level: 1,                               // разряд сотрудника
                  workingIntervals: ['09:00 – 16:00'],    // рабочее время сотрудника
                  compensation: 0,                        // компенсация
                  workload: 0,                            // нагрузка
                  workloadUnits: '₽',
                  salary: 3000,                           // зарплата
                  salaryBulk: 2000,                       // основная часть зарплаты
                  revenueStandartUnits: '₽',
                  revenueStandartPerHour: 10000,          // норматив выручки в час
                  revenueStandart: 130000,                // Норматив выручки
                  normalizationRatio: 0.5,                // Коэф. нормализации
                  bonusRatio: 0.5,                        // Коэф. премирования
                  bonusExceed: 100,                       // прем. за превыш. норм
                  bonuses: [],                            // бонусы
                  fines: [],                              // штрафы
                  depremation: 0,                         // депр.
                  correctedTime: '6:00',                  // корр. время
                  total: 7300,                            // всего
                  toPayment: 7300,                        // к выплате
                  lateness: {                             // опоздания сотрудника
                    light: 0,                             // меньше 5 минут
                    medium: 0,                            // 5-10 минут
                    hard: 0                               // больше 10 минут
                  },
                },
                {
                  name: 'Администратор #2 Down',
                  id: '12',
                  link: '#',
                  hasProblems: 0,
                  upRecommended: 0,
                  downRecommended: 1,
                  premiumAccount: 100,
                  account: 0,
                  accountOperations: [],
                  level: 2,
                  workingIntervals: ['09:00 – 16:00'],
                  compensation: 0,
                  workload: 0,
                  workloadUnits: '₽',
                  salary: 3000,
                  salaryBulk: 2000,
                  revenueStandartUnits: '₽',
                  revenueStandartPerHour: 10000,
                  revenueStandart: 130000,
                  normalizationRatio: 0.5,
                  bonusRatio: 0.5,
                  bonusExceed: 100,
                  bonuses: [],
                  fines: [],
                  depremation: 0,
                  correctedTime: '6:00',
                  total: 7300,
                  toPayment: 7300,
                  lateness: {
                    light: 0,
                    medium: 0,
                    hard: 0
                  },
                }
              ],
              visible: 0,
            },
            {
              name: 'Повар-сушист',
              id: '2',
              levels: [],
              workloadType: 'Выручка',
              workload: 0,
              workloadUnits: '₽',
              additionalWorkloadType: 'Лосось, кг',
              additionalWorkload: 200,
              additionalWorkloadUnits: '',
              fotCategory: 0,
              fotRevenue: 0,
              performanceStandart: 0,
              performanceStandartType: '',
              salary: 30000,
              salaryBulk: 7200,
              revenueStandart: 30,
              revenueStandartPerHour: 0,
              revenueStandartUnits: '₽',
              employees: [
                {
                  name: 'Повар-сушист #1 problems',
                  id: '21',
                  link: '#',
                  hasProblems: 1,
                  upRecommended: 0,
                  downRecommended: 0,
                  premiumAccount: 100,
                  account: 3000,
                  accountOperations: [],
                  level: 0,
                  workingIntervals: ['09:00 – 16:00'],
                  compensation: 0,
                  workload: 0,
                  workloadUnits: '₽',
                  salary: 3000,
                  salaryBulk: 2000,
                  revenueStandartUnits: '₽',
                  revenueStandartPerHour: 10000,
                  revenueStandart: 130000,
                  normalizationRatio: 0.5,
                  bonusRatio: 0.5,
                  bonusExceed: 100,
                  bonuses: [],
                  fines: [],
                  depremation: 0,
                  correctedTime: '6:00',
                  total: 7300,
                  toPayment: 7300,
                  lateness: {
                    light: 0,
                    medium: 0,
                    hard: 0
                  },
                },
                {
                  name: 'Повар-сушист #2 problems + up',
                  id: '22',
                  link: '#',
                  hasProblems: 1,
                  upRecommended: 1,
                  downRecommended: 0,
                  premiumAccount: 100,
                  account: 3000,
                  accountOperations: [],
                  level: 0,
                  workingIntervals: ['09:00 – 16:00'],
                  compensation: 0,
                  workload: 0,
                  workloadUnits: '₽',
                  salary: 3000,
                  salaryBulk: 2000,
                  revenueStandartUnits: '₽',
                  revenueStandartPerHour: 10000,
                  revenueStandart: 130000,
                  normalizationRatio: 0.5,
                  bonusRatio: 0.5,
                  bonusExceed: 100,
                  bonuses: [],
                  fines: [],
                  depremation: 0,
                  correctedTime: '6:00',
                  total: 7300,
                  toPayment: 7300,
                  lateness: {
                    light: 0,
                    medium: 0,
                    hard: 0
                  },
                }
              ],
              visible: 0,
            },
            {
              name: 'Повар-пиццмейкер',
              id: '3',
              levels: [1, 2, 3],
              workloadType: 'Пиццы',
              workload: 30,
              workloadUnits: 'шт.',
              additionalWorkloadType: 'Лосось, кг',
              additionalWorkload: 200,
              additionalWorkloadUnits: '',
              fotCategory: 0,
              fotRevenue: 0,
              performanceStandart: 0,
              performanceStandartType: '',
              salary: 30000,
              salaryBulk: 7200,
              revenueStandart: 30,
              revenueStandartPerHour: 0,
              revenueStandartUnits: '₽',
              employees: [
                {
                  name: 'Повар-пиццмейкер #1 problems + down',
                  id: '31',
                  link: '#',
                  hasProblems: 1,
                  upRecommended: 0,
                  downRecommended: 1,
                  premiumAccount: 100,
                  account: 3000,
                  accountOperations: [],
                  level: 1,
                  workingIntervals: ['09:00 – 16:00'],
                  compensation: 0,
                  workload: 0,
                  workloadUnits: '₽',
                  salary: 3000,
                  salaryBulk: 2000,
                  revenueStandartUnits: '₽',
                  revenueStandartPerHour: 10000,
                  revenueStandart: 130000,
                  normalizationRatio: 0.5,
                  bonusRatio: 0.5,
                  bonusExceed: 100,
                  bonuses: [],
                  fines: [],
                  depremation: 0,
                  correctedTime: '6:00',
                  total: 7300,
                  toPayment: 7300,
                  lateness: {
                    light: 0,
                    medium: 0,
                    hard: 0
                  },
                },
                {
                  name: 'Повар-пиццмейкер #2',
                  id: '32',
                  link: '#',
                  hasProblems: 0,
                  upRecommended: 0,
                  downRecommended: 0,
                  premiumAccount: 100,
                  account: 3000,
                  accountOperations: [],
                  level: 3,
                  workingIntervals: ['09:00 – 16:00'],
                  compensation: 0,
                  workload: 0,
                  workloadUnits: '₽',
                  salary: 3000,
                  salaryBulk: 2000,
                  revenueStandartUnits: '₽',
                  revenueStandartPerHour: 10000,
                  revenueStandart: 130000,
                  normalizationRatio: 0.5,
                  bonusRatio: 0.5,
                  bonusExceed: 100,
                  bonuses: [],
                  fines: [],
                  depremation: 0,
                  correctedTime: '6:00',
                  total: 7300,
                  toPayment: 7300,
                  lateness: {
                    light: 0,
                    medium: 0,
                    hard: 0
                  },
                }
              ],
              visible: 0,
            },
            {
              name: 'Официант',
              id: '4',
              levels: [1, 2],
              workloadType: 'Выручка',
              workload: 0,
              workloadUnits: '₽',
              additionalWorkloadType: '',
              additionalWorkload: 0,
              additionalWorkloadUnits: '',
              fotCategory: 0,
              fotRevenue: 0,
              performanceStandart: 0,
              performanceStandartType: '',
              salary: 30000,
              salaryBulk: 7200,
              revenueStandart: 30,
              revenueStandartPerHour: 0,
              revenueStandartUnits: '₽',
              employees: [
                {
                  name: 'Официант #1',
                  id: '41',
                  link: '#',
                  hasProblems: 0,
                  upRecommended: 0,
                  downRecommended: 0,
                  premiumAccount: 100,
                  account: 3000,
                  accountOperations: [],
                  level: 1,
                  workingIntervals: ['09:00 – 16:00'],
                  compensation: 0,
                  workload: 0,
                  workloadUnits: '₽',
                  salary: 3000,
                  salaryBulk: 2000,
                  revenueStandartUnits: '₽',
                  revenueStandartPerHour: 10000,
                  revenueStandart: 130000,
                  normalizationRatio: 0.5,
                  bonusRatio: 0.5,
                  bonusExceed: 100,
                  bonuses: [],
                  fines: [],
                  depremation: 0,
                  correctedTime: '6:00',
                  total: 7300,
                  toPayment: 7300,
                  lateness: {
                    light: 0,
                    medium: 0,
                    hard: 0
                  },
                },
                {
                  name: 'Официант #2',
                  id: '42',
                  link: '#',
                  hasProblems: 0,
                  upRecommended: 0,
                  downRecommended: 0,
                  premiumAccount: 100,
                  account: 3000,
                  accountOperations: [],
                  level: 2,
                  workingIntervals: ['09:00 – 16:00'],
                  compensation: 0,
                  workload: 0,
                  workloadUnits: '₽',
                  salary: 3000,
                  salaryBulk: 2000,
                  revenueStandartUnits: '₽',
                  revenueStandartPerHour: 10000,
                  revenueStandart: 130000,
                  normalizationRatio: 0.5,
                  bonusRatio: 0.5,
                  bonusExceed: 100,
                  bonuses: [],
                  fines: [],
                  depremation: 0,
                  correctedTime: '6:00',
                  total: 7300,
                  toPayment: 7300,
                  lateness: {
                    light: 0,
                    medium: 0,
                    hard: 0
                  },
                }
              ],
              visible: 0,
            },
            {
              name: 'Официант2',
              id: '5',
              levels: [1, 2],
              workloadType: 'Выручка',
              workload: 0,
              workloadUnits: '₽',
              additionalWorkloadType: '',
              additionalWorkload: 0,
              additionalWorkloadUnits: '',
              fotCategory: 0,
              fotRevenue: 0,
              performanceStandart: 0,
              performanceStandartType: '',
              salary: 30000,
              salaryBulk: 7200,
              revenueStandart: 30,
              revenueStandartPerHour: 0,
              revenueStandartUnits: '₽',
              employees: [
                {
                  name: 'Официант #1',
                  id: '51',
                  link: '#',
                  hasProblems: 0,
                  upRecommended: 0,
                  downRecommended: 0,
                  premiumAccount: 100,
                  account: 3000,
                  accountOperations: [],
                  level: 1,
                  workingIntervals: ['09:00 – 16:00'],
                  compensation: 0,
                  workload: 0,
                  workloadUnits: '₽',
                  salary: 3000,
                  salaryBulk: 2000,
                  revenueStandartUnits: '₽',
                  revenueStandartPerHour: 10000,
                  revenueStandart: 130000,
                  normalizationRatio: 0.5,
                  bonusRatio: 0.5,
                  bonusExceed: 100,
                  bonuses: [],
                  fines: [],
                  depremation: 0,
                  correctedTime: '6:00',
                  total: 7300,
                  toPayment: 7300,
                  lateness: {
                    light: 0,
                    medium: 0,
                    hard: 0
                  },
                },
                {
                  name: 'Официант #2',
                  id: '52',
                  link: '#',
                  hasProblems: 0,
                  upRecommended: 0,
                  downRecommended: 0,
                  premiumAccount: 100,
                  account: 3000,
                  accountOperations: [],
                  level: 2,
                  workingIntervals: ['09:00 – 16:00'],
                  compensation: 0,
                  workload: 0,
                  workloadUnits: '₽',
                  salary: 3000,
                  salaryBulk: 2000,
                  revenueStandartUnits: '₽',
                  revenueStandartPerHour: 10000,
                  revenueStandart: 130000,
                  normalizationRatio: 0.5,
                  bonusRatio: 0.5,
                  bonusExceed: 100,
                  bonuses: [],
                  fines: [],
                  depremation: 0,
                  correctedTime: '6:00',
                  total: 7300,
                  toPayment: 7300,
                  lateness: {
                    light: 0,
                    medium: 0,
                    hard: 0
                  },
                }
              ],
              visible: 0,
            },
            {
              name: 'Официант3',
              id: '6',
              levels: [1, 2],
              workloadType: 'Выручка',
              workload: 0,
              workloadUnits: '₽',
              additionalWorkloadType: '',
              additionalWorkload: 0,
              additionalWorkloadUnits: '',
              fotCategory: 0,
              fotRevenue: 0,
              performanceStandart: 0,
              performanceStandartType: '',
              salary: 30000,
              salaryBulk: 7200,
              revenueStandart: 30,
              revenueStandartPerHour: 0,
              revenueStandartUnits: '₽',
              employees: [],
              visible: 0,
            },
            {
              name: 'Официант4',
              id: '7',
              levels: [1, 2],
              workloadType: 'Выручка',
              workload: 0,
              units: '₽',
              additionalWorkloadType: '',
              additionalWorkload: 0,
              additionalWorkloadUnits: '',
              fotCategory: 0,
              fotRevenue: 0,
              performanceStandart: 0,
              performanceStandartType: '',
              salary: 30000,
              salaryBulk: 7200,
              revenueStandart: 30,
              revenueStandartPerHour: 0,
              revenueStandartUnits: '₽',
              employees: [],
              visible: 0,
            },
            {
              name: 'Официант5',
              id: '8',
              levels: [1, 2],
              workloadType: 'Выручка',
              workload: 0,
              workloadUnits: '₽',
              additionalWorkloadType: '',
              additionalWorkload: 0,
              additionalWorkloadUnits: '',
              fotCategory: 0,
              fotRevenue: 0,
              performanceStandart: 0,
              performanceStandartType: '',
              salary: 30000,
              salaryBulk: 7200,
              revenueStandart: 30,
              revenueStandartPerHour: 0,
              revenueStandartUnits: '₽',
              employees: [],
              visible: 0,
            },
            {
              name: 'Официант6',
              id: '9',
              levels: [1, 2],
              workloadType: 'Выручка',
              workload: 0,
              workloadUnits: '₽',
              additionalWorkloadType: '',
              additionalWorkload: 0,
              additionalWorkloadUnits: '',
              fotCategory: 0,
              fotRevenue: 0,
              performanceStandart: 0,
              performanceStandartType: '',
              salary: 30000,
              salaryBulk: 7200,
              revenueStandart: 30,
              revenueStandartPerHour: 0,
              revenueStandartUnits: '₽',
              employees: [],
              visible: 0,
            },
            {
              name: 'Официант7',
              id: '10',
              levels: [1, 2],
              workloadType: 'Выручка',
              workload: 0,
              workloadUnits: '₽',
              additionalWorkloadType: '',
              additionalWorkload: 0,
              additionalWorkloadUnits: '',
              fotCategory: 0,
              fotRevenue: 0,
              performanceStandart: 0,
              performanceStandartType: '',
              salary: 30000,
              salaryBulk: 7200,
              revenueStandart: 30,
              revenueStandartPerHour: 0,
              revenueStandartUnits: '₽',
              employees: [],
              visible: 0
            },
          ];

          /** Обновление представления */
          this.summaryModel.setPositions(positions);

          loadingDelay.then(() => {
            this.isBuilt(true);
            this.loading(false);
          });
        }, 10);
      };

      /** Tabs: production, delivery, lateness */
      this.tabs = (() => {
        const tabs = [
          new HrmTabGroupItem('Производство'),
          new HrmTabGroupItem('Доставка'),
          new HrmTabGroupItem('Опоздания')
        ];
        const activeTab = ko.observable(0);
        return {
          tabs,
          activeTab,
        }
      })();

      this.productionPositions = ko.pureComputed(() => {
        return this.summaryModel.positions();
      });

      /** Shift stimulation model (fine/bonus) */
      this.stimulation = (() => {
        function Stimulation() {
          return {
            base: ko.observable(''),
            author: ko.observable(''),
            sum: ko.observable(0),
            comment: ko.observable('')
          }
        }

        const fine = {
          production: Stimulation(),
          delivery: Stimulation()
        };

        const bonus = {
          production: Stimulation(),
          delivery: Stimulation()
        };

        const setStimulation = () => {
          this.utils.openModal(
            'stimulation',
            {
              fines: window.directories.fines,
              bonuses: window.directories.bonuses,
              authors: window.directories.authors
            },
            (data) => {
              console.log('stimulation saved', data)
            }
          )
        };

        return {
          fine,
          bonus,
          set: setStimulation
        };
      })();

      this.isEmployeesCalculated = ko.observable(false);

      this.calculateEmployees = function () {
        this.isEmployeesCalculated(true);
      };

      this.recalculateEmployees = function () {
        this.isEmployeesCalculated(false);

        // TODO
        this.formModel().positions().forEach((position, index) => {
          position.employees(positions[index].employees.map(e => this.createEmployeeModel(e)));
        });

        this.isEmployeesCalculated(true);
      };

      this.addWorkingInterval = function (employee) {
        employee.workingIntervals.push(this.createEmployeeWorkingIntervalModel(''));
      };

      this.onRateInput = function (position) {
        position.employees().forEach(employee => {
          employee.rate(position.rate());
        });
      };

      this.onEmployeeRateInput = function (position) {
        position.rate('');
      };

      this.getEmployeeWorkingHours = function (employee) {
        return ko.pureComputed(() => {
          if (employee.workingIntervalsValidationObject.isValid()) {
            return employee.workingIntervals().reduce((minutes, interval) => {
              const boundaries = interval.value().split(' – ').map(b => moment(b, 'HH:mm'));

              if (boundaries[0].isAfter(boundaries[1])) {
                boundaries[1].add(1, 'd');
              }

              return minutes + boundaries[1].diff(boundaries[0], 'minutes');
            }, 0);
          } else {
            return 0;
          }
        });
      };

      this.getEmployeeSalaryBulk = function (employee) {
        return ko.pureComputed(() => {
          const minutes = this.getEmployeeWorkingHours(employee)();

          return this.unmaskDecimal(employee.rate()) * (minutes / 60);
        });
      };

      this.getEmployeeSalary = function (employee) {
        return ko.pureComputed(() => {
          const bulk = this.getEmployeeSalaryBulk(employee)();
          const bonus = this.unmaskDecimal(employee.bonus());
          const fine = this.unmaskDecimal(employee.fine());

          return this.unmaskDecimal(bulk + bonus - fine);
        });
      };

      this.getPositionMaxWorkingIntervalCount = function (position) {
        return ko.pureComputed(() => {
          return Math.max(...position.employees().map(e => e.workingIntervals().length));
        });
      };

      this.getCategoriesTooltipText = function (categories) {
        return categories.map(c => c.name).join(', ');
      };

      this.getUnitsSuffixHtml = function (units) {
        switch (units) {
          case '1': return 'шт.';
          case '2': return '<i class="far fa-ruble-sign"></i>';
          case '3': return 'ч.';
        }
      };

      this.formatDecimal = function (value) {
        return Inputmask.format(value, { alias: 'decimal', digits: '2', groupSeparator: ' ', autoGroup: true, allowMinus: false }).replace('.00', '');
      };

      this.unmaskDecimal = function (value) {
        const result = Inputmask.unmask(value, { alias: 'decimal', digits: '2', groupSeparator: ' ', autoGroup: true, allowMinus: false, unmaskAsNumber: true });

        if (result === '') {
          return 0;
        }

        return result;
      };

      this.editableCellControlErrorExtractor = function (control) {
        return ko.pureComputed(() => {
          return !control.isValid() ? { message: control.error() } : null;
        });
      };

      this.formatDuration = function (minutes) {
        let h = Math.floor(minutes / 60).toString();
        h = h.length === 1 ? '0' + h : h;
        let m = (minutes % 60).toString();
        m = m.length === 1 ? '0' + m : m;

        return h + ':' + m;
      };

      this.afterRenderBuild = function (el) {
        $(el).hide().fadeIn(200, () => {
          $(window).resize();
        })
      }

      this.isSidebarCollapsed = ko.observable(localStorage.getItem(HRM_SIDEBAR_COLLAPSED_LOCAL_STORAGE_KEY) === 'true');

      (() => {
        $(window).on('resize', this.windowResizeHandler);

        this.subscriptions.push(this.isSidebarCollapsed.subscribe(collapsed => {
          localStorage.setItem(HRM_SIDEBAR_COLLAPSED_LOCAL_STORAGE_KEY, collapsed);
        }));
      })();

      this.calculate = () => {
        console.log('recalculate');

        // Позиции, участвующие в расчете
        const activePositions = this.summaryModel.positions().filter(p => {
          if (p.visible()) return true;
          if (p.visibleEmployees()) return true;
        });

        function getRandom(from, to) {
          return Math.floor(Math.random() * (to - from)) + from;
        }

        activePositions.forEach(position => {
          // нагрузка из первой таблицы
          const positionWorkload = position.workload();
          // сотрудники, участвующие в расчете
          const visibleEmployees = position.visibleEmployees();

          // Данные сотрудников
          visibleEmployees.forEach(employee => {
            const account = getRandom(0, 2000);
            const premiumAccount = getRandom(0, 2000);
            const compensation = getRandom(0, 2000);
            const workload = getRandom(0, 2000);
            const salary = getRandom(0, 2000);
            const salaryBulk = getRandom(0, 2000);
            const revenueStandart = getRandom(0, 2000);
            const revenueStandartPerHour = getRandom(0, 2000);
            const normalizationRatio = getRandom(0, 2000);
            const bonusRatio = getRandom(0, 2000);
            const correctedTime = getRandom(0, 2000);
            const bonusExceed = getRandom(0, 2000);
            const depremation = getRandom(0, 2000);
            const total = getRandom(0, 2000);
            const toPayment = getRandom(0, 2000);

            employee.account(account);
            employee.premiumAccount(premiumAccount);
            employee.compensation(compensation);
            employee.workload(workload);
            employee.salary(salary);
            employee.salaryBulk(salaryBulk);
            employee.revenueStandart(revenueStandart);
            employee.revenueStandartPerHour(revenueStandartPerHour);
            employee.normalizationRatio(normalizationRatio);
            employee.bonusRatio(bonusRatio);
            employee.correctedTime(correctedTime);
            employee.bonusExceed(bonusExceed);
            employee.depremation(depremation);
            employee.total(total);
            employee.toPayment(toPayment);
          });

          // данные позиции
          const fotCategory = getRandom(0, 80);
          const fotRevenue = getRandom(0, 80);
          const performanceStandart = getRandom(-80, 0);

          position.fotCategory(fotCategory);
          position.fotRevenue(fotRevenue);
          position.performanceStandart(performanceStandart);
        });

        // Итого первой таблицы
        const workload = getRandom(0, 2000);
        const workloadUnits = getRandom(0, 2000);
        const fotCategory = getRandom(0, 2000);
        const fotRevenue = getRandom(0, 2000);
        const performanceStandart = getRandom(0, 2000);

        this.summaryModel.total.workload(workload);
        this.summaryModel.total.workloadUnits(workloadUnits);
        this.summaryModel.total.fotCategory(fotCategory);
        this.summaryModel.total.fotRevenue(fotRevenue);
        this.summaryModel.total.performanceStandart(performanceStandart);

        // Итого второй таблицы
        const workingTime = '77:00';
        const salaryBulk = getRandom(0, 2000);
        const normalizationRatio = getRandom(0, 3);
        const revenueStandart = getRandom(0, 2000);
        const bonusRatio = getRandom(0, 3);
        const correctedTime = '22:22';
        const bonusExceed = getRandom(0, 2000);
        const total = getRandom(0, 34000);
        const toPayment = getRandom(0, 65000);

        this.summaryModel.productionTotal.workingTime(workingTime);
        this.summaryModel.productionTotal.salaryBulk(salaryBulk);
        this.summaryModel.productionTotal.normalizationRatio(normalizationRatio);
        this.summaryModel.productionTotal.revenueStandart(revenueStandart);
        this.summaryModel.productionTotal.bonusRatio(bonusRatio);
        this.summaryModel.productionTotal.correctedTime(correctedTime);
        this.summaryModel.productionTotal.bonusExceed(bonusExceed);
        this.summaryModel.productionTotal.total(total);
        this.summaryModel.productionTotal.toPayment(toPayment);

      }
    };


    ViewModel.prototype.dispose = function () {
      $(window).off('resize', this.windowResizeHandler);
      this.subscriptions.forEach(s => s.dispose());
    };

    /***** Model activation *******/
    const defaultPositions = [];
    const viewModel = new ViewModel(defaultPositions);



    ko.applyBindings(
      viewModel,
      $page.get()[0]
    );

    // TODO: test
    setTimeout(() => {
      viewModel.buildCalculation()
    }, 500)


    /*****/


    function createModalDialog(id, data, onSave) {
      return {
        dialogTemplateName: id + '-modal-template',
        data: data,
        options: {
          modalClass: 'calculation-modal calculation-modal--' + id
        },
        close: result => {
          if (result !== undefined && typeof onSave === 'function') {
            onSave(result);
          }
        }
      }
    }
  });
</script>
