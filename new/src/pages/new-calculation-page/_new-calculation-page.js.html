<script type="text/javascript">
  // Справочники
  window.directories = {
    fines: {
      get: () => {
        const directory = ko.observable([
          {
            name: 'Безопасность',
            items: [
              { id: 1, name: 'Возврат в кассу', sum: 200 }
            ],
          },
          {
            name: 'Дисциплина',
            items: [
              { id: 2, name: 'За отсутствие объяснительной', sum: 250 },
              { id: 3, name: 'Халатное отношение к работе', sum: 300 },
            ]
          },
          {
            name: 'Документы',
            items: [
              { id: 4, name: 'Налог', sum: 350 }
            ],
          },
          {
            name: 'Производство',
            items: [
              { id: 5, name: 'Выкуп готовой продукции', sum: 400 },
              { id: 6, name: 'Порча инвентаря и оборудования', sum: 450 },
              { id: 7, name: 'Компенсация за халатность', sum: 500 },
            ],
          },
        ]);

        return directory;
      }
    },
    authors: {
      get: () => {
        const directory = ko.observable([
          {
            id: 1,
            name: 'Иван Иванов'
          }, {
            id: 2,
            name: 'Петр Петров'
          }, {
            id: 3,
            name: 'Николай Николаев'
          }, {
            id: 4,
            name: 'Сергей Сергеев'
          }
        ]);

        return directory;
      }
    }
  };

  $(function () {
    const $page = $(document.documentElement);

    const PositionsModel = function () {
      const positions = ko.observableArray([]);

      /**
      * Returns position with specified id
      * @param {string|number} id
      * @returns {Observable}
      */
      function getPositionById(id) {
        return positions().find(position => position.id === id);
      }

      /**
      * Creates new positions list from data
      * @param {Object[]} positionsList
      */
      function setPositions(positionsList) {
        positions(positionsList.map(positionData => {
          return PositionModel(positionData)
        }))
      }

      /**
      * @params {string} interval
      * @returns {{value: Observable, getInterval: function}}
      */
      function WorkingIntervalModel(interval) {
        const value = ko.observable(interval).extend({
          required: {
            message: 'Обязательное поле'
          },
          validation: {
            validator: value => {

              if (!/^\d\d:\d\d – \d\d:\d\d$/.test(value)) {
                return false;
              } else {
                const boundaries = value.split(' – ');

                if (boundaries[0] === boundaries[1]) {
                  return false;
                }

                return boundaries.every(b => moment(b, 'HH:mm', true).isValid());
              }
            },
            message: 'Неверный формат интервала'
          }
        });

        /**
        * @returns {number}
        */
        function getInterval() {
          const boundaries = value().split(' – ').map(b => moment(b, 'HH:mm'));

          if (boundaries[0].isAfter(boundaries[1])) {
            boundaries[1].add(1, 'd');
          }

          return boundaries[1].diff(boundaries[0], 'minutes');
        }

        return {
          value,
          getInterval
        };
      }

      /**
      * @param {Object} employee
      * @param {Object} positionData
      * @param {boolean} visible
      */
      function EmployeeModel(employee, positionData, visible) {
        const defaultIntervals = employee.workingIntervals || [''];
        const workingIntervals = ko.observableArray(
          defaultIntervals.map(i => WorkingIntervalModel(i))
        );

        const isWorkingIntervalsValid = ko.pureComputed(() => {
          return workingIntervals().every(i => i.value.isValid())
        });

        const workingTime = ko.pureComputed(() => {
          if (!isWorkingIntervalsValid()) return 0;

          return workingIntervals().reduce((minutes, interval) => {
            return minutes + interval.getInterval();
          }, 0);
        });

        /**
        * Adds empty interval
        */
        function addWorkingInterval() {
          const model = WorkingIntervalModel('');
          workingIntervals.push(model);
        }

        /**
        * Removes specified interval from list
        * @param {WorkingIntervalModel} interval
        */
        function removeWorkingInterval(interval) {
          workingIntervals.remove(interval);
        }

        const accountOperations = ko.observableArray(employee.accountOperations || []);
        const accountState = ko.pureComputed(() => {
          return accountOperations().reduce((sum, operation) => {
            const operationSum = operation.type === 'fine' ? operation.sum * -1 : operation.sum;
            return sum + operationSum;
          }, 0);
        });

        const fines = ko.observableArray(employee.fines || []);
        const finesState = ko.pureComputed(() => {
          return fines().reduce((sum, fine) => {
            return sum + fine.sum;
          }, 0);
        });

        const bonuses = ko.observableArray(employee.bonuses || []);
        const bonusesState = ko.pureComputed(() => {
          return bonuses().reduce((sum, bonus) => {
            return sum + bonus.sum;
          }, 0);
        });

        return {
          name: employee.name, // имя
          id: employee.id, // идентификатор
          level: employee.level, // разряд

          accountOperations,
          accountState,

          workingIntervals: workingIntervals, // рабочие интервалы
          addWorkingInterval,
          removeWorkingInterval,
          workingTime,

          returnRate: 30, // норматив выручки
          salaryBulk: 7200, // основная часть зп


          bonuses,
          bonusesState,

          fines, // штрафы
          finesState,

          visible: ko.observable(!!visible), // участвует в расчете
          loaded: employee.loaded,
        }
      }

      /**
      * @param {Object} positionData
      */
      function PositionModel(positionData) {
        const visible = ko.observable(false);
        const employees = ko.observableArray(positionData.employees.map((e) => EmployeeModel(e, positionData, false)));

        const allEmployeesLoaded = ko.observable(false);

        const workingTime = ko.pureComputed(() => {
          return employees().reduce((minutes, employee) => {
            if (!employee.visible()) return minutes;
            return minutes + employee.workingTime();
          }, 0)
        });

        function findEmployeeById(employeeId) {
          return employees().find(employee => employee.id === employeeId);
        }

        /**
        * Adds new employee to list
        * @param {Object} employee
        */
        function addEmployee(employee) {
          employees.push(EmployeeModel(employee, positionData, 'visible'));
        }

        /**
        * Updates employees list, set visibility
        */
        function updateEmployees(updatedList) {
          const updatedIds = updatedList.map(e => e.id);
          const originalIds = employees().map(e => e.id);

          const notFoundIds = _.difference(originalIds, updatedIds);
          const newEmployeesIds = _.difference(updatedIds, originalIds);

          // remove not found-s
          const updated = employees().filter(e => notFoundIds.indexOf(e.id) === -1);

          // set visibility
          updated.forEach(employee => {
            const updatedEmployeeData = updatedList.find(updatedEmployee => updatedEmployee.id == employee.id);
            employee.visible(updatedEmployeeData.checked);
          });

          // add new-s
          const newEmployees = newEmployeesIds.map(id => {
            const employeeData = updatedList.find(e => e.id === id);
            const employee = EmployeeModel(employeeData, positionData, employeeData.checked);
            return employee;
          });

          // update list
          employees(updated.concat(newEmployees));
        }

        return {
          id: positionData.id,
          name: positionData.name, // название
          workloadType: positionData.workloadType,
          type: positionData.type, // production/delivery
          levels: positionData.levels, //
          rate: positionData.rate, // оклад
          units: 3,
          workload: 2.2, // нагрузка
          additionalWorkload: positionData.additionalWorkload,
          fotCategory: positionData.fotCategory,
          fotRevenue: positionData.fotRevenue,
          employees,
          addEmployee, // добавить сотрудника
          updateEmployees, // обновить список сотрудников
          allEmployeesLoaded, // загружены сотрудники из всех филиалов
          workingTime, // общее рабочее время всех сотрудников
          visible, // отображается в таблице
        };
      };


      return {
        positions,
        setPositions,
        getPositionById,
      }
    }

    const ViewModel = function (defaultPositions, settings) {
      /** Initialization */
      (() => {
        this.subscriptions = [];
        const viewportSize = ko.observable({ width: $(window).width(), height: $(window).height() });
        this.windowResizeHandler = () => {
          viewportSize({ width: $(window).width(), height: $(window).height() });
        };
        this.childrenComplete = function () {
          $page.removeClass('hrm-page--initializing');
        };
        this.modalOpens = ko.observableArray([]);

        this.utils = {
          openModal: (id, data, onSave) => {
            const modal = createModalDialog(id, data, onSave);
            this.modalOpens.push(modal)
          },

          formatSign: (number) => {
            const formattedNumber = parseFloat(ko.unwrap(number));
            if (!formattedNumber) return number;
            if (formattedNumber > 0) return '+' + formattedNumber;
            return formattedNumber;
          },

          viewportSize: viewportSize
        }
      })();

      this.summaryModel = new PositionsModel();
      this.summaryModel.setPositions(defaultPositions);

      /** Input data */
      this.inputModel = {
        filial: ko.observable(''),
        date: ko.observable(moment().format('DD.MM.YYYY')),
        shift: ko.observable(''),
        interval: {
          start: ko.observable(''),
          end: ko.observable(''),
        }
      };

      /** Calculation */
      this.isBuilt = ko.observable(false);
      this.loading = ko.observable(false);
      /** Get data for calculation */
      this.buildCalculation = () => {
        this.loading(true);
        const inputData = ko.toJS(this.inputModel);

        // Показывать лоадер 3с
        const loadingDelay = new Promise(resolve => {
          setTimeout(() => {
            resolve();
          }, 3000);
        });

        setTimeout(() => {
          /* Получение списка позиций */
          const positions = [
            {
              name: 'Администратор филиала',
              id: '1',
              levels: [1, 2],
              type: 'production',
              workloadType: 'Выручка',
              workload: 0,
              units: '₽',
              additionalWorkload: 'Время без дела 0%',
              fotCategory: 0,
              fotRevenue: 0,
              performanceStandart: -100,
              lateness: {
                green: 0,
                yellow: 0,
                red: 0
              },
              employees: [
                {
                  name: 'Администратор филиала #1',
                  id: '11',
                  level: 1,
                  workingIntervals: ['09:00 – 16:00'],
                },
                {
                  name: 'Администратор филиала #2',
                  id: '12',
                  level: 2,
                  workingIntervals: ['09:00 – 16:00'],
                }
              ]
            },
            {
              name: 'Повар-сушист',
              id: '2',
              levels: [],
              type: 'production',
              workloadType: 'Выручка',
              workload: 0,
              units: '₽',
              additionalWorkload: 'Время без дела 0%',
              fotCategory: 0,
              fotRevenue: 0,
              performanceStandart: -100,
              lateness: {
                green: 0,
                yellow: 0,
                red: 0
              },
              employees: [
                {
                  name: 'Повар-сушист #1',
                  id: '21',
                  level: 0,
                  workingIntervals: ['09:00 – 16:00'],
                },
                {
                  name: 'Повар-сушист #2',
                  id: '22',
                  level: 0,
                  workingIntervals: ['09:00 – 16:00'],
                }
              ]
            },
            {
              name: 'Повар-пиццмейкер',
              id: '3',
              levels: [1, 2, 3],
              type: 'production',
              workloadType: 'Выручка',
              workload: 0,
              units: '₽',
              additionalWorkload: 'Время без дела 0%',
              fotCategory: 0,
              fotRevenue: 0,
              performanceStandart: -100,
              lateness: {
                green: 0,
                yellow: 0,
                red: 0
              },
              employees: [
                {
                  name: 'Повар-пиццмейкер #1',
                  id: '31',
                  level: 1,
                  workingIntervals: ['09:00 – 16:00'],
                },
                {
                  name: 'Повар-пиццмейкер #2',
                  id: '32',
                  level: 3,
                  workingIntervals: ['09:00 – 16:00'],
                }
              ]

            },
            {
              name: 'Официант',
              id: '4',
              levels: [1, 2],
              type: 'production',
              workloadType: 'Выручка',
              workload: 0,
              units: '₽',
              additionalWorkload: 'Время без дела 0%',
              fotCategory: 0,
              fotRevenue: 0,
              performanceStandart: -100,
              lateness: {
                green: 0,
                yellow: 0,
                red: 0
              },
              employees: [
                {
                  name: 'Официант #1',
                  id: '41',
                  level: 1,
                  workingIntervals: ['09:00 – 16:00'],
                },
                {
                  name: 'Официант #2',
                  id: '42',
                  level: 2,
                  workingIntervals: ['09:00 – 16:00'],
                }
              ]
            },
          ];

          /** Обновление представления */
          this.summaryModel.setPositions(positions);

          loadingDelay.then(() => {
            this.isBuilt(true);
            this.loading(false);
          });
        }, 1000);
      };

      /** Tabs: production, delivery, lateness */
      this.tabs = (() => {
        const tabs = [
          new HrmTabGroupItem('Производство'),
          new HrmTabGroupItem('Доставка'),
          new HrmTabGroupItem('Опоздания')
        ];
        const activeTab = ko.observable(0);
        return {
          tabs,
          activeTab,
        }
      })();

      this.productionPositions = ko.pureComputed(() => {
        return this.summaryModel.positions()
          .filter(position => position.type === 'production');
      });


      /** Shift stimulation model (fine/bonus) */
      this.stimulation = (() => {
        function Stimulation() {
          return {
            base: ko.observable(''),
            author: ko.observable(''),
            sum: ko.observable(0),
            comment: ko.observable('')
          }
        }

        const fine = {
          production: Stimulation(),
          delivery: Stimulation()
        };

        const bonus = {
          production: Stimulation(),
          delivery: Stimulation()
        };

        const setStimulation = () => {
          this.utils.openModal(
            'stimulation',
            null,
            (data) => {
              console.log('stimulation saved', data)
            }
          )
        };

        return {
          fine,
          bonus,
          set: setStimulation
        };
      })();



      this.isEmployeesCalculated = ko.observable(false);

      this.calculateEmployees = function () {
        this.isEmployeesCalculated(true);
      };

      this.recalculateEmployees = function () {
        this.isEmployeesCalculated(false);

        this.formModel().positions().forEach((position, index) => {
          position.employees(positions[index].employees.map(e => this.createEmployeeModel(e)));
        });

        this.isEmployeesCalculated(true);
      };

      this.addWorkingInterval = function (employee) {
        employee.workingIntervals.push(this.createEmployeeWorkingIntervalModel(''));
      };



      this.onRateInput = function (position) {
        position.employees().forEach(employee => {
          employee.rate(position.rate());
        });
      };

      this.onEmployeeRateInput = function (position) {
        position.rate('');
      };


      this.getWorkloadTypeName = function (workloadType) {
        switch (workloadType) {
          case 1: return 'Объём товара по всему предприятию';
          case 2: return 'Объём товара по категориям';
        }
      };

      this.getEmployeeWorkingHours = function (employee) {
        return ko.pureComputed(() => {
          if (employee.workingIntervalsValidationObject.isValid()) {
            return employee.workingIntervals().reduce((minutes, interval) => {
              const boundaries = interval.value().split(' – ').map(b => moment(b, 'HH:mm'));

              if (boundaries[0].isAfter(boundaries[1])) {
                boundaries[1].add(1, 'd');
              }

              return minutes + boundaries[1].diff(boundaries[0], 'minutes');
            }, 0);
          } else {
            return 0;
          }
        });
      };

      this.getEmployeeSalaryBulk = function (employee) {
        return ko.pureComputed(() => {
          const minutes = this.getEmployeeWorkingHours(employee)();

          return this.unmaskDecimal(employee.rate()) * (minutes / 60);
        });
      };

      this.getEmployeeSalary = function (employee) {
        return ko.pureComputed(() => {
          const bulk = this.getEmployeeSalaryBulk(employee)();
          const bonus = this.unmaskDecimal(employee.bonus());
          const fine = this.unmaskDecimal(employee.fine());

          return this.unmaskDecimal(bulk + bonus - fine);
        });
      };

      this.getPositionMaxWorkingIntervalCount = function (position) {
        return ko.pureComputed(() => {
          return Math.max(...position.employees().map(e => e.workingIntervals().length));
        });
      };

      this.getCategoriesTooltipText = function (categories) {
        return categories.map(c => c.name).join(', ');
      };

      this.getUnitsSuffixHtml = function (units) {
        switch (units) {
          case '1': return 'шт.';
          case '2': return '<i class="far fa-ruble-sign"></i>';
          case '3': return 'ч.';
        }
      };

      this.formatDecimal = function (value) {
        return Inputmask.format(value, { alias: 'decimal', digits: '2', groupSeparator: ' ', autoGroup: true, allowMinus: false }).replace('.00', '');
      };

      this.unmaskDecimal = function (value) {
        const result = Inputmask.unmask(value, { alias: 'decimal', digits: '2', groupSeparator: ' ', autoGroup: true, allowMinus: false, unmaskAsNumber: true });

        if (result === '') {
          return 0;
        }

        return result;
      };

      this.editableCellControlErrorExtractor = function (control) {
        return ko.pureComputed(() => {
          return !control.isValid() ? { message: control.error() } : null;
        });
      };

      this.formatDuration = function (minutes) {
        let h = Math.floor(minutes / 60).toString();
        h = h.length === 1 ? '0' + h : h;
        let m = (minutes % 60).toString();
        m = m.length === 1 ? '0' + m : m;

        return h + ':' + m;
      };

      this.isSidebarCollapsed = ko.observable(localStorage.getItem(HRM_SIDEBAR_COLLAPSED_LOCAL_STORAGE_KEY) === 'true');

      (() => {
        $(window).on('resize', this.windowResizeHandler);

        this.subscriptions.push(this.isSidebarCollapsed.subscribe(collapsed => {
          localStorage.setItem(HRM_SIDEBAR_COLLAPSED_LOCAL_STORAGE_KEY, collapsed);
        }));
      })();
    };


    ViewModel.prototype.dispose = function () {
      $(window).off('resize', this.windowResizeHandler);
      this.subscriptions.forEach(s => s.dispose());
    };

    /***** Model activation *******/
    const defaultPositions = [];
    const viewModel = new ViewModel(defaultPositions);

    ko.applyBindings(
      viewModel,
      $page.get()[0]
    );


    /*****/


    function createModalDialog(id, data, onSave) {
      return {
        dialogTemplateName: id + '-modal-template',
        data: data,
        options: {
          modalClass: 'calculation-modal calculation-modal--' + id
        },
        close: result => {
          if (result !== undefined && typeof onSave === 'function') {
            onSave(result);
          }
        }
      }
    }
  });
</script>
