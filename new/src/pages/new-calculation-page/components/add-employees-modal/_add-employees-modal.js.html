@@include('./_add-employees-modal.html')

<script type="text/javascript">
  $(function () {
    function EmployeeModel(employee) {
      return {
        id: employee.id,
        name: employee.name,
        checked: ko.observable(employee.visible()),
        visible: ko.observable(true)
      }
    }

    function PositionModel(positionObservable) {
      const positionData = positionObservable();
      const employees = ko.observableArray(positionData.employees().map(EmployeeModel));
      const hasVisibleEmployees = ko.observable(true);

      return {
        name: positionData.name,
        id: positionData.id,
        employees,
        visible: positionData.visible(),
        hasVisibleEmployees,
      }
    }

    function NewEmployeeModel(employeeData) {
      return {
        id: employeeData.id,
        name: employeeData.name,
        checked: ko.observable(false),
        visible: ko.observable(true),
        loaded: true,
      }
    }



    ko.components.register('add-employees-modal-dialog', {
      viewModel: {
        createViewModel: function (params, componentInfo) {
          const originalPositions = params.data.positions;

          const $element = $(componentInfo.element);
          $element.addClass([
            'modal-dialog',
            'modal-dialog-centered',
            'hrm-modal-dialog',
            'hrm-basic-modal-dialog',
            'hrm-modal-dialog--size_large'
          ]);

          const ViewModel = function () {

            this.isSubmitted = ko.observable(false);

            this.formControlErrorStateMatcher = (formControl) => {
              return ko.pureComputed(() => {
                return this.isSubmitted() && !formControl.isValid();
              });
            };

            this.positions = originalPositions().map(PositionModel);

            this.visiblePositions = this.positions.filter(position => position.visible);
            this.invisiblePositions = this.positions.filter(position => !position.visible);

            this.term = ko.observable('');
            this.term.subscribe(value => {
              const formattedValue = value.toLowerCase();
              console.log(formattedValue)

              this.positions.forEach(p => {
                let hasVisibleEmployees = 0;
                p.employees().forEach(e => {
                  let isVisible = true;
                  if (formattedValue.length >= 2) {
                    const name = e.name.toLowerCase();
                    isVisible = name.indexOf(formattedValue) !== -1;
                  }
                  e.visible(isVisible);
                  if (isVisible) hasVisibleEmployees++;
                });
                p.hasVisibleEmployees(hasVisibleEmployees);
              })
            })

            this.tabs = (() => {
              const tabs = this.visiblePositions.map(position => new HrmTabGroupItem(position.name));
              if (this.invisiblePositions.length) tabs.push(new HrmTabGroupItem('Прочие'));
              return tabs;
            })();

            this.activeTab = ko.observable(0);
            this.activePosition = ko.pureComputed(() => {
              return this.visiblePositions[this.activeTab()];
            });
            this.activeTab(0);

            this.allBranches = ko.observable(false);
            this.loadingBranches = ko.observable(false);
            this.allBranches.subscribe(value => {
              if (value) {
                this.loadingBranches(true)
                this.loadBranches(() => {
                  this.loadingBranches(false);
                });
              } else {
                this.restoreEmployeesList();
              }
            })

            this.restoreEmployeesList = () => {
              this.positions.forEach(p => {
                const oldEmployeesList = p.employees().filter(e => !e.loaded)
                p.employees(oldEmployeesList)
              })
            }

            this.loadBranches = (cb) => {
              const activePosition = this.activePosition.peek();
              if (activePosition) {
                console.log('Сделать запрос, категория', activePosition.name);
                // Данные
                const employeesList = [
                  { name: 'Рабочий #1', id: activePosition.name + '1' },
                  { name: 'Рабочий #2', id: activePosition.name + '2' },
                  { name: 'Рабочий #3', id: activePosition.name + '3' }
                ];

                // Добавить новых работников
                employeesList.forEach(e => {
                  activePosition.employees.push(NewEmployeeModel(e))
                });
              } else {
                const positionsList = this.invisiblePositions.map(p => p.name)
                console.log('Сделать запрос, категории', positionsList);
                // Добавить новых работников в каждую категию
                updatedEmployees = this.invisiblePositions.forEach(p => {
                  const employeesList = [
                    { name: 'Рабочий #1', id: p.name + '1' },
                    { name: 'Рабочий #2', id: p.name + '2' },
                    { name: 'Рабочий #3', id: p.name + '3' }
                  ];
                  employeesList.forEach(e => {
                    p.employees.push(NewEmployeeModel(e))
                  });
                })
              }

              setTimeout(cb, 3000)
            }

            this.cancel = function () {
              if ('cancel' in params) {
                params.cancel();
              }
            };


            this.submit = function () {
              this.isSubmitted(true);

              if (this.validationObject.isValid()) {
                if ('submit' in params) {
                  params.submit(ko.toJS(this.positions));
                }
              }
            };
          }

          return new ViewModel();
        }
      },
      template: {
        element: document.getElementById('add-employees-modal-dialog-template')
      }
    });
  });
</script>
