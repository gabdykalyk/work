@@include('./_summary-position-row.html')
@@include('./_summary-total-row.html')
@@include('./_summary-table.html')

<script type="text/javascript">
  $(function () {
    function Column(id, title, fullTitle, total) {

      return {
        id,
        title,
        fullTitle,
        hasTotal: !!total,
        total
      }
    }

    ko.components.register('calculation-page-summary-table', {
      viewModel: {
        /**
        * @param {ObservableArray} params.positions
        */
        createViewModel: function (params, componentInfo) {
          const model = params.model;
          const positions = model.positions;

          const visiblePositions = ko.pureComputed(() => {
            return positions().filter(p => p.visible());
          });

          const driversData = model.driversData();

          /* TODO */
          const total = ko.pureComputed(() => {
            const result = {
              workload: 0,
              workloadType: '',
              units: '',
              additionalWorkload: '',
              fotCategory: 100,
              fotRevenue: 100,
              performanceStandart: -100,
              lateness: {
                light: 0,
                medium: 0,
                hard: 0,
                total: 0,
              },
              employees: []
            };

            positions().forEach(p => {
              result.workload += p.workload;
              result.employees = [...result.employees, ...p.employees()];
              result.lateness.light += p.lateness.light || 0;
              result.lateness.medium += p.lateness.medium || 0;
              result.lateness.hard += p.lateness.hard || 0;
              result.lateness.total += p.lateness.total || 0;
            });

            return result;
          });

          const columns = [
            Column('job', 'Должность', 'Должность'),
            Column('workload-type', 'Тип нагрузки', 'Тип нагрузки'),
            Column('workload', 'Нагрузка', 'Нагрузка'),
            Column('additional-workload', 'Доп. нагрузка', 'Дополнительная нагрузка'),
            Column('count', 'Сотр.', 'Сотрудники'),
            Column('fot-category', 'ФОТ, % в категории', 'ФОТ, % в категории'),
            Column('fot-revenue', 'ФОТ, % от выручки', 'ФОТ, % от выручки'),
            Column('performance-standart', 'Норм. выр-ки, %', 'Норма выработки, %'),
            Column('lateness', 'Опоздания', 'Опоздания'),
          ];

          return {
            positions,
            total,
            columns,
            driversData
          };
        }
      },
      template: {
        element: document.getElementById('calculation-page-summary-table-template')
      }
    });
  })
</script>
