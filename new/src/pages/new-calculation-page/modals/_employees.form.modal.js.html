<script type="text/javascript">
  $(function () {
    function EmployeeModel(employee) {
      return {
        id: employee.id,
        name: employee.name,
        checked: ko.observable(employee.visible()),
        visible: ko.observable(true)
      }
    }

    function PositionModel(positionObservable) {
      const positionData = positionObservable();
      const employees = ko.observableArray(positionData.employees().map(EmployeeModel));
      const hasVisibleEmployees = ko.observable(true);

      return {
        name: positionData.name,
        id: positionData.id,
        employees,
        visible: positionData.visible(),
        hasVisibleEmployees,
      }
    }

    function NewEmployeeModel(employeeData) {
      return {
        id: employee.id,
        name: employee.name,
        checked: ko.observable(false),
        visible: ko.observable(true),
        loaded: true,
      }
    }

    ko.components.register('calculation-settings-employees-form-modal-dialog', {
      viewModel: {
        createViewModel: function (params, componentInfo) {
          console.log(ko.toJS(params.data.positions))
          const originalPositions = params.data.positions;

          const $element = $(componentInfo.element);
          $element.addClass([
            'modal-dialog',
            'modal-dialog-centered',
            'hrm-modal-dialog',
            'hrm-basic-modal-dialog',
            'hrm-modal-dialog--size_large'
          ]);

          const ViewModel = function () {

            this.isSubmitted = ko.observable(false);

            this.formControlErrorStateMatcher = (formControl) => {
              return ko.pureComputed(() => {
                return this.isSubmitted() && !formControl.isValid();
              });
            };

            this.positions = originalPositions().map(PositionModel);

            this.visiblePositions = this.positions.filter(position => position.visible);
            this.invisiblePositions = this.positions.filter(position => !position.visible);

            this.term = ko.observable('');
            this.term.subscribe(value => {
              const formattedValue = value.toLowerCase();
              console.log(formattedValue)

              this.positions.forEach(p => {
                let hasVisibleEmployees = 0;
                p.employees().forEach(e => {
                  let isVisible = true;
                  if (formattedValue.length >= 2) {
                    const name = e.name.toLowerCase();
                    isVisible = name.indexOf(formattedValue) !== -1;
                  }
                  e.visible(isVisible);
                  if (isVisible) hasVisibleEmployees++;
                });
                p.hasVisibleEmployees(hasVisibleEmployees);
              })
            })

            this.tabs = (() => {
              const tabs = this.visiblePositions.map(position => new HrmTabGroupItem(position.name));
              if (this.invisiblePositions.length) tabs.push(new HrmTabGroupItem('Прочие'));
              return tabs;
            })();

            this.activeTab = ko.observable(0);
            this.activePosition = ko.pureComputed(() => {
              return this.visiblePositions[this.activeTab()];
            });
            this.activeTab(0);

            this.allBranches = ko.observable(false);
            this.loadingBranches = ko.observable(false);
            this.allBranches.subscribe(value => {
              if (value) {
                this.loadingBranches(true)
                this.loadBranches(() => {
                  this.loadingBranches(false);
                });
              } else {
                this.restoreEmployeesList();
              }
            })

            this.restoreEmployeesList = () => {
              this.positions.forEach(p => {
                const oldEmployeesList = p.employees().filter(e => !e.loaded)
                p.employees(oldEmployeesList)
              })
            }

            this.loadBranches = (cb) => {

              const activePosition = this.activePosition.peek();
              if (activePosition) {
                console.log('Сделать запрос, категория', activePosition.name);

                // Добавить новых работников
                activePosition.employees.push(NewEmployeeModel({ name: 'Рабочий #1', id: 'test1' }));
                activePosition.employees.push(NewEmployeeModel({ name: 'Рабочий #2', id: 'test1' }));
                activePosition.employees.push(NewEmployeeModel({ name: 'Рабочий #3', id: 'test1' }));
              } else {
                console.log('Сделать запрос, категории', this.invisiblePositions().map(p => p.name));

                // Добавить новых работников
                updatedEmployees = this.invisiblePositions().forEach(p => {
                  p.employees.push(NewEmployeeModel({ name: 'Рабочий #1', id: p.name + 'test1' }));
                  p.employees.push(NewEmployeeModel({ name: 'Рабочий #2', id: p.name + 'test2' }));
                  p.employees.push(NewEmployeeModel({ name: 'Рабочий #3', id: p.name + 'test3' }));
                })
              }

              setTimeout(cb, 3000)
            }

            this.formModel = {

            }


            this.validationObject = ko.validatedObservable({

            });


            this.cancel = function () {
              if ('cancel' in params) {
                params.cancel();
              }
            };


            this.submit = function () {
              this.isSubmitted(true);

              if (this.validationObject.isValid()) {
                if ('submit' in params) {
                  params.submit(ko.toJS(this.positions));
                }
              }
            };
          }

          return new ViewModel();
        }
      },
      template: {
        element: document.getElementById('calculation-settings-employees-form-modal-dialog-template')
      }
    });
  });
</script>

<template id="calculation-settings-employees-form-modal-dialog-template">

  <button class="hrm-button hrm-basic-modal-dialog__close-button"
          data-bind="click: function() { cancel(); }"
          aria-label="Close">
  </button>

  <div class="hrm-basic-modal-dialog__header">
    <h2 class="hrm-basic-modal-dialog__title">
      Добавить сотрудников
    </h2>
  </div>

  <div class="hrm-basic-modal-dialog__body employees-form">

    <div class="employees-form__tabs">
      <div style="width: 100%"
           data-bind="component: {name: 'hrm-tab-group', params: {items: tabs, activeItem: activeTab }}">
      </div>
    </div>

    <div class="employees-form__tab">

      <div class="employees-form__row">
        <!-- ko let: {control: ko.observable(null), label: ko.observable(null)} -->
        <div class="hrm-form-field-switch-group"
             data-bind="hrmSwitchGroup, hrmSwitchGroupControlRef: control, hrmSwitchGroupLabelRef: label">
          <div data-bind="component: {name: 'hrm-switch', params: {exportAs: control, checked: allBranches}}"></div>
          <label data-bind="hrmSwitchGroupLabel: label">
            Все филиалы
          </label>
        </div>
        <!-- /ko -->

        <div class="templates__form-field"
             data-bind="component: {name: 'hrm-search-field', params: { termModel: term, placeholder: 'Поиск по ФИО' }}">
        </div>

      </div>


      <!-- ko template: {
        foreach: hrmTemplateIf(loadingBranches(), $data),
        afterAdd: hrmFadeAfterAddFactory(200, 200),
        beforeRemove: hrmFadeBeforeRemoveFactory(200)
      } -->

      <div>
        <div class="employees-form__calculating">
          <i class="fa fa-spinner fa-pulse
                            employees-form__calculating-indicator">
          </i>
        </div>
      </div>
      <!-- /ko -->


      <!-- ko template: {
        foreach: hrmTemplateIf(!loadingBranches(), $data),
        afterAdd: hrmFadeAfterAddFactory(200, 200),
        beforeRemove: hrmFadeBeforeRemoveFactory(200)
      } -->
      <!-- ko if: activePosition -->
      <!-- Вкладка позиции -->
      <div class="employees-form__employees-scrollable-list"
           data-bind="hrmScrollable">

        <!-- ko foreach: {data: $parent.activePosition().employees, as: 'employee'} -->
        <div class="employees-form__checkbox"
             data-bind="if: $data.visible">

          <!-- ko let: {checkboxGroup: ko.observable(null)} -->
          <div data-bind="component: {name: 'hrm-checkbox-group', params: {exportAs: checkboxGroup}}">
            <div
                 data-bind="component: {name: 'hrm-checkbox', params: {owner: checkboxGroup, checked: employee.checked }}">
            </div>
            <label
                   data-bind="hrmCheckboxGroupLabel, hrmCheckboxGroupLabelOwner: checkboxGroup, text: employee.name"></label>
          </div>
          <!-- /ko -->

        </div>
        <!-- /ko -->

      </div>
      <!-- /Вкладка позиции -->
      <!-- /ko -->


      <!-- ko ifnot: activePosition -->
      <!-- Вкладка Прочие -->


      <div class="employees-form__employees-scrollable-list"
           data-bind="hrmScrollable">
        <!-- ko let: {checkboxGroup: ko.observable(null)} -->
        <div class="employees-form__checkbox-group">
          <div data-bind="component: {name: 'hrm-checkbox-group', params: {exportAs: checkboxGroup}}">

            <!-- ko foreach: $parent.invisiblePositions -->
            <div class="employees-form__position"
                 data-bind="if: hasVisibleEmployees">
              <div class="employees-form__position-name"
                   data-bind="text: $data.name"></div>


              <!-- ko foreach: {data: $data.employees, as: 'employee'} -->
              <div class="employees-form__checkbox"
                   data-bind="if: $data.visible">

                <!-- ko let: {checkboxGroup: ko.observable(null)} -->
                <div data-bind="component: {name: 'hrm-checkbox-group', params: {exportAs: checkboxGroup}}">
                  <div
                       data-bind="component: {name: 'hrm-checkbox', params: {owner: checkboxGroup, checked: employee.checked }}">
                  </div>
                  <label
                         data-bind="hrmCheckboxGroupLabel, hrmCheckboxGroupLabelOwner: checkboxGroup, text: employee.name"></label>
                </div>
                <!-- /ko -->


              </div>
              <!-- /ko -->




            </div>
            <!-- /ko -->

          </div>
        </div>
        <!-- /ko -->
      </div>

      <!-- /Вкладка Прочие -->
      <!-- /ko -->
      <!-- /ko -->






    </div><!-- /.employees-form__tab -->
  </div>

  <div class="hrm-basic-modal-dialog__action-list">
    <button class="hrm-button hrm-basic-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-cancel-button"
            data-bind="click: function() {cancel();}">
      Отменить
    </button>

    <button class="hrm-button hrm-basic-button hrm-accent-button hrm-basic-modal-dialog__action-list-item
         position-page__speciality-modal-dialog-submit-button"
            data-bind="click: function() {submit();}">
      Сохранить
    </button>
  </div>

</template>
