<script type="text/javascript">
    $(function () {
        ko.components.register('calculation-settings-positions-modal-dialog', {
            viewModel: {
                createViewModel: function (params, componentInfo) {
                    const $element = $(componentInfo.element);

                    $element.addClass([
                        'modal-dialog',
                        'modal-dialog-centered',
                        'hrm-modal-dialog',
                        'hrm-basic-modal-dialog'
                    ]);

                    return new (function () {
                        this.term = ko.observable('админ');

                        this.positions = params.data.positions.map((p) => {
                            const positionData = p();
                            return {
                                name: positionData.name,
                                checked: ko.observable(positionData.visible()),
                                position: p,
                                visible: ko.pureComputed(() => {
                                    const term = this.term();
                                    console.log('compute', term)
                                    if (term.length <= 2) return true;

                                    const formattedTerm = term.toLowerCase();
                                    const formattedName = positionData.name.toLowerCase();
                                    return formattedName.indexOf(formattedTerm) !== -1;


                                })
                            }
                        });

                        this.formControlErrorStateMatcher = function (formControl) {
                            return ko.pureComputed(() => {
                                return this.isSubmitted() && !formControl.isValid();
                            });
                        };

                        this.cancel = function () {
                            if ('cancel' in params) {
                                params.cancel();
                            }
                        };

                        this.submit = function () {
                            if ('submit' in params) {
                                this.positions.forEach(p => {
                                    console.log(p.checked())
                                    p.position().visible(p.checked());
                                });
                                params.submit(true);
                            }

                        };
                    });
                }
            },
            template: {
                element: document.getElementById('calculation-settings-positions-modal-dialog-template')
            }
        });
    });
</script>

<template id="calculation-settings-positions-modal-dialog-template">

    <button class="hrm-button hrm-basic-modal-dialog__close-button"
            data-bind="click: function() { cancel(); }"
            aria-label="Close">
    </button>

    <div class="hrm-basic-modal-dialog__header">
        <h2 class="hrm-basic-modal-dialog__title">
            Показывать в таблице должности
        </h2>
    </div>

    <div class="hrm-basic-modal-dialog__body">
        <!-- ko let: {control: ko.observable(null)} -->
        <div class="hrm-search-form-field"
             data-bind="hrmFormField, hrmFormFieldControlRef: control">
            <div data-bind="hrmFormFieldBasis, hrmFormFieldBasisControl: control">
                <i class="hrm-form-field__basis-prefix hrm-form-field-icon hrm-form-field-search-icon"></i>

                <input data-bind="
                        textInput: term,
                        hrmFormFieldInputControl: control
                    "
                       placeholder="Поиск">
            </div>
        </div>
        <!-- /ko -->

        <!-- ko foreach: { data: $component.positions, as: 'position' } -->

        <!-- ko let: {checkboxGroup: ko.observable(null), visible: position.visible} -->
        <div data-bind="if: visible">
            <div data-bind="component: {name: 'hrm-checkbox-group', params: {exportAs: checkboxGroup}}">
                <div
                     data-bind="component: {name: 'hrm-checkbox', params: {owner: checkboxGroup, checked: position.checked }}">
                </div>
                <label
                       data-bind="hrmCheckboxGroupLabel, hrmCheckboxGroupLabelOwner: checkboxGroup, text: position.name"></label>
            </div>
        </div>

        <!-- /ko -->

        <!-- /ko -->
    </div>

    <div class="hrm-basic-modal-dialog__action-list">
        <button class="hrm-button hrm-basic-button hrm-basic-modal-dialog__action-list-item
           position-page__speciality-modal-dialog-cancel-button"
                data-bind="click: function() {cancel();}">
            Отменить
        </button>

        <button class="hrm-button hrm-basic-button hrm-accent-button hrm-basic-modal-dialog__action-list-item
           position-page__speciality-modal-dialog-submit-button"
                data-bind="click: function() {submit();}">
            Сохранить
        </button>
    </div>

</template>
