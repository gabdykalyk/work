<script type="text/javascript">
    $(function () {
        ko.components.register('calculation-settings-positions-modal-dialog', {
            viewModel: {
                createViewModel: function (params, componentInfo) {
                    const $element = $(componentInfo.element);

                    $element.addClass([
                        'modal-dialog',
                        'modal-dialog-centered',
                        'hrm-modal-dialog',
                        'hrm-basic-modal-dialog',
                        'hrm-modal-dialog--size_large'
                    ]);

                    return new (function () {
                        this.term = ko.observable('');

                        this.positions = params.data.positions.map((p) => {
                            const positionData = p();
                            return {
                                name: positionData.name,
                                checked: ko.observable(positionData.visible()),
                                position: p,
                                visible: ko.pureComputed(() => {
                                    const term = this.term();

                                    if (!term || term.length < 2) return true;

                                    const formattedTerm = term.toLowerCase();
                                    const formattedName = positionData.name.toLowerCase();
                                    return formattedName.indexOf(formattedTerm) !== -1;


                                })
                            }
                        });

                        this.formControlErrorStateMatcher = function (formControl) {
                            return ko.pureComputed(() => {
                                return this.isSubmitted() && !formControl.isValid();
                            });
                        };

                        this.reset = function () {
                            this.term('');
                            this.positions.forEach(p => {
                                p.checked(false);
                            });
                        }

                        this.cancel = function () {
                            if ('cancel' in params) {
                                params.cancel();
                            }
                        };

                        this.submit = function () {
                            if ('submit' in params) {
                                this.positions.forEach(p => {
                                    p.position().visible(p.checked());
                                });
                                params.submit(true);
                            }

                        };
                    });
                }
            },
            template: {
                element: document.getElementById('calculation-settings-positions-modal-dialog-template')
            }
        });
    });
</script>

<template id="calculation-settings-positions-modal-dialog-template">

    <button class="hrm-button hrm-basic-modal-dialog__close-button"
            data-bind="click: function() { cancel(); }"
            aria-label="Close">
    </button>

    <div class="hrm-basic-modal-dialog__header">
        <h2 class="hrm-basic-modal-dialog__title">
            Показывать в таблице должности
        </h2>
    </div>

    <div class="hrm-basic-modal-dialog__body positions-settings">
        <div class="positions-settings__search"
             data-bind="component: {name: 'hrm-search-field', params: { termModel: term, placeholder: 'Поиск' }}"></div>

        <div class="positions-settings__list">
            <!-- ko foreach: { data: $component.positions, as: 'position' } -->

            <!-- ko let: {checkboxGroup: ko.observable(null), visible: position.visible} -->
            <div class="positions-settings__list-item" data-bind="if: visible">
                <div data-bind="component: {name: 'hrm-checkbox-group', params: {exportAs: checkboxGroup}}">
                    <div
                         data-bind="component: {name: 'hrm-checkbox', params: {owner: checkboxGroup, checked: position.checked }}">
                    </div>
                    <label
                           data-bind="hrmCheckboxGroupLabel, hrmCheckboxGroupLabelOwner: checkboxGroup, text: position.name"></label>
                </div>
            </div>
            <!-- /ko -->

            <!-- /ko -->
        </div>

    </div>

    <div class="hrm-basic-modal-dialog__action-list">
        <button class="hrm-button hrm-basic-button hrm-basic-modal-dialog__action-list-item
           position-page__speciality-modal-dialog-cancel-button"
                data-bind="click: function() {reset();}">
            Сбросить
        </button>

        <button class="hrm-button hrm-basic-button hrm-accent-button hrm-basic-modal-dialog__action-list-item
           position-page__speciality-modal-dialog-submit-button"
                data-bind="click: function() {submit();}">
            Применить
        </button>
    </div>

</template>
