<script type="text/javascript">
    $(function () {
        const $page = $(document.documentElement);

        const ViewModel = function () {
            this.subscriptions = [];

            this.windowResizeHandler = () => {
                this.viewportSize({width: $(window).width(), height: $(window).height()});
            };
            this.viewportSize = ko.observable({width: $(window).width(), height: $(window).height()});

            this.activeStep = ko.observable(4);

            this.childrenComplete = function () {
                $page.removeClass('hrm-page--initializing');
            };

            this.back = function () {
                if (this.activeStep() > 0) {
                    this.activeStep(this.activeStep() - 1);
                }
            };

            this.createDishCategoryFormModel = function (value) {
                return {
                    value: ko.observable(value).extend({
                        required: {
                            message: 'Выберите категорию блюд'
                        }
                    })
                }
            };

            this.companyType = ko.observable(null);

            this.selectCompanyType = function (type) {
                this.companyType(type);
                this.activeStep(2);
            };

            this.dishCategoriesStepFormModel = ko.validatedObservable({
                categories: ko.observableArray([this.createDishCategoryFormModel('')])
            }, {deep: true, live: true});

            this.dishCategoriesStepAdd = function () {
                this.dishCategoriesStepFormModel().categories.push(this.createDishCategoryFormModel(''));
            };

            this.dishCategoriesStepRemove = function (index) {
                this.dishCategoriesStepFormModel().categories.splice(index, 1);
            };

            this.isDishCategoriesStepSubmitted = ko.observable(false);

            this.dishCategoriesStepFormControlErrorStateMatcher = function (formControl) {
                return ko.computed(() => {
                    return this.isDishCategoriesStepSubmitted() && !formControl.isValid();
                });
            };

            this.submitDishCategoriesStep = function () {
                this.isDishCategoriesStepSubmitted(true);

                if (this.dishCategoriesStepFormModel.isValid()) {
                    this.activeStep(this.activeStep() + 1);
                }
            };

            this.scheduleStepFormModel = (() => {
                const schedule = [
                    ko.observableArray([]),
                    ko.observableArray([]),
                    ko.observableArray([]),
                    ko.observableArray([]),
                    ko.observableArray([]),
                    ko.observableArray([]),
                    ko.observableArray([])
                ];

                return ko.validatedObservable({
                    intervalStart: ko.observable('08:00').extend({
                        required: true,
                        hrmTime: true
                    }),
                    intervalEnd: ko.observable('20:00').extend({
                        required: true,
                        hrmTime: true
                    }),
                    schedule: schedule,
                    validationObject: ko.validatedObservable().extend({
                        validation: {
                            validator: () => {
                                return schedule.some(weekday => weekday().length > 0);
                            }
                        }
                    })
                });
            })();

            this.scheduleStepLastValidIntervalStart = ko.observable(this.scheduleStepFormModel().intervalStart());
            this.scheduleStepLastValidIntervalEnd = ko.observable(this.scheduleStepFormModel().intervalEnd());

            this.isScheduleStepIntervalValid = ko.computed(() => {
                return this.scheduleStepFormModel().intervalStart.isValid() && this.scheduleStepFormModel().intervalEnd.isValid();
            });

            this.scheduleStepUsedIntervalStart = ko.computed(() => {
                if (this.isScheduleStepIntervalValid()) {
                    return this.scheduleStepFormModel().intervalStart();
                } else {
                    return this.scheduleStepLastValidIntervalStart();
                }
            });

            this.scheduleStepUsedIntervalEnd = ko.computed(() => {
                if (this.isScheduleStepIntervalValid()) {
                    return this.scheduleStepFormModel().intervalEnd();
                } else {
                    return this.scheduleStepLastValidIntervalEnd();
                }
            });

            this.scheduleStepIntervalBoundaryFormControlErrorStateMatcher = function (formControl) {
                return ko.computed(() => {
                    return !formControl.isValid();
                });
            };

            this.scheduleStepCutSchedule = function () {
                const start = moment(this.scheduleStepUsedIntervalStart(), 'HH:mm');
                const end = moment(this.scheduleStepUsedIntervalEnd(), 'HH:mm');

                const startHour = start.hour() === 0 ? (start.isBefore(end) ? 0 : 24) : start.hour();
                const endHour = end.hour() === 0 ? (start.isBefore(end) ? 24 : 0) : end.hour();

                this.scheduleStepFormModel().schedule.forEach(week => {
                    if (start.isBefore(end)) {
                        week.remove(hour => hour < startHour || hour > endHour);
                    } else {
                        week.remove(hour => hour < endHour && hour > startHour);
                    }

                    week.sort();
                });
            };

            this.submitScheduleStep = function () {
                if (this.scheduleStepFormModel.isValid()) {
                    this.activeStep(this.activeStep() + 1);
                }
            };

            this.turnoverStepFormModel = (() => {
                return ko.validatedObservable({
                    categories: ko.observableArray([
                        {
                            name: 'Пицца',
                            units: ko.observable('0'),
                            week: [
                                ko.observable(''),
                                ko.observable(''),
                                ko.observable(''),
                                ko.observable(''),
                                ko.observable(''),
                                ko.observable(''),
                                ko.observable('')
                            ],
                            weekTotal: ko.observable('')
                        },
                        {
                            name: 'Роллы',
                            units: ko.observable('1'),
                            week: [
                                ko.observable(''),
                                ko.observable(''),
                                ko.observable(''),
                                ko.observable(''),
                                ko.observable(''),
                                ko.observable(''),
                                ko.observable('')
                            ],
                            weekTotal: ko.observable('')
                        }
                    ])
                });
            })();

            this.turnoverStepDistributeWeekTotal = function (categoryIndex, total) {
                const portion = Math.floor((this.unmaskTurnoverStepValue(total) / 7) * 100) / 100;
                this.turnoverStepFormModel().categories()[categoryIndex].week.forEach(weekday => weekday(this.formatTurnoverStepValue(portion)));
                this.turnoverStepCategoriesWithFillingError.remove(categoryIndex);
            };

            this.turnoverStepCategoriesWithFillingError = ko.observableArray([]);

            this.turnoverStepTableCategoryErrorExtractor = function (index) {
                return ko.computed(() => {
                    if (this.turnoverStepCategoriesWithFillingError().includes(index)) {
                        return {message: 'Для автоматического заполнения данными, введите хотя бы одно значение'};
                    } else {
                        return null;
                    }
                });
            };

            this.onTurnoverStepCategoryWeekdayInput = function (categoryIndex) {
                const category = this.turnoverStepFormModel().categories()[categoryIndex];
                const isEmpty = category.week.every(weekday => weekday() === '');
                const total = !isEmpty ? +category.week.reduce((total, wd) => total + +this.unmaskTurnoverStepValue(wd()), 0).toFixed(2) : 0;

                category.weekTotal(this.formatTurnoverStepValue(total));
                this.turnoverStepCategoriesWithFillingError.remove(categoryIndex);
            };

            this.fillTurnoverStep = function () {
                const valuesByUnits = {};

                this.turnoverStepFormModel().categories().forEach(category => {
                    const values = [];

                    if (!(category.units() in valuesByUnits)) {
                        valuesByUnits[category.units()] = [];
                    }

                    category.week.forEach(weekday => {
                        if (weekday() !== '' && !valuesByUnits[category.units()].includes(weekday())) {
                            valuesByUnits[category.units()].push(weekday());
                        }

                        if (weekday() !== '' && !values.includes(weekday())) {
                            values.push(weekday());
                        }
                    });

                    if (values.length === 1) {
                        category.week.forEach(weekday => weekday(values[0]));
                    }
                });

                this.turnoverStepFormModel().categories().forEach((category, index) => {
                    if (valuesByUnits[category.units()].length === 1 && category.week[0]() === '') {
                        category.week.forEach(weekday => weekday(valuesByUnits[category.units()][0]));
                    } else if (valuesByUnits[category.units()].length === 0) {
                        if (!this.turnoverStepCategoriesWithFillingError().includes(index)) {
                            this.turnoverStepCategoriesWithFillingError.push(index);
                        }
                    }
                });
            };

            this.clearTurnoverStep = function () {
                this.turnoverStepFormModel().categories().forEach((category, index) => {
                    category.week.forEach(weekday => weekday(''));
                    category.weekTotal('');
                    this.turnoverStepCategoriesWithFillingError.remove(index);
                });
            };

            this.submitTurnoverStep = function () {};

            this.formatTurnoverStepValue = function (value) {
                return Inputmask.format(value, {alias: 'decimal', digits: 2, groupSeparator: ' ', autoGroup: true, allowMinus: false});
            };

            this.unmaskTurnoverStepValue = function (value) {
                return Inputmask.unmask(value, {alias: 'decimal', digits: 2, groupSeparator: ' ', autoGroup: true, allowMinus: false});
            };

            this.maxAvailableStep = ko.computed(() => {
                if (this.companyType() === null) {
                    return 1;
                } else if (!this.dishCategoriesStepFormModel.isValid()) {
                    return 2;
                } else if (!this.scheduleStepFormModel.isValid()) {
                    return 3;
                } else if (!this.turnoverStepFormModel.isValid()) {
                    return 4;
                } else {
                    return 5;
                }
            });

            (() => {
                $(window).on('resize', this.windowResizeHandler);

                this.subscriptions.push(this.scheduleStepUsedIntervalStart.subscribe(() => {
                    this.scheduleStepCutSchedule();
                }));

                this.subscriptions.push(this.scheduleStepUsedIntervalEnd.subscribe(() => {
                    this.scheduleStepCutSchedule();
                }));

                this.subscriptions.push(this.scheduleStepFormModel().intervalStart.subscribe(value => {
                    if (this.scheduleStepFormModel().intervalStart.isValid()) {
                        this.scheduleStepLastValidIntervalStart(value);
                    }
                }));

                this.subscriptions.push(this.scheduleStepFormModel().intervalEnd.subscribe(value => {
                    if (this.scheduleStepFormModel().intervalEnd.isValid()) {
                        this.scheduleStepLastValidIntervalEnd(value);
                    }
                }));
            })();
        };

        const viewModel = new ViewModel();

        ViewModel.prototype.dispose = function() {
            $(window).off('resize', this.windowResizeHandler);
            this.subscriptions.forEach(s => s.dispose());
        };

        ko.applyBindings(
            viewModel,
            $page.get()[0]
        );
    });
</script>