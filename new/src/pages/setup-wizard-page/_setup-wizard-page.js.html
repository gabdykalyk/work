<script type="text/javascript">
    // setupWizardPageTurnoverSelectorTable
    (() => {
        class ViewModel {
            constructor(element, categoryRowElements) {
                this._subscriptions = [];
                this.element = element;
                this._categoryRowElements = categoryRowElements;
                this._bodyScrollHandler = () => {
                    this._updateActiveCategoryIndex();
                };
                this.activeCategoryIndex = ko.observable(null);

                this._init();
            }

            _init() {
                const $element = $(this.element);
                $element.addClass('setup-wizard-page__turnover-selector-table');

                if (this._categoryRowElements !== null) {
                    this._subscriptions.push(this._categoryRowElements.subscribe(() => {
                        this._updateActiveCategoryIndex();
                    }));

                    $('.hrm-scaffold__body').on('scroll', this._bodyScrollHandler);

                    this._updateActiveCategoryIndex();
                }
            }

            _destroy() {
                this._subscriptions.forEach(s => s.dispose());
                $('.hrm-scaffold__body').off('scroll', this._bodyScrollHandler);
            }

            _updateActiveCategoryIndex() {
                const rowElements = this._categoryRowElements();

                if (rowElements.length === 0) {
                    this.activeCategoryIndex(null);
                    return;
                }

                for (let i = 0; i < rowElements.length; i++) {
                    if ($(rowElements[i]).offset().top - $(window).scrollTop() > 0) {
                        this.activeCategoryIndex(Math.max(i - 1, 0));
                        return;
                    }
                }

                this.activeCategoryIndex(rowElements.length - 1);
            }
        }

        ko.bindingHandlers.setupWizardPageTurnoverSelectorTable = {
            init: function (element, valueAccessor, allBindings) {
                const categoryRowElements = allBindings.get('setupWizardPageTurnoverSelectorTableCategoryRowElements') || null;
                const viewModel = new ViewModel(element, categoryRowElements);

                if (valueAccessor() !== undefined) {
                    if (ko.isObservableArray(valueAccessor())) {
                        valueAccessor().push(viewModel);
                    } else {
                        valueAccessor()(viewModel);
                    }
                }

                ko.utils.domNodeDisposal.addDisposeCallback(element, function() {
                    if (valueAccessor() !== undefined) {
                        if (ko.isObservableArray(valueAccessor())) {
                            valueAccessor().remove(this);
                        } else {
                            valueAccessor()(null);
                        }
                    }

                    viewModel._destroy();
                });
            }
        };
    })();

    $(function () {
        const $page = $(document.documentElement);

        const ViewModel = function () {
            this.dishCategories = [
                {
                    id: '1',
                    name: 'Пицца',
                    turnoverDistribution: [
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 5, 5, 5, 5, 5, 5, 5, 5],
                        [2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 5, 5, 5, 5, 5, 5, 5, 5]
                    ]
                },
                {
                    id: '2',
                    name: 'Роллы',
                    turnoverDistribution: [
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 5, 5, 5, 5, 5, 5, 5, 5],
                        [2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 5, 5, 5, 5, 5, 5, 5, 5]
                    ]
                },
                {
                    id: '3',
                    name: 'Супы',
                    turnoverDistribution: [
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 5, 5, 5, 5, 5, 5, 5, 5],
                        [2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 5, 5, 5, 5, 5, 5, 5, 5]
                    ]
                },
                {
                    id: '4',
                    name: 'Салаты',
                    turnoverDistribution: [
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 5, 5, 5, 5, 5, 5, 5, 5],
                        [2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 5, 5, 5, 5, 5, 5, 5, 5]
                    ]
                },
                {
                    id: '5',
                    name: 'Закуски',
                    turnoverDistribution: [
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 5, 5, 5, 5, 5, 5, 5, 5],
                        [2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 5, 5, 5, 5, 5, 5, 5, 5]
                    ]
                },
                {
                    id: '6',
                    name: 'Десерты',
                    turnoverDistribution: [
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 5, 5, 5, 5, 5, 5, 5, 5],
                        [2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 5, 5, 5, 5, 5, 5, 5, 5]
                    ]
                },
                {
                    id: '7',
                    name: 'Напитки',
                    turnoverDistribution: [
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
                        [2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 5, 5, 5, 5, 5, 5, 5, 5],
                        [2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 5, 5, 5, 5, 5, 5, 5, 5]
                    ]
                }
            ];

            this.builtinPositionNames = ['Повар-пиццмейкер', 'Повар-сушист', 'Мороженщик'];

            this.subscriptions = [];

            this.windowResizeHandler = () => {
                this.viewportSize({width: $(window).width(), height: $(window).height()});
            };
            this.viewportSize = ko.observable({width: $(window).width(), height: $(window).height()});

            this.activeStep = ko.observable(1);

            this.childrenComplete = function () {
                $page.removeClass('hrm-page--initializing');
            };

            this.getDishCategory = function (categoryId) {
                return this.dishCategories.find(c => c.id === categoryId);
            };

            this.back = function () {
                if (this.activeStep() > 0) {
                    this.activeStep(this.activeStep() - 1);
                }
            };

            this.createDishCategoryFormModel = function (value) {
                return {
                    value: ko.observable(value).extend({
                        required: {
                            message: 'Выберите категорию блюд'
                        }
                    }),
                    units: ko.observable('0'),
                    week: [1, 2, 3, 4, 5, 6, 7].map(() => ({
                        hours: ko.observable(null),
                        weekdayTotal: ko.observable('').extend({
                            required: true
                        })
                    })),
                    hourTotals: ko.observable(null),
                    weekTotal: ko.observable('').extend({
                        required: true
                    })
                }
            };

            this.createPositionFormModel = function (name) {
                return {
                    name: ko.observable(name).extend({
                        required: {
                            message: 'Выберите должность'
                        }
                    }),
                    workloadType: ko.observable('').extend({
                        required: {
                            message: 'Обязательное поле'
                        }
                    }),
                    units: ko.observable('').extend({
                        required: {
                            message: 'Обязательное поле'
                        }
                    }),
                    standard: ko.observable('').extend({
                        required: {
                            message: 'Обязательное поле'
                        }
                    }),
                    dishCategories: ko.observableArray([]).extend({
                        required: {
                            message: 'Обязательное поле'
                        }
                    }),
                    dishCategoriesExclusive: ko.observable(false)
                }
            };

            this.formModel = ko.validatedObservable({
                companyType: ko.observable(null),
                dishCategories: ko.observableArray([
                    this.createDishCategoryFormModel()
                ]),
                isTurnoverCalculated: ko.observable(false),
                intervalStart: ko.observable('08:00').extend({
                    required: true,
                    hrmDate: {
                        params: 'HH:mm',
                        message: 'Неверный формат времени'
                    }
                }),
                intervalEnd: ko.observable('20:00').extend({
                    required: true,
                    hrmDate: {
                        params: 'HH:mm',
                        message: 'Неверный формат времени'
                    }
                }),
                schedule: [
                    ko.observableArray([]),
                    ko.observableArray([]),
                    ko.observableArray([]),
                    ko.observableArray([]),
                    ko.observableArray([]),
                    ko.observableArray([]),
                    ko.observableArray([])
                ],
                positions: ko.observableArray([
                    this.createPositionFormModel()
                ])
            });

            this.companyTypeStepSelect = function (type) {
                this.formModel().companyType(type);
                this.activeStep(2);
            };

            this.isDishCategoriesStepSubmitted = ko.observable(false);

            this.isDishCategoriesStepValid = ko.pureComputed(() => {
                return this.formModel().dishCategories().every(c => c.value() !== undefined);
            });

            this.dishCategoriesStepAdd = function () {
                this.formModel().dishCategories.push(this.createDishCategoryFormModel());
            };

            this.dishCategoriesStepRemove = function (index) {
                this.formModel().dishCategories.splice(index, 1);
            };

            this.dishCategoriesStepFormControlErrorStateMatcher = function (formControl) {
                return ko.pureComputed(() => {
                    return this.isDishCategoriesStepSubmitted() && !formControl.isValid();
                });
            };

            this.dishCategoriesStepSubmit = function () {
                this.isDishCategoriesStepSubmitted(true);

                if (this.isDishCategoriesStepValid()) {
                    this.activeStep(this.activeStep() + 1);
                }
            };

            this.scheduleStepLastValidIntervalStart = ko.observable(this.formModel().intervalStart());
            this.scheduleStepLastValidIntervalEnd = ko.observable(this.formModel().intervalEnd());

            this.isScheduleStepIntervalValid = ko.pureComputed(() => {
                return this.formModel().intervalStart.isValid() &&
                       this.formModel().intervalEnd.isValid();
            });

            this.isScheduleStepValid = ko.pureComputed(() => {
                return this.isScheduleStepIntervalValid() && this.formModel().schedule.some(weekday => weekday().length > 0);
            });

            this.scheduleStepUsedIntervalStart = ko.pureComputed(() => {
                if (this.isScheduleStepIntervalValid()) {
                    return this.formModel().intervalStart();
                } else {
                    return this.scheduleStepLastValidIntervalStart();
                }
            });

            this.scheduleStepUsedIntervalEnd = ko.pureComputed(() => {
                if (this.isScheduleStepIntervalValid()) {
                    return this.formModel().intervalEnd();
                } else {
                    return this.scheduleStepLastValidIntervalEnd();
                }
            });

            this.scheduleStepIntervalBoundaryFormControlErrorStateMatcher = function (formControl) {
                return ko.pureComputed(() => {
                    return !formControl.isValid();
                });
            };

            this.scheduleStepCutSchedule = function () {
                const start = moment(this.scheduleStepUsedIntervalStart(), 'HH:mm');
                const end = moment(this.scheduleStepUsedIntervalEnd(), 'HH:mm');

                const startHour = start.hour() === 0 ? (start.isBefore(end) ? 0 : 24) : start.hour();
                const endHour = end.hour() === 0 ? (start.isBefore(end) ? 24 : 0) : end.hour();

                this.formModel().schedule.forEach(week => {
                    if (start.isBefore(end)) {
                        week.remove(hour => hour < startHour || hour > endHour);
                    } else {
                        week.remove(hour => hour < endHour && hour > startHour);
                    }

                    week.sort();
                });
            };

            this.scheduleStepSubmit = function () {
                if (this.isScheduleStepValid()) {
                    this.activeStep(this.activeStep() + 1);
                }
            };

            this.isTurnoverStepSubmitted = ko.observable(false);

            this.turnoverStepLastWeekTotals = ko.observable(null);
            this.turnoverStepLastWeekdayTotals = ko.observable(null);
            this.turnoverStepLastHourTotals = ko.observable(null);

            this.turnoverStepUpdateLastWeekTotal = function (categoryIndex) {
                const weekTotal = this.formModel().dishCategories()[categoryIndex].weekTotal();
                this.turnoverStepLastWeekTotals()[categoryIndex](weekTotal);
            };

            this.turnoverStepUpdateLastWeekdayTotal = function (categoryIndex, weekdayIndex) {
                const weekdayTotal = this.formModel().dishCategories()[categoryIndex].week[weekdayIndex].weekdayTotal();
                this.turnoverStepLastWeekdayTotals()[categoryIndex][weekdayIndex](weekdayTotal);
            };

            this.turnoverStepUpdateLastHourTotal = function (categoryIndex, hourIndex) {
                const hourTotal = this.formModel().dishCategories()[categoryIndex].hourTotals()[hourIndex]();
                this.turnoverStepLastHourTotals()[categoryIndex][hourIndex](hourTotal);
            };

            this.turnoverStepIntervalHours = ko.pureComputed(() => {
                if (!this.formModel().intervalStart.isValid() || !this.formModel().intervalEnd.isValid()) {
                    return null;
                }

                const start = moment(this.formModel().intervalStart(), 'HH:mm');
                const end = moment(this.formModel().intervalEnd(), 'HH:mm');

                if (start.isSameOrAfter(end)) {
                    end.add(1, 'd');
                }

                const isEndHourInteger = end.minutes() === 0;

                if (!isEndHourInteger) {
                    end.add(1, 'h').minutes(0);
                }

                let hours = [];

                while (start.isBefore(end)) {
                    hours.push(start.hours());
                    start.add(1, 'h');
                }

                hours = hours.filter(hour => this.formModel().schedule.some(weekday => weekday().includes(hour)));

                return hours;
            });

            this.onTurnoverStepWeekTotalChange = function (categoryIndex) {
                if (this.formModel().isTurnoverCalculated()) {
                    const previousTotal = this.turnoverStepUnmaskValue(this.turnoverStepLastWeekTotals()[categoryIndex]());
                    const total = this.turnoverStepUnmaskValue(this.formModel().dishCategories()[categoryIndex].weekTotal());

                    if (previousTotal !== 0) {
                        const changeFactor = total / previousTotal;
                        this.turnoverStepChangeWeekTotal(categoryIndex, total / previousTotal);
                        [1, 2, 3, 4, 5, 6, 7].forEach((weekday, weekdayIndex) => this.turnoverStepChangeWeekdayTotal(categoryIndex, weekdayIndex, changeFactor));
                    } else {
                        this.turnoverStepDivideWeekTotal(categoryIndex);
                        [1, 2, 3, 4, 5, 6, 7].forEach((weekday, weekdayIndex) => this.turnoverStepDistributeWeekdayTotal(categoryIndex, weekdayIndex));
                    }

                    this.turnoverStepIntervalHours().forEach((hour, hourIndex) => {
                        this.turnoverStepCalculateHourTotal(categoryIndex, hourIndex);
                        this.turnoverStepUpdateLastHourTotal(categoryIndex, hourIndex);
                    });

                    this.turnoverStepUpdateLastWeekTotal(categoryIndex);
                } else {
                    this.turnoverStepDivideWeekTotal(categoryIndex);
                    this.turnoverStepCategoriesWithFillingError.remove(categoryIndex);
                }
            };

            this.turnoverStepDivideWeekTotal = function (categoryIndex) {
                const total = this.turnoverStepUnmaskValue(this.formModel().dishCategories()[categoryIndex].weekTotal());
                const portion = Math.floor((total / 7) * 100) / 100;
                this.formModel().dishCategories()[categoryIndex].week.forEach(weekday => weekday.weekdayTotal(this.turnoverStepFormatValue(portion)));
            };

            this.turnoverStepChangeWeekTotal = function (categoryIndex, changeFactor) {
                this.formModel().dishCategories()[categoryIndex].week.forEach(weekday => {
                    const value = this.turnoverStepUnmaskValue(weekday.weekdayTotal()) * changeFactor;
                    weekday.weekdayTotal(this.turnoverStepFormatValue(value));
                });
            };

            this.onTurnoverStepWeekdayTotalChange = function (categoryIndex, weekdayIndex) {
                if (this.formModel().isTurnoverCalculated()) {
                    const previousTotal = this.turnoverStepUnmaskValue(this.turnoverStepLastWeekdayTotals()[categoryIndex][weekdayIndex]());

                    if (previousTotal !== 0) {
                        const total = this.turnoverStepUnmaskValue(this.formModel().dishCategories()[categoryIndex].week[weekdayIndex].weekdayTotal());
                        this.turnoverStepChangeWeekdayTotal(categoryIndex, weekdayIndex, total / previousTotal);
                    } else {
                        this.turnoverStepDistributeWeekdayTotal(categoryIndex, weekdayIndex);
                    }

                    this.turnoverStepIntervalHours().forEach((hour, hourIndex) => {
                        this.turnoverStepCalculateHourTotal(categoryIndex, hourIndex);
                        this.turnoverStepUpdateLastHourTotal(categoryIndex, hourIndex);
                    });

                    this.turnoverStepUpdateLastWeekdayTotal(categoryIndex, weekdayIndex);
                }
            };

            this.turnoverStepChangeWeekdayTotal = function (categoryIndex, weekdayIndex, changeFactor) {
                this.formModel().dishCategories()[categoryIndex].week[weekdayIndex].hours().forEach(hour => {
                    if (hour !== null) {
                        const value = this.turnoverStepUnmaskValue(hour()) * changeFactor;
                        hour(this.turnoverStepFormatValue(value));
                    }
                });
            };

            this.turnoverStepDistributeWeekdayTotal = function (categoryIndex, weekdayIndex) {
                const category = this.formModel().dishCategories()[categoryIndex];
                const total = this.turnoverStepUnmaskValue(category.week[weekdayIndex].weekdayTotal());

                const weekdayDistribution = this.getDishCategory(category.value()).turnoverDistribution[weekdayIndex]
                    .filter((factor, hourIndex) => this.turnoverStepIntervalHours().includes(hourIndex))
                    .map((factor, hourIndex) => category.week[weekdayIndex].hours()[hourIndex] !== null ? factor : 0);

                const weekdayDistributionSum = weekdayDistribution.reduce((sum, factor) => sum + factor, 0);

                this.turnoverStepIntervalHours().forEach((_, hourIndex) => {
                    const hourValue = category.week[weekdayIndex].hours()[hourIndex];

                    if (hourValue !== null) {
                        const value = total * weekdayDistribution[hourIndex] / weekdayDistributionSum;
                        hourValue(this.turnoverStepFormatValue(value));
                    }
                });
            };

            this.onTurnoverStepWeekdayTotalInput = function (categoryIndex) {
                this.turnoverStepCalculateWeekTotal(categoryIndex);

                if (this.formModel().isTurnoverCalculated()) {
                    this.turnoverStepUpdateLastWeekTotal(categoryIndex);
                } else {
                    this.turnoverStepCategoriesWithFillingError.remove(categoryIndex);
                }
            };

            this.onTurnoverStepHourInput = function (categoryIndex, weekdayIndex, hourIndex) {
                this.turnoverStepCalculateWeekdayTotal(categoryIndex, weekdayIndex);
                this.turnoverStepCalculateWeekTotal(categoryIndex);
                this.turnoverStepCalculateHourTotal(categoryIndex, hourIndex);

                this.turnoverStepUpdateLastWeekdayTotal(categoryIndex, weekdayIndex);
                this.turnoverStepUpdateLastWeekTotal(categoryIndex);
                this.turnoverStepUpdateLastHourTotal(categoryIndex, hourIndex);
            };

            this.onTurnoverStepHourTotalChange = function (categoryIndex, hourIndex) {
                const previousTotal = this.turnoverStepUnmaskValue(this.turnoverStepLastHourTotals()[categoryIndex][hourIndex]());

                if (previousTotal !== 0) {
                    const total = this.turnoverStepUnmaskValue(this.formModel().dishCategories()[categoryIndex].hourTotals()[hourIndex]());
                    this.turnoverStepChangeHourTotal(categoryIndex, hourIndex, total / previousTotal);
                } else {
                    this.turnoverStepDivideHourTotal(categoryIndex, hourIndex);
                }

                [1, 2, 3, 4, 5, 6, 7].forEach((weekday, weekdayIndex) => {
                    this.turnoverStepCalculateWeekdayTotal(categoryIndex, weekdayIndex);
                });

                this.turnoverStepCalculateWeekTotal(categoryIndex);
                this.turnoverStepUpdateLastHourTotal(categoryIndex, hourIndex);
            };

            this.turnoverStepDivideHourTotal = function (categoryIndex, hourIndex) {
                const category = this.formModel().dishCategories()[categoryIndex];
                const total = this.turnoverStepUnmaskValue(category.hourTotals()[hourIndex]());
                const enabledHours = category.week.map(weekday => weekday.hours()[hourIndex]).filter(hour => hour !== null);

                if (enabledHours.length !== 0) {
                    const portion = Math.floor((total / enabledHours.length) * 100) / 100;
                    enabledHours.forEach(hour => {
                        hour(this.turnoverStepFormatValue(portion));
                    });
                }
            };

            this.turnoverStepChangeHourTotal = function (categoryIndex, hourIndex, changeFactor) {
                [1, 2, 3, 4, 5, 6, 7].forEach((weekday, weekdayIndex) => {
                    const hour = this.formModel().dishCategories()[categoryIndex].week[weekdayIndex].hours()[hourIndex];
                    const value = this.turnoverStepUnmaskValue(hour()) * changeFactor;
                    hour(this.turnoverStepFormatValue(value));
                });
            };

            this.turnoverStepCalculateWeekTotal = function (categoryIndex) {
                const category = this.formModel().dishCategories()[categoryIndex];
                const total = category.week.reduce((total, wd) => total + this.turnoverStepUnmaskValue(wd.weekdayTotal()), 0);

                category.weekTotal(this.turnoverStepFormatValue(total));
            };

            this.turnoverStepCalculateWeekdayTotal = function (categoryIndex, weekdayIndex) {
                const category = this.formModel().dishCategories()[categoryIndex];
                const weekdayTotal = category.week[weekdayIndex].hours().reduce((total, hour) => total + (hour !== null ? this.turnoverStepUnmaskValue(hour()) : 0), 0);
                category.week[weekdayIndex].weekdayTotal(this.turnoverStepFormatValue(weekdayTotal));
            };

            this.turnoverStepCalculateHourTotal = function (categoryIndex, hourIndex) {
                const total = this.formModel().dishCategories()[categoryIndex].week.reduce((total, weekday) => {
                    return total + (weekday.hours()[hourIndex] !== null ? this.turnoverStepUnmaskValue(weekday.hours()[hourIndex]()) : 0);
                }, 0);

                this.formModel().dishCategories()[categoryIndex].hourTotals()[hourIndex](this.turnoverStepFormatValue(total));
            };

            this.turnoverStepCategoriesWithFillingError = ko.observableArray([]);

            this.turnoverStepTableCategoryErrorExtractor = function (index) {
                return ko.pureComputed(() => {
                    if (this.turnoverStepCategoriesWithFillingError().includes(index)) {
                        return {message: 'Для автоматического заполнения данными, введите хотя бы одно значение'};
                    } else {
                        return null;
                    }
                });
            };

            this.turnoverStepFill = function () {
                const valuesByUnits = {};

                this.turnoverStepCategoriesWithFillingError([]);

                this.formModel().dishCategories().forEach(category => {
                    const values = [];

                    if (!(category.units() in valuesByUnits)) {
                        valuesByUnits[category.units()] = [];
                    }

                    category.week.forEach(weekday => {
                        if (weekday.weekdayTotal() !== '' && !valuesByUnits[category.units()].includes(weekday.weekdayTotal())) {
                            valuesByUnits[category.units()].push(weekday.weekdayTotal());
                        }

                        if (weekday.weekdayTotal() !== '' && !values.includes(weekday.weekdayTotal())) {
                            values.push(weekday.weekdayTotal());
                        }
                    });

                    if (values.length === 1) {
                        category.week.forEach(weekday => weekday.weekdayTotal(values[0]));
                    }
                });

                this.formModel().dishCategories().forEach((category, categoryIndex) => {
                    if (valuesByUnits[category.units()].length === 1 && category.week[0].weekdayTotal() === '') {
                        category.week.forEach(weekday => weekday.weekdayTotal(valuesByUnits[category.units()][0]));
                    } else if (valuesByUnits[category.units()].length === 0) {
                        if (!this.turnoverStepCategoriesWithFillingError().includes(categoryIndex)) {
                            this.turnoverStepCategoriesWithFillingError.push(categoryIndex);
                        }
                    }

                    this.turnoverStepCalculateWeekTotal(categoryIndex);
                });
            };

            this.turnoverStepClear = function () {
                if (this.formModel().isTurnoverCalculated()) {
                    this.isTurnoverStepSubmitted(false);
                    this.formModel().isTurnoverCalculated(false);

                    this.formModel().dishCategories().forEach(category => {
                        category.week.forEach(weekday => {
                            weekday.hours(null);
                        });

                        category.hourTotals(null);
                    });

                    this.turnoverStepLastWeekTotals(null);
                    this.turnoverStepLastWeekdayTotals(null);
                    this.turnoverStepLastHourTotals(null);
                } else {
                    this.formModel().dishCategories().forEach((category, index) => {
                        category.week.forEach(weekday => weekday.weekdayTotal(''));
                        category.weekTotal('');
                        this.turnoverStepCategoriesWithFillingError.remove(index);
                    });
                }
            };

            this.turnoverStepBack = function () {
                if (this.formModel().isTurnoverCalculated()) {
                    this.isTurnoverStepSubmitted(false);
                    this.formModel().isTurnoverCalculated(false);

                    this.formModel().dishCategories().forEach(category => {
                        category.week.forEach(weekday => {
                            weekday.hours(null);
                        });

                        category.hourTotals(null);
                    });

                    this.turnoverStepLastWeekTotals(null);
                    this.turnoverStepLastWeekdayTotals(null);
                    this.turnoverStepLastHourTotals(null);
                } else {
                    this.back();
                }
            };

            this.isTurnoverStepValid = ko.pureComputed(() => {
                if (!this.formModel().isTurnoverCalculated()) {
                    return false;
                }

                for (let category of this.formModel().dishCategories()) {
                    if (category.weekTotal() === '') {
                        return false;
                    }

                    for (let weekday of category.week) {
                        if (weekday.weekdayTotal() === '') {
                            return false;
                        }

                        for (let hour of weekday.hours()) {
                            if (hour !== null && hour() === '') {
                                return false;
                            }
                        }
                    }

                    for (let hourTotal of category.hourTotals()) {
                        if (hourTotal() === '') {
                            return false;
                        }
                    }
                }

                return true;
            });

            this.turnoverStepSubmit = function () {
                if (!this.formModel().isTurnoverCalculated()) {
                    const schedule = this.formModel().schedule;

                    this.formModel().dishCategories().forEach((category, categoryIndex) => {
                        category.week.forEach((weekday, weekdayIndex) => {
                            weekday.hours(this.turnoverStepIntervalHours().map(hour => {
                                if (schedule[weekdayIndex]().includes(hour)) {
                                    return ko.observable('').extend({
                                        required: true
                                    });
                                } else {
                                    return null;
                                }
                            }));

                            this.turnoverStepDistributeWeekdayTotal(categoryIndex, weekdayIndex);
                        });

                        category.hourTotals(this.turnoverStepIntervalHours().map(() => ko.observable('').extend({required: true})));
                        this.turnoverStepIntervalHours().forEach((hour, hourIndex) => {
                            this.turnoverStepCalculateHourTotal(categoryIndex, hourIndex);
                        });
                    });

                    this.turnoverStepLastWeekTotals(this.formModel().dishCategories().map(category => ko.observable(category.weekTotal())));
                    this.turnoverStepLastWeekdayTotals(this.formModel().dishCategories().map(category => {
                        return category.week.map(weekday => {
                            return ko.observable(weekday.weekdayTotal());
                        })
                    }));
                    this.turnoverStepLastHourTotals(this.formModel().dishCategories().map(category => {
                        return category.hourTotals()    .map(hourTotal => ko.observable(hourTotal()));
                    }));

                    this.formModel().isTurnoverCalculated(true);
                } else {
                    this.isTurnoverStepSubmitted(true);

                    if (this.isTurnoverStepValid()) {
                        this.activeStep(this.activeStep() + 1);
                    }
                }

                this.turnoverStepCategoriesWithFillingError([]);
            };

            this.turnoverStepGetHourLabelData = function (hourIndex) {
                function process (time) {
                    const parts = time.split(':');

                    return {
                        hour: parts[0],
                        minute: parts[1]
                    };
                }

                const hours = this.turnoverStepIntervalHours();

                const currentParts = process(moment().hour(hours[hourIndex]).minute(0).format('HH:mm'));

                const data = {
                    start: currentParts,
                    end: {
                        ...currentParts,
                        minute: '59'
                    }
                };

                if (hourIndex === 0) {
                    const startParts = process(this.formModel().intervalStart());

                    if (startParts.minute !== '00') {
                        data.start.minute = startParts.minute;
                    }
                }

                if (hourIndex === hours.length - 1) {
                    const endParts = process(this.formModel().intervalEnd());

                    if (endParts.minute !== '00') {
                        data.end.minute = endParts.minute;
                    } else {
                        data.end = process(moment().hour(hours[hourIndex]).add(1, 'h').minute(0).format('HH:mm'));
                    }
                }

                return data;
            };

            this.turnoverStepFormatValue = function (value) {
                return Inputmask.format(value, {alias: 'decimal', digits: '0,2', groupSeparator: ' ', autoGroup: true, allowMinus: false}).replace('.00', '');
            };

            this.turnoverStepUnmaskValue = function (value) {
                const result = Inputmask.unmask(value, {alias: 'decimal', digits: '0,2', groupSeparator: ' ', autoGroup: true, allowMinus: false, unmaskAsNumber: true});

                if (result === '') {
                    return 0;
                }

                return result;
            };

            this.isPositionsStepSubmitted = ko.observable(false);

            this.isPositionsStepValid = ko.pureComputed(() => {
                return this.formModel().positions().every(p => p.name() !== '');
            });

            this.positionsStepAdd = function () {
                this.formModel().positions.push(this.createPositionFormModel());
            };

            this.positionsStepRemove = function (index) {
                this.formModel().positions.splice(index, 1);
            };

            this.positionsStepFormControlErrorStateMatcher = function (formControl) {
                return ko.pureComputed(() => {
                    return this.isPositionsStepSubmitted() && !formControl.isValid();
                });
            };

            this.positionsStepSubmit = function () {
                this.isPositionsStepSubmitted(true);

                if (this.isPositionsStepValid()) {
                    this.activeStep(this.activeStep() + 1);
                }
            };

            this.isWorkloadTypeStepSubmitted = ko.observable(false);

            this.isWorkloadTypeStepValid = ko.pureComputed(() => {
                return this.formModel().positions().every(position => {
                    return position.workloadType() !== '' &&
                           position.units() !== '' &&
                           position.standard() !== '' &&
                          (position.workloadType() !== '2' || position.dishCategories().length > 0);
                });
            });

            this.workloadTypeStepFormControlErrorStateMatcher = function (formControl) {
                return ko.pureComputed(() => {
                    return this.isWorkloadTypeStepSubmitted() && !formControl.isValid();
                });
            };

            this.workloadTypeStepSubmit = function () {
                this.isWorkloadTypeStepSubmitted(true);

                if (this.isWorkloadTypeStepValid()) {
                    console.log('end');
                }
            };

            this.maxAvailableStep = ko.pureComputed(() => {
                if (this.formModel().companyType() === null) {
                    return 1;
                } else if (!this.isDishCategoriesStepValid()) {
                    return 2;
                } else if (!this.isScheduleStepValid()) {
                    return 3;
                } else if (!this.isTurnoverStepValid()) {
                    return 4;
                } else if (!this.isPositionsStepValid()) {
                    return 5;
                } else {
                    return 6;
                }
            });

            (() => {
                $(window).on('resize', this.windowResizeHandler);

                this.subscriptions.push(this.scheduleStepUsedIntervalStart.subscribe(() => {
                    this.scheduleStepCutSchedule();
                }));

                this.subscriptions.push(this.scheduleStepUsedIntervalEnd.subscribe(() => {
                    this.scheduleStepCutSchedule();
                }));

                this.subscriptions.push(this.formModel().intervalStart.subscribe(value => {
                    if (this.formModel().intervalStart.isValid()) {
                        this.scheduleStepLastValidIntervalStart(value);
                    }
                }));

                this.subscriptions.push(this.formModel().intervalEnd.subscribe(value => {
                    if (this.formModel().intervalEnd.isValid()) {
                        this.scheduleStepLastValidIntervalEnd(value);
                    }
                }));

                this.subscriptions.push(this.formModel().dishCategories.subscribe(() => {
                    this.isTurnoverStepSubmitted(false);
                    this.formModel().isTurnoverCalculated(false);

                    this.formModel().dishCategories().forEach(category => {
                        category.week.forEach(weekday => {
                            weekday.hours(null);
                        });

                        category.hourTotals(null);
                    });

                    this.turnoverStepLastWeekdayTotals([]);
                }));

                this.subscriptions.push(...this.formModel().schedule.map(weekday => weekday.subscribe(() => {
                    this.isTurnoverStepSubmitted(false);
                    this.formModel().isTurnoverCalculated(false);

                    this.formModel().dishCategories().forEach(category => {
                        category.week.forEach(weekday => {
                            weekday.hours(null);
                        });

                        category.hourTotals(null);
                    });

                    this.turnoverStepLastWeekdayTotals([]);
                })));
            })();
        };

        const viewModel = new ViewModel();

        ViewModel.prototype.dispose = function() {
            $(window).off('resize', this.windowResizeHandler);
            this.subscriptions.forEach(s => s.dispose());
        };

        ko.applyBindings(
            viewModel,
            $page.get()[0]
        );
    });
</script>