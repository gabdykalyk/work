<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Правовые статусы</title>

    @@include('include/_css.html')

    @@include('include/_ie8.html')
</head>

<body>
    <div class="hat-scaffold">
        <div class="hat-scaffold__navbar">
            @@include('include/hat-navbar.html')
        </div>

        <div class="hat-scaffold__body">
            <div class="hat-scaffold__content-wrapper">
                <div class="law-statuses__content">
                    <div class="law-statuses__header">
                        <h1>Правовые статусы</h1>
                    </div>

                    <div class="law-statuses__sub-header">
                        <div class="form-group search-global search-global--empty">
                            <input class="form-control" placeholder="Поиск">

                            <button type="button" class="btn btn-default search-global__search-clear-button"
                                    title="Удалить">
                                <i class="far fa-times"></i>
                            </button>
                        </div>

                        <button class="btn btn-primary btn-p25 law-statuses__add-button">Добавить статус</button>
                    </div>

                    <div class="table law-statuses__table">
                        <div class="law-statuses__table-head">
                            <div class="law-statuses__table-head-row">
                                <div class="law-statuses__table-head-cell law-statuses__table-name-head-cell">
                                    Название
                                </div>

                                <div class="law-statuses__table-head-cell law-statuses__table-citizenship-head-cell">
                                    Гражданство
                                </div>

                                <div class="law-statuses__table-head-cell law-statuses__table-actions-head-cell"></div>
                            </div>
                        </div>

                        <ul class="law-statuses__table-body">
                            <li class="law-statuses__table-row law-statuses__table-status-row law-statuses__table-status-row--empty">
                                <div class="law-statuses__table-row-header">
                                    <div class="law-statuses__table-cell law-statuses__table-name-cell">
                                        <div class="law-statuses__table-status-row-toggle">
                                            <i class="fa fa-chevron-circle-down"></i>
                                            <span class="law-statuses__table-name">
                                                Резидент РФ
                                            </span>
                                        </div>
                                    </div>

                                    <div class="law-statuses__table-cell law-statuses__table-citizenship-cell">Россия</div>

                                    <div class="law-statuses__table-cell law-statuses__table-actions-cell">
                                        <button type="button" class="btn btn-default btn-w-30 law-statuses__table-row-edit-button" title="Редактировать">
                                            <i class="far fa-pencil"></i>
                                        </button>

                                        <button type="button" class="btn btn-default btn-w-30 law-statuses__table-row-remove-button"
                                                title="Удалить">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>

                                <ul class="law-statuses__table-row-content"></ul>
                            </li>

                            <li class="law-statuses__table-row law-statuses__table-status-row law-statuses__table-status-row--empty">
                                <div class="law-statuses__table-row-header">
                                    <div class="law-statuses__table-cell law-statuses__table-name-cell">
                                        <div class="law-statuses__table-status-row-toggle">
                                            <i class="fa fa-chevron-circle-down"></i>
                                            <span class="law-statuses__table-name">
                                                Временно пребывающий (по регистрации, с визой или без визы)
                                            </span>
                                        </div>
                                    </div>

                                    <div class="law-statuses__table-cell law-statuses__table-citizenship-cell">-</div>

                                    <div class="law-statuses__table-cell law-statuses__table-actions-cell">
                                        <button type="button" class="btn btn-default btn-w-30 law-statuses__table-row-edit-button" title="Редактировать">
                                            <i class="far fa-pencil"></i>
                                        </button>

                                        <button type="button" class="btn btn-default btn-w-30 law-statuses__table-row-remove-button"
                                                title="Удалить">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>

                                <ul class="law-statuses__table-row-content"></ul>
                            </li>

                            <li class="law-statuses__table-row law-statuses__table-status-row law-statuses__table-status-row--empty">
                                <div class="law-statuses__table-row-header">
                                    <div class="law-statuses__table-cell law-statuses__table-name-cell">
                                        <div class="law-statuses__table-status-row-toggle">
                                            <i class="fa fa-chevron-circle-down"></i>
                                            <span class="law-statuses__table-name">
                                                Временно проживающий (РВП)
                                            </span>
                                        </div>
                                    </div>

                                    <div class="law-statuses__table-cell law-statuses__table-citizenship-cell">
                                        Украина, Белоруссия, Казахстан
                                    </div>

                                    <div class="law-statuses__table-cell law-statuses__table-actions-cell">
                                        <button type="button" class="btn btn-default btn-w-30 law-statuses__table-row-edit-button" title="Редактировать">
                                            <i class="far fa-pencil"></i>
                                        </button>

                                        <button type="button" class="btn btn-default btn-w-30 law-statuses__table-row-remove-button"
                                                title="Удалить">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>

                                <ul class="law-statuses__table-row-content"></ul>
                            </li>

                            <li class="law-statuses__table-row law-statuses__table-status-row law-statuses__table-status-row--empty">
                                <div class="law-statuses__table-row-header">
                                    <div class="law-statuses__table-cell law-statuses__table-name-cell">
                                        <div class="law-statuses__table-status-row-toggle">
                                            <i class="fa fa-chevron-circle-down"></i>
                                            <span class="law-statuses__table-name">
                                                Постоянно проживающий (ВНЖ)
                                            </span>
                                        </div>
                                    </div>

                                    <div class="law-statuses__table-cell law-statuses__table-citizenship-cell">-</div>

                                    <div class="law-statuses__table-cell law-statuses__table-actions-cell">
                                        <button type="button" class="btn btn-default btn-w-30 law-statuses__table-row-edit-button" title="Редактировать">
                                            <i class="far fa-pencil"></i>
                                        </button>

                                        <button type="button" class="btn btn-default btn-w-30 law-statuses__table-row-remove-button"
                                                title="Удалить">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>

                                <ul class="law-statuses__table-row-content"></ul>
                            </li>

                            <li class="law-statuses__table-row law-statuses__table-document-row">
                                <div class="law-statuses__table-row-header">
                                    <div class="law-statuses__table-cell law-statuses__table-name-cell">
                                        <span class="law-statuses__table-name">
                                            Миграционная карта
                                        </span>
                                    </div>
                                </div>
                            </li>

                            <li class="law-statuses__table-row law-statuses__table-document-row">
                                <div class="law-statuses__table-row-header">
                                    <div class="law-statuses__table-cell law-statuses__table-name-cell">
                                        <span class="law-statuses__table-name">
                                            Патент
                                        </span>
                                    </div>
                                </div>
                            </li>

                            <li class="law-statuses__table-row law-statuses__table-document-row">
                                <div class="law-statuses__table-row-header">
                                    <div class="law-statuses__table-cell law-statuses__table-name-cell">
                                        <span class="law-statuses__table-name">
                                            Вид на жительство
                                        </span>
                                    </div>
                                </div>
                            </li>

                            <li class="law-statuses__table-row law-statuses__table-document-row">
                                <div class="law-statuses__table-row-header">
                                    <div class="law-statuses__table-cell law-statuses__table-name-cell">
                                        <span class="law-statuses__table-name">
                                            РВП
                                        </span>
                                    </div>
                                </div>
                            </li>

                            <li class="law-statuses__table-row law-statuses__table-document-row">
                                <div class="law-statuses__table-row-header">
                                    <div class="law-statuses__table-cell law-statuses__table-name-cell">
                                        <span class="law-statuses__table-name">
                                            Справка об отсутствии судимости
                                        </span>
                                    </div>
                                </div>
                            </li>

                            <li class="law-statuses__table-row law-statuses__table-document-row">
                                <div class="law-statuses__table-row-header">
                                    <div class="law-statuses__table-cell law-statuses__table-name-cell">
                                        <span class="law-statuses__table-name">
                                            Пенсионное страховое свидетельство
                                        </span>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade law-statuses__modal modal-global" tabindex="-1" role="dialog" id="law-statuses__modal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>

                    <h4 class="modal-title">Создать правовой статус</h4>
                </div>

                <div class="modal-body">
                    <form action="" method="post" class="form-respons">
                        <div class="form-group required law-statuses__modal-name-form-group">
                            <label for="law-statuses__modal-name">Название статуса</label>
                            <input type="text" class="form-control" value="" name="law-statuses__modal-name"
                                   id="law-statuses__modal-name">
                            <span class="help-block" style="display: none">Должно быть не меньше 2 символов</span>
                        </div>

                        <div class="form-group law-statuses__modal-citizenship-form-group">
                            <label for="law-statuses__modal-citizenship">Гражданство</label>
                            <select class="form-control" name="law-statuses__modal-citizenship[]" id="law-statuses__modal-citizenship" multiple="multiple">
                                <option value="1">Россия</option>
                                <option value="2">Украина</option>
                                <option value="3">Белоруссия</option>
                                <option value="4">Казахстан</option>
                            </select>
                        </div>

                        <div class="form-btns clearfix law-statuses__modal-save-button">
                            <button type="button" class="btn btn-primary">Сохранить</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    @@include('include/_js.html')

    <script src="https://unpkg.com/web-animations-js@2.3.1/web-animations.min.js"></script>
    <script src="https://unpkg.com/hammerjs@2.0.8/hammer.min.js"></script>
    <script src="https://unpkg.com/muuri@0.7.1/dist/muuri.min.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            initHatNavbar(document);

            const $tableBody = $('.law-statuses__table-body');
            const $tableStatusRows = $('.law-statuses__table-status-row');
            const $modal = $('.law-statuses__modal');
            const $modalNameFormGroup = $('.law-statuses__modal-name-form-group');
            const $search = $('.search-global');
            const $searchInput = $search.find('.form-control');

            $tableBody.nestedSortable({
                items: '.law-statuses__table-row',
                listType: 'ul',
                doNotClear: true,
                maxLevels: 2,
                disableNestingClass: 'law-statuses__table-document-row',
                tabSize: 10,
                isAllowed: ($placeholder, $placeholderParent, $currentItem) => {
                    return $currentItem.hasClass('law-statuses__table-document-row') || !$placeholderParent;
                },
                change: function(mouseEvent, event) {
                    const $placeholder = event.placeholder;

                    if ($placeholder.hasClass('law-statuses__table-document-row')) {
                        $placeholder.toggle($placeholder.nextAll().filter('.law-statuses__table-status-row').length === 0);
                    } else {
                        $placeholder.toggle($placeholder.prevAll().filter('.law-statuses__table-document-row').length === 0);
                    }

                    $tableStatusRows.each((_, row) => {
                        $(row).trigger('nestedSortableChange', [event.helper]);
                    });
                },
                update: function() {
                    const $tableBodyChildren = $tableBody.children();

                    $tableBodyChildren.sort((a, b) => {
                        const aValue = $(a).hasClass('law-statuses__table-status-row') ? 1 : 0;
                        const bValue = $(b).hasClass('law-statuses__table-status-row') ? 1 : 0;

                        return bValue - aValue;
                    });

                    $tableBody.append($tableBodyChildren);

                    $tableStatusRows.each((_, row) => {
                        $(row).trigger('nestedSortableUpdate');
                    });
                }
            });

            $tableBody.on('sortrevert', () => {
                $tableStatusRows.each((_, row) => {
                    $(row).trigger('nestedSortableChange');
                });
            });

            $modal.modal({
                show: false
            });

            $('.law-statuses__add-button').on('click', () => {
                $modal.modal('show');
            });

            $('.law-statuses__modal-save-button').on('click', () => {
                const value = $modalNameFormGroup.find('.form-control').val();
                const hasError = value.length < 2;
                $modalNameFormGroup.toggleClass('has-error', hasError);
                $modalNameFormGroup.find('.help-block').toggle(hasError);

                if (!hasError) {
                    $modal.modal('hide');
                }
            });

            $('.law-statuses__modal-citizenship-form-group .form-control').select2({
                width: '100%'
            });

            $tableStatusRows.each((_, row) => {
                const $row = $(row);
                const $header = $row.find('.law-statuses__table-row-header');
                const $content = $row.find('.law-statuses__table-row-content');
                const $toggle = $row.find('.law-statuses__table-status-row-toggle');
                const $icon = $toggle.find('i');
                let isOpen = false;
                let isEmpty = $content.children().length === 0;

                $row.height($header.height());

                $toggle.on('click', () => {
                    if (isEmpty) {
                        return;
                    }

                    isOpen = !isOpen;

                    if (isOpen) {
                        $row.animate({height: $header.height() + $content.height()}, 200);
                    } else {
                        $row.animate({height: $header.height()}, 200);
                    }

                    $icon.toggleClass('fa-chevron-circle-down', !isOpen);
                    $icon.toggleClass('fa-chevron-circle-up', isOpen);
                });

                $row.on('nestedSortableChange', (_, $helperRow) => {
                    if (isOpen || ((!$helperRow || $helperRow.hasClass('law-statuses__table-document-row')) && isEmpty && $content.children().length > 0)) {
                        $row.height($header.height() + $content.height());
                    } else {
                        $row.height($header.height());
                    }
                });

                $row.on('nestedSortableUpdate', () => {
                    const isBeforeEmpty = isEmpty;
                    isEmpty = $content.children().length === 0;

                    if (isOpen) {
                        if (isEmpty) {
                            isOpen = false;
                            $row.height($header.height());
                            $icon.addClass('fa-chevron-circle-down');
                            $icon.removeClass('fa-chevron-circle-up');
                        } else {
                            $row.height($header.height() + $content.height());
                        }
                    }

                    $row.toggleClass('law-statuses__table-status-row--empty', isEmpty);

                    if (isBeforeEmpty !== isEmpty && !isOpen) {
                        $row.height($header.height());
                    }
                });
            });

            $tableStatusRows.each((_, row) => {
                const $row = $(row);

                $row.find('.law-statuses__table-row-remove-button').on('click', () => {
                    $row.hide(200, () => $row.remove());
                });
            });

            $search.find('.search-global__search-clear-button').on('click', () => {
                $searchInput.val('').trigger('input');
                $search.addClass('search-global--empty');
            });

            $searchInput.on('input', event => {
                const value = event.target.value;
                $search.toggleClass('search-global--empty', value.length === 0);
            });

            initSearch(
                $search.get()[0],
                $tableStatusRows.toArray(),
                item => $(item).find('> .law-statuses__table-row-header .law-statuses__table-name').text()
            );
        });
    </script>

    <!-- TODO: удалить после перехода всех страниц на новое меню -->
    @@include('include/_hat-navbar-fix.html')
</body>
</html>
